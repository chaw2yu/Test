cscope 15 $HOME/pbc -q 0000000930 0000227580
	@binding/lua/parser.lua

2 -- 
sim¶e
 
´Ùo
 
	g·r£r


5 
loÿl
 
	gÍeg
 = 
»quœe
 "lpeg"

6 
loÿl
 
P
 = 
Íeg
.P

7 
loÿl
 
S
 = 
Íeg
.S

8 
loÿl
 
R
 = 
Íeg
.R

9 
loÿl
 
C
 = 
Íeg
.C

10 
loÿl
 
Ct
 = 
Íeg
.Ct

11 
loÿl
 
Cg
 = 
Íeg
.Cg

12 
loÿl
 
Cc
 = 
Íeg
.Cc

13 
loÿl
 
V
 = 
Íeg
.V

15 
loÿl
 
Ãxt
 =‚ext

16 
loÿl
 
”rÜ
 =ƒrror

17 
loÿl
 
tÚumb”
 =onumber

18 
loÿl
 
·œs
 =…airs

19 
loÿl
 
aœs
 = ipairs

20 
loÿl
 
¿w£t
 =„awset

21 
loÿl
 
tš£¹
 = 
bË
.
š£¹


22 
loÿl
 
sm©ch
 = 
¡ršg
.
m©ch


23 
loÿl
 
sby‹
 = 
¡ršg
.
by‹


25 
loÿl
 
š‹º®_ty³
 = {

28 
	gušt64
 = "TYPE_UINT64",

30 
	gšt32
 = "TYPE_INT32",

31 
	gšt64
 = "TYPE_INT64",

32 
	gfixed64
 = "TYPE_FIXED64",

33 
	gfixed32
 = "TYPE_FIXED32",

34 
	gboŞ
 = "TYPE_BOOL",

35 
	g¡ršg
 = "TYPE_STRING",

36 
	gby‹s
 = "TYPE_BYTES",

37 
	gušt32
 = "TYPE_UINT32",

38 
	gsfixed32
 = "TYPE_SFIXED32",

39 
	gsfixed64
 = "TYPE_SFIXED64",

40 
	gsšt32
 = "TYPE_SINT32",

41 
	gsšt64
 = "TYPE_SINT64",

44 
loÿl
 
funùiÚ
 
	$couÁ_lšes
(
_
,
pos
, 
·r£r_¡©e
)

45 
·r£r_¡©e
.
pos
 <…o 
th’


46 
·r£r_¡©e
.
lše
 =…arser_state.line + 1

47 
·r£r_¡©e
.
pos
 =…os

48 
’d


49  
pos


50 
’d


52 
loÿl
 
exû±iÚ
 = 
Íeg
.
	`Cmt
ĞÍeg.
	`C¬g
(1è, 
	$funùiÚ
 ( 
_
 , 
pos
, 
·r£r_¡©e
)

53 
	`”rÜ
Ğ"syÁaxƒ¼Ü‡ˆ[" .. (
·r£r_¡©e
.
fe
 
Ü
 ""è.."] (" ..…¬£r_¡©e.
lše
 ..")" )

54  
pos


55 
’d
)

57 
loÿl
 
eof
 = 
	`P
(-1)

58 
loÿl
 
Ãwlše
 = 
Íeg
.
	`Cmt
((
P
"\n" + "\r\n"è*†³g.
	`C¬g
(1è,
couÁ_lšes
)

59 
loÿl
 
lše_comm’t
 = "//" * (1 - 
Ãwlše
è^0 * (Ãwlš+ 
eof
)

60 
loÿl
 
bÏnk
 = 
S
" \t" + 
Ãwlše
 + 
lše_comm’t


61 
loÿl
 
bÏnk0
 = 
bÏnk
 ^ 0

62 
loÿl
 
bÏnks
 = 
bÏnk
 ^ 1

63 
loÿl
 
®pha
 = 
R
"az" + R"AZ" + "_"

64 
loÿl
 
®num
 = 
®pha
 + 
R
"09"

65 
loÿl
 
¡r_c
 = (1 - 
	`S
("\\\"")è+ 
	`P
("\\") * 1

66 
loÿl
 
¡r
 = 
P
"\"" * 
	`C
(
¡r_c
^0) * "\""

67 
loÿl
 
dÙÇme
 = ("." * 
®pha
 * 
®num
 ^ 0) ^ 0

68 
loÿl
 
ty³Çme
 = 
	`C
(
®pha
 * 
®num
 ^ 0 * 
dÙÇme
)

69 
loÿl
 
Çme
 = 
	`C
(
®pha
 * 
®num
 ^ 0)

70 
loÿl
 
f’ame
 = 
P
"\"" * 
	`C
((
®num
 + "/" + "." + "-")^1) * "\""

71 
loÿl
 
id
 = 
R
"09" ^ 1 / 
tÚumb”
 + "max" * 
	`Cc
(-1)

72 
loÿl
 
boŞ
 = "Œue" * 
	`Cc
(
Œue
è+ "çl£" * 
	$Cc
(
çl£
)

73 
loÿl
 
v®ue
 = 
¡r
 + 
boŞ
 + 
Çme
 + 
id


74 
loÿl
 
·‰”ns
 = {
	}
}

76 
loÿl
 
’um_™em
 = 
Cg
(
Çme
 * 
bÏnk0
 * "=" * bÏnk0 * 
id
 * blank0 * ";" * blank0)

78 
loÿl
 
funùiÚ
 
	$š£¹
(
tbl
, 
k
,
v
)

79 
	`tš£¹
(
tbl
, { 
Çme
 = 
k
 , 
numb”
 = 
v
 
	}
})

80  
tbl


81 
’d


83 
	g·‰”ns
.
	gENUM
 = 
Ct
(
Cg
("’um","ty³"è* 
bÏnks
 * Cg(
ty³Çme
,"Çme"è* 
bÏnk0
 *

84 "{" * 
bÏnk0
 *

85 
Cg
(
Íeg
.
Cf
(
Ct
"" * 
’um_™em
^1 , 
š£¹
),"value")

86 * "}" * 
bÏnk0
)

88 
loÿl
 
	g´efix_f›ld
 = 
P
"»quœed" * 
Cc
"LABEL_REQUIRED" +

89 
P
"İtiÚ®" * 
Cc
"LABEL_OPTIONAL" +

90 
P
"»³©ed" * 
Cc
"LABEL_REPEATED"

91 
loÿl
 
po¡fix_·œ
 = 
bÏnk0
 * 
Cg
(
Çme
 * bÏnk0 * "=" * bÏnk0 * 
v®ue
 * blank0)

92 
loÿl
 
po¡fix_·œ_2
 = 
bÏnk0
 * "," * 
po¡fix_·œ


93 
loÿl
 
po¡fix_f›ld
 = "[" * 
po¡fix_·œ
 * 
po¡fix_·œ_2
^0 * 
bÏnk0
 * "]"

94 
loÿl
 
İtiÚs
 = 
Íeg
.
Cf
(
Ct
"" * 
po¡fix_f›ld
 , 
¿w£t
) ^ -1

96 
loÿl
 
funùiÚ
 
	$£tİtiÚ
(
t
, 
İtiÚs
)

97 
	$Ãxt
(
İtiÚs
è
th’


98 
t
.
İtiÚs
 = options

99 
’d


100  
t


101 
’d


103 
loÿl
 
mes§ge_f›ld
 = 
Íeg
.
	`Cf
 (

104 
	`Ct
Ğ
	`Cg
(
´efix_f›ld
,"Ïb–"è* 
bÏnks
 *

105 
	`Cg
(
ty³Çme
,"ty³_Çme"è* 
bÏnks
 *

106 
	`Cg
(
Çme
,"Çme"è* 
bÏnk0
 * "=" * blank0 *

107 
	`Cg
(
id
,"number")

108 è* 
bÏnk0
 * 
İtiÚs
 ,

109 
£tİtiÚ
è* 
bÏnk0
 * ";" * blank0

111 
loÿl
 
ex‹nsiÚs
 = 
	`Ct
(

112 
	`Cg
("ex‹nsiÚs" , "ty³"è* 
bÏnks
 *

113 
	`Cg
(
id
,"¡¬t"è* 
bÏnks
 * "to" * blanks *

114 
	`Cg
(
id
,"’d"è* 
bÏnk0
 * ";" * blank0

117 
·‰”ns
.
EXTEND
 = 
	`Ct
(

118 
	`Cg
("ex‹nd", "ty³"è* 
bÏnks
 *

119 
	`Cg
(
ty³Çme
, "Çme"è* 
bÏnk0
 * "{" * blank0 *

120 
	`Cg
(
	`Ct
((
mes§ge_f›ld
è^ 1),"ex‹nsiÚ"è* "}" * 
bÏnk0


123 
·‰”ns
.
MESSAGE
 = 
P
 { 
	`Ct
(

124 
	`Cg
("mes§ge","ty³"è* 
bÏnks
 *

125 
	`Cg
(
ty³Çme
,"Çme"è* 
bÏnk0
 * "{" * blank0 *

126 
	`Cg
(
	`Ct
((
mes§ge_f›ld
 + 
·‰”ns
.
ENUM
 + 
ex‹nsiÚs
 +…©‹ºs.
EXTEND
 + 
	`V
(1)è^ 0),"™ems"è* "}" * 
bÏnk0


127 è
	}
}

129 
·‰”ns
.
OPTION
 = 
Ct
(

130 
Cg
("İtiÚ" , "ty³"è* 
bÏnks
 *

131 
Cg
(
Çme
, "Çme"è* 
bÏnk0
 * "=" * blank0 *

132 
Cg
(
v®ue
, "value")

133 è* 
	gbÏnk0
 * ";" * 
bÏnk0


135 
	g·‰”ns
.
	gIMPORT
 = 
Ct
Ğ
Cg
("impÜt" , "ty³"è* 
bÏnks
 * Cg(
f’ame
, "Çme"èè* 
	gbÏnk0
 * ";" * 
bÏnk0


137 
	g·‰”ns
.
	gPACKAGE
 = 
Ct
Ğ
Cg
("·ckage", "ty³"è* 
bÏnks
 * Cg(
ty³Çme
, "Çme"èè* 
	gbÏnk0
 * ";" * 
bÏnk0


139 
loÿl
 
	g´Ùo_tbl
 = { "PROTO" }

142 
loÿl
 
k
, 
	gv
 = 
	$Ãxt
(
·‰”ns
)

143 
loÿl
 
p
 = 
	$V
(
k
)

144 
´Ùo_tbl
[
k
] = 
v


145 
k
,
v
 
š
 
Ãxt
 , 
·‰”ns
 , k do

146 
´Ùo_tbl
[
k
] = 
v


147 
p
 =… + 
	$V
(
k
)

148 
’d


149 
´Ùo_tbl
.
PROTO
 = 
	`Ct
(
bÏnk0
 * 
p
 ^ 1)

150 
’d


152 
loÿl
 
´Ùo
 = 
	$P
(
´Ùo_tbl
)

154 
loÿl
 
d—l
 = {
	}
}

156 
funùiÚ
 
d—l
:
	$impÜt
(
v
)

157 
£lf
.
d•’d’cy
 = s–f.d•’d’cy 
Ü
 {
	}
}

158 
	$tš£¹
(
£lf
.
d•’d’cy
 , 
v
.
Çme
)

159 
’d


161 
funùiÚ
 
d—l
:
	$·ckage
(
v
)

162 
£lf
.
·ckage
 = 
v
.
Çme


163 
’d


165 
funùiÚ
 
d—l
:(
v
)

166 
£lf
.
’um_ty³
 = s–f.’um_ty³ 
Ü
 {
	}
}

167 
	$tš£¹
(
£lf
.
’um_ty³
 , 
v
)

168 
’d


170 
funùiÚ
 
d—l
:
	$İtiÚ
(
v
)

171 
£lf
.
İtiÚs
 = s–f.İtiÚ 
Ü
 {
	}
}

172 
£lf
.
İtiÚs
[
v
.
Çme
] = v.
v®ue


173 
’d


175 
funùiÚ
 
d—l
:
	$ex‹nd
(
v
)

176 
£lf
.
ex‹nsiÚ
 = s–f.ex‹nsiÚ 
Ü
 {
	}
}

177 
loÿl
 
ex‹nd“
 = 
v
.
Çme


178 
_
,
v
 
š
 
	$aœs
(
v
.
ex‹nsiÚ
) do

179 
v
.
ex‹nd“
 =ƒxtendee

180 
v
.
ty³
 = 
š‹º®_ty³
[v.
ty³_Çme
]

181 
v
.
ty³
 
th’


182 
v
.
ty³_Çme
 = 
n


183 
’d


184 
	$tš£¹
(
£lf
.
ex‹nsiÚ
 , 
v
)

185 
’d


186 
’d


188 
funùiÚ
 
d—l
:
	$ex‹nsiÚs
(
v
)

189 
£lf
.
ex‹nsiÚ_¿nge
 = s–f.ex‹nsiÚ_¿ng
Ü
 {
	}
}

190 
	$tš£¹
(
£lf
.
ex‹nsiÚ_¿nge
, 
v
)

191 
’d


193 
loÿl
 
funùiÚ
 
	$_add_Ã¡ed_mes§ge
(
£lf
, 
™em
)

194 
™em
.
ty³
 =ğ
n
 
th’


195 
™em
.
ty³
 = 
š‹º®_ty³
[™em.
ty³_Çme
]

196 
™em
.
ty³
 
th’


197 
™em
.
ty³_Çme
 = 
n


198 
’d


199 
£lf
.
f›ld
 = s–f.f›ld 
Ü
 {
	}
}

200 
	$tš£¹
(
£lf
.
f›ld
, 
™em
)

202 
loÿl
 
f
 = 
d—l
[
™em
.
ty³
]

203 
™em
.
ty³
 = 
n


204 
	$f
(
£lf
 , 
™em
)

205 
’d


206 
’d


208 
funùiÚ
 
d—l
:
	$mes§ge
(
v
)

209 
£lf
.
Ã¡ed_ty³
 = s–f.Ã¡ed_ty³ 
Ü
 {
	}
}

210 
loÿl
 
m
 = { 
Çme
 = 
v
.name }

211 
	$tš£¹
(
£lf
.
Ã¡ed_ty³
 , 
m
)

212 
_
,
v
 
š
 
	$aœs
(
v
.
™ems
) do

213 
	$_add_Ã¡ed_mes§ge
(
m
, 
v
)

214 
’d


215 
’d


217 
loÿl
 
funùiÚ
 
	$fix
(
r
)

218 
loÿl
 
p
 = {
	}
}

219 
_
,
v
 
š
 
	$aœs
(
r
) do

220 
loÿl
 
f
 = 
d—l
[
v
.
ty³
]

221 
v
.
ty³
 = 
n


222 
	$f
(
p
 , 
v
)

223 
’d


225 
p
.
mes§ge_ty³
 =….
Ã¡ed_ty³


226 
p
.
Ã¡ed_ty³
 = 
n


228  
p


229 
’d


231 --- 
fix
 
mes§ge
 
Çme


233 
loÿl
 
NULL
 = {
	}
}

235 
loÿl
 
funùiÚ
 
	$_m©ch_Çme
(
Çme¥aû
 , 
n
 , 
®l
)

236 
	`sby‹
(
n
è=ğ46 
th’


237  
n


238 
’d


240 
»³©


241 
loÿl
 
Çme
 = 
Çme¥aû
 .. "." .. 
n


242 
®l
[
Çme
] 
th’


243  
Çme


244 
’d


245 
Çme¥aû
 = 
	`sm©ch
(namespace,"(.*)%.[%w_]+$")

246 
uÁ
 
Çme¥aû
 =ğ
n


247 
’d


249 
loÿl
 
funùiÚ
 
	$_fix_f›ld
(
Çme¥aû
 , 
f›ld
, 
®l
)

250 
loÿl
 
ty³_Çme
 = 
f›ld
.type_name

251 
ty³_Çme
 =ğ"" 
th’


252 
f›ld
.
ty³_Çme
 = 
n


254 
–£if
 
ty³_Çme
 =ğ
n
 
th’


256 
’d


258 
loÿl
 
fuÎ_Çme
 = 
	`as£¹
(
	`_m©ch_Çme
(
Çme¥aû
, 
f›ld
.
ty³_Çme
, 
®l
) , field.type_name ,‡ll)

260 
f›ld
.
ty³_Çme
 = 
fuÎ_Çme


261 
f›ld
.
ty³
 = 
®l
[
fuÎ_Çme
]

263 
loÿl
 
İtiÚs
 = 
f›ld
.options

264 
İtiÚs
 
th’


265 
İtiÚs
. 
th’


266 
f›ld
.
deçuÉ_v®ue
 = 
	$to¡ršg
(
İtiÚs
.)

267 
İtiÚs
. = 
n


268 
’d


269 
	`Ãxt
(
İtiÚs
è=ğ
n
 
th’


270 
f›ld
.
İtiÚs
 = 
n


271 
’d


272 
’d


273 
’d


275 
loÿl
 
funùiÚ
 
	$_fix_ex‹nsiÚ
(
Çme¥aû
, 
ext
, 
®l
)

276 
_
,
f›ld
 
š
 
	$aœs
(
ext
 
Ü
 
NULL
) do

277 
f›ld
.
ex‹nd“
 = 
	`as£¹
(
	`_m©ch_Çme
(
Çme¥aû
, f›ld.ex‹nd“,
®l
),field.extendee)

278 
	$_fix_f›ld
(
Çme¥aû
 , 
f›ld
 , 
®l
)

279 
’d


280 
’d


282 
loÿl
 
funùiÚ
 
	$_fix_mes§ge
(
msg
 , 
®l
)

283 
_
,
f›ld
 
š
 
	$aœs
(
msg
.
f›ld
 
Ü
 
NULL
) do

284 
	`_fix_f›ld
(
	`as£¹
(
®l
[
msg
],msg.
Çme
è, 
f›ld
 ,‡ll)

285 
’d


286 
_
,
Ã¡
 
š
 
	$aœs
(
msg
.
Ã¡ed_ty³
 
Ü
 
NULL
) do

287 
	$_fix_mes§ge
(
Ã¡
 , 
®l
)

288 
’d


289 
	$_fix_ex‹nsiÚ
(
®l
[
msg
] , msg.
ex‹nsiÚ
 ,‡ll)

290 
’d


292 
loÿl
 
funùiÚ
 
	$_fix_ty³Çme
(
fe
 , 
®l
)

293 
_
,
mes§ge
 
š
 
	$aœs
(
fe
.
mes§ge_ty³
 
Ü
 
NULL
) do

294 
	$_fix_mes§ge
(
mes§ge
 , 
®l
)

295 
’d


296 
	$_fix_ex‹nsiÚ
(
fe
.
·ckage
 , fe.
ex‹nsiÚ
 , 
®l
)

297 
’d


299 --- 
m”ge
 
mes§ges


301 
loÿl
 
funùiÚ
 
	$_’um_fuÎÇme
(
´efix
, , 
®l
)

302 
loÿl
 
fuÎÇme


303 
	`sby‹
(.
Çme
è=ğ46 
th’


304 
fuÎÇme
 = .
Çme


306 
fuÎÇme
 = 
´efix
 .. "." .. .
Çme


307 
’d


308 
®l
[
fuÎÇme
] = "TYPE_ENUM"

309 
®l
[] = 
fuÎÇme


310 
’d


312 
loÿl
 
funùiÚ
 
	$_mes§ge_fuÎÇme
(
´efix
 , 
msg
 , 
®l
)

313 
loÿl
 
fuÎÇme


314 
	`sby‹
(
msg
.
Çme
è=ğ46 
th’


315 
fuÎÇme
 = 
msg
.
Çme


317 
fuÎÇme
 = 
´efix
 .. "." .. 
msg
.
Çme


318 
’d


319 
®l
[
fuÎÇme
] = "TYPE_MESSAGE"

320 
®l
[
msg
] = 
fuÎÇme


321 
_
,
Ã¡
 
š
 
	$aœs
(
msg
.
Ã¡ed_ty³
 
Ü
 
NULL
) do

322 
	$_mes§ge_fuÎÇme
(
fuÎÇme
 , 
Ã¡
 , 
®l
)

323 
’d


324 
_
,
š
 
	$aœs
(
msg
.
’um_ty³
 
Ü
 
NULL
) do

325 
	$_’um_fuÎÇme
(
fuÎÇme
 , , 
®l
)

326 
’d


327 
’d


329 
loÿl
 
funùiÚ
 
	$_g’_fuÎÇme
(
fe
 , 
®l
)

330 
loÿl
 
´efix
 = ""

331 
fe
.
·ckage
 
th’


332 
´efix
 = "." .. 
fe
.
·ckage


333 
’d


334 
_
,
mes§ge
 
š
 
	$aœs
(
fe
.
mes§ge_ty³
 
Ü
 
NULL
) do

335 
	$_mes§ge_fuÎÇme
(
´efix
 , 
mes§ge
 , 
®l
)

336 
’d


337 
_
,
š
 
	$aœs
(
fe
.
’um_ty³
 
Ü
 
NULL
) do

338 
	$_’um_fuÎÇme
(
´efix
 , , 
®l
)

339 
’d


340 
’d


342 --- 
·r£r


344 
loÿl
 
·r£r
 = {
	}
}

346 
loÿl
 
funùiÚ
 
	$·r£r_Úe
(
‹xt
,
f’ame
)

347 
loÿl
 
¡©e
 = { 
fe
 = 
f’ame
, 
pos
 = 0, 
lše
 = 1 
	}
}

348 
loÿl
 
	gr
 = 
Íeg
.
m©ch
(
´Ùo
 * -1 + 
exû±iÚ
 , 
‹xt
 , 1, 
¡©e
 )

349 
loÿl
 
	gt
 = 
	$fix
(
r
)

350  
t


351 
’d


353 
funùiÚ
 
·r£r
.
	$·r£r
(
‹xt
,
f’ame
)

354 
loÿl
 
t
 = 
	$·r£r_Úe
(
‹xt
,
f’ame
)

355 
loÿl
 
®l
 = {
	}
}

356 
	$_g’_fuÎÇme
(
t
,
®l
)

357 
	$_fix_ty³Çme
(
t
 , 
®l
)

358  
t


359 
’d


361 
loÿl
 
pb
 = 
»quœe
 "protobuf"

363 
funùiÚ
 
·r£r
.(
fe£t
 , 
·th
)

364 
loÿl
 
®l
 = {
	}
}

365 
loÿl
 
fes
 = {}

366 
ty³
(
fe£t
è=ğ"¡ršg" 
th’


367 
fe£t
 = { fileset }

368 
’d


369 
_
, 
f’ame
 
š
 
	$aœs
(
fe£t
) do

370 
loÿl
 
fuÎÇme


371 
·th
 
th’


372 
fuÎÇme
 = 
·th
 .. "/" .. 
f’ame


374 
fuÎÇme
 = 
f’ame


375 
’d


376 
loÿl
 
f
 = 
	`as£¹
(
io
.
	`İ’
(
fuÎÇme
 , "r"))

377 
loÿl
 
bufãr
 = 
f
:
»ad
 "*a"

378 
f
:
	$şo£
()

379 
loÿl
 
t
 = 
	$·r£r_Úe
(
bufãr
,
f’ame
)

380 
	$_g’_fuÎÇme
(
t
,
®l
)

381 
t
.
Çme
 = 
f’ame


382 
	$tš£¹
(
fes
 , 
t
)

383 
’d


384 
_
,
fe
 
š
 
	$aœs
(
fes
) do

385 
	$_fix_ty³Çme
(
fe
,
®l
)

386 
’d


388 
loÿl
 
pb’code
 = 
pb
.
	`’code
("googË.´Ùobuf.FeDesütÜS‘" , { 
fe
 = 
fes
 
	}
})

390 
	gpb’code
 =ğ
n
 
th’


391 
”rÜ
(
pb
.
	$Ï¡”rÜ
())

392 
’d


393 
pb
.(
pb’code
)

394  
fes


395 
’d


	@binding/lua/pbc-lua.c

1 #ifdeà
__ılu¥lus


4 
	~"lua.h
"

5 
	~"lu®ib.h
"

6 
	~"Ïuxlib.h
"

8 
	~"pbc.h
"

10 #ifdeà
__ılu¥lus


14 
	~<¡dboŞ.h
>

15 #ià
defšed
(
__APPLE__
)

16 
	~<m®loc/m®loc.h
>

18 
	~<m®loc.h
>

22 #iâdeà
_MSC_VER


23 
	~<®loÿ.h
>

25 
	#®loÿ
 
_®loÿ


	)

28 
	~<¡ršg.h
>

29 
	~<¡dlib.h
>

30 
	~<¡dšt.h
>

32 #ià
LUA_VERSION_NUM
 == 501

34 
	#lua_¿wËn
 
lua_objËn


	)

35 
	#luaL_Ãwlib
(
L
 ,
»g
è
	`luaL_»gi¡”
(L,"´Ùobuf.c",»g)

	)

36 
	#luaL_buffš™
(
L
 , 
_
 )

	)

37 
	#luaL_´•buffsize
Ğ
b
 , 
ÿp
 ) 
	`m®loc
(ÿp)

	)

38 
	#_F»e
(
p
è
	`ä“
Õ)

	)

39 #undeà
luaL_addsize


40 
	#luaL_addsize
(
b
 , 
Ën
è
	`lua_pushl¡ršg
(
L
, 
‹mp
 ,†’è; 
	`ä“
Ñemp)

	)

41 
	#luaL_push»suÉ
(
b
)

	)

42 
	#luaL_checkv”siÚ
(
L
)

	)

46 
	#_F»e
(
p
)

	)

50 
	#UNUSED
(
x
è(()(x)è

	)

52 
šlše
 *

53 
	$checku£rd©a
(
lua_S‹
 *
L
, 
šdex
) {

54 * 
ud
 = 
	`lua_tou£rd©a
(
L
,
šdex
);

55 ià(
ud
 =ğ
NULL
) {

56 
	`luaL_”rÜ
(
L
, "u£rd©¨%d i n",
šdex
);

58  
ud
;

59 
	}
}

62 
	$_’v_Ãw
(
lua_S‹
 *
L
) {

63 
pbc_’v
 * 
’v
 = 
	`pbc_Ãw
();

64 
	`lua_pushlightu£rd©a
(
L
, 
’v
);

66 
	}
}

69 
	$_’v_»gi¡”
(
lua_S‹
 *
L
) {

70 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
,1);

71 
size_t
 
sz
 = 0;

72 cÚ¡ * 
bufãr
 = 
	`luaL_checkl¡ršg
(
L
, 2 , &
sz
);

73 
pbc_¦iû
 
¦iû
;

74 
¦iû
.
bufãr
 = (*)buffer;

75 
¦iû
.
Ën
 = ()
sz
;

76 
»t
 = 
	`pbc_»gi¡”
(
’v
, &
¦iû
);

78 ià(
»t
) {

79  
	`luaL_”rÜ
(
L
, "register fail");

82 
	}
}

85 
	$_’v_’um_id
(
lua_S‹
 *
L
) {

86 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
,1);

87 
size_t
 
sz
 = 0;

88 cÚ¡ * 
’um_ty³
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
sz
);

89 cÚ¡ * 
’um_Çme
 = 
	`luaL_checkl¡ršg
(
L
, 3, &
sz
);

90 
št32_t
 
’um_id
 = 
	`pbc_’um_id
(
’v
, 
’um_ty³
, 
’um_Çme
);

91 ià(
’um_id
 < 0)

93 
	`lua_pushš‹g”
(
L
, 
’um_id
);

95 
	}
}

98 
	$_rmes§ge_Ãw
(
lua_S‹
 *
L
) {

99 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
,1);

100 cÚ¡ * 
ty³_Çme
 = 
	`luaL_check¡ršg
(
L
,2);

101 
pbc_¦iû
 
¦iû
;

102 ià(
	`lua_is¡ršg
(
L
,3)) {

103 
size_t
 
sz
 = 0;

104 
¦iû
.
bufãr
 = (*)
	`lua_tŞ¡ršg
(
L
,3,&
sz
);

105 
¦iû
.
Ën
 = ()
sz
;

107 
¦iû
.
bufãr
 = 
	`lua_tou£rd©a
(
L
,3);

108 
¦iû
.
Ën
 = 
	`luaL_checkš‹g”
(
L
,4);

110 
pbc_rmes§ge
 * 
m
 = 
	`pbc_rmes§ge_Ãw
(
’v
, 
ty³_Çme
, &
¦iû
);

111 ià(
m
==
NULL
)

113 
	`lua_pushlightu£rd©a
(
L
,
m
);

115 
	}
}

118 
	$_rmes§ge_d–‘e
(
lua_S‹
 *
L
) {

119 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

120 
	`pbc_rmes§ge_d–‘e
(
m
);

123 
	}
}

126 
	$_rmes§ge_š‹g”
(
lua_S‹
 *
L
) {

127 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

128 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

129 
šdex
 = 
	`luaL_checkš‹g”
(
L
,3);

130 
št32_t
 
v
 = (št32_t)
	`pbc_rmes§ge_š‹g”
(
m
, 
key
, 
šdex
, 
NULL
);

132 
	`lua_pushš‹g”
(
L
,
v
);

135 
	}
}

138 
	$_rmes§ge_št32
(
lua_S‹
 *
L
) {

139 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

140 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

141 
šdex
 = 
	`luaL_checkš‹g”
(
L
,3);

142 
ušt32_t
 
v
 = 
	`pbc_rmes§ge_š‹g”
(
m
, 
key
, 
šdex
, 
NULL
);

143 
	`lua_pushlightu£rd©a
(
L
,(*)(
šŒ_t
)
v
);

146 
	}
}

150 
	$_rmes§ge_št64
(
lua_S‹
 *
L
) {

151 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

152 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

153 
šdex
 = 
	`luaL_checkš‹g”
(
L
,3);

154 
ušt32_t
 
v
[2];

155 
v
[0] = 
	`pbc_rmes§ge_š‹g”
(
m
, 
key
, 
šdex
, &v[1]);

157 
	`lua_pushl¡ršg
(
L
,(cÚ¡ *)
v
,(v));

160 
	}
}

163 
	$_rmes§ge_št52
(
lua_S‹
 *
L
) {

164 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

165 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

166 
šdex
 = 
	`luaL_checkš‹g”
(
L
,3);

167 
ušt32_t
 
hi
,
low
;

168 
low
 = 
	`pbc_rmes§ge_š‹g”
(
m
, 
key
, 
šdex
, &
hi
);

169 
št64_t
 
v
 = (št64_t)((
ušt64_t
)
hi
 << 32 | (ušt64_t)
low
);

170 
	`lua_pushnumb”
(
L
,(
lua_Numb”
)
v
);

173 
	}
}

176 
	$_rmes§ge_ušt52
(
lua_S‹
 *
L
) {

177 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

178 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

179 
šdex
 = 
	`luaL_checkš‹g”
(
L
,3);

180 
ušt32_t
 
hi
,
low
;

181 
low
 = 
	`pbc_rmes§ge_š‹g”
(
m
, 
key
, 
šdex
, &
hi
);

182 
ušt64_t
 
v
 = (ušt64_t)
hi
 << 32 | (ušt64_t)
low
;

183 
	`lua_pushnumb”
(
L
,(
lua_Numb”
)
v
);

186 
	}
}

189 
	$_rmes§ge_»®
(
lua_S‹
 *
L
) {

190 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

191 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

192 
šdex
 = 
	`luaL_checkš‹g”
(
L
,3);

193 
v
 = 
	`pbc_rmes§ge_»®
(
m
, 
key
, 
šdex
);

195 
	`lua_pushnumb”
(
L
,
v
);

198 
	}
}

201 
	$_rmes§ge_¡ršg
(
lua_S‹
 *
L
) {

202 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

203 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

204 
šdex
 = 
	`lua_toš‹g”
(
L
,3);

205 
sz
 = 0;

206 cÚ¡ * 
v
 = 
	`pbc_rmes§ge_¡ršg
(
m
,
key
,
šdex
,&
sz
);

207 
	`lua_pushl¡ršg
(
L
,
v
,
sz
);

209 
	}
}

212 
	$_rmes§ge_mes§ge
(
lua_S‹
 *
L
) {

213 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

214 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

215 
šdex
 = 
	`lua_toš‹g”
(
L
,3);

216 
pbc_rmes§ge
 * 
v
 = 
	`pbc_rmes§ge_mes§ge
(
m
,
key
,
šdex
);

217 
	`lua_pushlightu£rd©a
(
L
,
v
);

219 
	}
}

222 
	$_rmes§ge_size
(
lua_S‹
 *
L
) {

223 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

224 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

226 
sz
 = 
	`pbc_rmes§ge_size
(
m
, 
key
);

228 
	`lua_pushš‹g”
(
L
, 
sz
);

231 
	}
}

234 
	$_’v_ty³
(
lua_S‹
 *
L
) {

235 
	`lua_£‰İ
(
L
,3);

236 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
,1);

237 cÚ¡ * 
ty³_Çme
 = 
	`luaL_check¡ršg
(
L
,2);

238 ià(
	`lua_i¢
(
L
,3)) {

239 
»t
 = 
	`pbc_ty³
(
’v
, 
ty³_Çme
, 
NULL
, NULL);

240 
	`lua_pushboŞ—n
(
L
,
»t
);

243 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,3);

244 cÚ¡ * 
ty³
 = 
NULL
;

245 
»t
 = 
	`pbc_ty³
(
’v
, 
ty³_Çme
, 
key
, &
ty³
);

246 
	`lua_pushš‹g”
(
L
,
»t
);

247 ià(
ty³
 =ğ
NULL
) {

250 
	`lua_push¡ršg
(
L
, 
ty³
);

253 
	}
}

256 
	$_wmes§ge_Ãw
(
lua_S‹
 *
L
) {

257 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
,1);

258 cÚ¡ * 
ty³_Çme
 = 
	`luaL_check¡ršg
(
L
,2);

259 
pbc_wmes§ge
 * 
»t
 = 
	`pbc_wmes§ge_Ãw
(
’v
, 
ty³_Çme
);

260 
	`lua_pushlightu£rd©a
(
L
,
»t
);

262 
	}
}

265 
	$_wmes§ge_d–‘e
(
lua_S‹
 *
L
) {

266 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`lua_tou£rd©a
(
L
,1);

267 
	`pbc_wmes§ge_d–‘e
(
m
);

270 
	}
}

274 
	$_wmes§ge_š‹g”
(
lua_S‹
 *
L
) {

275 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

276 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

277 
numb”
 = 
	`luaL_checkš‹g”
(
L
,3);

278 
ušt32_t
 
hi
 = 0;

279 ià(
numb”
 < 0)

280 
hi
 = ~0;

281 
	`pbc_wmes§ge_š‹g”
(
m
, 
key
, 
numb”
, 
hi
);

284 
	}
}

287 
	$_wmes§ge_»®
(
lua_S‹
 *
L
) {

288 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

289 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

290 
numb”
 = 
	`luaL_checknumb”
(
L
,3);

291 
	`pbc_wmes§ge_»®
(
m
, 
key
, 
numb”
);

294 
	}
}

297 
	$_wmes§ge_¡ršg
(
lua_S‹
 *
L
) {

298 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

299 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

300 
size_t
 
Ën
 = 0;

301 cÚ¡ * 
v
 = 
	`luaL_checkl¡ršg
(
L
,3,&
Ën
);

302 
”r
 = 
	`pbc_wmes§ge_¡ršg
(
m
, 
key
, 
v
, ()
Ën
);

303 ià(
”r
) {

304  
	`luaL_”rÜ
(
L
, "Wr™¡ršgƒ¼Ü : %s", 
v
);

308 
	}
}

311 
	$_wmes§ge_mes§ge
(
lua_S‹
 *
L
) {

312 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

313 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

314 
pbc_wmes§ge
 * 
»t
 = 
	`pbc_wmes§ge_mes§ge
(
m
, 
key
);

315 
	`lua_pushlightu£rd©a
(
L
, 
»t
);

318 
	}
}

321 
	$_wmes§ge_št32
(
lua_S‹
 *
L
) {

322 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

323 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

324 ià(!
	`lua_i¦ightu£rd©a
(
L
,3)) {

325  
	`luaL_”rÜ
(
L
,"Need‡†ightuserdata for int32");

327 *
numb”
 = 
	`lua_tou£rd©a
(
L
,3);

328 
	`pbc_wmes§ge_š‹g”
(
m
, 
key
, (
ušt32_t
)(
šŒ_t
)
numb”
 , 0);

330 
	}
}

333 
	$_wmes§ge_št64
(
lua_S‹
 *
L
) {

334 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

335 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

336 
	`lua_ty³
(
L
,3)) {

337 
LUA_TSTRING
 : {

338 
size_t
 
Ën
 = 0;

339 cÚ¡ * 
numb”
 = 
	`lua_tŞ¡ršg
(
L
,3,&
Ën
);

340 ià(
Ën
 !=8 ) {

341  
	`luaL_”rÜ
(
L
,"Need‡n 8†ength string for int64");

343 cÚ¡ 
ušt32_t
 * 
v
 = (cÚ¡ ušt32_ˆ*è
numb”
;

344 
	`pbc_wmes§ge_š‹g”
(
m
, 
key
, 
v
[0] , v[1]);

347 
LUA_TLIGHTUSERDATA
 : {

348 * 
v
 = 
	`lua_tou£rd©a
(
L
,3);

349 
ušt64_t
 
v64
 = (
ušŒ_t
)
v
;

350 
	`pbc_wmes§ge_š‹g”
(
m
, 
key
, (
ušt32_t
)
v64
 , (uint32_t)(v64>>32));

354  
	`luaL_”rÜ
(
L
, "Need‡n int64ype");

357 
	}
}

360 
	$_wmes§ge_št52
(
lua_S‹
 *
L
) {

361 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

362 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

363 
št64_t
 
numb”
 = (št64_t)(
	`luaL_checknumb”
(
L
,3));

364 
ušt32_t
 
hi
 = (ušt32_t)(
numb”
 >> 32);

365 
	`pbc_wmes§ge_š‹g”
(
m
, 
key
, (
ušt32_t
)
numb”
, 
hi
);

368 
	}
}

371 
	$_wmes§ge_ušt52
(
lua_S‹
 *
L
) {

372 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

373 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

374 
lua_Numb”
 
v
 = (
	`luaL_checknumb”
(
L
,3));

375 ià(
v
 < 0) {

376  
	`luaL_”rÜ
(
L
, "Ãg©ivnumb” : %à·s£dØunsigÃd f›ld",
v
);

378 
ušt64_t
 
numb”
 = (ušt64_t)
v
;

379 
ušt32_t
 
hi
 = (ušt32_t)(
numb”
 >> 32);

380 
	`pbc_wmes§ge_š‹g”
(
m
, 
key
, (
ušt32_t
)
numb”
, 
hi
);

383 
	}
}

386 
	$_wmes§ge_bufãr
(
lua_S‹
 *
L
) {

387 
pbc_¦iû
 
¦iû
;

388 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

389 
	`pbc_wmes§ge_bufãr
(
m
 , &
¦iû
);

390 
	`lua_pushlightu£rd©a
(
L
, 
¦iû
.
bufãr
);

391 
	`lua_pushš‹g”
(
L
, 
¦iû
.
Ën
);

393 
	}
}

396 
	$_wmes§ge_bufãr_¡ršg
(
lua_S‹
 *
L
) {

397 
pbc_¦iû
 
¦iû
;

398 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

399 
	`pbc_wmes§ge_bufãr
(
m
 , &
¦iû
);

400 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
¦iû
.
bufãr
, sliû.
Ën
);

402 
	}
}

408 
	$_Ï¡_”rÜ
(
lua_S‹
 *
L
) {

409 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
, 1);

410 cÚ¡ * 
”r
 = 
	`pbc_”rÜ
(
’v
);

411 
	`lua_push¡ršg
(
L
,
”r
);

413 
	}
}

421 
	$_·‰”n_Ãw
(
lua_S‹
 *
L
) {

422 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
, 1);

423 cÚ¡ * 
mes§ge
 = 
	`luaL_check¡ršg
(
L
,2);

424 cÚ¡ * 
fÜm©
 = 
	`luaL_check¡ršg
(
L
,3);

425 
pbc_·‰”n
 * 
·t
 = 
	`pbc_·‰”n_Ãw
(
’v
, 
mes§ge
, 
fÜm©
);

426 ià(
·t
 =ğ
NULL
) {

427  
	`luaL_”rÜ
(
L
, "ü—‹…©‹À% (%sèçed", 
mes§ge
 , 
fÜm©
);

429 
	`lua_pushlightu£rd©a
(
L
,
·t
);

432 
	}
}

435 
	$_·‰”n_d–‘e
(
lua_S‹
 *
L
) {

436 
pbc_·‰”n
 * 
·t
 = (pbc_·‰”À*)
	`lua_tou£rd©a
(
L
,1);

437 
	`pbc_·‰”n_d–‘e
(
·t
);

440 
	}
}

443 
	$_push_v®ue
(
lua_S‹
 *
L
, * 
±r
, 
ty³
) {

444 
ty³
) {

446 
ušt64_t
 
v
 = *(ušt64_t*)
±r
;

447 
±r
 += 8;

448 
	`lua_pushnumb”
(
L
,(
lua_Numb”
)
v
);

452 
št32_t
 
v
 = *(št32_t*)
±r
;

453 
±r
 += 4;

454 
	`lua_pushš‹g”
(
L
,
v
);

458 
št32_t
 
v
 = *(št32_t*)
±r
;

459 
±r
 += 4;

460 
	`lua_pushboŞ—n
(
L
,
v
);

464 
ušt32_t
 
v
 = *(ušt32_t*)
±r
;

465 
±r
 += 4;

466 
	`lua_pushlightu£rd©a
(
L
,(*)(
šŒ_t
)
v
);

470 
	`lua_pushl¡ršg
(
L
,
±r
,8);

471 
±r
 += 8;

475 
št64_t
 
v
 = *(št64_t*)
±r
;

476 
±r
 += 8;

477 
	`lua_pushnumb”
(
L
,(
lua_Numb”
)
v
);

481 
v
 = *(*)
±r
;

482 
±r
 += 8;

483 
	`lua_pushnumb”
(
L
,
v
);

487 
pbc_¦iû
 * 
¦iû
 = (pbc_¦iû *)
±r
;

488 
	`lua_pushl¡ršg
(
L
,(cÚ¡ *)
¦iû
->
bufãr
, sliû->
Ën
);

489 
±r
 +ğ(
pbc_¦iû
);

493 
pbc_¦iû
 * 
¦iû
 = (pbc_¦iû *)
±r
;

494 
	`lua_ü—‹bË
(
L
,2,0);

495 
	`lua_pushlightu£rd©a
(
L
, 
¦iû
->
bufãr
);

496 
	`lua_¿w£ti
(
L
,-2,1);

497 
	`lua_pushš‹g”
(
L
,
¦iû
->
Ën
);

498 
	`lua_¿w£ti
(
L
,-2,2);

499 
±r
 +ğ(
pbc_¦iû
);

503  
±r
;

504 
	}
}

507 
	$_push_¬¿y
(
lua_S‹
 *
L
, 
pbc_¬¿y
 
¬¿y
, 
ty³
, 
šdex
) {

508 
ty³
) {

510 
v
 = 
	`pbc_¬¿y_š‹g”
(
¬¿y
, 
šdex
, 
NULL
);

511 
	`lua_pushš‹g”
(
L
, 
v
);

515 
ušt32_t
 
hi
 = 0;

516 
ušt32_t
 
low
 = 
	`pbc_¬¿y_š‹g”
(
¬¿y
, 
šdex
, &
hi
);

517 
ušt64_t
 
v
 = (ušt64_t)
hi
 << 32 | (ušt64_t)
low
;

518 
	`lua_pushnumb”
(
L
, (
lua_Numb”
)
v
);

522 
ušt32_t
 
hi
 = 0;

523 
ušt32_t
 
low
 = 
	`pbc_¬¿y_š‹g”
(
¬¿y
, 
šdex
, &
hi
);

524 
ušt64_t
 
v
 = (ušt64_t)
hi
 << 32 | (ušt64_t)
low
;

525 
	`lua_pushnumb”
(
L
, (
lua_Numb”
)((
št64_t
)
v
));

529 
v
 = 
	`pbc_¬¿y_š‹g”
(
¬¿y
, 
šdex
, 
NULL
);

530 
	`lua_pushboŞ—n
(
L
, 
v
);

534 
ušt32_t
 
v
 = 
	`pbc_¬¿y_š‹g”
(
¬¿y
, 
šdex
, 
NULL
);

535 
	`lua_pushlightu£rd©a
(
L
,(*)(
šŒ_t
)
v
);

539 
ušt32_t
 
hi
 = 0;

540 
ušt32_t
 
low
 = 
	`pbc_¬¿y_š‹g”
(
¬¿y
, 
šdex
, &
hi
);

541 
ušt64_t
 
v
 = (ušt64_t)
low
 | (ušt64_t)
hi
 << 32;

542 
	`lua_pushl¡ršg
(
L
, (*)&
v
, 8);

546 
v
 = 
	`pbc_¬¿y_»®
(
¬¿y
, 
šdex
);

547 
	`lua_pushnumb”
(
L
, 
v
);

551 
pbc_¦iû
 * 
¦iû
 = 
	`pbc_¬¿y_¦iû
(
¬¿y
, 
šdex
);

552 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
¦iû
->
bufãr
,¦iû->
Ën
);

556 
pbc_¦iû
 * 
¦iû
 = 
	`pbc_¬¿y_¦iû
(
¬¿y
, 
šdex
);

557 
	`lua_ü—‹bË
(
L
,2,0);

558 
	`lua_pushlightu£rd©a
(
L
,
¦iû
->
bufãr
);

559 
	`lua_¿w£ti
(
L
,-2,1);

560 
	`lua_pushš‹g”
(
L
,
¦iû
->
Ën
);

561 
	`lua_¿w£ti
(
L
,-2,2);

565 
	`lua_¿w£ti
(
L
,-2,
šdex
+1);

566 
	}
}

576 
	$_·‰”n_uÅack
(
lua_S‹
 *
L
) {

577 
pbc_·‰”n
 * 
·t
 = (pbc_·‰”À*)
	`checku£rd©a
(
L
, 1);

578 ià(
·t
 =ğ
NULL
) {

579  
	`luaL_”rÜ
(
L
, "unpack…attern is NULL");

581 
size_t
 
fÜm©_sz
 = 0;

582 cÚ¡ * 
fÜm©
 = 
	`lua_tŞ¡ršg
(
L
,2,&
fÜm©_sz
);

583 
size
 = 
	`lua_toš‹g”
(
L
,3);

584 
pbc_¦iû
 
¦iû
;

585 ià(
	`lua_is¡ršg
(
L
,4)) {

586 
size_t
 
bufãr_Ën
 = 0;

587 cÚ¡ *
bufãr
 = 
	`luaL_checkl¡ršg
(
L
,4,&
bufãr_Ën
);

588 
¦iû
.
bufãr
 = (*)buffer;

589 
¦iû
.
Ën
 = 
bufãr_Ën
;

591 ià(!
	`lua_isu£rd©a
(
L
,4)) {

592  
	`luaL_”rÜ
(
L
, "Need‡ userdata");

594 
¦iû
.
bufãr
 = 
	`lua_tou£rd©a
(
L
,4);

595 
¦iû
.
Ën
 = 
	`luaL_checkš‹g”
(
L
,5);

598 * 
‹mp
 = (*)
	`®loÿ
(
size
);

599 
»t
 = 
	`pbc_·‰”n_uÅack
(
·t
, &
¦iû
, 
‹mp
);

600 ià(
»t
 < 0) {

603 
	`lua_check¡ack
(
L
, 
fÜm©_sz
 + 3);

604 
size_t
 
i
;

605 * 
±r
 = 
‹mp
;

606 
boŞ
 
is_¬¿y
 = 
çl£
;

607 
i
=0;i<
fÜm©_sz
;i++) {

608 
ty³
 = 
fÜm©
[
i
];

609 ià(
ty³
 >= 'a' &&ype <='z') {

610 
±r
 = (*)
	`_push_v®ue
(
L
,±r,
ty³
);

612 
is_¬¿y
 = 
Œue
;

613 
n
 = 
	`pbc_¬¿y_size
((
_pbc_¬¿y
 *)
±r
);

614 
	`lua_ü—‹bË
(
L
,
n
,0);

615 
j
;

616 
j
=0;j<
n
;j++) {

617 
	`_push_¬¿y
(
L
,(
_pbc_¬¿y
 *)
±r
, 
ty³
, 
j
);

619 
±r
 +ğ(
pbc_¬¿y
);

622 ià(
is_¬¿y
) {

623 
	`pbc_·‰”n_şo£_¬¿ys
(
·t
, 
‹mp
);

625  
fÜm©_sz
;

626 
	}
}

629 
	$_g‘_v®ue
(
lua_S‹
 *
L
, 
šdex
, * 
±r
, 
ty³
) {

630 
ty³
) {

632 
št32_t
 
v
 = 
	`luaL_checkš‹g”
(
L
, 
šdex
);

633 
	`memıy
(
±r
, &
v
, 4);

634  
±r
 + 4;

637 
ušt64_t
 
v
 = (ušt64_t)
	`luaL_checknumb”
(
L
, 
šdex
);

638 
	`memıy
(
±r
, &
v
, 8);

639  
±r
 + 8;

642 
št64_t
 
v
 = (št64_t)
	`luaL_checknumb”
(
L
, 
šdex
);

643 
	`memıy
(
±r
, &
v
, 8);

644  
±r
 + 8;

647 
št32_t
 
v
 = 
	`lua_toboŞ—n
(
L
, 
šdex
);

648 
	`memıy
(
±r
, &
v
, 4);

649  
±r
 + 4;

652 *
p
 = 
	`lua_tou£rd©a
(
L
, 
šdex
);

653 
ušt32_t
 
v
 = (ušt32_t)(
šŒ_t
)
p
;

654 
	`memıy
(
±r
, &
v
 , 4);

655  
±r
 + 4;

658 cÚ¡ * 
i64
 = 
	`luaL_check¡ršg
(
L
, 
šdex
);

659 
	`memıy
(
±r
, 
i64
, 8);

660  
±r
 + 8;

663 
v
 = 
	`luaL_checknumb”
(
L
, 
šdex
);

664 
	`memıy
(
±r
, &
v
, 8);

665  
±r
 + 8;

668 
size_t
 
sz
 = 0;

669 cÚ¡ * 
¡r
 = 
	`luaL_checkl¡ršg
(
L
, 
šdex
, &
sz
);

670 
pbc_¦iû
 * 
¦iû
 = (pbc_¦iû *)
±r
;

671 
¦iû
->
bufãr
 = (*)
¡r
;

672 
¦iû
->
Ën
 = 
sz
;

673  
±r
 + (
pbc_¦iû
);

676 
pbc_¦iû
 * 
¦iû
 = (pbc_¦iû *)
±r
;

677 ià(
	`lua_i¡abË
(
L
,
šdex
)) {

678 
	`lua_¿wg‘i
(
L
,
šdex
,1);

679 
¦iû
->
bufãr
 = 
	`lua_tou£rd©a
(
L
,-1);

680 
	`lua_¿wg‘i
(
L
,
šdex
,2);

681 
¦iû
->
Ën
 = 
	`lua_toš‹g”
(
L
,-1);

682 
	`lua_pİ
(
L
,2);

684 
size_t
 
sz
 = 0;

685 cÚ¡ * 
bufãr
 = 
	`luaL_checkl¡ršg
(
L
, 
šdex
, &
sz
);

686 
¦iû
->
bufãr
 = (*)buffer;

687 
¦iû
->
Ën
 = 
sz
;

689  
±r
 + (
pbc_¦iû
);

692 
	`luaL_”rÜ
(
L
,"unknowÀfÜm© %c", 
ty³
);

693  
±r
;

695 
	}
}

698 
	$_g‘_¬¿y_v®ue
(
lua_S‹
 *
L
, 
pbc_¬¿y
 
¬¿y
, 
ty³
) {

699 
ty³
) {

701 
št32_t
 
v
 = 
	`luaL_checkš‹g”
(
L
, -1);

702 
ušt32_t
 
hi
 = 0;

703 ià(
v
<0) {

704 
hi
 = ~0;

706 
	`pbc_¬¿y_push_š‹g”
(
¬¿y
, 
v
, 
hi
);

710 
ušt64_t
 
v
 = (ušt64_t)
	`luaL_checknumb”
(
L
, -1);

711 
	`pbc_¬¿y_push_š‹g”
(
¬¿y
, (
ušt32_t
)
v
, (uint32_t)(v >> 32));

715 
št64_t
 
v
 = (št64_t)
	`luaL_checknumb”
(
L
, -1);

716 
	`pbc_¬¿y_push_š‹g”
(
¬¿y
, (
ušt32_t
)
v
, (uint32_t)(v >> 32));

720 
št32_t
 
v
 = 
	`lua_toboŞ—n
(
L
, -1);

721 
	`pbc_¬¿y_push_š‹g”
(
¬¿y
, 
v
 ? 1: 0, 0);

725 *
p
 = 
	`lua_tou£rd©a
(
L
, -1);

726 
ušt32_t
 
v
 = (ušt32_t)(
šŒ_t
)
p
;

727 
	`pbc_¬¿y_push_š‹g”
(
¬¿y
, 
v
, 0);

731 cÚ¡ * 
i64
 = 
	`luaL_check¡ršg
(
L
, -1);

732 
ušt64_t
 
v
 = *(ušt64_ˆ*)
i64
;

733 
	`pbc_¬¿y_push_š‹g”
(
¬¿y
, (
ušt32_t
)
v
, (uint32_t)(v >> 32));

737 
v
 = 
	`luaL_checknumb”
(
L
, -1);

738 
	`pbc_¬¿y_push_»®
(
¬¿y
, 
v
);

742 
size_t
 
sz
 = 0;

743 cÚ¡ * 
¡r
 = 
	`luaL_checkl¡ršg
(
L
, -1, &
sz
);

744 
pbc_¦iû
 
¦iû
;

745 
¦iû
.
bufãr
 = (*)
¡r
;

746 
¦iû
.
Ën
 = 
sz
;

747 
	`pbc_¬¿y_push_¦iû
(
¬¿y
, &
¦iû
);

751 
pbc_¦iû
 
¦iû
;

752 ià(
	`lua_i¡abË
(
L
,-1)) {

753 
	`lua_¿wg‘i
(
L
,-1,1);

754 
¦iû
.
bufãr
 = 
	`lua_tou£rd©a
(
L
,-1);

755 
	`lua_¿wg‘i
(
L
,-2,2);

756 
¦iû
.
Ën
 = 
	`lua_toš‹g”
(
L
,-1);

757 
	`lua_pİ
(
L
,2);

759 
size_t
 
sz
 = 0;

760 cÚ¡ * 
bufãr
 = 
	`luaL_checkl¡ršg
(
L
, -1, &
sz
);

761 
¦iû
.
bufãr
 = (*)buffer;

762 
¦iû
.
Ën
 = 
sz
;

764 
	`pbc_¬¿y_push_¦iû
(
¬¿y
, &
¦iû
);

768 
	}
}

776 
	$_·‰”n_·ck
(
lua_S‹
 *
L
) {

777 
pbc_·‰”n
 * 
·t
 = (pbc_·‰”À*)
	`checku£rd©a
(
L
,1);

778 ià(
·t
 =ğ
NULL
) {

779  
	`luaL_”rÜ
(
L
, "pack…attern is NULL");

781 
size_t
 
fÜm©_sz
 = 0;

782 cÚ¡ * 
fÜm©
 = 
	`lua_tŞ¡ršg
(
L
,2,&
fÜm©_sz
);

783 
size
 = 
	`lua_toš‹g”
(
L
,3);

785 * 
d©a
 = (*)
	`®loÿ
(
size
);

788 
	`mem£t
(
d©a
, 0 , 
size
);

790 * 
±r
 = 
d©a
;

792 
size_t
 
i
;

794 
i
=0;i<
fÜm©_sz
;i++) {

795 ià(
fÜm©
[
i
] >= 'a' && format[i] <='z') {

796 
±r
 = 
	`_g‘_v®ue
(
L
, 4+
i
,…Œ, 
fÜm©
[i]);

798 ià(!
	`lua_i¡abË
(
L
,4+
i
)) {

799 
	`luaL_”rÜ
(
L
,"needable for‡rrayype");

801 
j
;

802 
n
 = 
	`lua_¿wËn
(
L
,4+
i
);

803 
j
=0;j<
n
;j++) {

804 
	`lua_¿wg‘i
(
L
,4+
i
,
j
+1);

805 
	`_g‘_¬¿y_v®ue
(
L
,(
_pbc_¬¿y
 *)
±r
,
fÜm©
[
i
]);

806 
	`lua_pİ
(
L
,1);

808 
±r
 +ğ(
pbc_¬¿y
);

812 
luaL_Bufãr
 
b
;

813 
	`UNUSED
(&
b
);

814 
	`luaL_buffš™
(
L
, &
b
);

816 
ÿp
 = 128;

818 * 
‹mp
 = (*)
	`luaL_´•buffsize
(&
b
 , 
ÿp
);

820 
pbc_¦iû
 
¦iû
;

821 
¦iû
.
bufãr
 = 
‹mp
;

822 
¦iû
.
Ën
 = 
ÿp
;

824 
»t
 = 
	`pbc_·‰”n_·ck
(
·t
, 
d©a
, &
¦iû
);

826 ià(
»t
 < 0) {

827 
ÿp
 = cap * 2;

828 
	`_F»e
(
‹mp
);

832 
	`luaL_addsize
(&
b
 , 
¦iû
.
Ën
);

835 
	`luaL_push»suÉ
(&
b
);

837 
	`pbc_·‰”n_şo£_¬¿ys
(
·t
, 
d©a
);

839 
	}
}

842 
	$_·‰”n_size
(
lua_S‹
 *
L
) {

843 
size_t
 
sz
 =0;

844 cÚ¡ *
fÜm©
 = 
	`luaL_checkl¡ršg
(
L
,1,&
sz
);

845 
size_t
 
i
;

846 
size
 = 0;

847 
i
=0;i<
sz
;i++) {

848 
fÜm©
[
i
]) {

852 
size
 += 4;

858 
size
 += 8;

862 
size
 +ğ(
pbc_¦iû
);

865 
size
 +ğ(
pbc_¬¿y
);

869 
	`lua_pushš‹g”
(
L
,
size
);

871 
	}
}

879 
	$Ãw_¬¿y
(
lua_S‹
 *
L
, 
id
, cÚ¡ *
key
) {

880 
	`lua_¿wg‘i
(
L
, -2 , 
id
);

881 ià(
	`lua_i¢
(
L
, -1)) {

882 
	`lua_pİ
(
L
,1);

883 
	`lua_ÃwbË
(
L
);

884 
	`lua_pushv®ue
(
L
,-1);

885 
	`lua_pushv®ue
(
L
,-1);

886 
	`lua_£tf›ld
(
L
, -6 , 
key
);

887 
	`lua_¿w£ti
(
L
, -4, 
id
);

889 
	}
}

892 
	$push_v®ue
(
lua_S‹
 *
L
, 
ty³
, cÚ¡ * 
ty³_Çme
, 
pbc_v®ue
 *
v
) {

893 
ty³
) {

894 
PBC_INT
:

895 
	`lua_pushš‹g”
(
L
, ()
v
->
i
.
low
);

897 
PBC_REAL
:

898 
	`lua_pushnumb”
(
L
, 
v
->
f
);

900 
PBC_BOOL
:

901 
	`lua_pushboŞ—n
(
L
, 
v
->
i
.
low
);

903 
PBC_ENUM
:

904 
	`lua_push¡ršg
(
L
, 
v
->
e
.
Çme
);

906 
PBC_BYTES
:

907 
PBC_STRING
:

908 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
v
->
s
.
bufãr
 , v->s.
Ën
);

910 
PBC_MESSAGE
:

911 
	`lua_pushv®ue
(
L
, -3);

912 
	`lua_push¡ršg
(
L
, 
ty³_Çme
);

913 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
v
->
s
.
bufãr
 , v->s.
Ën
);

914 
	`lua_ÿÎ
(
L
, 2 , 1);

916 
PBC_FIXED64
:

917 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)&(
v
->
i
), 8);

919 
PBC_FIXED32
:

920 
	`lua_pushlightu£rd©a
(
L
,(*)(
šŒ_t
)
v
->
i
.
low
);

922 
PBC_INT64
: {

923 
ušt64_t
 
v64
 = (ušt64_t)(
v
->
i
.
hi
è<< 32 | (ušt64_t)(v->i.
low
);

924 
	`lua_pushnumb”
(
L
,(
lua_Numb”
)(
št64_t
)
v64
);

927 
PBC_UINT
: {

928 
ušt64_t
 
v64
 = (ušt64_t)(
v
->
i
.
hi
è<< 32 | (ušt64_t)(v->i.
low
);

929 
	`lua_pushnumb”
(
L
,(
lua_Numb”
)
v64
);

933 
	`luaL_”rÜ
(
L
, "UnknowÀty³ %s", 
ty³_Çme
);

936 
	}
}

944 
	$decode_cb
(*
ud
, 
ty³
, cÚ¡ * 
ty³_Çme
, 
pbc_v®ue
 *
v
, 
id
, cÚ¡ *
key
) {

945 
lua_S‹
 *
L
 = (lua_S‹ *)
ud
;

946 ià(
key
 =ğ
NULL
) {

950 ià(
ty³
 & 
PBC_REPEATED
) {

951 
	`push_v®ue
(
L
, 
ty³
 & ~
PBC_REPEATED
, 
ty³_Çme
, 
v
);

952 
	`Ãw_¬¿y
(
L
, 
id
 , 
key
);

953 
n
 = 
	`lua_¿wËn
(
L
,-1);

954 
	`lua_š£¹
(
L
, -2);

955 
	`lua_¿w£ti
(
L
, -2 , 
n
+1);

956 
	`lua_pİ
(
L
,1);

958 
	`push_v®ue
(
L
, 
ty³
, 
ty³_Çme
, 
v
);

959 
	`lua_£tf›ld
(
L
, -3 , 
key
);

961 
	}
}

975 
	$_decode
(
lua_S‹
 *
L
) {

976 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
,1);

977 
	`luaL_checkty³
(
L
, 2 , 
LUA_TFUNCTION
);

978 
	`luaL_checkty³
(
L
, 3 , 
LUA_TTABLE
);

979 cÚ¡ * 
ty³
 = 
	`luaL_check¡ršg
(
L
,4);

980 
pbc_¦iû
 
¦iû
;

981 ià(
	`lua_ty³
(
L
,5è=ğ
LUA_TSTRING
) {

982 
size_t
 
Ën
;

983 
¦iû
.
bufãr
 = (*)
	`luaL_checkl¡ršg
(
L
,5,&
Ën
);

984 
¦iû
.
Ën
 = ()len;

986 
¦iû
.
bufãr
 = 
	`checku£rd©a
(
L
,5);

987 
¦iû
.
Ën
 = 
	`luaL_checkš‹g”
(
L
,6);

989 
	`lua_pushv®ue
(
L
, 2);

990 
	`lua_pushv®ue
(
L
, 3);

991 
	`lua_ÃwbË
(
L
);

993 
n
 = 
	`pbc_decode
(
’v
, 
ty³
, &
¦iû
, 
decode_cb
, 
L
);

994 ià(
n
<0) {

995 
	`lua_pushboŞ—n
(
L
,0);

997 
	`lua_pushboŞ—n
(
L
,1);

1000 
	}
}

1002 
	sgcobj
 {

1003 
pbc_’v
 * 
	m’v
;

1004 
	msize_·t
;

1005 
	mÿp_·t
;

1006 
pbc_·‰”n
 ** 
	m·t
;

1007 
	msize_msg
;

1008 
	mÿp_msg
;

1009 
pbc_rmes§ge
 ** 
	mmsg
;

1013 
	$_ş—r_gcobj
(
lua_S‹
 *
L
) {

1014 
gcobj
 * 
obj
 = (gcobj *)
	`lua_tou£rd©a
(
L
,1);

1015 
i
;

1016 
i
=0;i<
obj
->
size_·t
;i++) {

1017 
	`pbc_·‰”n_d–‘e
(
obj
->
·t
[
i
]);

1019 
i
=0;i<
obj
->
size_msg
;i++) {

1020 
	`pbc_rmes§ge_d–‘e
(
obj
->
msg
[
i
]);

1022 
	`ä“
(
obj
->
·t
);

1023 
	`ä“
(
obj
->
msg
);

1024 
obj
->
·t
 = 
NULL
;

1025 
obj
->
msg
 = 
NULL
;

1026 
	`pbc_d–‘e
(
obj
->
’v
);

1027 
obj
->
’v
 = 
NULL
;

1030 
	}
}

1033 
	$_gc
(
lua_S‹
 *
L
) {

1034 
gcobj
 * 
obj
 = (gcobj *)
	`lua_Ãwu£rd©a
(
L
,(*obj));

1035 
obj
->
’v
 = (
pbc_’v
 *)
	`lua_tou£rd©a
(
L
,1);

1036 
obj
->
size_·t
 = 0;

1037 
obj
->
ÿp_·t
 = 4;

1038 
obj
->
size_msg
 = 0;

1039 
obj
->
ÿp_msg
 = 4;

1040 
obj
->
·t
 = (
pbc_·‰”n
 **)
	`m®loc
(obj->
ÿp_·t
 * (pbc_pattern *));

1041 
obj
->
msg
 = (
pbc_rmes§ge
 **)
	`m®loc
(obj->
ÿp_msg
 * (pbc_rmessage *));

1043 
	`lua_ü—‹bË
(
L
,0,1);

1044 
	`lua_pushcfunùiÚ
(
L
, 
_ş—r_gcobj
);

1045 
	`lua_£tf›ld
(
L
,-2,"__gc");

1046 
	`lua_£tm‘©abË
(
L
,-2);

1049 
	}
}

1052 
	$_add_·‰”n
(
lua_S‹
 *
L
) {

1053 
gcobj
 * 
obj
 = (gcobj *)
	`lua_tou£rd©a
(
L
,1);

1054 ià(
obj
->
size_·t
 >ğobj->
ÿp_·t
) {

1055 
obj
->
ÿp_·t
 *= 2;

1056 
obj
->
·t
 = (
pbc_·‰”n
 **)
	`»®loc
(obj->·t, obj->
ÿp_·t
 * (pbc_pattern *));

1058 
pbc_·‰”n
 * 
·t
 = (pbc_·‰”À*)
	`lua_tou£rd©a
(
L
,2);

1059 
obj
->
·t
[obj->
size_·t
++] =…at;

1061 
	}
}

1064 
	$_add_rmes§ge
(
lua_S‹
 *
L
) {

1065 
gcobj
 * 
obj
 = (gcobj *)
	`lua_tou£rd©a
(
L
,1);

1066 ià(
obj
->
size_msg
 >ğobj->
ÿp_msg
) {

1067 
obj
->
ÿp_msg
 *= 2;

1068 
obj
->
msg
 = (
pbc_rmes§ge
 **)
	`»®loc
(obj->msg, obj->
ÿp_msg
 * (pbc_rmessage *));

1070 
pbc_rmes§ge
 * 
msg
 = (pbc_rmes§g*)
	`lua_tou£rd©a
(
L
,2);

1071 
obj
->
msg
[obj->
size_msg
++] = msg;

1073 
	}
}

1075 #ifdeà
__ılu¥lus


1080 
luaİ’_´Ùobuf_c
(
lua_S‹
 *
L
) {

1081 
luaL_Reg
 
»g
[] = {

1082 {"_’v_Ãw" , 
_’v_Ãw
 },

1083 {"_’v_»gi¡”" , 
_’v_»gi¡”
 },

1084 {"_’v_ty³", 
_’v_ty³
 },

1085 {"_rmes§ge_Ãw" , 
_rmes§ge_Ãw
 },

1086 {"_rmes§ge_d–‘e" , 
_rmes§ge_d–‘e
 },

1087 {"_rmes§ge_š‹g”" , 
_rmes§ge_š‹g”
 },

1088 {"_rmes§ge_št32", 
_rmes§ge_št32
 },

1089 {"_rmes§ge_št64", 
_rmes§ge_št64
 },

1090 {"_rmes§ge_št52", 
_rmes§ge_št52
 },

1091 {"_rmes§ge_ušt52", 
_rmes§ge_ušt52
 },

1092 {"_rmes§ge_»®" , 
_rmes§ge_»®
 },

1093 {"_rmes§ge_¡ršg" , 
_rmes§ge_¡ršg
 },

1094 {"_rmes§ge_mes§ge" , 
_rmes§ge_mes§ge
 },

1095 {"_rmes§ge_size" , 
_rmes§ge_size
 },

1096 {"_wmes§ge_Ãw", 
_wmes§ge_Ãw
 },

1097 {"_wmes§ge_d–‘e", 
_wmes§ge_d–‘e
 },

1098 {"_wmes§ge_š‹g”", 
_wmes§ge_š‹g”
 },

1099 {"_wmes§ge_»®", 
_wmes§ge_»®
 },

1100 {"_wmes§ge_¡ršg", 
_wmes§ge_¡ršg
 },

1101 {"_wmes§ge_mes§ge", 
_wmes§ge_mes§ge
 },

1102 {"_wmes§ge_št32", 
_wmes§ge_št32
 },

1103 {"_wmes§ge_št64", 
_wmes§ge_št64
 },

1104 {"_wmes§ge_št52", 
_wmes§ge_št52
 },

1105 {"_wmes§ge_ušt52", 
_wmes§ge_ušt52
 },

1106 {"_wmes§ge_bufãr", 
_wmes§ge_bufãr
 },

1107 {"_wmes§ge_bufãr_¡ršg", 
_wmes§ge_bufãr_¡ršg
 },

1108 {"_·‰”n_Ãw", 
_·‰”n_Ãw
 },

1109 {"_·‰”n_d–‘e", 
_·‰”n_d–‘e
 },

1110 {"_·‰”n_size", 
_·‰”n_size
 },

1111 {"_·‰”n_uÅack", 
_·‰”n_uÅack
 },

1112 {"_·‰”n_·ck", 
_·‰”n_·ck
 },

1113 {"_Ï¡_”rÜ", 
_Ï¡_”rÜ
 },

1114 {"_decode", 
_decode
 },

1115 {"_gc", 
_gc
 },

1116 {"_add_·‰”n", 
_add_·‰”n
 },

1117 {"_add_rmes§ge", 
_add_rmes§ge
 },

1118 {"_’v_’um_id", 
_’v_’um_id
},

1119 {
NULL
,NULL},

1122 
luaL_checkv”siÚ
(
L
);

1123 
luaL_Ãwlib
(
L
, 
»g
);

1128 #ifdeà
__ılu¥lus


	@binding/lua/protobuf.lua

1 
loÿl
 
	gc
 = 
»quœe
 "protobuf.c"

3 
loÿl
 
£tm‘©abË
 = setmetatable

4 
loÿl
 
ty³
 =ype

5 
loÿl
 
bË
 =able

6 
loÿl
 
as£¹
 =‡ssert

7 
loÿl
 
·œs
 =…airs

8 
loÿl
 
aœs
 = ipairs

9 
loÿl
 
¡ršg
 = string

10 
loÿl
 
´št
 =…rint

11 
loÿl
 
io
 = io

12 
loÿl
 
tš£¹
 = 
bË
.
š£¹


13 
loÿl
 
¿wg‘
 =„awget

15 
moduË
 "protobuf"

17 
loÿl
 
_·‰”n_ÿche
 = {}

19 -- 
skyÃt
 
ş—r


20 
loÿl
 
P
 = 
c
.
	$_’v_Ãw
()

21 
loÿl
 
GC
 = 
c
.
	$_gc
(
P
)

23 
funùiÚ
 
	$Ï¡”rÜ
()

24  
c
.
	$_Ï¡_”rÜ
(
P
)

25 
’d


27 
loÿl
 
decode_ty³_ÿche
 = {
	}
}

28 
loÿl
 
_R_m‘a
 = {}

30 
funùiÚ
 
_R_m‘a
:
	$__šdex
(
key
)

31 
loÿl
 
v
 = 
decode_ty³_ÿche
[
£lf
.
_CTy³
][
key
](self, key)

32 
£lf
[
key
] = 
v


33  
v


34 
’d


36 
loÿl
 
_»ad”
 = {
	}
}

38 
funùiÚ
 
_»ad”
:(
key
)

39  
c
.
	$_rmes§ge_š‹g”
(
£lf
.
_CObj
 , 
key
 , 0)

40 
’d


42 
funùiÚ
 
_»ad”
:
	$»®
(
key
)

43  
c
.
	$_rmes§ge_»®
(
£lf
.
_CObj
 , 
key
 , 0)

44 
’d


46 
funùiÚ
 
_»ad”
:
	$¡ršg
(
key
)

47  
c
.
	$_rmes§ge_¡ršg
(
£lf
.
_CObj
 , 
key
 , 0)

48 
’d


50 
funùiÚ
 
_»ad”
:
	$boŞ
(
key
)

51  
c
.
	`_rmes§ge_š‹g”
(
£lf
.
_CObj
 , 
key
 , 0) ~= 0

52 
’d


54 
funùiÚ
 
_»ad”
:
	$mes§ge
(
key
, 
mes§ge_ty³
)

55 
loÿl
 
rmes§ge
 = 
c
.
	$_rmes§ge_mes§ge
(
£lf
.
_CObj
 , 
key
 , 0)

56 
rmes§ge
 
th’


57 
loÿl
 
v
 = {

58 
_CObj
 = 
rmes§ge
,

59 
_CTy³
 = 
mes§ge_ty³
,

60 
_P¬’t
 = 
£lf
,

61 
	}
}

62  
	$£tm‘©abË
Ğ
v
 , 
_R_m‘a
 )

63 
’d


64 
’d


66 
funùiÚ
 
_»ad”
:
	$št32
(
key
)

67  
c
.
	$_rmes§ge_št32
(
£lf
.
_CObj
 , 
key
 , 0)

68 
’d


70 
funùiÚ
 
_»ad”
:
	$št64
(
key
)

71  
c
.
	$_rmes§ge_št64
(
£lf
.
_CObj
 , 
key
 , 0)

72 
’d


74 
funùiÚ
 
_»ad”
:
	$št52
(
key
)

75  
c
.
	$_rmes§ge_št52
(
£lf
.
_CObj
 , 
key
 , 0)

76 
’d


78 
funùiÚ
 
_»ad”
:
	$ušt52
(
key
)

79  
c
.
	$_rmes§ge_ušt52
(
£lf
.
_CObj
 , 
key
 , 0)

80 
’d


82 
funùiÚ
 
_»ad”
:
	$št_»³©ed
(
key
)

83 
loÿl
 
cobj
 = 
£lf
.
_CObj


84 
loÿl
 
n
 = 
c
.
	$_rmes§ge_size
(
cobj
 , 
key
)

85 
loÿl
 
»t
 = {
	}
}

86 
i
=0,
	gn
-1 do

87 
tš£¹
(
»t
, 
c
.
	$_rmes§ge_š‹g”
(
cobj
 , 
key
 , 
i
))

88 
’d


89  
»t


90 
’d


92 
funùiÚ
 
_»ad”
:
	$»®_»³©ed
(
key
)

93 
loÿl
 
cobj
 = 
£lf
.
_CObj


94 
loÿl
 
n
 = 
c
.
	$_rmes§ge_size
(
cobj
 , 
key
)

95 
loÿl
 
»t
 = {
	}
}

96 
i
=0,
	gn
-1 do

97 
tš£¹
(
»t
, 
c
.
	$_rmes§ge_»®
(
cobj
 , 
key
 , 
i
))

98 
’d


99  
»t


100 
’d


102 
funùiÚ
 
_»ad”
:
	$¡ršg_»³©ed
(
key
)

103 
loÿl
 
cobj
 = 
£lf
.
_CObj


104 
loÿl
 
n
 = 
c
.
	$_rmes§ge_size
(
cobj
 , 
key
)

105 
loÿl
 
»t
 = {
	}
}

106 
i
=0,
	gn
-1 do

107 
tš£¹
(
»t
, 
c
.
	$_rmes§ge_¡ršg
(
cobj
 , 
key
 , 
i
))

108 
’d


109  
»t


110 
’d


112 
funùiÚ
 
_»ad”
:
	$boŞ_»³©ed
(
key
)

113 
loÿl
 
cobj
 = 
£lf
.
_CObj


114 
loÿl
 
n
 = 
c
.
	$_rmes§ge_size
(
cobj
 , 
key
)

115 
loÿl
 
»t
 = {
	}
}

116 
i
=0,
	gn
-1 do

117 
tš£¹
(
»t
, 
c
.
_rmes§ge_š‹g”
(
cobj
 , 
key
 , 
i
) ~= 0)

118 
’d


119  
»t


120 
’d


122 
funùiÚ
 
_»ad”
:
	$mes§ge_»³©ed
(
key
, 
mes§ge_ty³
)

123 
loÿl
 
cobj
 = 
£lf
.
_CObj


124 
loÿl
 
n
 = 
c
.
	$_rmes§ge_size
(
cobj
 , 
key
)

125 
loÿl
 
»t
 = {
	}
}

126 
i
=0,
	gn
-1 do

127 
loÿl
 
	gm
 = {

128 
_CObj
 = 
c
.
_rmes§ge_mes§ge
(
cobj
 , 
key
 , 
i
),

129 
	g_CTy³
 = 
mes§ge_ty³
,

130 
	g_P¬’t
 = 
£lf
,

132 
tš£¹
(
»t
, 
	$£tm‘©abË
Ğ
m
 , 
_R_m‘a
 ))

133 
’d


134  
»t


135 
’d


137 
funùiÚ
 
_»ad”
:
	$št32_»³©ed
(
key
)

138 
loÿl
 
cobj
 = 
£lf
.
_CObj


139 
loÿl
 
n
 = 
c
.
	$_rmes§ge_size
(
cobj
 , 
key
)

140 
loÿl
 
»t
 = {
	}
}

141 
i
=0,
	gn
-1 do

142 
tš£¹
(
»t
, 
c
.
	$_rmes§ge_št32
(
cobj
 , 
key
 , 
i
))

143 
’d


144  
»t


145 
’d


147 
funùiÚ
 
_»ad”
:
	$št64_»³©ed
(
key
)

148 
loÿl
 
cobj
 = 
£lf
.
_CObj


149 
loÿl
 
n
 = 
c
.
	$_rmes§ge_size
(
cobj
 , 
key
)

150 
loÿl
 
»t
 = {
	}
}

151 
i
=0,
	gn
-1 do

152 
tš£¹
(
»t
, 
c
.
	$_rmes§ge_št64
(
cobj
 , 
key
 , 
i
))

153 
’d


154  
»t


155 
’d


157 
funùiÚ
 
_»ad”
:
	$št52_»³©ed
(
key
)

158 
loÿl
 
cobj
 = 
£lf
.
_CObj


159 
loÿl
 
n
 = 
c
.
	$_rmes§ge_size
(
cobj
 , 
key
)

160 
loÿl
 
»t
 = {
	}
}

161 
i
=0,
	gn
-1 do

162 
tš£¹
(
»t
, 
c
.
	$_rmes§ge_št52
(
cobj
 , 
key
 , 
i
))

163 
’d


164  
»t


165 
’d


167 
funùiÚ
 
_»ad”
:
	$ušt52_»³©ed
(
key
)

168 
loÿl
 
cobj
 = 
£lf
.
_CObj


169 
loÿl
 
n
 = 
c
.
	$_rmes§ge_size
(
cobj
 , 
key
)

170 
loÿl
 
»t
 = {
	}
}

171 
i
=0,
	gn
-1 do

172 
tš£¹
(
»t
, 
c
.
	$_rmes§ge_ušt52
(
cobj
 , 
key
 , 
i
))

173 
’d


174  
»t


175 
’d


177 
_»ad”
[1] = 
	$funùiÚ
(
msg
è 
_»ad”
.
’d


178 
_»ad”
[2] = 
	$funùiÚ
(
msg
è 
_»ad”
.
»®
 
’d


179 
_»ad”
[3] = 
	$funùiÚ
(
msg
è 
_»ad”
.
boŞ
 
’d


180 
_»ad”
[4] = 
	$funùiÚ
(
msg
è 
_»ad”
.
¡ršg
 
’d


181 
_»ad”
[5] = 
	$funùiÚ
(
msg
è 
_»ad”
.
¡ršg
 
’d


182 
_»ad”
[6] = 
	$funùiÚ
(
msg
)

183 
loÿl
 
mes§ge
 = 
_»ad”
.message

184  
	$funùiÚ
(
£lf
,
key
)

185  
	$mes§ge
(
£lf
, 
key
, 
msg
)

186 
’d


187 
’d


188 
_»ad”
[7] = 
	$funùiÚ
(
msg
è 
_»ad”
.
št64
 
’d


189 
_»ad”
[8] = 
	$funùiÚ
(
msg
è 
_»ad”
.
št32
 
’d


190 
_»ad”
[9] = _reader[5]

191 
_»ad”
[10] = 
	$funùiÚ
(
msg
è 
_»ad”
.
št52
 
’d


192 
_»ad”
[11] = 
	$funùiÚ
(
msg
è 
_»ad”
.
ušt52
 
’d


194 
_»ad”
[128+1] = 
	$funùiÚ
(
msg
è 
_»ad”
.
št_»³©ed
 
’d


195 
_»ad”
[128+2] = 
	$funùiÚ
(
msg
è 
_»ad”
.
»®_»³©ed
 
’d


196 
_»ad”
[128+3] = 
	$funùiÚ
(
msg
è 
_»ad”
.
boŞ_»³©ed
 
’d


197 
_»ad”
[128+4] = 
	$funùiÚ
(
msg
è 
_»ad”
.
¡ršg_»³©ed
 
’d


198 
_»ad”
[128+5] = 
	$funùiÚ
(
msg
è 
_»ad”
.
¡ršg_»³©ed
 
’d


199 
_»ad”
[128+6] = 
	$funùiÚ
(
msg
)

200 
loÿl
 
mes§ge
 = 
_»ad”
.
mes§ge_»³©ed


201  
	$funùiÚ
(
£lf
,
key
)

202  
	$mes§ge
(
£lf
, 
key
, 
msg
)

203 
’d


204 
’d


205 
_»ad”
[128+7] = 
	$funùiÚ
(
msg
è 
_»ad”
.
št64_»³©ed
 
’d


206 
_»ad”
[128+8] = 
	$funùiÚ
(
msg
è 
_»ad”
.
št32_»³©ed
 
’d


207 
_»ad”
[128+9] = _reader[128+5]

208 
_»ad”
[128+10] = 
	$funùiÚ
(
msg
è 
_»ad”
.
št52_»³©ed
 
’d


209 
_»ad”
[128+11] = 
	$funùiÚ
(
msg
è 
_»ad”
.
ušt52_»³©ed
 
’d


211 
loÿl
 
_decode_ty³_m‘a
 = {
	}
}

213 
funùiÚ
 
_decode_ty³_m‘a
:
	$__šdex
(
key
)

214 
loÿl
 
t
, 
msg
 = 
c
.
	$_’v_ty³
(
P
, 
£lf
.
_CTy³
, 
key
)

215 
loÿl
 
func
 = 
	$as£¹
(
_»ad”
[
t
],
key
)(
msg
)

216 
£lf
[
key
] = 
func


217  
func


218 
’d


220 
	`£tm‘©abË
(
decode_ty³_ÿche
 , {

221 
__šdex
 = 
	`funùiÚ
(
£lf
, 
key
)

222 
loÿl
 
v
 = 
	`£tm‘©abË
({ 
_CTy³
 = 
key
 } , 
_decode_ty³_m‘a
)

223 
£lf
[
key
] = 
v


224  
v


225 
’d


226 
	}
})

228 
loÿl
 
funùiÚ
 
	$decode_mes§ge
Ğ
mes§ge
 , 
bufãr
, 
Ëngth
)

229 
loÿl
 
rmes§ge
 = 
c
.
	$_rmes§ge_Ãw
(
P
, 
mes§ge
, 
bufãr
, 
Ëngth
)

230 
rmes§ge
 
th’


231 
loÿl
 
£lf
 = {

232 
_CObj
 = 
rmes§ge
,

233 
_CTy³
 = 
mes§ge
,

234 
	}
}

235 
	gc
.
	$_add_rmes§ge
(
GC
,
rmes§ge
)

236  
	$£tm‘©abË
Ğ
£lf
 , 
_R_m‘a
 )

237 
’d


238 
’d


240 ----------- 
’code
 ----------------

242 
loÿl
 
’code_ty³_ÿche
 = {
	}
}

244 
loÿl
 
funùiÚ
 
	$’code_mes§ge
(
CObj
, 
mes§ge_ty³
, 
t
)

245 
loÿl
 
ty³
 = 
’code_ty³_ÿche
[
mes§ge_ty³
]

246 
k
,
v
 
š
 
	$·œs
(
t
) do

247 
loÿl
 
func
 = 
ty³
[
k
]

248 
	$func
(
CObj
, 
k
 , 
v
)

249 
’d


250 
’d


252 
loÿl
 
_wr™”
 = {

253 ğ
c
.
_wmes§ge_š‹g”
,

254 
»®
 = 
c
.
_wmes§ge_»®
,

255 ğ
c
.
_wmes§ge_¡ršg
,

256 
¡ršg
 = 
c
.
_wmes§ge_¡ršg
,

257 
št64
 = 
c
.
_wmes§ge_št64
,

258 
št32
 = 
c
.
_wmes§ge_št32
,

259 
št52
 = 
c
.
_wmes§ge_št52
,

260 
ušt52
 = 
c
.
_wmes§ge_ušt52
,

261 
	}
}

263 
funùiÚ
 
	g_wr™”
:
	$boŞ
(
k
,
v
)

264 
c
.
	$_wmes§ge_š‹g”
(
£lf
, 
k
, 
v
 
ªd
 1 
Ü
 0)

265 
’d


267 
funùiÚ
 
_wr™”
:
	$mes§ge
(
k
, 
v
 , 
mes§ge_ty³
)

268 
loÿl
 
submes§ge
 = 
c
.
	$_wmes§ge_mes§ge
(
£lf
, 
k
)

269 
	$’code_mes§ge
(
submes§ge
, 
mes§ge_ty³
, 
v
)

270 
’d


272 
funùiÚ
 
_wr™”
:
	$št_»³©ed
(
k
,
v
)

273 
_
,
v
 
š
 
	$aœs
(
v
) do

274 
c
.
	$_wmes§ge_š‹g”
(
£lf
,
k
,
v
)

275 
’d


276 
’d


278 
funùiÚ
 
_wr™”
:
	$»®_»³©ed
(
k
,
v
)

279 
_
,
v
 
š
 
	$aœs
(
v
) do

280 
c
.
	$_wmes§ge_»®
(
£lf
,
k
,
v
)

281 
’d


282 
’d


284 
funùiÚ
 
_wr™”
:
	$boŞ_»³©ed
(
k
,
v
)

285 
_
,
v
 
š
 
	$aœs
(
v
) do

286 
c
.
	$_wmes§ge_š‹g”
(
£lf
, 
k
, 
v
 
ªd
 1 
Ü
 0)

287 
’d


288 
’d


290 
funùiÚ
 
_wr™”
:
	$¡ršg_»³©ed
(
k
,
v
)

291 
_
,
v
 
š
 
	$aœs
(
v
) do

292 
c
.
	$_wmes§ge_¡ršg
(
£lf
,
k
,
v
)

293 
’d


294 
’d


296 
funùiÚ
 
_wr™”
:
	$mes§ge_»³©ed
(
k
,
v
, 
mes§ge_ty³
)

297 
_
,
v
 
š
 
	$aœs
(
v
) do

298 
loÿl
 
submes§ge
 = 
c
.
	$_wmes§ge_mes§ge
(
£lf
, 
k
)

299 
	$’code_mes§ge
(
submes§ge
, 
mes§ge_ty³
, 
v
)

300 
’d


301 
’d


303 
funùiÚ
 
_wr™”
:
	$št32_»³©ed
(
k
,
v
)

304 
_
,
v
 
š
 
	$aœs
(
v
) do

305 
c
.
	$_wmes§ge_št32
(
£lf
,
k
,
v
)

306 
’d


307 
’d


309 
funùiÚ
 
_wr™”
:
	$št64_»³©ed
(
k
,
v
)

310 
_
,
v
 
š
 
	$aœs
(
v
) do

311 
c
.
	$_wmes§ge_št64
(
£lf
,
k
,
v
)

312 
’d


313 
’d


315 
funùiÚ
 
_wr™”
:
	$št52_»³©ed
(
k
,
v
)

316 
_
,
v
 
š
 
	$aœs
(
v
) do

317 
c
.
	$_wmes§ge_št52
(
£lf
,
k
,
v
)

318 
’d


319 
’d


321 
funùiÚ
 
_wr™”
:
	$ušt52_»³©ed
(
k
,
v
)

322 
_
,
v
 
š
 
	$aœs
(
v
) do

323 
c
.
	$_wmes§ge_ušt52
(
£lf
,
k
,
v
)

324 
’d


325 
’d


327 
_wr™”
[1] = 
	$funùiÚ
(
msg
è 
_wr™”
.
’d


328 
_wr™”
[2] = 
	$funùiÚ
(
msg
è 
_wr™”
.
»®
 
’d


329 
_wr™”
[3] = 
	$funùiÚ
(
msg
è 
_wr™”
.
boŞ
 
’d


330 
_wr™”
[4] = 
	$funùiÚ
(
msg
è 
_wr™”
.
¡ršg
 
’d


331 
_wr™”
[5] = 
	$funùiÚ
(
msg
è 
_wr™”
.
¡ršg
 
’d


332 
_wr™”
[6] = 
	$funùiÚ
(
msg
)

333 
loÿl
 
mes§ge
 = 
_wr™”
.message

334  
	$funùiÚ
(
£lf
,
key
 , 
v
)

335  
	$mes§ge
(
£lf
, 
key
, 
v
, 
msg
)

336 
’d


337 
’d


338 
_wr™”
[7] = 
	$funùiÚ
(
msg
è 
_wr™”
.
št64
 
’d


339 
_wr™”
[8] = 
	$funùiÚ
(
msg
è 
_wr™”
.
št32
 
’d


340 
_wr™”
[9] = _writer[5]

341 
_wr™”
[10] = 
	$funùiÚ
(
msg
è 
_wr™”
.
št52
 
’d


342 
_wr™”
[11] = 
	$funùiÚ
(
msg
è 
_wr™”
.
ušt52
 
’d


344 
_wr™”
[128+1] = 
	$funùiÚ
(
msg
è 
_wr™”
.
št_»³©ed
 
’d


345 
_wr™”
[128+2] = 
	$funùiÚ
(
msg
è 
_wr™”
.
»®_»³©ed
 
’d


346 
_wr™”
[128+3] = 
	$funùiÚ
(
msg
è 
_wr™”
.
boŞ_»³©ed
 
’d


347 
_wr™”
[128+4] = 
	$funùiÚ
(
msg
è 
_wr™”
.
¡ršg_»³©ed
 
’d


348 
_wr™”
[128+5] = 
	$funùiÚ
(
msg
è 
_wr™”
.
¡ršg_»³©ed
 
’d


349 
_wr™”
[128+6] = 
	$funùiÚ
(
msg
)

350 
loÿl
 
mes§ge
 = 
_wr™”
.
mes§ge_»³©ed


351  
	$funùiÚ
(
£lf
,
key
, 
v
)

352  
	$mes§ge
(
£lf
, 
key
, 
v
, 
msg
)

353 
’d


354 
’d


355 
_wr™”
[128+7] = 
	$funùiÚ
(
msg
è 
_wr™”
.
št64_»³©ed
 
’d


356 
_wr™”
[128+8] = 
	$funùiÚ
(
msg
è 
_wr™”
.
št32_»³©ed
 
’d


357 
_wr™”
[128+9] = _writer[128+5]

358 
_wr™”
[128+10] = 
	$funùiÚ
(
msg
è 
_wr™”
.
št52_»³©ed
 
’d


359 
_wr™”
[128+11] = 
	$funùiÚ
(
msg
è 
_wr™”
.
ušt52_»³©ed
 
’d


361 
loÿl
 
_’code_ty³_m‘a
 = {
	}
}

363 
funùiÚ
 
_’code_ty³_m‘a
:
	$__šdex
(
key
)

364 
loÿl
 
t
, 
msg
 = 
c
.
	$_’v_ty³
(
P
, 
£lf
.
_CTy³
, 
key
)

365 
loÿl
 
func
 = 
	$as£¹
(
_wr™”
[
t
],
key
)(
msg
)

366 
£lf
[
key
] = 
func


367  
func


368 
’d


370 
	`£tm‘©abË
(
’code_ty³_ÿche
 , {

371 
__šdex
 = 
	`funùiÚ
(
£lf
, 
key
)

372 
loÿl
 
v
 = 
	`£tm‘©abË
({ 
_CTy³
 = 
key
 } , 
_’code_ty³_m‘a
)

373 
£lf
[
key
] = 
v


374  
v


375 
’d


376 
	}
})

378 
funùiÚ
 
	$’code
Ğ
mes§ge
, 
t
 , 
func
 , ...)

379 
loÿl
 
’cod”
 = 
c
.
	$_wmes§ge_Ãw
(
P
, 
mes§ge
)

380 
	$as£¹
(
’cod”
 , 
mes§ge
)

381 
	$’code_mes§ge
(
’cod”
, 
mes§ge
, 
t
)

382 
func
 
th’


383 
loÿl
 
bufãr
, 
Ën
 = 
c
.
	$_wmes§ge_bufãr
(
’cod”
)

384 
loÿl
 
»t
 = 
	$func
(
bufãr
, 
Ën
, ...)

385 
c
.
	$_wmes§ge_d–‘e
(
’cod”
)

386  
»t


388 
loÿl
 
s
 = 
c
.
	$_wmes§ge_bufãr_¡ršg
(
’cod”
)

389 
c
.
	$_wmes§ge_d–‘e
(
’cod”
)

390  
s


391 
’d


392 
’d


394 --------- 
uÅack
 ----------

396 
loÿl
 
_·‰”n_ty³
 = {

417 
	}
}

419 
	g_·‰”n_ty³
[9] = 
_·‰”n_ty³
[5]

420 
_·‰”n_ty³
[128+9] = _pattern_type[128+5]

423 
loÿl
 
funùiÚ
 
	$_·‰”n_ü—‹
(
·‰”n
)

424 
loÿl
 
™”
 = 
¡ršg
.
	`gm©ch
(
·‰”n
,"[^ ]+")

425 
loÿl
 
mes§ge
 = 
	$™”
()

426 
loÿl
 
ı©
 = {
	}
}

427 
loÿl
 
lua
 = {}

428 
v
 
š
 
™”
 do

429 
loÿl
 
tidx
 = 
c
.
	$_’v_ty³
(
P
, 
mes§ge
, 
v
)

430 
loÿl
 
t
 = 
_·‰”n_ty³
[
tidx
]

431 
	$as£¹
(
t
,
tidx
)

432 
	`tš£¹
(
ı©
,
v
 .. " " .. 
t
[1])

433 
	$tš£¹
(
lua
,
t
[2])

434 
’d


435 
loÿl
 
cobj
 = 
c
.
	`_·‰”n_Ãw
(
P
, 
mes§ge
 , "@" .. 
bË
.
	`cÚÿt
(
ı©
," "))

436 
cobj
 =ğ
n
 
th’


438 
’d


439 
c
.
	$_add_·‰”n
(
GC
, 
cobj
)

440 
loÿl
 
·t
 = {

441 
CObj
 = 
cobj
,

442 
fÜm©
 = 
bË
.
	`cÚÿt
(
lua
),

443 
size
 = 0

444 
	}
}

445 
	g·t
.
	gsize
 = 
c
.
	$_·‰”n_size
(
·t
.
fÜm©
)

447  
·t


448 
’d


450 
	`£tm‘©abË
(
_·‰”n_ÿche
, {

451 
__šdex
 = 
	`funùiÚ
(
t
, 
key
)

452 
loÿl
 
v
 = 
	`_·‰”n_ü—‹
(
key
)

453 
t
[
key
] = 
v


454  
v


455 
’d


456 
	}
})

458 
funùiÚ
 
	$uÅack
(
·‰”n
, 
bufãr
, 
Ëngth
)

459 
loÿl
 
·t
 = 
_·‰”n_ÿche
[
·‰”n
]

460  
c
.
	$_·‰”n_uÅack
(
·t
.
CObj
 ,…©.
fÜm©
,…©.
size
, 
bufãr
, 
Ëngth
)

461 
’d


463 
funùiÚ
 
	$·ck
(
·‰”n
, ...)

464 
loÿl
 
·t
 = 
_·‰”n_ÿche
[
·‰”n
]

465  
c
.
	$_·‰”n_·ck
(
·t
.
CObj
,…©.
fÜm©
,…©.
size
 , ...)

466 
’d


468 
funùiÚ
 
	$check
(
ty³Çme
 , 
f›ld
)

469 
f›ld
 =ğ
n
 
th’


470  
c
.
	$_’v_ty³
(
P
,
ty³Çme
)

472  
c
.
	`_’v_ty³
(
P
,
ty³Çme
,
f›ld
) ~=0

473 
’d


474 
’d


478 
loÿl
 
deçuÉ_ÿche
 = {
	}
}

480 -- 
todo
 : 
ş—r
 
deçuÉ_ÿche
, 
	gv
.
_CObj


482 
loÿl
 
funùiÚ
 
	$deçuÉ_bË
(
ty³Çme
)

483 
loÿl
 
v
 = 
deçuÉ_ÿche
[
ty³Çme
]

484 
v
 
th’


485  
v


486 
’d


488 
v
 = { 
__šdex
 = 
	`as£¹
(
	`decode_mes§ge
(
ty³Çme
 , "")è
	}
}

490 
	gdeçuÉ_ÿche
[
ty³Çme
] = 
v


491  
v


492 
’d


494 
loÿl
 
decode_mes§ge_mt
 = {}

496 
loÿl
 
funùiÚ
 
	$decode_mes§ge_cb
(
ty³Çme
, 
bufãr
)

497  
	`£tm‘©abË
 ( { 
ty³Çme
, 
bufãr
 
	}
} , 
	gdecode_mes§ge_mt
)

498 
’d


500 
funùiÚ
 
	$decode
(
ty³Çme
, 
bufãr
, 
Ëngth
)

501 
loÿl
 
»t
 = {
	}
}

502 
loÿl
 
ok
 = 
c
.
	$_decode
(
P
, 
decode_mes§ge_cb
 , 
»t
 , 
ty³Çme
, 
bufãr
, 
Ëngth
)

503 
ok
 
th’


504  
	`£tm‘©abË
(
»t
 , 
	$deçuÉ_bË
(
ty³Çme
))

506  
çl£
 , 
c
.
	$_Ï¡_”rÜ
(
P
)

507 
’d


508 
’d


510 
loÿl
 
funùiÚ
 
	$ex·nd
(
tbl
)

511 
loÿl
 
ty³Çme
 = 
	$¿wg‘
(
tbl
 , 1)

512 
loÿl
 
bufãr
 = 
	$¿wg‘
(
tbl
 , 2)

513 
tbl
[1] ,bl[2] = 
n
 ,‚il

514 
	`as£¹
(
c
.
	`_decode
(
P
, 
decode_mes§ge_cb
 , 
tbl
 , 
ty³Çme
, 
bufãr
),ypename)

515 
	`£tm‘©abË
(
tbl
 , 
	$deçuÉ_bË
(
ty³Çme
))

516 
’d


518 
funùiÚ
 
decode_mes§ge_mt
.
	$__šdex
(
tbl
, 
key
)

519 
	$ex·nd
(
tbl
)

520  
tbl
[
key
]

521 
’d


523 
funùiÚ
 
decode_mes§ge_mt
.
	$__·œs
(
tbl
)

524 
	$ex·nd
(
tbl
)

525  
	$·œs
(
tbl
)

526 
’d


528 
loÿl
 
funùiÚ
 
	$£t_deçuÉ
(
ty³Çme
, 
tbl
)

529 
k
,
v
 
š
 
	$·œs
(
tbl
) do

530 
	`ty³
(
v
è=ğ"bË" 
th’


531 
loÿl
 
t
, 
msg
 = 
c
.
	$_’v_ty³
(
P
, 
ty³Çme
, 
k
)

532 
t
 =ğ6 
th’


533 
	$£t_deçuÉ
(
msg
, 
v
)

534 
–£if
 
t
 =ğ128+6 
th’


535 
_
,
v
 
š
 
	$aœs
(
v
) do

536 
	$£t_deçuÉ
(
msg
, 
v
)

537 
’d


538 
’d


539 
’d


540 
’d


541  
	`£tm‘©abË
(
tbl
 , 
	$deçuÉ_bË
(
ty³Çme
))

542 
’d


544 
funùiÚ
 Ğ
bufãr
)

545 
c
.
	$_’v_»gi¡”
(
P
, 
bufãr
)

546 
’d


548 
funùiÚ
 
	$»gi¡”_fe
(
f’ame
)

549 
loÿl
 
f
 = 
	`as£¹
(
io
.
	`İ’
(
f’ame
 , "rb"))

550 
loÿl
 
bufãr
 = 
f
:
»ad
 "*a"

551 
c
.
	$_’v_»gi¡”
(
P
, 
bufãr
)

552 
f
:
	$şo£
()

553 
’d


555 
funùiÚ
 
	$’um_id
(
’um_ty³
, 
’um_Çme
)

556  
c
.
	$_’v_’um_id
(
P
, 
’um_ty³
, 
’um_Çme
)

557 
’d


559 
funùiÚ
 
	$exŒaù
(
tbl
)

560 
loÿl
 
ty³Çme
 = 
	$¿wg‘
(
tbl
 , 1)

561 
loÿl
 
bufãr
 = 
	$¿wg‘
(
tbl
 , 2)

562 
	`ty³
(
ty³Çme
è=ğ"¡ršg" 
ªd
y³(
bufãr
è=ğ"¡ršg" 
th’


563 
	$check
(
ty³Çme
è
th’


564 
	$ex·nd
(
tbl
)

565 
’d


566 
’d


568 
k
, 
v
 
š
 
	$·œs
(
tbl
) do

569 
	`ty³
(
v
è=ğ"bË" 
th’


570 
	$exŒaù
(
v
)

571 
’d


572 
’d


573 
’d


575 =
£t_deçuÉ


	@binding/lua/test.lua

1 
	g»quœe
 "protobuf"

3 
	gaddr
 = 
io
.
İ’
("../../build/addressbook.pb","rb")

4 
	gbufãr
 = 
addr
:
»ad
 "*a"

5 
addr
:
	$şo£
()

7 
´Ùobuf
.(
bufãr
)

9 
t
 = 
´Ùobuf
.
	`decode
("googË.´Ùobuf.FeDesütÜS‘", 
bufãr
)

11 
´Ùo
 = 
t
.
fe
[1]

13 
	$´št
(
´Ùo
.
Çme
)

14 
	$´št
(
´Ùo
.
·ckage
)

16 
mes§ge
 = 
´Ùo
.
mes§ge_ty³


18 
_
,
v
 
š
 
	$aœs
(
mes§ge
) do

19 
	$´št
(
v
.
Çme
)

20 
_
,
v
 
š
 
	$aœs
(
v
.
f›ld
) do

21 
	`´št
("\t".. 
v
.
Çme
 .. " ["..v.
numb”
.."] " .. v.
Ïb–
)

22 
’d


23 
’d


25 
add»ssbook
 = {

26 
Çme
 = "Alice",

27 
id
 = 12345,

28 
phÚe
 = {

29 { 
numb”
 = "1301234567" },

30 { 
numb”
 = "87654321", 
ty³
 = "WORK" },

32 
	}
}

34 
	gcode
 = 
´Ùobuf
.
’code
("tutÜŸl.P”sÚ", 
add»ssbook
)

36 
	gdecode
 = 
´Ùobuf
.
decode
("tutÜŸl.P”sÚ" , 
code
)

38 
	$´št
(
decode
.
Çme
)

39 
	$´št
(
decode
.
id
)

40 
_
,
v
 
š
 
	$aœs
(
decode
.
phÚe
) do

41 
	`´št
("\t"..
v
.
numb”
, v.
ty³
)

42 
’d


44 
phÚebuf
 = 
´Ùobuf
.
	`·ck
("tutorial.Person.PhoneNumber‚umber","87654321")

45 
bufãr
 = 
´Ùobuf
.
	`·ck
("tutÜŸl.P”sÚ‚amid…hÚe", "Aliû", 123, { 
phÚebuf
 
	}
})

46 
´št
(
´Ùobuf
.
uÅack
("tutÜŸl.P”sÚ‚amid…hÚe", 
bufãr
))

	@binding/lua/test2.lua

1 
loÿl
 
	g´Ùobuf
 = 
»quœe
 "protobuf"

3 
addr
 = 
io
.
İ’
("../../build/addressbook.pb","rb")

4 
	gbufãr
 = 
addr
:
»ad
 "*a"

5 
addr
:
	$şo£
()

6 
´Ùobuf
.(
bufãr
)

8 
loÿl
 
³rsÚ
 = {

9 
Çme
 = "Alice",

10 
id
 = 123,

11 
phÚe
 = {

12 { 
numb”
 = "123456789" , 
ty³
 = "MOBILE" },

13 { 
numb”
 = "87654321" , 
ty³
 = "HOME" },

15 
	}
}

17 
loÿl
 
	gbufãr
 = 
´Ùobuf
.
’code
("tutÜŸl.P”sÚ", 
³rsÚ
)

19 
loÿl
 
	gt
 = 
´Ùobuf
.
decode
("tutÜŸl.P”sÚ", 
bufãr
)

21 
	gk
,
v
 
š
 
	$·œs
(
t
) do

22 
	`ty³
(
k
è=ğ"¡ršg" 
th’


23 
	$´št
(
k
,
v
)

24 
’d


25 
’d


27 
	$´št
(
t
.
phÚe
[2].
ty³
)

29 
k
,
v
 
š
 
	$·œs
(
t
.
phÚe
[1]) do

30 
	$´št
(
k
,
v
)

31 
’d


	@binding/lua/testparser.lua

1 
	g´Ùobuf
 = 
»quœe
 "protobuf"

2 
·r£r
 = 
»quœe
 "parser"

4 
t
 = 
·r£r
.("addressbook.proto","../../test")

6 
	gadd»ssbook
 = {

7 
Çme
 = "Alice",

8 
	gid
 = 12345,

9 
	gphÚe
 = {

10 { 
numb”
 = "1301234567" },

11 { 
	gnumb”
 = "87654321", 
	gty³
 = "WORK" },

15 
	gcode
 = 
´Ùobuf
.
’code
("tutÜŸl.P”sÚ", 
add»ssbook
)

17 
	gdecode
 = 
´Ùobuf
.
decode
("tutÜŸl.P”sÚ" , 
code
)

19 
	$´št
(
decode
.
Çme
)

20 
	$´št
(
decode
.
id
)

21 
_
,
v
 
š
 
	$aœs
(
decode
.
phÚe
) do

22 
	`´št
("\t"..
v
.
numb”
, v.
ty³
)

23 
’d


25 
bufãr
 = 
´Ùobuf
.
	`·ck
("tutorial.Person‚ame id", "Alice", 123)

26 
	`´št
(
´Ùobuf
.
	`uÅack
("tutÜŸl.P”sÚ‚amid", 
bufãr
))

	@binding/lua53/pbc-lua53.c

1 #ifdeà
__ılu¥lus


4 
	~"lua.h
"

5 
	~"lu®ib.h
"

6 
	~"Ïuxlib.h
"

7 #ifdeà
__ılu¥lus


11 
	~<m®loc.h
>

13 #iâdeà
_MSC_VER


14 
	~<¡dboŞ.h
>

16 
	#®loÿ
 
_®loÿ


	)

19 
	~<¡ršg.h
>

20 
	~<¡dlib.h
>

21 
	~<¡dšt.h
>

23 
	~"pbc.h
"

25 
šlše
 *

26 
	$checku£rd©a
(
lua_S‹
 *
L
, 
šdex
) {

27 * 
ud
 = 
	`lua_tou£rd©a
(
L
,
šdex
);

28 ià(
ud
 =ğ
NULL
) {

29 
	`luaL_”rÜ
(
L
, "u£rd©¨%d i n",
šdex
);

31  
ud
;

32 
	}
}

35 
	$_’v_Ãw
(
lua_S‹
 *
L
) {

36 
pbc_’v
 * 
’v
 = 
	`pbc_Ãw
();

37 
	`lua_pushlightu£rd©a
(
L
, 
’v
);

39 
	}
}

42 
	$_’v_»gi¡”
(
lua_S‹
 *
L
) {

43 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
,1);

44 
size_t
 
sz
 = 0;

45 cÚ¡ * 
bufãr
 = 
	`luaL_checkl¡ršg
(
L
, 2 , &
sz
);

46 
pbc_¦iû
 
¦iû
;

47 
¦iû
.
bufãr
 = (*)buffer;

48 
¦iû
.
Ën
 = ()
sz
;

49 
»t
 = 
	`pbc_»gi¡”
(
’v
, &
¦iû
);

51 ià(
»t
) {

52  
	`luaL_”rÜ
(
L
, "register fail");

55 
	}
}

58 
	$_’v_’um_id
(
lua_S‹
 *
L
) {

59 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
,1);

60 
size_t
 
sz
 = 0;

61 cÚ¡ * 
’um_ty³
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
sz
);

62 cÚ¡ * 
’um_Çme
 = 
	`luaL_checkl¡ršg
(
L
, 3, &
sz
);

63 
št32_t
 
’um_id
 = 
	`pbc_’um_id
(
’v
, 
’um_ty³
, 
’um_Çme
);

64 ià(
’um_id
 < 0)

66 
	`lua_pushš‹g”
(
L
, 
’um_id
);

68 
	}
}

71 
	$_rmes§ge_Ãw
(
lua_S‹
 *
L
) {

72 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
,1);

73 cÚ¡ * 
ty³_Çme
 = 
	`luaL_check¡ršg
(
L
,2);

74 
pbc_¦iû
 
¦iû
;

75 ià(
	`lua_is¡ršg
(
L
,3)) {

76 
size_t
 
sz
 = 0;

77 
¦iû
.
bufãr
 = (*)
	`lua_tŞ¡ršg
(
L
,3,&
sz
);

78 
¦iû
.
Ën
 = ()
sz
;

80 
¦iû
.
bufãr
 = 
	`lua_tou£rd©a
(
L
,3);

81 
¦iû
.
Ën
 = 
	`luaL_checkš‹g”
(
L
,4);

83 
pbc_rmes§ge
 * 
m
 = 
	`pbc_rmes§ge_Ãw
(
’v
, 
ty³_Çme
, &
¦iû
);

84 ià(
m
==
NULL
)

86 
	`lua_pushlightu£rd©a
(
L
,
m
);

88 
	}
}

91 
	$_rmes§ge_d–‘e
(
lua_S‹
 *
L
) {

92 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

93 
	`pbc_rmes§ge_d–‘e
(
m
);

96 
	}
}

99 
	$_rmes§ge_št
(
lua_S‹
 *
L
) {

100 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

101 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

102 
šdex
 = 
	`luaL_checkš‹g”
(
L
,3);

103 
ušt32_t
 
hi
,
low
;

104 
low
 = 
	`pbc_rmes§ge_š‹g”
(
m
, 
key
, 
šdex
, &
hi
);

105 
št64_t
 
v
 = (št64_t)((
ušt64_t
)
hi
 << 32 | (ušt64_t)
low
);

106 
	`lua_pushš‹g”
(
L
,
v
);

109 
	}
}

112 
	$_rmes§ge_»®
(
lua_S‹
 *
L
) {

113 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

114 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

115 
šdex
 = 
	`luaL_checkš‹g”
(
L
,3);

116 
v
 = 
	`pbc_rmes§ge_»®
(
m
, 
key
, 
šdex
);

118 
	`lua_pushnumb”
(
L
,
v
);

121 
	}
}

124 
	$_rmes§ge_¡ršg
(
lua_S‹
 *
L
) {

125 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

126 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

127 
šdex
 = 
	`lua_toš‹g”
(
L
,3);

128 
sz
 = 0;

129 cÚ¡ * 
v
 = 
	`pbc_rmes§ge_¡ršg
(
m
,
key
,
šdex
,&
sz
);

130 
	`lua_pushl¡ršg
(
L
,
v
,
sz
);

132 
	}
}

135 
	$_rmes§ge_mes§ge
(
lua_S‹
 *
L
) {

136 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

137 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

138 
šdex
 = 
	`lua_toš‹g”
(
L
,3);

139 
pbc_rmes§ge
 * 
v
 = 
	`pbc_rmes§ge_mes§ge
(
m
,
key
,
šdex
);

140 
	`lua_pushlightu£rd©a
(
L
,
v
);

142 
	}
}

145 
	$_rmes§ge_size
(
lua_S‹
 *
L
) {

146 
pbc_rmes§ge
 * 
m
 = (pbc_rmes§g*)
	`checku£rd©a
(
L
,1);

147 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

149 
sz
 = 
	`pbc_rmes§ge_size
(
m
, 
key
);

151 
	`lua_pushš‹g”
(
L
, 
sz
);

154 
	}
}

157 
	$_’v_ty³
(
lua_S‹
 *
L
) {

158 
	`lua_£‰İ
(
L
,3);

159 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
,1);

160 cÚ¡ * 
ty³_Çme
 = 
	`luaL_check¡ršg
(
L
,2);

161 ià(
	`lua_i¢
(
L
,3)) {

162 
»t
 = 
	`pbc_ty³
(
’v
, 
ty³_Çme
, 
NULL
, NULL);

163 
	`lua_pushboŞ—n
(
L
,
»t
);

166 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,3);

167 cÚ¡ * 
ty³
 = 
NULL
;

168 
»t
 = 
	`pbc_ty³
(
’v
, 
ty³_Çme
, 
key
, &
ty³
);

169 
	`lua_pushš‹g”
(
L
,
»t
);

170 ià(
ty³
 =ğ
NULL
) {

173 
	`lua_push¡ršg
(
L
, 
ty³
);

176 
	}
}

179 
	$_wmes§ge_Ãw
(
lua_S‹
 *
L
) {

180 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
,1);

181 cÚ¡ * 
ty³_Çme
 = 
	`luaL_check¡ršg
(
L
,2);

182 
pbc_wmes§ge
 * 
»t
 = 
	`pbc_wmes§ge_Ãw
(
’v
, 
ty³_Çme
);

183 
	`lua_pushlightu£rd©a
(
L
,
»t
);

185 
	}
}

188 
	$_wmes§ge_d–‘e
(
lua_S‹
 *
L
) {

189 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`lua_tou£rd©a
(
L
,1);

190 
	`pbc_wmes§ge_d–‘e
(
m
);

193 
	}
}

197 
	$_wmes§ge_»®
(
lua_S‹
 *
L
) {

198 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

199 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

200 
numb”
 = 
	`luaL_checknumb”
(
L
,3);

201 
	`pbc_wmes§ge_»®
(
m
, 
key
, 
numb”
);

204 
	}
}

207 
	$_wmes§ge_¡ršg
(
lua_S‹
 *
L
) {

208 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

209 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

210 
size_t
 
Ën
 = 0;

211 cÚ¡ * 
v
 = 
	`luaL_checkl¡ršg
(
L
,3,&
Ën
);

212 
”r
 = 
	`pbc_wmes§ge_¡ršg
(
m
, 
key
, 
v
, ()
Ën
);

213 ià(
”r
) {

214  
	`luaL_”rÜ
(
L
, "Wr™¡ršgƒ¼Ü : %s", 
v
);

218 
	}
}

221 
	$_wmes§ge_mes§ge
(
lua_S‹
 *
L
) {

222 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

223 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

224 
pbc_wmes§ge
 * 
»t
 = 
	`pbc_wmes§ge_mes§ge
(
m
, 
key
);

225 
	`lua_pushlightu£rd©a
(
L
, 
»t
);

228 
	}
}

231 
	$_wmes§ge_št
(
lua_S‹
 *
L
) {

232 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

233 cÚ¡ * 
key
 = 
	`luaL_check¡ršg
(
L
,2);

234 
št64_t
 
numb”
;

236 ià(
	`lua_isš‹g”
(
L
, 3)) {

237 
numb”
 = 
	`lua_toš‹g”
(
L
,3);

239 
numb”
 = (
št64_t
)
	`lua_tÚumb”
(
L
,3);

241 
ušt32_t
 
hi
 = (ušt32_t)(
numb”
 >> 32);

242 
	`pbc_wmes§ge_š‹g”
(
m
, 
key
, (
ušt32_t
)
numb”
, 
hi
);

245 
	}
}

248 
	$_wmes§ge_bufãr
(
lua_S‹
 *
L
) {

249 
pbc_¦iû
 
¦iû
;

250 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

251 
	`pbc_wmes§ge_bufãr
(
m
 , &
¦iû
);

252 
	`lua_pushlightu£rd©a
(
L
, 
¦iû
.
bufãr
);

253 
	`lua_pushš‹g”
(
L
, 
¦iû
.
Ën
);

255 
	}
}

258 
	$_wmes§ge_bufãr_¡ršg
(
lua_S‹
 *
L
) {

259 
pbc_¦iû
 
¦iû
;

260 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`checku£rd©a
(
L
,1);

261 
	`pbc_wmes§ge_bufãr
(
m
 , &
¦iû
);

262 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
¦iû
.
bufãr
, sliû.
Ën
);

264 
	}
}

270 
	$_Ï¡_”rÜ
(
lua_S‹
 *
L
) {

271 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
, 1);

272 cÚ¡ * 
”r
 = 
	`pbc_”rÜ
(
’v
);

273 
	`lua_push¡ršg
(
L
,
”r
);

275 
	}
}

283 
	$_·‰”n_Ãw
(
lua_S‹
 *
L
) {

284 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
, 1);

285 cÚ¡ * 
mes§ge
 = 
	`luaL_check¡ršg
(
L
,2);

286 cÚ¡ * 
fÜm©
 = 
	`luaL_check¡ršg
(
L
,3);

287 
pbc_·‰”n
 * 
·t
 = 
	`pbc_·‰”n_Ãw
(
’v
, 
mes§ge
, 
fÜm©
);

288 ià(
·t
 =ğ
NULL
) {

289  
	`luaL_”rÜ
(
L
, "ü—‹…©‹À% (%sèçed", 
mes§ge
 , 
fÜm©
);

291 
	`lua_pushlightu£rd©a
(
L
,
·t
);

294 
	}
}

297 
	$_·‰”n_d–‘e
(
lua_S‹
 *
L
) {

298 
pbc_·‰”n
 * 
·t
 = (pbc_·‰”À*)
	`lua_tou£rd©a
(
L
,1);

299 
	`pbc_·‰”n_d–‘e
(
·t
);

302 
	}
}

305 
	$_push_v®ue
(
lua_S‹
 *
L
, * 
±r
, 
ty³
) {

306 
ty³
) {

308 
ušt64_t
 
v
 = *(ušt64_t*)
±r
;

309 
±r
 += 8;

310 
	`lua_pushš‹g”
(
L
, 
v
);

314 
št32_t
 
v
 = *(št32_t*)
±r
;

315 
±r
 += 4;

316 
	`lua_pushš‹g”
(
L
,
v
);

320 
št32_t
 
v
 = *(št32_t*)
±r
;

321 
±r
 += 4;

322 
	`lua_pushboŞ—n
(
L
,
v
);

326 
v
 = *(*)
±r
;

327 
±r
 += 8;

328 
	`lua_pushnumb”
(
L
,
v
);

332 
pbc_¦iû
 * 
¦iû
 = (pbc_¦iû *)
±r
;

333 
	`lua_pushl¡ršg
(
L
,(cÚ¡ *)
¦iû
->
bufãr
, sliû->
Ën
);

334 
±r
 +ğ(
pbc_¦iû
);

338 
pbc_¦iû
 * 
¦iû
 = (pbc_¦iû *)
±r
;

339 
	`lua_ü—‹bË
(
L
,2,0);

340 
	`lua_pushlightu£rd©a
(
L
, 
¦iû
->
bufãr
);

341 
	`lua_¿w£ti
(
L
,-2,1);

342 
	`lua_pushš‹g”
(
L
,
¦iû
->
Ën
);

343 
	`lua_¿w£ti
(
L
,-2,2);

344 
±r
 +ğ(
pbc_¦iû
);

348  
±r
;

349 
	}
}

352 
	$_push_¬¿y
(
lua_S‹
 *
L
, 
pbc_¬¿y
 
¬¿y
, 
ty³
, 
šdex
) {

353 
ty³
) {

355 
v
 = 
	`pbc_¬¿y_š‹g”
(
¬¿y
, 
šdex
, 
NULL
);

356 
	`lua_pushš‹g”
(
L
, 
v
);

360 
ušt32_t
 
hi
 = 0;

361 
ušt32_t
 
low
 = 
	`pbc_¬¿y_š‹g”
(
¬¿y
, 
šdex
, &
hi
);

362 
ušt64_t
 
v
 = (ušt64_t)
hi
 << 32 | (ušt64_t)
low
;

363 
	`lua_pushš‹g”
(
L
, 
v
);

367 
v
 = 
	`pbc_¬¿y_š‹g”
(
¬¿y
, 
šdex
, 
NULL
);

368 
	`lua_pushboŞ—n
(
L
, 
v
);

372 
ušt32_t
 
hi
 = 0;

373 
ušt32_t
 
low
 = 
	`pbc_¬¿y_š‹g”
(
¬¿y
, 
šdex
, &
hi
);

374 
ušt64_t
 
v
 = (ušt64_t)
low
 | (ušt64_t)
hi
 << 32;

375 
	`lua_pushl¡ršg
(
L
, (*)&
v
, 8);

379 
v
 = 
	`pbc_¬¿y_»®
(
¬¿y
, 
šdex
);

380 
	`lua_pushnumb”
(
L
, 
v
);

384 
pbc_¦iû
 * 
¦iû
 = 
	`pbc_¬¿y_¦iû
(
¬¿y
, 
šdex
);

385 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
¦iû
->
bufãr
,¦iû->
Ën
);

389 
pbc_¦iû
 * 
¦iû
 = 
	`pbc_¬¿y_¦iû
(
¬¿y
, 
šdex
);

390 
	`lua_ü—‹bË
(
L
,2,0);

391 
	`lua_pushlightu£rd©a
(
L
,
¦iû
->
bufãr
);

392 
	`lua_¿w£ti
(
L
,-2,1);

393 
	`lua_pushš‹g”
(
L
,
¦iû
->
Ën
);

394 
	`lua_¿w£ti
(
L
,-2,2);

398 
	`lua_¿w£ti
(
L
,-2,
šdex
+1);

399 
	}
}

409 
	$_·‰”n_uÅack
(
lua_S‹
 *
L
) {

410 
pbc_·‰”n
 * 
·t
 = (pbc_·‰”À*)
	`checku£rd©a
(
L
, 1);

411 ià(
·t
 =ğ
NULL
) {

412  
	`luaL_”rÜ
(
L
, "unpack…attern is NULL");

414 
size_t
 
fÜm©_sz
 = 0;

415 cÚ¡ * 
fÜm©
 = 
	`lua_tŞ¡ršg
(
L
,2,&
fÜm©_sz
);

416 
size
 = 
	`lua_toš‹g”
(
L
,3);

417 
pbc_¦iû
 
¦iû
;

418 ià(
	`lua_is¡ršg
(
L
,4)) {

419 
size_t
 
bufãr_Ën
 = 0;

420 cÚ¡ *
bufãr
 = 
	`luaL_checkl¡ršg
(
L
,4,&
bufãr_Ën
);

421 
¦iû
.
bufãr
 = (*)buffer;

422 
¦iû
.
Ën
 = 
bufãr_Ën
;

424 ià(!
	`lua_isu£rd©a
(
L
,4)) {

425  
	`luaL_”rÜ
(
L
, "Need‡ userdata");

427 
¦iû
.
bufãr
 = 
	`lua_tou£rd©a
(
L
,4);

428 
¦iû
.
Ën
 = 
	`luaL_checkš‹g”
(
L
,5);

431 * 
‹mp
 = (*)
	`®loÿ
(
size
);

432 
»t
 = 
	`pbc_·‰”n_uÅack
(
·t
, &
¦iû
, 
‹mp
);

433 ià(
»t
 < 0) {

436 
	`lua_check¡ack
(
L
, 
fÜm©_sz
 + 3);

437 
i
;

438 * 
±r
 = 
‹mp
;

439 
boŞ
 
¬¿y
 = 
çl£
;

440 
i
=0;i<
fÜm©_sz
;i++) {

441 
ty³
 = 
fÜm©
[
i
];

442 ià(
ty³
 >= 'a' &&ype <='z') {

443 
±r
 = (*)
	`_push_v®ue
(
L
,±r,
ty³
);

445 
¬¿y
 = 
Œue
;

446 
n
 = 
	`pbc_¬¿y_size
((
_pbc_¬¿y
 *)
±r
);

447 
	`lua_ü—‹bË
(
L
,
n
,0);

448 
j
;

449 
j
=0;j<
n
;j++) {

450 
	`_push_¬¿y
(
L
,(
_pbc_¬¿y
 *)
±r
, 
ty³
, 
j
);

452 
±r
 +ğ(
pbc_¬¿y
);

455 ià(
¬¿y
) {

456 
	`pbc_·‰”n_şo£_¬¿ys
(
·t
, 
‹mp
);

458  
fÜm©_sz
;

459 
	}
}

462 
	$_g‘_v®ue
(
lua_S‹
 *
L
, 
šdex
, * 
±r
, 
ty³
) {

463 
ty³
) {

465 
št32_t
 
v
 = 
	`luaL_checkš‹g”
(
L
, 
šdex
);

466 
	`memıy
(
±r
, &
v
, 4);

467  
±r
 + 4;

470 
št64_t
 
v
 = (št64_t)
	`luaL_checkš‹g”
(
L
, 
šdex
);

471 
	`memıy
(
±r
, &
v
, 8);

472  
±r
 + 8;

475 
št32_t
 
v
 = 
	`lua_toboŞ—n
(
L
, 
šdex
);

476 
	`memıy
(
±r
, &
v
, 4);

477  
±r
 + 4;

480 
v
 = 
	`luaL_checknumb”
(
L
, 
šdex
);

481 
	`memıy
(
±r
, &
v
, 8);

482  
±r
 + 8;

485 
size_t
 
sz
 = 0;

486 cÚ¡ * 
¡r
 = 
	`luaL_checkl¡ršg
(
L
, 
šdex
, &
sz
);

487 
pbc_¦iû
 * 
¦iû
 = (pbc_¦iû *)
±r
;

488 
¦iû
->
bufãr
 = (*)
¡r
;

489 
¦iû
->
Ën
 = 
sz
;

490  
±r
 + (
pbc_¦iû
);

493 
pbc_¦iû
 * 
¦iû
 = (pbc_¦iû *)
±r
;

494 ià(
	`lua_i¡abË
(
L
,
šdex
)) {

495 
	`lua_¿wg‘i
(
L
,
šdex
,1);

496 
¦iû
->
bufãr
 = 
	`lua_tou£rd©a
(
L
,-1);

497 
	`lua_¿wg‘i
(
L
,
šdex
,2);

498 
¦iû
->
Ën
 = 
	`lua_toš‹g”
(
L
,-1);

499 
	`lua_pİ
(
L
,2);

501 
size_t
 
sz
 = 0;

502 cÚ¡ * 
bufãr
 = 
	`luaL_checkl¡ršg
(
L
, 
šdex
, &
sz
);

503 
¦iû
->
bufãr
 = (*)buffer;

504 
¦iû
->
Ën
 = 
sz
;

506  
±r
 + (
pbc_¦iû
);

509 
	`luaL_”rÜ
(
L
,"unknowÀfÜm© %c", 
ty³
);

510  
±r
;

512 
	}
}

515 
	$_g‘_¬¿y_v®ue
(
lua_S‹
 *
L
, 
pbc_¬¿y
 
¬¿y
, 
ty³
) {

516 
ty³
) {

518 
št32_t
 
v
 = 
	`luaL_checkš‹g”
(
L
, -1);

519 
ušt32_t
 
hi
 = 0;

520 ià(
v
<0) {

521 
hi
 = ~0;

523 
	`pbc_¬¿y_push_š‹g”
(
¬¿y
, 
v
, 
hi
);

527 
ušt64_t
 
v
 = (ušt64_t)
	`luaL_checknumb”
(
L
, -1);

528 
	`pbc_¬¿y_push_š‹g”
(
¬¿y
, (
ušt32_t
)
v
, (uint32_t)(v >> 32));

532 
št32_t
 
v
 = 
	`lua_toboŞ—n
(
L
, -1);

533 
	`pbc_¬¿y_push_š‹g”
(
¬¿y
, 
v
 ? 1: 0, 0);

537 
v
 = 
	`luaL_checknumb”
(
L
, -1);

538 
	`pbc_¬¿y_push_»®
(
¬¿y
, 
v
);

542 
size_t
 
sz
 = 0;

543 cÚ¡ * 
¡r
 = 
	`luaL_checkl¡ršg
(
L
, -1, &
sz
);

544 
pbc_¦iû
 
¦iû
;

545 
¦iû
.
bufãr
 = (*)
¡r
;

546 
¦iû
.
Ën
 = 
sz
;

547 
	`pbc_¬¿y_push_¦iû
(
¬¿y
, &
¦iû
);

551 
pbc_¦iû
 
¦iû
;

552 ià(
	`lua_i¡abË
(
L
,-1)) {

553 
	`lua_¿wg‘i
(
L
,-1,1);

554 
¦iû
.
bufãr
 = 
	`lua_tou£rd©a
(
L
,-1);

555 
	`lua_¿wg‘i
(
L
,-2,2);

556 
¦iû
.
Ën
 = 
	`lua_toš‹g”
(
L
,-1);

557 
	`lua_pİ
(
L
,2);

559 
size_t
 
sz
 = 0;

560 cÚ¡ * 
bufãr
 = 
	`luaL_checkl¡ršg
(
L
, -1, &
sz
);

561 
¦iû
.
bufãr
 = (*)buffer;

562 
¦iû
.
Ën
 = 
sz
;

564 
	`pbc_¬¿y_push_¦iû
(
¬¿y
, &
¦iû
);

568 
	}
}

576 
	$_·‰”n_·ck
(
lua_S‹
 *
L
) {

577 
pbc_·‰”n
 * 
·t
 = (pbc_·‰”À*)
	`checku£rd©a
(
L
,1);

578 ià(
·t
 =ğ
NULL
) {

579  
	`luaL_”rÜ
(
L
, "pack…attern is NULL");

581 
size_t
 
fÜm©_sz
 = 0;

582 cÚ¡ * 
fÜm©
 = 
	`lua_tŞ¡ršg
(
L
,2,&
fÜm©_sz
);

583 
size
 = 
	`lua_toš‹g”
(
L
,3);

585 * 
d©a
 = (*)
	`®loÿ
(
size
);

588 
	`mem£t
(
d©a
, 0 , 
size
);

590 * 
±r
 = 
d©a
;

592 
i
;

594 
i
=0;i<
fÜm©_sz
;i++) {

595 ià(
fÜm©
[
i
] >= 'a' && format[i] <='z') {

596 
±r
 = 
	`_g‘_v®ue
(
L
, 4+
i
,…Œ, 
fÜm©
[i]);

598 ià(!
	`lua_i¡abË
(
L
,4+
i
)) {

599 
	`luaL_”rÜ
(
L
,"needable for‡rrayype");

601 
j
;

602 
n
 = 
	`lua_¿wËn
(
L
,4+
i
);

603 
j
=0;j<
n
;j++) {

604 
	`lua_¿wg‘i
(
L
,4+
i
,
j
+1);

605 
	`_g‘_¬¿y_v®ue
(
L
,(
_pbc_¬¿y
 *)
±r
,
fÜm©
[
i
]);

606 
	`lua_pİ
(
L
,1);

608 
±r
 +ğ(
pbc_¬¿y
);

612 
luaL_Bufãr
 
b
;

613 
	`luaL_buffš™
(
L
, &
b
);

615 
ÿp
 = 128;

617 * 
‹mp
 = (*)
	`luaL_´•buffsize
(&
b
 , 
ÿp
);

619 
pbc_¦iû
 
¦iû
;

620 
¦iû
.
bufãr
 = 
‹mp
;

621 
¦iû
.
Ën
 = 
ÿp
;

623 
»t
 = 
	`pbc_·‰”n_·ck
(
·t
, 
d©a
, &
¦iû
);

625 ià(
»t
 < 0) {

626 
ÿp
 = cap * 2;

630 
	`luaL_addsize
(&
b
 , 
¦iû
.
Ën
);

633 
	`luaL_push»suÉ
(&
b
);

635 
	`pbc_·‰”n_şo£_¬¿ys
(
·t
, 
d©a
);

637 
	}
}

640 
	$_·‰”n_size
(
lua_S‹
 *
L
) {

641 
size_t
 
sz
 =0;

642 cÚ¡ *
fÜm©
 = 
	`luaL_checkl¡ršg
(
L
,1,&
sz
);

643 
i
;

644 
size
 = 0;

645 
i
=0;i<
sz
;i++) {

646 
fÜm©
[
i
]) {

649 
size
 += 4;

653 
size
 += 8;

657 
size
 +ğ(
pbc_¦iû
);

660 
size
 +ğ(
pbc_¬¿y
);

664 
	`lua_pushš‹g”
(
L
,
size
);

666 
	}
}

674 
	$Ãw_¬¿y
(
lua_S‹
 *
L
, 
id
, cÚ¡ *
key
) {

675 
	`lua_¿wg‘i
(
L
, -2 , 
id
);

676 ià(
	`lua_i¢
(
L
, -1)) {

677 
	`lua_pİ
(
L
,1);

678 
	`lua_ÃwbË
(
L
);

679 
	`lua_pushv®ue
(
L
,-1);

680 
	`lua_pushv®ue
(
L
,-1);

681 
	`lua_£tf›ld
(
L
, -6 , 
key
);

682 
	`lua_¿w£ti
(
L
, -4, 
id
);

684 
	}
}

687 
	$push_v®ue
(
lua_S‹
 *
L
, 
ty³
, cÚ¡ * 
ty³_Çme
, 
pbc_v®ue
 *
v
) {

688 
ty³
) {

689 
PBC_FIXED32
:

690 
PBC_INT
:

691 
	`lua_pushš‹g”
(
L
, ()
v
->
i
.
low
);

693 
PBC_REAL
:

694 
	`lua_pushnumb”
(
L
, 
v
->
f
);

696 
PBC_BOOL
:

697 
	`lua_pushboŞ—n
(
L
, 
v
->
i
.
low
);

699 
PBC_ENUM
:

700 
	`lua_push¡ršg
(
L
, 
v
->
e
.
Çme
);

702 
PBC_BYTES
:

703 
PBC_STRING
:

704 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
v
->
s
.
bufãr
 , v->s.
Ën
);

706 
PBC_MESSAGE
:

707 
	`lua_pushv®ue
(
L
, -3);

708 
	`lua_push¡ršg
(
L
, 
ty³_Çme
);

709 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
v
->
s
.
bufãr
 , v->s.
Ën
);

710 
	`lua_ÿÎ
(
L
, 2 , 1);

712 
PBC_FIXED64
:

713 
PBC_UINT
:

714 
PBC_INT64
: {

715 
ušt64_t
 
v64
 = (ušt64_t)(
v
->
i
.
hi
è<< 32 | (ušt64_t)(v->i.
low
);

716 
	`lua_pushš‹g”
(
L
,
v64
);

720 
	`luaL_”rÜ
(
L
, "UnknowÀty³ %s", 
ty³_Çme
);

723 
	}
}

731 
	$decode_cb
(*
ud
, 
ty³
, cÚ¡ * 
ty³_Çme
, 
pbc_v®ue
 *
v
, 
id
, cÚ¡ *
key
) {

732 
lua_S‹
 *
L
 = (lua_S‹ *)
ud
;

733 ià(
key
 =ğ
NULL
) {

738 ià(
ty³
 & 
PBC_REPEATED
) {

739 
	`push_v®ue
(
L
, 
ty³
 & ~
PBC_REPEATED
, 
ty³_Çme
, 
v
);

740 
	`Ãw_¬¿y
(
L
, 
id
 , 
key
);

741 
n
 = 
	`lua_¿wËn
(
L
,-1);

742 
	`lua_š£¹
(
L
, -2);

743 
	`lua_¿w£ti
(
L
, -2 , 
n
+1);

744 
	`lua_pİ
(
L
,1);

746 
	`push_v®ue
(
L
, 
ty³
, 
ty³_Çme
, 
v
);

747 
	`lua_£tf›ld
(
L
, -3 , 
key
);

749 
	}
}

763 
	$_decode
(
lua_S‹
 *
L
) {

764 
pbc_’v
 * 
’v
 = (pbc_’v *)
	`checku£rd©a
(
L
,1);

765 
	`luaL_checkty³
(
L
, 2 , 
LUA_TFUNCTION
);

766 
	`luaL_checkty³
(
L
, 3 , 
LUA_TTABLE
);

767 cÚ¡ * 
ty³
 = 
	`luaL_check¡ršg
(
L
,4);

768 
pbc_¦iû
 
¦iû
;

769 ià(
	`lua_ty³
(
L
,5è=ğ
LUA_TSTRING
) {

770 
size_t
 
Ën
;

771 
¦iû
.
bufãr
 = (*)
	`luaL_checkl¡ršg
(
L
,5,&
Ën
);

772 
¦iû
.
Ën
 = ()len;

774 
¦iû
.
bufãr
 = 
	`checku£rd©a
(
L
,5);

775 
¦iû
.
Ën
 = 
	`luaL_checkš‹g”
(
L
,6);

777 
	`lua_pushv®ue
(
L
, 2);

778 
	`lua_pushv®ue
(
L
, 3);

779 
	`lua_ÃwbË
(
L
);

781 
n
 = 
	`pbc_decode
(
’v
, 
ty³
, &
¦iû
, 
decode_cb
, 
L
);

782 ià(
n
<0) {

783 
	`lua_pushboŞ—n
(
L
,0);

785 
	`lua_pushboŞ—n
(
L
,1);

788 
	}
}

790 
	sgcobj
 {

791 
pbc_’v
 * 
’v
;

792 
size_·t
;

793 
ÿp_·t
;

794 
pbc_·‰”n
 ** 
·t
;

795 
size_msg
;

796 
ÿp_msg
;

797 
pbc_rmes§ge
 ** 
msg
;

801 
	$_ş—r_gcobj
(
lua_S‹
 *
L
) {

802 
gcobj
 * 
obj
 = (gcobj *)
	`lua_tou£rd©a
(
L
,1);

803 
i
;

804 
i
=0;i<
obj
->
size_·t
;i++) {

805 
	`pbc_·‰”n_d–‘e
(
obj
->
·t
[
i
]);

807 
i
=0;i<
obj
->
size_msg
;i++) {

808 
	`pbc_rmes§ge_d–‘e
(
obj
->
msg
[
i
]);

810 
	`ä“
(
obj
->
·t
);

811 
	`ä“
(
obj
->
msg
);

812 
obj
->
·t
 = 
NULL
;

813 
obj
->
msg
 = 
NULL
;

814 ià(
obj
->
’v
) {

815 
	`pbc_d–‘e
(
obj
->
’v
);

816 
obj
->
’v
 = 
NULL
;

820 
	}
}

823 
	$_gc
(
lua_S‹
 *
L
) {

824 
gcobj
 * 
obj
;

825 
	`lua_£‰İ
(
L
,1);

826 
obj
 = (
gcobj
 *)
	`lua_Ãwu£rd©a
(
L
,(*obj));

827 
obj
->
’v
 = (
pbc_’v
 *)
	`lua_tou£rd©a
(
L
,1);

828 
obj
->
size_·t
 = 0;

829 
obj
->
ÿp_·t
 = 4;

830 
obj
->
size_msg
 = 0;

831 
obj
->
ÿp_msg
 = 4;

832 
obj
->
·t
 = (
pbc_·‰”n
 **)
	`m®loc
(obj->
ÿp_·t
 * (pbc_pattern *));

833 
obj
->
msg
 = (
pbc_rmes§ge
 **)
	`m®loc
(obj->
ÿp_msg
 * (pbc_rmessage *));

835 
	`lua_ü—‹bË
(
L
,0,1);

836 
	`lua_pushcfunùiÚ
(
L
, 
_ş—r_gcobj
);

837 
	`lua_£tf›ld
(
L
,-2,"__gc");

838 
	`lua_£tm‘©abË
(
L
,-2);

841 
	}
}

844 
	$_add_·‰”n
(
lua_S‹
 *
L
) {

845 
gcobj
 * 
obj
 = (gcobj *)
	`lua_tou£rd©a
(
L
,1);

846 ià(
obj
->
size_·t
 >ğobj->
ÿp_·t
) {

847 
obj
->
ÿp_·t
 *= 2;

848 
obj
->
·t
 = (
pbc_·‰”n
 **)
	`»®loc
(obj->·t, obj->
ÿp_·t
 * (pbc_pattern *));

850 
pbc_·‰”n
 * 
·t
 = (pbc_·‰”À*)
	`lua_tou£rd©a
(
L
,2);

851 
obj
->
·t
[obj->
size_·t
++] =…at;

853 
	}
}

856 
	$_add_rmes§ge
(
lua_S‹
 *
L
) {

857 
gcobj
 * 
obj
 = (gcobj *)
	`lua_tou£rd©a
(
L
,1);

858 ià(
obj
->
size_msg
 >ğobj->
ÿp_msg
) {

859 
obj
->
ÿp_msg
 *= 2;

860 
obj
->
msg
 = (
pbc_rmes§ge
 **)
	`»®loc
(obj->msg, obj->
ÿp_msg
 * (pbc_rmessage *));

862 
pbc_rmes§ge
 * 
msg
 = (pbc_rmes§g*)
	`lua_tou£rd©a
(
L
,2);

863 
obj
->
msg
[obj->
size_msg
++] = msg;

865 
	}
}

868 
	$luaİ’_´Ùobuf_c
(
lua_S‹
 *
L
) {

869 
luaL_Reg
 
»g
[] = {

870 {"_’v_Ãw" , 
_’v_Ãw
 },

871 {"_’v_»gi¡”" , 
_’v_»gi¡”
 },

872 {"_’v_ty³", 
_’v_ty³
 },

873 {"_rmes§ge_Ãw" , 
_rmes§ge_Ãw
 },

874 {"_rmes§ge_d–‘e" , 
_rmes§ge_d–‘e
 },

875 {"_rmes§ge_št", 
_rmes§ge_št
 },

876 {"_rmes§ge_»®" , 
_rmes§ge_»®
 },

877 {"_rmes§ge_¡ršg" , 
_rmes§ge_¡ršg
 },

878 {"_rmes§ge_mes§ge" , 
_rmes§ge_mes§ge
 },

879 {"_rmes§ge_size" , 
_rmes§ge_size
 },

880 {"_wmes§ge_Ãw", 
_wmes§ge_Ãw
 },

881 {"_wmes§ge_d–‘e", 
_wmes§ge_d–‘e
 },

882 {"_wmes§ge_»®", 
_wmes§ge_»®
 },

883 {"_wmes§ge_¡ršg", 
_wmes§ge_¡ršg
 },

884 {"_wmes§ge_mes§ge", 
_wmes§ge_mes§ge
 },

885 {"_wmes§ge_št", 
_wmes§ge_št
 },

886 {"_wmes§ge_bufãr", 
_wmes§ge_bufãr
 },

887 {"_wmes§ge_bufãr_¡ršg", 
_wmes§ge_bufãr_¡ršg
 },

888 {"_·‰”n_Ãw", 
_·‰”n_Ãw
 },

889 {"_·‰”n_d–‘e", 
_·‰”n_d–‘e
 },

890 {"_·‰”n_size", 
_·‰”n_size
 },

891 {"_·‰”n_uÅack", 
_·‰”n_uÅack
 },

892 {"_·‰”n_·ck", 
_·‰”n_·ck
 },

893 {"_Ï¡_”rÜ", 
_Ï¡_”rÜ
 },

894 {"_decode", 
_decode
 },

895 {"_gc", 
_gc
 },

896 {"_add_·‰”n", 
_add_·‰”n
 },

897 {"_add_rmes§ge", 
_add_rmes§ge
 },

898 {"_’v_’um_id", 
_’v_’um_id
},

899 {
NULL
,NULL},

902 
	`luaL_checkv”siÚ
(
L
);

903 
	`luaL_Ãwlib
(
L
, 
»g
);

906 
	}
}

	@binding/lua53/protobuf.lua

1 
loÿl
 
	gc
 = 
»quœe
 "protobuf.c"

3 
loÿl
 
£tm‘©abË
 = setmetatable

4 
loÿl
 
ty³
 =ype

5 
loÿl
 
bË
 =able

6 
loÿl
 
as£¹
 =‡ssert

7 
loÿl
 
·œs
 =…airs

8 
loÿl
 
aœs
 = ipairs

9 
loÿl
 
¡ršg
 = string

10 
loÿl
 
´št
 =…rint

11 
loÿl
 
io
 = io

12 
loÿl
 
tš£¹
 = 
bË
.
š£¹


13 
loÿl
 
¿wg‘
 =„awget

15 
loÿl
 
M
 = {}

17 
loÿl
 
_·‰”n_ÿche
 = {}

19 
loÿl
 
P
,
GC


21 
	gP
 = 
debug
.
g‘»gi¡ry
().
PROTOBUF_ENV


23 
P
 
th’


24 
GC
 = 
c
.
	$_gc
()

26 
P
ğ
c
.
	$_’v_Ãw
()

27 
GC
 = 
c
.
	$_gc
(
P
)

28 
’d


30 
M
.
GC
 = GC

32 
funùiÚ
 
M
.
	$Ï¡”rÜ
()

33  
c
.
	$_Ï¡_”rÜ
(
P
)

34 
’d


36 
loÿl
 
decode_ty³_ÿche
 = {
	}
}

37 
loÿl
 
_R_m‘a
 = {}

39 
funùiÚ
 
_R_m‘a
:
	$__šdex
(
key
)

40 
loÿl
 
v
 = 
decode_ty³_ÿche
[
£lf
.
_CTy³
][
key
](self, key)

41 
£lf
[
key
] = 
v


42  
v


43 
’d


45 
loÿl
 
_»ad”
 = {
	}
}

47 
funùiÚ
 
_»ad”
:
	$»®
(
key
)

48  
c
.
	$_rmes§ge_»®
(
£lf
.
_CObj
 , 
key
 , 0)

49 
’d


51 
funùiÚ
 
_»ad”
:
	$¡ršg
(
key
)

52  
c
.
	$_rmes§ge_¡ršg
(
£lf
.
_CObj
 , 
key
 , 0)

53 
’d


55 
funùiÚ
 
_»ad”
:
	$boŞ
(
key
)

56  
c
.
	`_rmes§ge_št
(
£lf
.
_CObj
 , 
key
 , 0) ~= 0

57 
’d


59 
funùiÚ
 
_»ad”
:
	$mes§ge
(
key
, 
mes§ge_ty³
)

60 
loÿl
 
rmes§ge
 = 
c
.
	$_rmes§ge_mes§ge
(
£lf
.
_CObj
 , 
key
 , 0)

61 
rmes§ge
 
th’


62 
loÿl
 
v
 = {

63 
_CObj
 = 
rmes§ge
,

64 
_CTy³
 = 
mes§ge_ty³
,

65 
_P¬’t
 = 
£lf
,

66 
	}
}

67  
	$£tm‘©abË
Ğ
v
 , 
_R_m‘a
 )

68 
’d


69 
’d


71 
funùiÚ
 
_»ad”
:(
key
)

72  
c
.
	$_rmes§ge_št
(
£lf
.
_CObj
 , 
key
 , 0)

73 
’d


75 
funùiÚ
 
_»ad”
:
	$»®_»³©ed
(
key
)

76 
loÿl
 
cobj
 = 
£lf
.
_CObj


77 
loÿl
 
n
 = 
c
.
	$_rmes§ge_size
(
cobj
 , 
key
)

78 
loÿl
 
»t
 = {
	}
}

79 
i
=0,
	gn
-1 do

80 
tš£¹
(
»t
, 
c
.
	$_rmes§ge_»®
(
cobj
 , 
key
 , 
i
))

81 
’d


82  
»t


83 
’d


85 
funùiÚ
 
_»ad”
:
	$¡ršg_»³©ed
(
key
)

86 
loÿl
 
cobj
 = 
£lf
.
_CObj


87 
loÿl
 
n
 = 
c
.
	$_rmes§ge_size
(
cobj
 , 
key
)

88 
loÿl
 
»t
 = {
	}
}

89 
i
=0,
	gn
-1 do

90 
tš£¹
(
»t
, 
c
.
	$_rmes§ge_¡ršg
(
cobj
 , 
key
 , 
i
))

91 
’d


92  
»t


93 
’d


95 
funùiÚ
 
_»ad”
:
	$boŞ_»³©ed
(
key
)

96 
loÿl
 
cobj
 = 
£lf
.
_CObj


97 
loÿl
 
n
 = 
c
.
	$_rmes§ge_size
(
cobj
 , 
key
)

98 
loÿl
 
»t
 = {
	}
}

99 
i
=0,
	gn
-1 do

100 
tš£¹
(
»t
, 
c
.
_rmes§ge_št
(
cobj
 , 
key
 , 
i
) ~= 0)

101 
’d


102  
»t


103 
’d


105 
funùiÚ
 
_»ad”
:
	$mes§ge_»³©ed
(
key
, 
mes§ge_ty³
)

106 
loÿl
 
cobj
 = 
£lf
.
_CObj


107 
loÿl
 
n
 = 
c
.
	$_rmes§ge_size
(
cobj
 , 
key
)

108 
loÿl
 
»t
 = {
	}
}

109 
i
=0,
	gn
-1 do

110 
loÿl
 
	gm
 = {

111 
_CObj
 = 
c
.
_rmes§ge_mes§ge
(
cobj
 , 
key
 , 
i
),

112 
	g_CTy³
 = 
mes§ge_ty³
,

113 
	g_P¬’t
 = 
£lf
,

115 
tš£¹
(
»t
, 
	$£tm‘©abË
Ğ
m
 , 
_R_m‘a
 ))

116 
’d


117  
»t


118 
’d


120 
funùiÚ
 
_»ad”
:
	$št_»³©ed
(
key
)

121 
loÿl
 
cobj
 = 
£lf
.
_CObj


122 
loÿl
 
n
 = 
c
.
	$_rmes§ge_size
(
cobj
 , 
key
)

123 
loÿl
 
»t
 = {
	}
}

124 
i
=0,
	gn
-1 do

125 
tš£¹
(
»t
, 
c
.
	$_rmes§ge_št
(
cobj
 , 
key
 , 
i
))

126 
’d


127  
»t


128 
’d


131 
	#PBC_INT
 1

	)

132 
	#PBC_REAL
 2

	)

133 
	#PBC_BOOL
 3

	)

134 
	#PBC_ENUM
 4

	)

135 
	#PBC_STRING
 5

	)

136 
	#PBC_MESSAGE
 6

	)

137 
	#PBC_FIXED64
 7

	)

138 
	#PBC_FIXED32
 8

	)

139 
	#PBC_BYTES
 9

	)

140 
	#PBC_INT64
 10

	)

141 
	#PBC_UINT
 11

	)

142 
	#PBC_UNKNOWN
 12

	)

143 
	#PBC_REPEATED
 128

	)

146 
_»ad”
[1] = 
	$funùiÚ
(
msg
è 
_»ad”
.
’d


147 
_»ad”
[2] = 
	$funùiÚ
(
msg
è 
_»ad”
.
»®
 
’d


148 
_»ad”
[3] = 
	$funùiÚ
(
msg
è 
_»ad”
.
boŞ
 
’d


149 
_»ad”
[4] = 
	$funùiÚ
(
msg
è 
_»ad”
.
¡ršg
 
’d


150 
_»ad”
[5] = 
	$funùiÚ
(
msg
è 
_»ad”
.
¡ršg
 
’d


151 
_»ad”
[6] = 
	$funùiÚ
(
msg
)

152 
loÿl
 
mes§ge
 = 
_»ad”
.message

153  
	$funùiÚ
(
£lf
,
key
)

154  
	$mes§ge
(
£lf
, 
key
, 
msg
)

155 
’d


156 
’d


157 
_»ad”
[7] = _reader[1]

158 
_»ad”
[8] = _reader[1]

159 
_»ad”
[9] = _reader[5]

160 
_»ad”
[10] = _reader[7]

161 
_»ad”
[11] = _reader[7]

163 
_»ad”
[128+1] = 
	$funùiÚ
(
msg
è 
_»ad”
.
št_»³©ed
 
’d


164 
_»ad”
[128+2] = 
	$funùiÚ
(
msg
è 
_»ad”
.
»®_»³©ed
 
’d


165 
_»ad”
[128+3] = 
	$funùiÚ
(
msg
è 
_»ad”
.
boŞ_»³©ed
 
’d


166 
_»ad”
[128+4] = 
	$funùiÚ
(
msg
è 
_»ad”
.
¡ršg_»³©ed
 
’d


167 
_»ad”
[128+5] = 
	$funùiÚ
(
msg
è 
_»ad”
.
¡ršg_»³©ed
 
’d


168 
_»ad”
[128+6] = 
	$funùiÚ
(
msg
)

169 
loÿl
 
mes§ge
 = 
_»ad”
.
mes§ge_»³©ed


170  
	$funùiÚ
(
£lf
,
key
)

171  
	$mes§ge
(
£lf
, 
key
, 
msg
)

172 
’d


173 
’d


174 
_»ad”
[128+7] = _reader[128+1]

175 
_»ad”
[128+8] = _reader[128+1]

176 
_»ad”
[128+9] = _reader[128+5]

177 
_»ad”
[128+10] = _reader[128+7]

178 
_»ad”
[128+11] = _reader[128+7]

180 
loÿl
 
_decode_ty³_m‘a
 = {
	}
}

182 
funùiÚ
 
_decode_ty³_m‘a
:
	$__šdex
(
key
)

183 
loÿl
 
t
, 
msg
 = 
c
.
	$_’v_ty³
(
P
, 
£lf
.
_CTy³
, 
key
)

184 
loÿl
 
func
 = 
	$as£¹
(
_»ad”
[
t
],
key
)(
msg
)

185 
£lf
[
key
] = 
func


186  
func


187 
’d


189 
	`£tm‘©abË
(
decode_ty³_ÿche
 , {

190 
__šdex
 = 
	`funùiÚ
(
£lf
, 
key
)

191 
loÿl
 
v
 = 
	`£tm‘©abË
({ 
_CTy³
 = 
key
 } , 
_decode_ty³_m‘a
)

192 
£lf
[
key
] = 
v


193  
v


194 
’d


195 
	}
})

197 
loÿl
 
funùiÚ
 
	$decode_mes§ge
Ğ
mes§ge
 , 
bufãr
, 
Ëngth
)

198 
loÿl
 
rmes§ge
 = 
c
.
	$_rmes§ge_Ãw
(
P
, 
mes§ge
, 
bufãr
, 
Ëngth
)

199 
rmes§ge
 
th’


200 
loÿl
 
£lf
 = {

201 
_CObj
 = 
rmes§ge
,

202 
_CTy³
 = 
mes§ge
,

203 
	}
}

204 
	gc
.
	$_add_rmes§ge
(
GC
,
rmes§ge
)

205  
	$£tm‘©abË
Ğ
£lf
 , 
_R_m‘a
 )

206 
’d


207 
’d


209 ----------- 
’code
 ----------------

211 
loÿl
 
’code_ty³_ÿche
 = {
	}
}

213 
loÿl
 
funùiÚ
 
	$’code_mes§ge
(
CObj
, 
mes§ge_ty³
, 
t
)

214 
loÿl
 
ty³
 = 
’code_ty³_ÿche
[
mes§ge_ty³
]

215 
k
,
v
 
š
 
	$·œs
(
t
) do

216 
loÿl
 
func
 = 
ty³
[
k
]

217 
	$func
(
CObj
, 
k
 , 
v
)

218 
’d


219 
’d


221 
loÿl
 
_wr™”
 = {

222 
»®
 = 
c
.
_wmes§ge_»®
,

223 ğ
c
.
_wmes§ge_¡ršg
,

224 
¡ršg
 = 
c
.
_wmes§ge_¡ršg
,

225 ğ
c
.
_wmes§ge_št
,

226 
	}
}

228 
funùiÚ
 
	g_wr™”
:
	$boŞ
(
k
,
v
)

229 
c
.
	$_wmes§ge_št
(
£lf
, 
k
, 
v
 
ªd
 1 
Ü
 0)

230 
’d


232 
funùiÚ
 
_wr™”
:
	$mes§ge
(
k
, 
v
 , 
mes§ge_ty³
)

233 
loÿl
 
submes§ge
 = 
c
.
	$_wmes§ge_mes§ge
(
£lf
, 
k
)

234 
	$’code_mes§ge
(
submes§ge
, 
mes§ge_ty³
, 
v
)

235 
’d


237 
funùiÚ
 
_wr™”
:
	$»®_»³©ed
(
k
,
v
)

238 
_
,
v
 
š
 
	$aœs
(
v
) do

239 
c
.
	$_wmes§ge_»®
(
£lf
,
k
,
v
)

240 
’d


241 
’d


243 
funùiÚ
 
_wr™”
:
	$boŞ_»³©ed
(
k
,
v
)

244 
_
,
v
 
š
 
	$aœs
(
v
) do

245 
c
.
	$_wmes§ge_št
(
£lf
, 
k
, 
v
 
ªd
 1 
Ü
 0)

246 
’d


247 
’d


249 
funùiÚ
 
_wr™”
:
	$¡ršg_»³©ed
(
k
,
v
)

250 
_
,
v
 
š
 
	$aœs
(
v
) do

251 
c
.
	$_wmes§ge_¡ršg
(
£lf
,
k
,
v
)

252 
’d


253 
’d


255 
funùiÚ
 
_wr™”
:
	$mes§ge_»³©ed
(
k
,
v
, 
mes§ge_ty³
)

256 
_
,
v
 
š
 
	$aœs
(
v
) do

257 
loÿl
 
submes§ge
 = 
c
.
	$_wmes§ge_mes§ge
(
£lf
, 
k
)

258 
	$’code_mes§ge
(
submes§ge
, 
mes§ge_ty³
, 
v
)

259 
’d


260 
’d


262 
funùiÚ
 
_wr™”
:
	$št_»³©ed
(
k
,
v
)

263 
_
,
v
 
š
 
	$aœs
(
v
) do

264 
c
.
	$_wmes§ge_št
(
£lf
,
k
,
v
)

265 
’d


266 
’d


268 
_wr™”
[1] = 
	$funùiÚ
(
msg
è 
_wr™”
.
’d


269 
_wr™”
[2] = 
	$funùiÚ
(
msg
è 
_wr™”
.
»®
 
’d


270 
_wr™”
[3] = 
	$funùiÚ
(
msg
è 
_wr™”
.
boŞ
 
’d


271 
_wr™”
[4] = 
	$funùiÚ
(
msg
è 
_wr™”
.
¡ršg
 
’d


272 
_wr™”
[5] = 
	$funùiÚ
(
msg
è 
_wr™”
.
¡ršg
 
’d


273 
_wr™”
[6] = 
	$funùiÚ
(
msg
)

274 
loÿl
 
mes§ge
 = 
_wr™”
.message

275  
	$funùiÚ
(
£lf
,
key
 , 
v
)

276  
	$mes§ge
(
£lf
, 
key
, 
v
, 
msg
)

277 
’d


278 
’d


279 
_wr™”
[7] = _writer[1]

280 
_wr™”
[8] = _writer[1]

281 
_wr™”
[9] = _writer[5]

282 
_wr™”
[10] = _writer[7]

283 
_wr™”
[11] = _writer[7]

285 
_wr™”
[128+1] = 
	$funùiÚ
(
msg
è 
_wr™”
.
št_»³©ed
 
’d


286 
_wr™”
[128+2] = 
	$funùiÚ
(
msg
è 
_wr™”
.
»®_»³©ed
 
’d


287 
_wr™”
[128+3] = 
	$funùiÚ
(
msg
è 
_wr™”
.
boŞ_»³©ed
 
’d


288 
_wr™”
[128+4] = 
	$funùiÚ
(
msg
è 
_wr™”
.
¡ršg_»³©ed
 
’d


289 
_wr™”
[128+5] = 
	$funùiÚ
(
msg
è 
_wr™”
.
¡ršg_»³©ed
 
’d


290 
_wr™”
[128+6] = 
	$funùiÚ
(
msg
)

291 
loÿl
 
mes§ge
 = 
_wr™”
.
mes§ge_»³©ed


292  
	$funùiÚ
(
£lf
,
key
, 
v
)

293  
	$mes§ge
(
£lf
, 
key
, 
v
, 
msg
)

294 
’d


295 
’d


297 
_wr™”
[128+7] = _writer[128+1]

298 
_wr™”
[128+8] = _writer[128+1]

299 
_wr™”
[128+9] = _writer[128+5]

300 
_wr™”
[128+10] = _writer[128+7]

301 
_wr™”
[128+11] = _writer[128+7]

303 
loÿl
 
_’code_ty³_m‘a
 = {
	}
}

305 
funùiÚ
 
_’code_ty³_m‘a
:
	$__šdex
(
key
)

306 
loÿl
 
t
, 
msg
 = 
c
.
	$_’v_ty³
(
P
, 
£lf
.
_CTy³
, 
key
)

307 
loÿl
 
func
 = 
	$as£¹
(
_wr™”
[
t
],
key
)(
msg
)

308 
£lf
[
key
] = 
func


309  
func


310 
’d


312 
	`£tm‘©abË
(
’code_ty³_ÿche
 , {

313 
__šdex
 = 
	`funùiÚ
(
£lf
, 
key
)

314 
loÿl
 
v
 = 
	`£tm‘©abË
({ 
_CTy³
 = 
key
 } , 
_’code_ty³_m‘a
)

315 
£lf
[
key
] = 
v


316  
v


317 
’d


318 
	}
})

320 
funùiÚ
 
	gM
.
	$’code
Ğ
mes§ge
, 
t
 , 
func
 , ...)

321 
loÿl
 
’cod”
 = 
c
.
	$_wmes§ge_Ãw
(
P
, 
mes§ge
)

322 
	$as£¹
(
’cod”
 , 
mes§ge
)

323 
	$’code_mes§ge
(
’cod”
, 
mes§ge
, 
t
)

324 
func
 
th’


325 
loÿl
 
bufãr
, 
Ën
 = 
c
.
	$_wmes§ge_bufãr
(
’cod”
)

326 
loÿl
 
»t
 = 
	$func
(
bufãr
, 
Ën
, ...)

327 
c
.
	$_wmes§ge_d–‘e
(
’cod”
)

328  
»t


330 
loÿl
 
s
 = 
c
.
	$_wmes§ge_bufãr_¡ršg
(
’cod”
)

331 
c
.
	$_wmes§ge_d–‘e
(
’cod”
)

332  
s


333 
’d


334 
’d


336 --------- 
uÅack
 ----------

338 
loÿl
 
_·‰”n_ty³
 = {

351 
	}
}

353 
	g_·‰”n_ty³
[4] = 
_·‰”n_ty³
[1]

354 
_·‰”n_ty³
[8] = _pattern_type[1]

355 
_·‰”n_ty³
[9] = _pattern_type[5]

356 
_·‰”n_ty³
[10] = _pattern_type[7]

357 
_·‰”n_ty³
[11] = _pattern_type[7]

358 
_·‰”n_ty³
[128+4] = _pattern_type[128+1]

359 
_·‰”n_ty³
[128+8] = _pattern_type[128+1]

360 
_·‰”n_ty³
[128+9] = _pattern_type[128+5]

361 
_·‰”n_ty³
[128+10] = _pattern_type[128+7]

362 
_·‰”n_ty³
[128+11] = _pattern_type[128+7]

365 
loÿl
 
funùiÚ
 
	$_·‰”n_ü—‹
(
·‰”n
)

366 
loÿl
 
™”
 = 
¡ršg
.
	`gm©ch
(
·‰”n
,"[^ ]+")

367 
loÿl
 
mes§ge
 = 
	$™”
()

368 
loÿl
 
ı©
 = {
	}
}

369 
loÿl
 
lua
 = {}

370 
v
 
š
 
™”
 do

371 
loÿl
 
tidx
 = 
c
.
	$_’v_ty³
(
P
, 
mes§ge
, 
v
)

372 
loÿl
 
t
 = 
_·‰”n_ty³
[
tidx
]

373 
	$as£¹
(
t
,
tidx
)

374 
	`tš£¹
(
ı©
,
v
 .. " " .. 
t
[1])

375 
	$tš£¹
(
lua
,
t
[2])

376 
’d


377 
loÿl
 
cobj
 = 
c
.
	`_·‰”n_Ãw
(
P
, 
mes§ge
 , "@" .. 
bË
.
	`cÚÿt
(
ı©
," "))

378 
cobj
 =ğ
n
 
th’


380 
’d


381 
c
.
	$_add_·‰”n
(
GC
, 
cobj
)

382 
loÿl
 
·t
 = {

383 
CObj
 = 
cobj
,

384 
fÜm©
 = 
bË
.
	`cÚÿt
(
lua
),

385 
size
 = 0

386 
	}
}

387 
	g·t
.
	gsize
 = 
c
.
	$_·‰”n_size
(
·t
.
fÜm©
)

389  
·t


390 
’d


392 
	`£tm‘©abË
(
_·‰”n_ÿche
, {

393 
__šdex
 = 
	`funùiÚ
(
t
, 
key
)

394 
loÿl
 
v
 = 
	`_·‰”n_ü—‹
(
key
)

395 
t
[
key
] = 
v


396  
v


397 
’d


398 
	}
})

400 
funùiÚ
 
	gM
.
	$uÅack
(
·‰”n
, 
bufãr
, 
Ëngth
)

401 
loÿl
 
·t
 = 
_·‰”n_ÿche
[
·‰”n
]

402  
c
.
	$_·‰”n_uÅack
(
·t
.
CObj
 ,…©.
fÜm©
,…©.
size
, 
bufãr
, 
Ëngth
)

403 
’d


405 
funùiÚ
 
M
.
	$·ck
(
·‰”n
, ...)

406 
loÿl
 
·t
 = 
_·‰”n_ÿche
[
·‰”n
]

407  
c
.
	$_·‰”n_·ck
(
·t
.
CObj
,…©.
fÜm©
,…©.
size
 , ...)

408 
’d


410 
funùiÚ
 
M
.
	$check
(
ty³Çme
 , 
f›ld
)

411 
f›ld
 =ğ
n
 
th’


412  
c
.
	$_’v_ty³
(
P
,
ty³Çme
)

414  
c
.
	`_’v_ty³
(
P
,
ty³Çme
,
f›ld
) ~=0

415 
’d


416 
’d


420 
loÿl
 
deçuÉ_ÿche
 = {
	}
}

422 -- 
todo
 : 
ş—r
 
deçuÉ_ÿche
, 
	gv
.
_CObj


424 
loÿl
 
funùiÚ
 
	$deçuÉ_bË
(
ty³Çme
)

425 
loÿl
 
v
 = 
deçuÉ_ÿche
[
ty³Çme
]

426 
v
 
th’


427  
v


428 
’d


430 
v
 = { 
__šdex
 = 
	`as£¹
(
	`decode_mes§ge
(
ty³Çme
 , "")è
	}
}

432 
	gdeçuÉ_ÿche
[
ty³Çme
] = 
v


433  
v


434 
’d


436 
loÿl
 
decode_mes§ge_mt
 = {}

438 
loÿl
 
funùiÚ
 
	$decode_mes§ge_cb
(
ty³Çme
, 
bufãr
)

439  
	`£tm‘©abË
 ( { 
ty³Çme
, 
bufãr
 
	}
} , 
	gdecode_mes§ge_mt
)

440 
’d


442 
funùiÚ
 
	gM
.
	$decode
(
ty³Çme
, 
bufãr
, 
Ëngth
)

443 
loÿl
 
»t
 = {
	}
}

444 
loÿl
 
ok
 = 
c
.
	$_decode
(
P
, 
decode_mes§ge_cb
 , 
»t
 , 
ty³Çme
, 
bufãr
, 
Ëngth
)

445 
ok
 
th’


446  
	`£tm‘©abË
(
»t
 , 
	$deçuÉ_bË
(
ty³Çme
))

448  
çl£
 , 
c
.
	$_Ï¡_”rÜ
(
P
)

449 
’d


450 
’d


452 
loÿl
 
funùiÚ
 
	$ex·nd
(
tbl
)

453 
loÿl
 
ty³Çme
 = 
	$¿wg‘
(
tbl
 , 1)

454 
loÿl
 
bufãr
 = 
	$¿wg‘
(
tbl
 , 2)

455 
tbl
[1] ,bl[2] = 
n
 ,‚il

456 
	`as£¹
(
c
.
	`_decode
(
P
, 
decode_mes§ge_cb
 , 
tbl
 , 
ty³Çme
, 
bufãr
),ypename)

457 
	`£tm‘©abË
(
tbl
 , 
	$deçuÉ_bË
(
ty³Çme
))

458 
’d


460 
funùiÚ
 
decode_mes§ge_mt
.
	$__šdex
(
tbl
, 
key
)

461 
	$ex·nd
(
tbl
)

462  
tbl
[
key
]

463 
’d


465 
funùiÚ
 
decode_mes§ge_mt
.
	$__·œs
(
tbl
)

466 
	$ex·nd
(
tbl
)

467  
	$·œs
(
tbl
)

468 
’d


470 
loÿl
 
funùiÚ
 
	$£t_deçuÉ
(
ty³Çme
, 
tbl
)

471 
k
,
v
 
š
 
	$·œs
(
tbl
) do

472 
	`ty³
(
v
è=ğ"bË" 
th’


473 
loÿl
 
t
, 
msg
 = 
c
.
	$_’v_ty³
(
P
, 
ty³Çme
, 
k
)

474 
t
 =ğ6 
th’


475 
	$£t_deçuÉ
(
msg
, 
v
)

476 
–£if
 
t
 =ğ128+6 
th’


477 
_
,
v
 
š
 
	$aœs
(
v
) do

478 
	$£t_deçuÉ
(
msg
, 
v
)

479 
’d


480 
’d


481 
’d


482 
’d


483  
	`£tm‘©abË
(
tbl
 , 
	$deçuÉ_bË
(
ty³Çme
))

484 
’d


486 
funùiÚ
 
M
.(
bufãr
)

487 
c
.
	$_’v_»gi¡”
(
P
, 
bufãr
)

488 
’d


490 
funùiÚ
 
M
.
	$»gi¡”_fe
(
f’ame
)

491 
loÿl
 
f
 = 
	`as£¹
(
io
.
	`İ’
(
f’ame
 , "rb"))

492 
loÿl
 
bufãr
 = 
f
:
»ad
 "*a"

493 
c
.
	$_’v_»gi¡”
(
P
, 
bufãr
)

494 
f
:
	$şo£
()

495 
’d


497 
funùiÚ
 
M
.
	$’um_id
(
’um_ty³
, 
’um_Çme
)

498  
c
.
	$_’v_’um_id
(
P
, 
’um_ty³
, 
’um_Çme
)

499 
’d


501 
funùiÚ
 
M
.
	$exŒaù
(
tbl
)

502 
loÿl
 
ty³Çme
 = 
	$¿wg‘
(
tbl
 , 1)

503 
loÿl
 
bufãr
 = 
	$¿wg‘
(
tbl
 , 2)

504 
	`ty³
(
ty³Çme
è=ğ"¡ršg" 
ªd
y³(
bufãr
è=ğ"¡ršg" 
th’


505 
M
.
	$check
(
ty³Çme
è
th’


506 
	$ex·nd
(
tbl
)

507 
’d


508 
’d


510 
k
, 
v
 
š
 
	$·œs
(
tbl
) do

511 
	`ty³
(
v
è=ğ"bË" 
th’


512 
M
.
	$exŒaù
(
v
)

513 
’d


514 
’d


515 
’d


517 
M
.=
£t_deçuÉ


519  
M


	@binding/lua53/test.lua

1 
loÿl
 
	g´Ùobuf
 = 
»quœe
 "protobuf"

3 
addr
 = 
io
.
İ’
("../../build/addressbook.pb","rb")

4 
	gbufãr
 = 
addr
:
»ad
 "*a"

5 
addr
:
	$şo£
()

7 
´Ùobuf
.(
bufãr
)

9 
t
 = 
´Ùobuf
.
	`decode
("googË.´Ùobuf.FeDesütÜS‘", 
bufãr
)

11 
´Ùo
 = 
t
.
fe
[1]

13 
	$´št
(
´Ùo
.
Çme
)

14 
	$´št
(
´Ùo
.
·ckage
)

16 
mes§ge
 = 
´Ùo
.
mes§ge_ty³


18 
_
,
v
 
š
 
	$aœs
(
mes§ge
) do

19 
	$´št
(
v
.
Çme
)

20 
_
,
v
 
š
 
	$aœs
(
v
.
f›ld
) do

21 
	`´št
("\t".. 
v
.
Çme
 .. " ["..v.
numb”
.."] " .. v.
Ïb–
)

22 
’d


23 
’d


25 
add»ssbook
 = {

26 
Çme
 = "Alice",

27 
id
 = 12345,

28 
phÚe
 = {

29 { 
numb”
 = "1301234567" },

30 { 
numb”
 = "87654321", 
ty³
 = "WORK" },

32 
	}
}

34 
	gcode
 = 
´Ùobuf
.
’code
("tutÜŸl.P”sÚ", 
add»ssbook
)

36 
	gdecode
 = 
´Ùobuf
.
decode
("tutÜŸl.P”sÚ" , 
code
)

38 
	$´št
(
decode
.
Çme
)

39 
	$´št
(
decode
.
id
)

40 
_
,
v
 
š
 
	$aœs
(
decode
.
phÚe
) do

41 
	`´št
("\t"..
v
.
numb”
, v.
ty³
)

42 
’d


44 
phÚebuf
 = 
´Ùobuf
.
	`·ck
("tutorial.Person.PhoneNumber‚umber","87654321")

45 
bufãr
 = 
´Ùobuf
.
	`·ck
("tutÜŸl.P”sÚ‚amid…hÚe", "Aliû", 123, { 
phÚebuf
 
	}
})

46 
´št
(
´Ùobuf
.
uÅack
("tutÜŸl.P”sÚ‚amid…hÚe", 
bufãr
))

	@pbc.h

1 #iâdeà
PROTOBUF_C_H


2 
	#PROTOBUF_C_H


	)

4 
	~<¡dio.h
>

5 
	~<¡dšt.h
>

7 
	#PBC_ARRAY_CAP
 64

	)

9 
	#PBC_NOEXIST
 -1

	)

10 
	#PBC_INT
 1

	)

11 
	#PBC_REAL
 2

	)

12 
	#PBC_BOOL
 3

	)

13 
	#PBC_ENUM
 4

	)

14 
	#PBC_STRING
 5

	)

15 
	#PBC_MESSAGE
 6

	)

16 
	#PBC_FIXED64
 7

	)

17 
	#PBC_FIXED32
 8

	)

18 
	#PBC_BYTES
 9

	)

19 
	#PBC_INT64
 10

	)

20 
	#PBC_UINT
 11

	)

21 
	#PBC_UNKNOWN
 12

	)

22 
	#PBC_REPEATED
 128

	)

24 #ifdeà
__ılu¥lus


28 
	s_pbc_¬¿y
 { 
_d©a
[
PBC_ARRAY_CAP
]; } 
	tpbc_¬¿y
[1];

30 
	spbc_¦iû
 {

31 *
bufãr
;

32 
Ën
;

35 
pbc_·‰”n
;

36 
pbc_’v
;

37 
pbc_rmes§ge
;

38 
pbc_wmes§ge
;

40 
pbc_’v
 * 
pbc_Ãw
();

41 
pbc_d–‘e
(
pbc_’v
 *);

42 
pbc_»gi¡”
(
pbc_’v
 *, 
pbc_¦iû
 * 
¦iû
);

43 
pbc_ty³
(
pbc_’v
 *, cÚ¡ * 
ty³_Çme
 , cÚ¡ * 
key
 , cÚ¡ ** 
ty³
);

44 cÚ¡ * 
pbc_”rÜ
(
pbc_’v
 *);

47 
	upbc_v®ue
 {

49 
ušt32_t
 
low
;

50 
ušt32_t
 
hi
;

51 } 
i
;

52 
f
;

53 
pbc_¦iû
 
s
;

55 
id
;

56 cÚ¡ * 
Çme
;

57 } 
e
;

60 (*
pbc_decod”
)(*
	tud
, 
	tty³
, cÚ¡ * 
	tty³_Çme
, 
	tpbc_v®ue
 *
	tv
, 
	tid
, cÚ¡ *
	tkey
);

61 
pbc_decode
(
pbc_’v
 * 
’v
, cÚ¡ * 
ty³_Çme
 , 
pbc_¦iû
 * 
¦iû
, 
pbc_decod”
 
f
, *
ud
);

65 
pbc_rmes§ge
 * 
pbc_rmes§ge_Ãw
(
pbc_’v
 * 
’v
, cÚ¡ * 
ty³_Çme
 , 
pbc_¦iû
 * 
¦iû
);

66 
pbc_rmes§ge_d–‘e
(
pbc_rmes§ge
 *);

68 
ušt32_t
 
pbc_rmes§ge_š‹g”
(
pbc_rmes§ge
 * , cÚ¡ *
key
 , 
šdex
, ušt32_ˆ*
hi
);

69 
pbc_rmes§ge_»®
(
pbc_rmes§ge
 * , cÚ¡ *
key
 , 
šdex
);

70 cÚ¡ * 
pbc_rmes§ge_¡ršg
(
pbc_rmes§ge
 * , cÚ¡ *
key
 , 
šdex
, *
sz
);

71 
pbc_rmes§ge
 * 
pbc_rmes§ge_mes§ge
(pbc_rmes§g*, cÚ¡ *
key
, 
šdex
);

72 
pbc_rmes§ge_size
(
pbc_rmes§ge
 *, cÚ¡ *
key
);

73 
pbc_rmes§ge_Ãxt
(
pbc_rmes§ge
 *, cÚ¡ **
key
);

75 
pbc_wmes§ge
 * 
pbc_wmes§ge_Ãw
(
pbc_’v
 * 
’v
, cÚ¡ *
ty³_Çme
);

76 
pbc_wmes§ge_d–‘e
(
pbc_wmes§ge
 *);

79 
pbc_wmes§ge_š‹g”
(
pbc_wmes§ge
 *, cÚ¡ *
key
, 
ušt32_t
 
low
, ušt32_ˆ
hi
);

80 
pbc_wmes§ge_»®
(
pbc_wmes§ge
 *, cÚ¡ *
key
, 
v
);

81 
pbc_wmes§ge_¡ršg
(
pbc_wmes§ge
 *, cÚ¡ *
key
, cÚ¡ * 
v
, 
Ën
);

82 
pbc_wmes§ge
 * 
pbc_wmes§ge_mes§ge
(pbc_wmes§g*, cÚ¡ *
key
);

83 * 
pbc_wmes§ge_bufãr
(
pbc_wmes§ge
 *, 
pbc_¦iû
 * 
¦iû
);

87 
pbc_¬¿y_size
(
pbc_¬¿y
);

88 
ušt32_t
 
pbc_¬¿y_š‹g”
(
pbc_¬¿y
 
¬¿y
, 
šdex
, ušt32_ˆ*
hi
);

89 
pbc_¬¿y_»®
(
pbc_¬¿y
 
¬¿y
, 
šdex
);

90 
pbc_¦iû
 * 
pbc_¬¿y_¦iû
(
pbc_¬¿y
 
¬¿y
, 
šdex
);

92 
pbc_¬¿y_push_š‹g”
(
pbc_¬¿y
 
¬¿y
, 
ušt32_t
 
low
, ušt32_ˆ
hi
);

93 
pbc_¬¿y_push_¦iû
(
pbc_¬¿y
 
¬¿y
, 
pbc_¦iû
 *);

94 
pbc_¬¿y_push_»®
(
pbc_¬¿y
 
¬¿y
, 
v
);

96 
pbc_·‰”n
 * 
pbc_·‰”n_Ãw
(
pbc_’v
 * , cÚ¡ * 
mes§ge
, cÚ¡ *
fÜm©
, ...);

97 
pbc_·‰”n_d–‘e
(
pbc_·‰”n
 *);

100 
pbc_·‰”n_·ck
(
pbc_·‰”n
 *, *
šput
, 
pbc_¦iû
 * 
s
);

103 
pbc_·‰”n_uÅack
(
pbc_·‰”n
 *, 
pbc_¦iû
 * 
s
 , * 
ouut
);

105 
pbc_·‰”n_£t_deçuÉ
(
pbc_·‰”n
 * , *
d©a
);

106 
pbc_·‰”n_şo£_¬¿ys
(
pbc_·‰”n
 *, *
d©a
);

108 
pbc_’um_id
(
pbc_’v
 *
’v
, cÚ¡ *
’um_ty³
, cÚ¡ *
’um_Çme
);

110 #ifdeà
__ılu¥lus


	@src/alloc.c

1 
	~<¡dlib.h
>

2 
	~<¡dio.h
>

4 
	g_g
 = 0;

6 * 
	$_pbcM_m®loc
(
size_t
 
sz
) {

7 ++ 
_g
;

8  
	`m®loc
(
sz
);

9 
	}
}

11 
	$_pbcM_ä“
(*
p
) {

12 ià(
p
) {

13 -- 
_g
;

14 
	`ä“
(
p
);

16 
	}
}

18 * 
	$_pbcM_»®loc
(*
p
, 
size_t
 
sz
) {

19  
	`»®loc
(
p
,
sz
);

20 
	}
}

22 
	$_pbcM_memÜy
() {

23 
	`´štf
("%d\n",
_g
);

24 
	}
}

26 
	sh—p_·ge
 {

27 
h—p_·ge
 * 
	mÃxt
;

30 
	sh—p
 {

31 
h—p_·ge
 *
	mcu¼’t
;

32 
	msize
;

33 
	mu£d
;

36 
h—p
 *

37 
	$_pbcH_Ãw
(
·gesize
) {

38 
ÿp
 = 1024;

39 
ÿp
 < 
·gesize
) {

40 
ÿp
 *= 2;

42 
h—p
 * 
h
 = (h—°*)
	`_pbcM_m®loc
((heap));

43 
h
->
cu¼’t
 = (
h—p_·ge
 *)
	`_pbcM_m®loc
((h—p_·geè+ 
ÿp
);

44 
h
->
size
 = 
ÿp
;

45 
h
->
u£d
 = 0;

46 
h
->
cu¼’t
->
Ãxt
 = 
NULL
;

47  
h
;

48 
	}
}

51 
	$_pbcH_d–‘e
(
h—p
 *
h
) {

52 
h—p_·ge
 * 
p
 = 
h
->
cu¼’t
;

53 
h—p_·ge
 * 
Ãxt
 = 
p
->next;

55 
	`_pbcM_ä“
(
p
);

56 ià(
Ãxt
 =ğ
NULL
)

58 
p
 = 
Ãxt
;

59 
Ãxt
 = 
p
->next;

61 
	`_pbcM_ä“
(
h
);

62 
	}
}

65 
	$_pbcH_®loc
(
h—p
 *
h
, 
size
) {

66 
size
 = (size + 3) & ~3;

67 ià(
h
->
size
 - h->
u£d
 < size) {

68 
h—p_·ge
 * 
p
;

69 ià(
size
 < 
h
->size) {

70 
p
 = (
h—p_·ge
 *)
	`_pbcM_m®loc
((h—p_·geè+ 
h
->
size
);

72 
p
 = (
h—p_·ge
 *)
	`_pbcM_m®loc
((h—p_·geè+ 
size
);

74 
p
->
Ãxt
 = 
h
->
cu¼’t
;

75 
h
->
cu¼’t
 = 
p
;

76 
h
->
u£d
 = 
size
;

77  (
p
+1);

79 * 
bufãr
 = (*)(
h
->
cu¼’t
 + 1);

80 
bufãr
 +ğ
h
->
u£d
;

81 
h
->
u£d
 +ğ
size
;

82  
bufãr
;

84 
	}
}

	@src/alloc.h

1 #iâdeà
PROTOBUF_C_ALLOC_H


2 
	#PROTOBUF_C_ALLOC_H


	)

4 
	~<¡dlib.h
>

5 
	~<¡ršg.h
>

7 * 
_pbcM_m®loc
(
size_t
 
sz
);

8 
_pbcM_ä“
(*
p
);

9 * 
_pbcM_»®loc
(*
p
, 
size_t
 
sz
);

10 
_pbcM_memÜy
();

12 
	gh—p
;

14 
h—p
 * 
_pbcH_Ãw
(
·gesize
);

15 
_pbcH_d–‘e
(
h—p
 *);

16 * 
_pbcH_®loc
(
h—p
 *, 
size
);

18 
	#HMALLOC
(
size
è((
h
è? 
	`_pbcH_®loc
(h, sizeè: 
	`_pbcM_m®loc
(size))

	)

20 
	#m®loc
 
_pbcM_m®loc


	)

21 
	#ä“
 
_pbcM_ä“


	)

22 
	#»®loc
 
_pbcM_»®loc


	)

23 
	#memÜy
 
_pbcM_memÜy


	)

25 #ifdeà
_WIN32


27 
	~<m®loc.h
>

31 #ifdeà
_MSC_VER


33 
	#®loÿ
 
_®loÿ


	)

	@src/array.c

1 
	~"pbc.h
"

2 
	~"¬¿y.h
"

3 
	~"®loc.h
"

5 
	~<¡dlib.h
>

6 
	~<¡ršg.h
>

8 
	s¬¿y
 {

9 
	mnumb”
;

10 
h—p
 *
	mh—p
;

11 
_pbc_v¬
 * 
	ma
;

14 
	#INNER_FIELD
 ((
PBC_ARRAY_CAP
 - (
¬¿y
)è/ (
pbc_v¬
))

	)

17 
	$_pbcA_İ’
(
pbc_¬¿y
 
_¬¿y
) {

18 
¬¿y
 * 
a
 = (¬¿y *)
_¬¿y
;

19 
a
->
numb”
 = 0;

20 
a
->
h—p
 = 
NULL
;

21 
a
->¨ğ(
_pbc_v¬
 *)(a+1);

22 
	}
}

25 
	$_pbcA_İ’_h—p
(
pbc_¬¿y
 
_¬¿y
, 
h—p
 *
h
) {

26 
¬¿y
 * 
a
 = (¬¿y *)
_¬¿y
;

27 
a
->
numb”
 = 0;

28 
a
->
h—p
 = 
h
;

29 
a
->¨ğ(
_pbc_v¬
 *)(a+1);

30 
	}
}

33 
	$_pbcA_şo£
(
pbc_¬¿y
 
_¬¿y
) {

34 
¬¿y
 * 
a
 = (¬¿y *)
_¬¿y
;

35 ià(
a
->
h—p
 =ğ
NULL
 &&‡->¨!ğNULL && (
_pbc_v¬
 *)(a+1) !=‡->a) {

36 
	`_pbcM_ä“
(
a
->a);

37 
a
->¨ğ
NULL
;

39 
	}
}

42 
	$_pbcA_push
(
pbc_¬¿y
 
_¬¿y
, 
pbc_v¬
 
v¬
) {

43 
¬¿y
 * 
a
 = (¬¿y *)
_¬¿y
;

44 ià(
a
->
numb”
 == 0) {

45 
a
->¨ğ(
_pbc_v¬
 *)(a+1);

46 } ià(
a
->
numb”
 >ğ
INNER_FIELD
) {

47 ià(
a
->
numb”
 =ğ
INNER_FIELD
) {

48 
ÿp
 = 1;

49 
ÿp
 <ğ
a
->
numb”
 + 1)

50 
ÿp
 *= 2;

51 
h—p
 * 
h
 = 
a
->heap;

52 
_pbc_v¬
 * 
ou‹r
 = (_pbc_v¬ *)
	`HMALLOC
(
ÿp
 * (_pbc_var));

53 
	`memıy
(
ou‹r
 , 
a
->¨, 
INNER_FIELD
 * (
pbc_v¬
));

54 
a
->¨ğ
ou‹r
;

56 
size
=
a
->
numb”
;

57 ià(((
size
 + 1) ^ size) > size) {

58 
h—p
 * 
h
 = 
a
->heap;

59 ià(
h
) {

60 * 
Şd
 = 
a
->a;

61 
a
->¨ğ(
_pbc_v¬
 *)
	`_pbcH_®loc
(
h
, (_pbc_v¬è* (
size
+1) * 2);

62 
	`memıy
(
a
->a, 
Şd
, (
_pbc_v¬
è* 
size
);

64 
a
->¨ğ(
_pbc_v¬
 *)
	`_pbcM_»®loc
×->a,(_pbc_v¬è* (
size
+1) * 2);

69 
a
->a[a->
numb”
] = *
v¬
;

70 ++ 
a
->
numb”
;

71 
	}
}

74 
	$_pbcA_šdex
(
pbc_¬¿y
 
_¬¿y
, 
idx
, 
pbc_v¬
 
v¬
)

76 
¬¿y
 * 
a
 = (¬¿y *)
_¬¿y
;

77 
v¬
[0] = 
a
->a[
idx
];

78 
	}
}

81 
	$_pbcA_šdex_p
(
pbc_¬¿y
 
_¬¿y
, 
idx
)

83 
¬¿y
 * 
a
 = (¬¿y *)
_¬¿y
;

84  &(
a
->a[
idx
]);

85 
	}
}

88 
	$pbc_¬¿y_size
(
pbc_¬¿y
 
_¬¿y
) {

89 
¬¿y
 * 
a
 = (¬¿y *)
_¬¿y
;

90  
a
->
numb”
;

91 
	}
}

93 
ušt32_t


94 
	$pbc_¬¿y_š‹g”
(
pbc_¬¿y
 
¬¿y
, 
šdex
, 
ušt32_t
 *
hi
) {

95 
pbc_v¬
 
v¬
;

96 
	`_pbcA_šdex
(
¬¿y
 , 
šdex
 , 
v¬
);

97 ià(
hi
) {

98 *
hi
 = 
v¬
->
š‹g”
.hi;

100  
v¬
->
š‹g”
.
low
;

101 
	}
}

104 
	$pbc_¬¿y_»®
(
pbc_¬¿y
 
¬¿y
, 
šdex
) {

105 
pbc_v¬
 
v¬
;

106 
	`_pbcA_šdex
(
¬¿y
 , 
šdex
 , 
v¬
);

107  
v¬
->
»®
;

108 
	}
}

110 
pbc_¦iû
 *

111 
	$pbc_¬¿y_¦iû
(
pbc_¬¿y
 
_¬¿y
, 
šdex
) {

112 
¬¿y
 * 
a
 = (¬¿y *)
_¬¿y
;

113 ià(
šdex
 <0 || index > 
a
->
numb”
) {

114  
NULL
;

116  (
pbc_¦iû
 *è&(
a
->a[
šdex
]);

117 
	}
}

120 
	$pbc_¬¿y_push_š‹g”
(
pbc_¬¿y
 
¬¿y
, 
ušt32_t
 
low
, ušt32_ˆ
hi
) {

121 
pbc_v¬
 
v¬
;

122 
v¬
->
š‹g”
.
low
 =†ow;

123 
v¬
->
š‹g”
.
hi
 = hi;

124 
	`_pbcA_push
(
¬¿y
,
v¬
);

125 
	}
}

128 
	$pbc_¬¿y_push_¦iû
(
pbc_¬¿y
 
¬¿y
, 
pbc_¦iû
 *
s
) {

129 
pbc_v¬
 
v¬
;

130 
v¬
->
m
 = *
s
;

131 
	`_pbcA_push
(
¬¿y
,
v¬
);

132 
	}
}

135 
	$pbc_¬¿y_push_»®
(
pbc_¬¿y
 
¬¿y
, 
v
) {

136 
pbc_v¬
 
v¬
;

137 
v¬
->
»®
 = 
v
;

138 
	`_pbcA_push
(
¬¿y
,
v¬
);

139 
	}
}

	@src/array.h

1 #iâdeà
PROTOBUF_C_ARRAY_H


2 
	#PROTOBUF_C_ARRAY_H


	)

4 
	~"v¬št.h
"

5 
	~"pbc.h
"

6 
	~"®loc.h
"

8 
	u_pbc_v¬
 {

9 
lÚglÚg
 
	mš‹g”
;

10 
	m»®
;

12 cÚ¡ * 
	m¡r
;

13 
	mËn
;

14 } 
	ms
;

16 
	mid
;

17 cÚ¡ * 
	mÇme
;

18 } 
	me
;

19 
pbc_¦iû
 
	mm
;

20 * 
	mp
[2];

21 } 
	tpbc_v¬
[1];

23 
_pbcA_İ’
(
pbc_¬¿y
);

24 
_pbcA_İ’_h—p
(
pbc_¬¿y
, 
h—p
 *
h
);

25 
_pbcA_şo£
(
pbc_¬¿y
);

27 
_pbcA_push
(
pbc_¬¿y
, 
pbc_v¬
 
v¬
);

28 
_pbcA_šdex
(
pbc_¬¿y
 , 
idx
, 
pbc_v¬
 
v¬
);

29 * 
_pbcA_šdex_p
(
pbc_¬¿y
 
_¬¿y
, 
idx
);

	@src/bootstrap.c

1 
	~"pbc.h
"

2 
	~"m­.h
"

3 
	~"cÚ‹xt.h
"

4 
	~"·‰”n.h
"

5 
	~"´Ùo.h
"

6 
	~"®loc.h
"

7 
	~"boÙ¡¿p.h
"

8 
	~"¡ršgpoŞ.h
"

9 
	~"¬¿y.h
"

10 
	~"desütÜ.pbc.h
"

12 
	~<¡dlib.h
>

13 
	~<¡ddef.h
>

14 
	~<¡ršg.h
>

15 
	~<¡dšt.h
>

52 
	sf›ld_t
 {

53 
pbc_¦iû
 
	mÇme
;

54 
št32_t
 
	mid
;

55 
št32_t
 
	mÏb–
;

56 
št32_t
 
	mty³
;

57 
pbc_¦iû
 
	mty³_Çme
;

58 
št32_t
 
	mdeçuÉ_š‹g”
;

59 
pbc_¦iû
 
	mdeçuÉ_¡ršg
;

60 
	mdeçuÉ_»®
;

63 
	sfe_t
 {

64 
pbc_¦iû
 
	mÇme
;

65 
pbc_¬¿y
 
	md•’d’cy
;

66 
pbc_¬¿y
 
	mmes§ge_Çme
;

67 
pbc_¬¿y
 
	mmes§ge_size
;

68 
pbc_¬¿y
 
	mmes§ge_f›ld
;

69 
pbc_¬¿y
 
	m’um_Çme
;

70 
pbc_¬¿y
 
	m’um_size
;

71 
pbc_¬¿y
 
	m’um_¡ršg
;

72 
pbc_¬¿y
 
	m’um_id
;

76 
	$£t_’um_Úe
(
pbc_’v
 *
p
, 
fe_t
 *
fe
, cÚ¡ *
Çme
, 
¡¬t
, 
sz
) {

77 
m­_kv
 *
bË
 = (m­_kv *)
	`m®loc
(
sz
 * (map_kv));

78 
i
;

79 
i
=0;i<
sz
;i++) {

80 
pbc_v¬
 
id
;

81 
pbc_v¬
 
¡ršg
;

82 
	`_pbcA_šdex
(
fe
->
’um_id
, 
¡¬t
+
i
, 
id
);

83 
	`_pbcA_šdex
(
fe
->
’um_¡ršg
, 
¡¬t
+
i
, 
¡ršg
);

84 
bË
[
i
].
id
 = ()id->
š‹g”
.
low
;

85 
bË
[
i
].
poš‹r
 = (*)
¡ršg
->
s
.
¡r
;

87 
	`_pbcP_push_’um
(
p
,
Çme
,
bË
,
sz
);

89 
	`ä“
(
bË
);

90 
	}
}

93 
	$£t_’ums
(
pbc_’v
 *
p
, 
fe_t
 *
fe
) {

94 
n
 = 
	`pbc_¬¿y_size
(
fe
->
’um_size
);

95 
i
;

96 
¡¬t
 = 0;

97 
i
=0;i<
n
;i++) {

98 
pbc_v¬
 
Çme
;

99 
	`_pbcA_šdex
(
fe
->
’um_Çme
,
i
,
Çme
);

100 
pbc_v¬
 
v¬
;

101 
	`_pbcA_šdex
(
fe
->
’um_size
,
i
,
v¬
);

102 
	`£t_’um_Úe
(
p
, 
fe
, 
Çme
->
s
.
¡r
, 
¡¬t
 , ()
v¬
->
š‹g”
.
low
);

103 
¡¬t
 +ğ
v¬
->
š‹g”
.
low
;

105 
	}
}

108 
	$£t_deçuÉ
(
_f›ld
 *
f
, 
f›ld_t
 *
šput
) {

109 
f
->
ty³
) {

110 
PTYPE_DOUBLE
:

111 
PTYPE_FLOAT
:

112 
f
->
deçuÉ_v
->
»®
 = 
šput
->
deçuÉ_»®
;

114 
PTYPE_STRING
:

115 
PTYPE_ENUM
:

116 
f
->
deçuÉ_v
->
m
 = 
šput
->
deçuÉ_¡ršg
;

119 
f
->
deçuÉ_v
->
š‹g”
.
low
 = 
šput
->
deçuÉ_š‹g”
;

122 
	}
}

125 
	$£t_msg_Úe
(
pbc_·‰”n
 * 
FIELD_T
, 
pbc_’v
 *
p
, 
fe_t
 *
fe
, cÚ¡ *
Çme
, 
¡¬t
, 
sz
 , 
pbc_¬¿y
 
queue
) {

126 
i
;

127 
i
=0;i<
sz
;i++) {

128 
pbc_v¬
 
_f›ld
;

129 
	`_pbcA_šdex
(
fe
->
mes§ge_f›ld
, 
¡¬t
+
i
, 
_f›ld
);

130 
f›ld_t
 
f›ld
;

132 
»t
 = 
	`pbc_·‰”n_uÅack
(
FIELD_T
, &
_f›ld
->
m
, &
f›ld
);

133 ià(
»t
 != 0) {

136 
_f›ld
 
f
;

137 
f
.
id
 = 
f›ld
.id;

138 
f
.
Çme
 = (cÚ¡ *)
f›ld
.Çme.
bufãr
;

139 
f
.
ty³
 = 
f›ld
.type;

140 
f
.
Ïb–
 = 
f›ld
.label;

141 
f
.
ty³_Çme
.
n
 = (cÚ¡ *)
f›ld
.ty³_Çme.
bufãr
;

142 
	`£t_deçuÉ
(&
f
, &
f›ld
);

144 
	`_pbcP_push_mes§ge
(
p
,
Çme
, &
f
 , 
queue
);

148 
	`_pbcP_š™_mes§ge
(
p
, 
Çme
);

149 
	}
}

152 
	$£t_msgs
(
pbc_·‰”n
 * 
FIELD_T
, 
pbc_’v
 *
p
, 
fe_t
 *
fe
 , 
pbc_¬¿y
 
queue
) {

153 
n
 = 
	`pbc_¬¿y_size
(
fe
->
mes§ge_size
);

154 
i
;

155 
¡¬t
 = 0;

156 
i
=0;i<
n
;i++) {

157 
pbc_v¬
 
Çme
;

158 
	`_pbcA_šdex
(
fe
->
mes§ge_Çme
,
i
,
Çme
);

159 
pbc_v¬
 
sz
;

160 
	`_pbcA_šdex
(
fe
->
mes§ge_size
,
i
,
sz
);

161 
	`£t_msg_Úe
(
FIELD_T
, 
p
, 
fe
, 
Çme
->
s
.
¡r
, 
¡¬t
 , ()
sz
->
š‹g”
.
low
 , 
queue
);

162 
¡¬t
 +ğ
sz
->
š‹g”
.
low
;

164 
	}
}

167 
	$£t_f›ld_Úe
(
pbc_’v
 *
p
, 
_f›ld
 *
f
) {

168 cÚ¡ * 
ty³_Çme
 = 
f
->ty³_Çme.
n
;

169 ià(
f
->
ty³
 =ğ
PTYPE_MESSAGE
) {

170 
f
->
ty³_Çme
.
m
 = (
_mes§ge
 *)
	`_pbcM_¥_qu”y
(
p
->
msgs
,ype_name);

172 } ià(
f
->
ty³
 =ğ
PTYPE_ENUM
) {

173 
f
->
ty³_Çme
.
e
 = (
_’um
 *)
	`_pbcM_¥_qu”y
(
p
->
’ums
,ype_name);

175 cÚ¡ * 
¡r
 = 
f
->
deçuÉ_v
->
s
.str;

176 ià(
¡r
 && str[0]) {

177 
”r
 = 
	`_pbcM_si_qu”y
(
f
->
ty³_Çme
.
e
->
Çme
, 
¡r
 , &(f->
deçuÉ_v
->e.
id
));

178 ià(
”r
 < 0)

179 
_deçuÉ
;

180 
f
->
deçuÉ_v
->
e
.
Çme
 = (cÚ¡ *)
	`_pbcM__qu”y
(f->
ty³_Çme
.e->
id
, f->default_v->e.id);

183 
_deçuÉ
:

184 
	`memıy
(
f
->
deçuÉ_v
, f->
ty³_Çme
.
e
->deçuÉ_v, (
pbc_v¬
));

188 
	}
}

191 
	$_pbcB_»gi¡”_f›lds
(
pbc_’v
 *
p
, 
pbc_¬¿y
 
queue
) {

192 
sz
 = 
	`pbc_¬¿y_size
(
queue
);

193 
i
;

194 
i
=0;i<
sz
;i++) {

195 
pbc_v¬
 
©om
;

196 
	`_pbcA_šdex
(
queue
,
i
,
©om
);

197 
_f›ld
 * 
f
 = (_f›ld *)
©om
->
m
.
bufãr
;

198 
	`£t_f›ld_Úe
(
p
, 
f
);

200 
	}
}

203 
	$_£t_¡ršg
(
_·‰”n_f›ld
 * 
f
) {

204 
f
->
±y³
 = 
PTYPE_STRING
;

205 
f
->
ùy³
 = 
CTYPE_VAR
;

206 
f
->
defv
->
s
.
¡r
 = "";

207 
f
->
defv
->
s
.
Ën
 = 0;

208 
	}
}

211 
	$_£t_št32
(
_·‰”n_f›ld
 * 
f
) {

212 
f
->
±y³
 = 
PTYPE_INT32
;

213 
f
->
ùy³
 = 
CTYPE_INT32
;

214 
	}
}

217 
	$_£t_doubË
(
_·‰”n_f›ld
 * 
f
) {

218 
f
->
±y³
 = 
PTYPE_DOUBLE
;

219 
f
->
ùy³
 = 
CTYPE_DOUBLE
;

220 
	}
}

223 
	$_£t_mes§ge_¬¿y
(
_·‰”n_f›ld
 *
f
) {

224 
f
->
±y³
 = 
PTYPE_MESSAGE
;

225 
f
->
ùy³
 = 
CTYPE_ARRAY
;

226 
	}
}

229 
	$_£t_¡ršg_¬¿y
(
_·‰”n_f›ld
 * 
f
) {

230 
f
->
±y³
 = 
PTYPE_STRING
;

231 
f
->
ùy³
 = 
CTYPE_ARRAY
;

232 
	}
}

235 
	$_£t_št32_¬¿y
(
_·‰”n_f›ld
 * 
f
) {

236 
f
->
±y³
 = 
PTYPE_INT32
;

237 
f
->
ùy³
 = 
CTYPE_ARRAY
;

238 
	}
}

240 
	#SET_PATTERN
(
·t
 , 
idx
 , 
·t_ty³
, 
f›ld_Çme
 , 
ty³
) \

241 
·t
->
f
[
idx
].
id
 = idx+1 ; \

242 
·t
->
f
[
idx
].
off£t
 = 
	`off£tof
(
·t_ty³
, 
f›ld_Çme
); \

243 
_£t_
##
	`ty³
(&
·t
->
f
[
idx
]);

	)

245 
	#F
(
idx
,
f›ld_Çme
,
ty³
è
	`SET_PATTERN
(
FIELD_T
, idx, 
f›ld_t
 ,f›ld_Çme,y³)

	)

246 
	#D
(
idx
,
f›ld_Çme
,
ty³
è
	`SET_PATTERN
(
FILE_T
, idx, 
fe_t
 ,f›ld_Çme,y³)

	)

249 
	$»gi¡”_š‹º®
(
pbc_’v
 * 
p
, 
pbc_¦iû
 *
¦iû
) {

250 
pbc_·‰”n
 * 
FIELD_T
 = 
	`_pbcP_Ãw
(
p
,8);

251 
	`F
(0,
Çme
,
¡ršg
);

252 
	`F
(1,
id
,
št32
);

253 
	`F
(2,
Ïb–
,
št32
);

254 
	`F
(3,
ty³
,
št32
);

255 
	`F
(4,
ty³_Çme
,
¡ršg
);

256 
	`F
(5,
deçuÉ_š‹g”
,
št32
);

257 
	`F
(6,
deçuÉ_¡ršg
,
¡ršg
);

258 
	`F
(7,
deçuÉ_»®
,);

260 
pbc_·‰”n
 * 
FILE_T
 = 
	`_pbcP_Ãw
(
p
,10);

262 
	`D
(0,
Çme
,
¡ršg
);

263 
	`D
(1,
d•’d’cy
,
¡ršg_¬¿y
);

264 
	`D
(2,
mes§ge_Çme
,
¡ršg_¬¿y
);

265 
	`D
(3,
mes§ge_size
,
št32_¬¿y
);

266 
	`D
(4,
mes§ge_f›ld
,
mes§ge_¬¿y
);

267 
	`D
(5,
’um_Çme
,
¡ršg_¬¿y
);

268 
	`D
(6,
’um_size
,
št32_¬¿y
);

269 
	`D
(7,
’um_¡ršg
,
¡ršg_¬¿y
);

270 
	`D
(8,
’um_id
,
št32_¬¿y
);

272 
»t
 = 0;

274 
fe_t
 
fe
;

275 
r
 = 
	`pbc_·‰”n_uÅack
(
FILE_T
, 
¦iû
, &
fe
);

276 ià(
r
 != 0) {

277 
»t
 = 1;

278 
_»tuº
;

281 
	`_pbcM_¥_š£¹
(
p
->
fes
 , (cÚ¡ *)
fe
.
Çme
.
bufãr
, 
NULL
);

283 
pbc_¬¿y
 
queue
;

284 
	`_pbcA_İ’
(
queue
);

286 
	`£t_’ums
(
p
, &
fe
);

287 
	`£t_msgs
(
FIELD_T
, 
p
, &
fe
, 
queue
);

288 
	`_pbcB_»gi¡”_f›lds
(
p
, 
queue
);

290 
	`_pbcA_şo£
(
queue
);

291 
	`pbc_·‰”n_şo£_¬¿ys
(
FILE_T
, &
fe
);

293 
_»tuº
:

294 
	`ä“
(
FIELD_T
);

295 
	`ä“
(
FILE_T
);

296  
»t
;

297 
	}
}

300 
	$_pbcB_š™
(
pbc_’v
 * 
p
) {

301 
pbc_¦iû
 
¦iû
 = { 
pbc_desütÜ
,(pbc_descriptor) };

302 
	`»gi¡”_š‹º®
(
p
,&
¦iû
);

303 
	}
}

	@src/bootstrap.h

1 #iâdeà
PROTOBUF_C_BOOTSTRAP_H


2 
	#PROTOBUF_C_BOOTSTRAP_H


	)

4 
	~"´Ùo.h
"

5 
	~"pbc.h
"

7 
_pbcB_š™
(
pbc_’v
 *);

8 
_pbcB_»gi¡”_f›lds
(
pbc_’v
 *, 
pbc_¬¿y
 
queue
);

	@src/context.c

1 
	~"pbc.h
"

2 
	~"®loc.h
"

3 
	~"v¬št.h
"

4 
	~"cÚ‹xt.h
"

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<¡dšt.h
>

9 #iâdeà
_MSC_VER


10 
	~<¡dboŞ.h
>

13 
	#INNER_ATOM
 ((
PBC_CONTEXT_CAP
 - (
cÚ‹xt
)è/ (
©om
))

	)

16 
	$wœ‘y³_decode
(
ušt8_t
 *
bufãr
, 
ÿp
 , 
©om
 *
a
 , 
¡¬t
)

18 
ušt8_t
 
‹mp
[10];

19 
lÚglÚg
 
r
;

20 
Ën
;

21 ià(
ÿp
 >= 10) {

22 
Ën
 = 
	`_pbcV_decode
(
bufãr
, &
r
);

23 ià(
r
.
hi
 !=0)

24  
NULL
;

26 
	`memıy
(
‹mp
, 
bufãr
 , 
ÿp
);

27 
Ën
 = 
	`_pbcV_decode
(
‹mp
, &
r
);

28 ià(
Ën
 > 
ÿp
 || 
r
.
hi
 !=0)

29  
NULL
;

32 
wœ‘y³
 = 
r
.
low
 & 7;

33 
a
->
wœe_id
 = 
r
.
low
;

34 
bufãr
 +ğ
Ën
;

35 
¡¬t
 +ğ
Ën
;

36 
ÿp
 -=
Ën
;

38 
wœ‘y³
) {

39 
WT_VARINT
 :

40 ià(
ÿp
 >=10) {

41 
Ën
 = 
	`_pbcV_decode
(
bufãr
, &
a
->
v
.
i
);

43 
	`memıy
(
‹mp
, 
bufãr
 , 
ÿp
);

44 
Ën
 = 
	`_pbcV_decode
(
‹mp
, &
a
->
v
.
i
);

45 ià(
ÿp
 < 
Ën
)

46  
NULL
;

48  (*)
bufãr
+
Ën
;

49 
WT_BIT64
 :

50 ià(
ÿp
 < 8)

51  
NULL
;

52 
a
->
v
.
i
.
low
 = 
bufãr
[0] |

53 
bufãr
[1] << 8 |

54 
bufãr
[2] << 16 |

55 
bufãr
[3] << 24;

56 
a
->
v
.
i
.
hi
 = 
bufãr
[4] |

57 
bufãr
[5] << 8 |

58 
bufãr
[6] << 16 |

59 
bufãr
[7] << 24;

60  (*)
bufãr
 + 8;

61 
WT_LEND
 :

62 ià(
ÿp
 >=10) {

63 
Ën
 = 
	`_pbcV_decode
(
bufãr
, &
r
);

65 
	`memıy
(
‹mp
, 
bufãr
 , 
ÿp
);

66 
Ën
 = 
	`_pbcV_decode
(
‹mp
, &
r
);

68 ià(
ÿp
 < 
Ën
 + 
r
.
low
 ||„.
hi
 !=0)

69  
NULL
;

70 
a
->
v
.
s
.
¡¬t
 = s¹ + 
Ën
;

71 
a
->
v
.
s
.
’d
 = 
¡¬t
 + 
Ën
 + 
r
.
low
;

72  (*)
bufãr
 + 
Ën
 + 
r
.
low
;

73 
WT_BIT32
 :

74 ià(
ÿp
 < 4)

75  
NULL
;

76 
a
->
v
.
i
.
low
 = 
bufãr
[0] |

77 
bufãr
[1] << 8 |

78 
bufãr
[2] << 16 |

79 
bufãr
[3] << 24;

80 
a
->
v
.
i
.
hi
 = 0;

81  (*)
bufãr
 + 4;

83  
NULL
;

85 
	}
}

87 
šlše
 

88 
	$_decode_v¬št
(
ušt8_t
 * 
bufãr
, 
size
 , 
©om
 * 
a
) {

89 
a
->
wœe_id
 = 
WT_VARINT
;

90 ià(
size
 < 10) {

91 
ušt8_t
 
‹mp
[10];

92 
	`memıy
(
‹mp
,
bufãr
,
size
);

93  
	`_pbcV_decode
(
‹mp
 , &(
a
->
v
.
i
));

95  
	`_pbcV_decode
(
bufãr
 , &(
a
->
v
.
i
));

97 
	}
}

100 
	$_İ’_·cked_v¬št
(
cÚ‹xt
 * 
ùx
 , 
ušt8_t
 * 
bufãr
, 
size
) {

101 
©om
 * 
a
 = (©om *)(
ùx
 + 1);

103 
i
;

105 
i
=0;i<
INNER_ATOM
;i++) {

106 ià(
size
 == 0)

108 
Ën
 = 
	`_decode_v¬št
(
bufãr
, 
size
, &
a
[
i
]);

109 
bufãr
 +ğ
Ën
;

110 
size
 -ğ
Ën
;

113 ià(
size
 == 0) {

114 
ùx
->
a
 =‡;

116 
ÿp
 = 64;

117 
ùx
->
a
 = (
©om
 *)
	`m®loc
(
ÿp
 * (atom));

118 
size
 > 0) {

119 ià(
i
 >ğ
ÿp
) {

120 
ÿp
 = cap + 64;

121 
ùx
->
a
 = (
©om
 *)
	`»®loc
(ùx->a, 
ÿp
 * (atom));

124 
Ën
 = 
	`_decode_v¬št
(
bufãr
, 
size
, &
a
[
i
]);

125 
bufãr
 +ğ
Ën
;

126 
size
 -ğ
Ën
;

128 ++
i
;

130 
	`memıy
(
ùx
->
a
,‡ , (
©om
è* 
INNER_ATOM
);

132 
ùx
->
numb”
 = 
i
;

134  
i
;

135 
	}
}

138 
	$_pbcC_İ’_·cked
(
pbc_ùx
 
_ùx
, 
±y³
, *
bufãr
, 
size
) {

139 
cÚ‹xt
 * 
ùx
 = (cÚ‹xˆ*)
_ùx
;

140 
ùx
->
bufãr
 = (*)buffer;

141 
ùx
->
size
 = size;

142 
ùx
->
numb”
 = 0;

143 
ùx
->
a
 = 
NULL
;

145 ià(
bufãr
 =ğ
NULL
 || 
size
 == 0) {

149 
b™s
 = 0;

151 
±y³
) {

152 
PTYPE_INT64
:

153 
PTYPE_UINT64
:

154 
PTYPE_INT32
:

155 
PTYPE_BOOL
:

156 
PTYPE_UINT32
:

157 
PTYPE_ENUM
:

158 
PTYPE_SINT32
:

159 
PTYPE_SINT64
:

160  
	`_İ’_·cked_v¬št
(
ùx
 , (
ušt8_t
 *)
bufãr
, 
size
);

161 
PTYPE_DOUBLE
:

162 
PTYPE_FIXED64
:

163 
PTYPE_SFIXED64
:

164 
ùx
->
numb”
 = 
size
 / 8;

165 
b™s
 = 64;

167 
PTYPE_FLOAT
:

168 
PTYPE_FIXED32
:

169 
PTYPE_SFIXED32
:

170 
ùx
->
numb”
 = 
size
 / 4;

171 
b™s
 = 32;

177 
©om
 * 
a
 = (©om *)(
ùx
 + 1);

179 ià(
ùx
->
numb”
 > 
INNER_ATOM
) {

180 
ùx
->
a
 = (
©om
 *)
	`m®loc
(ùx->
numb”
 * (atom));

181 
a
 = 
ùx
->a;

183 
ùx
->
a
 =‡;

186 
i
;

187 ià(
b™s
 == 64) {

188 
ušt8_t
 * 
d©a
 = (ušt8_ˆ*)
bufãr
;

189 
i
=0;i<
ùx
->
numb”
;i++) {

190 
a
[
i
].
wœe_id
 = 
WT_BIT64
;

191 
a
[
i
].
v
.i.
low
 = 
d©a
[0] |

192 
d©a
[1] << 8 |

193 
d©a
[2] << 16 |

194 
d©a
[3] << 24;

195 
a
[
i
].
v
.i.
hi
 = 
d©a
[4] |

196 
d©a
[5] << 8 |

197 
d©a
[6] << 16 |

198 
d©a
[7] << 24;

199 
d©a
 += 8;

202 
ušt8_t
 * 
d©a
 = (ušt8_ˆ*)
bufãr
;

203 
i
=0;i<
ùx
->
numb”
;i++) {

204 
a
[
i
].
wœe_id
 = 
WT_BIT32
;

205 
a
[
i
].
v
.i.
low
 = 
d©a
[0] |

206 
d©a
[1] << 8 |

207 
d©a
[2] << 16 |

208 
d©a
[3] << 24;

209 
a
[
i
].
v
.i.
hi
 = 0;

210 
d©a
 += 4;

214  
ùx
->
numb”
;

215 
	}
}

218 
	$_pbcC_İ’
(
pbc_ùx
 
_ùx
 , *
bufãr
, 
size
) {

219 
cÚ‹xt
 * 
ùx
 = (cÚ‹xˆ*)
_ùx
;

220 
ùx
->
bufãr
 = (*)buffer;

221 
ùx
->
size
 = size;

223 ià(
bufãr
 =ğ
NULL
 || 
size
 == 0) {

224 
ùx
->
numb”
 = 0;

225 
ùx
->
a
 = 
NULL
;

229 
©om
 * 
a
 = (©om *)(
ùx
 + 1);

231 
i
;

232 
¡¬t
 = 0;

234 
ùx
->
a
 =‡;

236 
i
=0;i<
INNER_ATOM
;i++) {

237 ià(
size
 == 0)

239 * 
Ãxt
 = 
	`wœ‘y³_decode
((
ušt8_t
 *)
bufãr
, 
size
 , &
a
[
i
] , 
¡¬t
);

240 ià(
Ãxt
 =ğ
NULL
)

241  -
i
;

242 
¡¬t
 +ğ
Ãxt
 - (*)
bufãr
;

243 
size
 -ğ
Ãxt
 - (*)
bufãr
;

244 
bufãr
 = 
Ãxt
;

247 ià(
size
 > 0) {

248 
ÿp
 = 64;

249 
ùx
->
a
 = (
©om
 *)
	`m®loc
(
ÿp
 * (atom));

250 
size
 > 0) {

251 ià(
i
 >ğ
ÿp
) {

252 
ÿp
 = cap + 64;

253 
ùx
->
a
 = (
©om
 *)
	`»®loc
(ùx->a, 
ÿp
 * (atom));

256 * 
Ãxt
 = 
	`wœ‘y³_decode
((
ušt8_t
 *)
bufãr
, 
size
 , &
ùx
->
a
[
i
] , 
¡¬t
);

257 ià(
Ãxt
 =ğ
NULL
) {

258  -
i
;

260 
¡¬t
 +ğ
Ãxt
 - (*)
bufãr
;

261 
size
 -ğ
Ãxt
 - (*)
bufãr
;

262 
bufãr
 = 
Ãxt
;

263 ++
i
;

265 
	`memıy
(
ùx
->
a
,‡ , (
©om
è* 
INNER_ATOM
);

267 
ùx
->
numb”
 = 
i
;

269  
i
;

270 
	}
}

274 
	$_pbcC_şo£
(
pbc_ùx
 
_ùx
) {

275 
cÚ‹xt
 * 
ùx
 = (cÚ‹xˆ*)
_ùx
;

276 ià(
ùx
->
a
 !ğ
NULL
 && (
©om
 *)(ctx+1) != ctx->a) {

277 
	`ä“
(
ùx
->
a
);

278 
ùx
->
a
 = 
NULL
;

280 
	}
}

	@src/context.h

1 #iâdeà
PROTOBUF_C_CONTEXT_H


2 
	#PROTOBUF_C_CONTEXT_H


	)

4 
	~<¡dšt.h
>

6 
	~"¬¿y.h
"

8 
	#PBC_CONTEXT_CAP
 256

	)

12 
	#WT_VARINT
 0

	)

13 
	#WT_BIT64
 1

	)

14 
	#WT_LEND
 2

	)

15 
	#WT_BIT32
 5

	)

17 
	#CTYPE_INT32
 1

	)

18 
	#CTYPE_INT64
 2

	)

19 
	#CTYPE_DOUBLE
 3

	)

20 
	#CTYPE_FLOAT
 4

	)

21 
	#CTYPE_POINTER
 5

	)

22 
	#CTYPE_BOOL
 6

	)

23 
	#CTYPE_INT8
 7

	)

24 
	#CTYPE_INT16
 8

	)

25 
	#CTYPE_ARRAY
 9

	)

26 
	#CTYPE_VAR
 10

	)

27 
	#CTYPE_PACKED
 11

	)

29 
	#PTYPE_DOUBLE
 1

	)

30 
	#PTYPE_FLOAT
 2

	)

31 
	#PTYPE_INT64
 3

32 
	#PTYPE_UINT64
 4

	)

33 
	#PTYPE_INT32
 5

34 
	#PTYPE_FIXED64
 6

	)

35 
	#PTYPE_FIXED32
 7

	)

36 
	#PTYPE_BOOL
 8

	)

37 
	#PTYPE_STRING
 9

	)

38 
	#PTYPE_GROUP
 10

39 
	#PTYPE_MESSAGE
 11

40 
	#PTYPE_BYTES
 12

	)

41 
	#PTYPE_UINT32
 13

	)

42 
	#PTYPE_ENUM
 14

	)

43 
	#PTYPE_SFIXED32
 15

	)

44 
	#PTYPE_SFIXED64
 16

	)

45 
	#PTYPE_SINT32
 17

46 
	#PTYPE_SINT64
 18

47 

	)

48 
	s¦iû
 {

49 
	m¡¬t
;

50 
	m’d
;

53 
	s©om
 {

54 
	mwœe_id
;

56 
¦iû
 
	ms
;

57 
lÚglÚg
 
	mi
;

58 } 
	mv
;

61 
	scÚ‹xt
 {

62 * 
	mbufãr
;

63 
	msize
;

64 
	mnumb”
;

65 
©om
 * 
	ma
;

68 
	s_pbc_ùx
 { 
	m_d©a
[
PBC_CONTEXT_CAP
]; } 
	tpbc_ùx
[1];

70 
_pbcC_İ’
(
pbc_ùx
 , *
bufãr
, 
size
);

71 
_pbcC_İ’_·cked
(
pbc_ùx
 
_ùx
, 
±y³
, *
bufãr
, 
size
);

72 
_pbcC_şo£
(
pbc_ùx
);

74 
šlše
 

75 
	$»ad_doubË
(
©om
 * 
a
) {

77 
ušt64_t
 
i
;

78 
d
;

79 } 
u
;

80 
u
.
i
 = (
ušt64_t
è
a
->
v
.i.
low
 | (ušt64_tèa->v.i.
hi
 << 32;

81  
u
.
d
;

82 
	}
}

84 
šlše
 

85 
	$»ad_æßt
(
©om
 * 
a
) {

87 
ušt32_t
 
i
;

88 
f
;

89 } 
u
;

90 
u
.
i
 = 
a
->
v
.i.
low
;

91  
u
.
f
;

92 
	}
}

94 
šlše
 

95 
	$doubË_’code
(
v
 , 
ušt8_t
 * 
bufãr
) {

97 
v
;

98 
ušt64_t
 
e
;

99 } 
u
;

100 
u
.
v
 = v;

101 
bufãr
[0] = (
ušt8_t
è(
u
.
e
 & 0xff);

102 
bufãr
[1] = (
ušt8_t
è(
u
.
e
 >> 8 & 0xff);

103 
bufãr
[2] = (
ušt8_t
è(
u
.
e
 >> 16 & 0xff);

104 
bufãr
[3] = (
ušt8_t
è(
u
.
e
 >> 24 & 0xff);

105 
bufãr
[4] = (
ušt8_t
è(
u
.
e
 >> 32 & 0xff);

106 
bufãr
[5] = (
ušt8_t
è(
u
.
e
 >> 40 & 0xff);

107 
bufãr
[6] = (
ušt8_t
è(
u
.
e
 >> 48 & 0xff);

108 
bufãr
[7] = (
ušt8_t
è(
u
.
e
 >> 56 & 0xff);

109 
	}
}

111 
šlše
 

112 
	$æßt_’code
(
v
 , 
ušt8_t
 * 
bufãr
) {

114 
v
;

115 
ušt32_t
 
e
;

116 } 
u
;

117 
u
.
v
 = v;

118 
bufãr
[0] = (
ušt8_t
è(
u
.
e
 & 0xff);

119 
bufãr
[1] = (
ušt8_t
è(
u
.
e
 >> 8 & 0xff);

120 
bufãr
[2] = (
ušt8_t
è(
u
.
e
 >> 16 & 0xff);

121 
bufãr
[3] = (
ušt8_t
è(
u
.
e
 >> 24 & 0xff);

122 
	}
}

124 
	#CHECK_LEND
(
a
,
”r
èià(×->
wœe_id
 & 7è!ğ
WT_LEND
èƒ¼;

	)

128 
	#CHECK_VARINT
(
a
,
”r
èià(×->
wœe_id
 & 7è!ğ
WT_VARINT
èƒ¼;

	)

129 
	#CHECK_BIT32
(
a
,
”r
èià(×->
wœe_id
 & 7è!ğ
WT_BIT32
èƒ¼;

	)

130 
	#CHECK_BIT64
(
a
,
”r
èià(×->
wœe_id
 & 7è!ğ
WT_BIT64
èƒ¼;

	)

134 
	#CHECK_VARINT
(
a
,
”r
)

	)

135 
	#CHECK_BIT32
(
a
,
”r
)

	)

136 
	#CHECK_BIT64
(
a
,
”r
)

	)

	@src/decode.c

1 
	~"pbc.h
"

2 
	~"®loc.h
"

3 
	~"cÚ‹xt.h
"

4 
	~"´Ùo.h
"

5 
	~"v¬št.h
"

7 
	~<as£¹.h
>

9 cÚ¡ * 
	gTYPENAME
[] = {

25 
	$ÿÎ_unknown
(
pbc_decod”
 
f
, * 
ud
, 
id
, 
©om
 *
a
, 
ušt8_t
 * 
¡¬t
) {

26 
pbc_v®ue
 
v
;

27 
a
->
wœe_id
 & 7) {

28 
WT_VARINT
:

29 
v
.
i
.
low
 = 
a
->v.i.low;

30 
v
.
i
.
hi
 = 
a
->v.i.hi;

31 
	`f
(
ud
, 
PBC_INT
, 
TYPENAME
[PBC_INT], &
v
, 
id
 , 
NULL
);

33 
WT_BIT64
:

34 
v
.
i
.
low
 = 
a
->v.i.low;

35 
v
.
i
.
hi
 = 
a
->v.i.hi;

36 
	`f
(
ud
, 
PBC_FIXED64
, 
TYPENAME
[PBC_FIXED64], &
v
, 
id
 , 
NULL
);

38 
WT_LEND
:

39 
v
.
s
.
bufãr
 = (*)
¡¬t
 + 
a
->v.s.start;

40 
v
.
s
.
Ën
 = 
a
->v.s.
’d
 -‡->v.s.
¡¬t
;

41 
	`f
(
ud
, 
PBC_BYTES
, 
TYPENAME
[PBC_BYTES], &
v
, 
id
 , 
NULL
);

43 
WT_BIT32
:

44 
v
.
i
.
low
 = 
a
->v.i.low;

45 
v
.
i
.
hi
 = 0;

46 
	`f
(
ud
, 
PBC_FIXED32
, 
TYPENAME
[PBC_FIXED32], &
v
, 
id
 , 
NULL
);

52 
	}
}

55 
	$ÿÎ_ty³
(
pbc_decod”
 
pd
, * 
ud
, 
_f›ld
 *
f
, 
©om
 *
a
, 
ušt8_t
 * 
¡¬t
) {

56 
pbc_v®ue
 
v
;

57 cÚ¡ * 
ty³_Çme
 = 
NULL
;

58 
ty³
 = 
	`_pbcP_ty³
(
f
, &
ty³_Çme
);

59 
	`as£¹
(
ty³
 != 0);

60 ià(
ty³_Çme
 =ğ
NULL
) {

61 
ty³_Çme
 = 
TYPENAME
[
ty³
 & ~
PBC_REPEATED
];

63 
f
->
ty³
) {

64 
PTYPE_DOUBLE
:

65 
	`CHECK_BIT64
(
a
, -1);

66 
v
.
f
 = 
	`»ad_doubË
(
a
);

68 
PTYPE_FLOAT
:

69 
	`CHECK_BIT32
(
a
, -1);

70 
v
.
f
 = (è
	`»ad_æßt
(
a
);

72 
PTYPE_ENUM
:

73 
	`CHECK_VARINT
(
a
, -1);

74 
v
.
e
.
id
 = 
a
->v.
i
.
low
;

75 
v
.
e
.
Çme
 = (cÚ¡ *)
	`_pbcM__qu”y
(
f
->
ty³_Çme
.e->
id
 , v.e.id);

77 
PTYPE_INT64
:

78 
PTYPE_UINT64
:

79 
	`CHECK_VARINT
(
a
, -1);

80 
v
.
i
.
low
 = 
a
->v.i.low;

81 
v
.
i
.
hi
 = 
a
->v.i.hi;

83 
PTYPE_FIXED64
:

84 
PTYPE_SFIXED64
:

85 
	`CHECK_BIT64
(
a
, -1);

86 
v
.
i
.
low
 = 
a
->v.i.low;

87 
v
.
i
.
hi
 = 
a
->v.i.hi;

89 
PTYPE_INT32
:

90 
PTYPE_UINT32
:

91 
PTYPE_BOOL
:

92 
	`CHECK_VARINT
(
a
, -1);

93 
v
.
i
.
low
 = 
a
->v.i.low;

94 
v
.
i
.
hi
 = 0;

96 
PTYPE_FIXED32
:

97 
PTYPE_SFIXED32
:

98 
	`CHECK_BIT32
(
a
, -1);

99 
v
.
i
.
low
 = 
a
->v.i.low;

100 
v
.
i
.
hi
 = 0;

102 
PTYPE_SINT32
:

103 
	`CHECK_VARINT
(
a
, -1);

104 
v
.
i
.
low
 = 
a
->v.i.low;

105 
v
.
i
.
hi
 = 
a
->v.i.hi;

106 
	`_pbcV_dezigzag32
((
lÚglÚg
 *)&(
v
.
i
));

108 
PTYPE_SINT64
:

109 
	`CHECK_VARINT
(
a
, -1);

110 
v
.
i
.
low
 = 
a
->v.i.low;

111 
v
.
i
.
hi
 = 
a
->v.i.hi;

112 
	`_pbcV_dezigzag64
((
lÚglÚg
 *)&(
v
.
i
));

114 
PTYPE_STRING
:

115 
PTYPE_BYTES
:

116 
PTYPE_MESSAGE
:

117 
	`CHECK_LEND
(
a
, -1);

118 
v
.
s
.
bufãr
 = 
¡¬t
 + 
a
->v.s.start;

119 
v
.
s
.
Ën
 = 
a
->v.s.
’d
 -‡->v.s.
¡¬t
;

122 
	`as£¹
(0);

125 
	`pd
(
ud
, 
ty³
, 
ty³_Çme
, &
v
, 
f
->
id
, f->
Çme
);

127 
	}
}

130 
	$ÿÎ_¬¿y
(
pbc_decod”
 
pd
, * 
ud
, 
_f›ld
 *
f
, 
ušt8_t
 * 
bufãr
 , 
size
) {

131 
pbc_v®ue
 
v
;

132 cÚ¡ * 
ty³_Çme
 = 
NULL
;

133 
ty³
 = 
	`_pbcP_ty³
(
f
, &
ty³_Çme
);

134 
	`as£¹
(
ty³
 != 0);

135 ià(
ty³_Çme
 =ğ
NULL
) {

136 
ty³_Çme
 = 
TYPENAME
[
ty³
 & ~
PBC_REPEATED
];

138 
v
.
i
.
hi
 = 0;

139 
i
;

140 
f
->
ty³
) {

141 
PTYPE_DOUBLE
:

142 ià(
size
 % 8 != 0) {

145 
i
=0;i<
size
;i+=8) {

147 
d
;

148 
ušt64_t
 
i64
;

149 } 
u
;

150 
u
.
i64
 = (
ušt64_t
)
bufãr
[
i
] |

151 (
ušt64_t
)
bufãr
[
i
+1] << 8 |

152 (
ušt64_t
)
bufãr
[
i
+2] << 16 |

153 (
ušt64_t
)
bufãr
[
i
+3] << 24 |

154 (
ušt64_t
)
bufãr
[
i
+4] << 32 |

155 (
ušt64_t
)
bufãr
[
i
+5] << 40 |

156 (
ušt64_t
)
bufãr
[
i
+6] << 48 |

157 (
ušt64_t
)
bufãr
[
i
+7] << 56;

158 
v
.
f
 = 
u
.
d
;

159 
	`pd
(
ud
, 
ty³
 , 
ty³_Çme
, &
v
, 
f
->
id
, f->
Çme
);

161  
size
/8;

162 
PTYPE_FLOAT
:

163 ià(
size
 % 4 != 0)

165 
i
=0;i<
size
;i+=4) {

167 
f
;

168 
ušt32_t
 
i32
;

169 } 
u
;

170 
u
.
i32
 = (
ušt32_t
)
bufãr
[
i
] |

171 (
ušt32_t
)
bufãr
[
i
+1] << 8 |

172 (
ušt32_t
)
bufãr
[
i
+2] << 16 |

173 (
ušt32_t
)
bufãr
[
i
+3] << 24;

174 
v
.
f
 = ()
u
.f;

175 
	`pd
(
ud
, 
ty³
 , 
ty³_Çme
, &
v
, 
f
->
id
, f->
Çme
);

177  
size
/4;

178 
PTYPE_FIXED32
:

179 
PTYPE_SFIXED32
:

180 ià(
size
 % 4 != 0)

182 
i
=0;i<
size
;i+=4) {

183 
v
.
i
.
low
 = (
ušt32_t
)
bufãr
[i] |

184 (
ušt32_t
)
bufãr
[
i
+1] << 8 |

185 (
ušt32_t
)
bufãr
[
i
+2] << 16 |

186 (
ušt32_t
)
bufãr
[
i
+3] << 24;

187 
	`pd
(
ud
, 
ty³
 , 
ty³_Çme
, &
v
, 
f
->
id
, f->
Çme
);

189  
size
/4;

190 
PTYPE_FIXED64
:

191 
PTYPE_SFIXED64
:

192 ià(
size
 % 8 != 0)

194 
i
=0;i<
size
;i+=8) {

195 
v
.
i
.
low
 = (
ušt32_t
)
bufãr
[i] |

196 (
ušt32_t
)
bufãr
[
i
+1] << 8 |

197 (
ušt32_t
)
bufãr
[
i
+2] << 16 |

198 (
ušt32_t
)
bufãr
[
i
+3] << 24;

199 
v
.
i
.
hi
 = (
ušt32_t
)
bufãr
[i+4] |

200 (
ušt32_t
)
bufãr
[
i
+5] << 8 |

201 (
ušt32_t
)
bufãr
[
i
+6] << 16 |

202 (
ušt32_t
)
bufãr
[
i
+7] << 24;

203 
	`pd
(
ud
, 
ty³
 , 
ty³_Çme
, &
v
, 
f
->
id
, f->
Çme
);

205  
size
/8;

206 
PTYPE_INT64
:

207 
PTYPE_UINT64
:

208 
PTYPE_INT32
:

209 
PTYPE_UINT32
:

210 
PTYPE_BOOL
: {

211 
n
 = 0;

212 
size
 > 0) {

213 
Ën
;

214 ià(
size
 >= 10) {

215 
Ën
 = 
	`_pbcV_decode
(
bufãr
, (
lÚglÚg
 *)&(
v
.
i
));

217 
ušt8_t
 
‹mp
[10];

218 
	`memıy
(
‹mp
, 
bufãr
, 
size
);

219 
Ën
 = 
	`_pbcV_decode
(
bufãr
, (
lÚglÚg
 *)&(
v
.
i
));

220 ià(
Ën
 > 
size
)

223 
	`pd
(
ud
, 
ty³
 , 
ty³_Çme
, &
v
, 
f
->
id
, f->
Çme
);

224 
bufãr
 +ğ
Ën
;

225 
size
 -ğ
Ën
;

226 ++
n
;

228  
n
;

230 
PTYPE_ENUM
: {

231 
n
 = 0;

232 
size
 > 0) {

233 
Ën
;

234 ià(
size
 >= 10) {

235 
Ën
 = 
	`_pbcV_decode
(
bufãr
, (
lÚglÚg
 *)&(
v
.
i
));

237 
ušt8_t
 
‹mp
[10];

238 
	`memıy
(
‹mp
, 
bufãr
, 
size
);

239 
Ën
 = 
	`_pbcV_decode
(
bufãr
, (
lÚglÚg
 *)&(
v
.
i
));

240 ià(
Ën
 > 
size
)

243 
v
.
e
.
id
 = v.
i
.
low
;

244 
v
.
e
.
Çme
 = (cÚ¡ *)
	`_pbcM__qu”y
(
f
->
ty³_Çme
.e->
id
 , v.
i
.
low
);

245 
	`pd
(
ud
, 
ty³
 , 
ty³_Çme
, &
v
, 
f
->
id
, f->
Çme
);

246 
bufãr
 +ğ
Ën
;

247 
size
 -ğ
Ën
;

248 ++
n
;

250  
n
;

252 
PTYPE_SINT32
: {

253 
n
 = 0;

254 
size
 > 0) {

255 
Ën
;

256 ià(
size
 >= 10) {

257 
Ën
 = 
	`_pbcV_decode
(
bufãr
, (
lÚglÚg
 *)&(
v
.
i
));

258 
	`_pbcV_dezigzag32
((
lÚglÚg
 *)&(
v
.
i
));

260 
ušt8_t
 
‹mp
[10];

261 
	`memıy
(
‹mp
, 
bufãr
, 
size
);

262 
Ën
 = 
	`_pbcV_decode
(
bufãr
, (
lÚglÚg
 *)&(
v
.
i
));

263 ià(
Ën
 > 
size
)

265 
	`_pbcV_dezigzag32
((
lÚglÚg
 *)&(
v
.
i
));

267 
	`pd
(
ud
, 
ty³
 , 
ty³_Çme
, &
v
, 
f
->
id
, f->
Çme
);

268 
bufãr
 +ğ
Ën
;

269 
size
 -ğ
Ën
;

270 ++
n
;

272  
n
;

274 
PTYPE_SINT64
: {

275 
n
 = 0;

276 
size
 > 0) {

277 
Ën
;

278 ià(
size
 >= 10) {

279 
Ën
 = 
	`_pbcV_decode
(
bufãr
, (
lÚglÚg
 *)&(
v
.
i
));

280 
	`_pbcV_dezigzag64
((
lÚglÚg
 *)&(
v
.
i
));

282 
ušt8_t
 
‹mp
[10];

283 
	`memıy
(
‹mp
, 
bufãr
, 
size
);

284 
Ën
 = 
	`_pbcV_decode
(
bufãr
, (
lÚglÚg
 *)&(
v
.
i
));

285 ià(
Ën
 > 
size
)

287 
	`_pbcV_dezigzag64
((
lÚglÚg
 *)&(
v
.
i
));

289 
	`pd
(
ud
, 
ty³
 , 
ty³_Çme
, &
v
, 
f
->
id
, f->
Çme
);

290 
bufãr
 +ğ
Ën
;

291 
size
 -ğ
Ën
;

292 ++
n
;

294  
n
;

299 
	}
}

302 
	$pbc_decode
(
pbc_’v
 * 
’v
, cÚ¡ * 
ty³_Çme
 , 
pbc_¦iû
 * 
¦iû
, 
pbc_decod”
 
pd
, *
ud
) {

303 
_mes§ge
 * 
msg
 = 
	`_pbcP_g‘_mes§ge
(
’v
, 
ty³_Çme
);

304 ià(
msg
 =ğ
NULL
) {

305 
’v
->
Ï¡”rÜ
 = "Proto‚ot found";

308 ià(
¦iû
->
Ën
 == 0) {

311 
pbc_ùx
 
_ùx
;

312 
couÁ
 = 
	`_pbcC_İ’
(
_ùx
,
¦iû
->
bufãr
,¦iû->
Ën
);

313 ià(
couÁ
 <= 0) {

314 
’v
->
Ï¡”rÜ
 = "decode contextƒrror";

315 
	`_pbcC_şo£
(
_ùx
);

316  
couÁ
 - 1;

318 
cÚ‹xt
 * 
ùx
 = (cÚ‹xˆ*)
_ùx
;

319 
ušt8_t
 * 
¡¬t
 = (ušt8_ˆ*)
¦iû
->
bufãr
;

321 
i
;

322 
i
=0;i<
ùx
->
numb”
;i++) {

323 
id
 = 
ùx
->
a
[
i
].
wœe_id
 >> 3;

324 
_f›ld
 * 
f
 = (_f›ld *)
	`_pbcM__qu”y
(
msg
->
id
 , id);

325 ià(
f
==
NULL
) {

326 
”r
 = 
	`ÿÎ_unknown
(
pd
,
ud
,
id
,&
ùx
->
a
[
i
],
¡¬t
);

327 ià(
”r
) {

328 
	`_pbcC_şo£
(
_ùx
);

329  -
i
-1;

331 } ià(
f
->
Ïb–
 =ğ
LABEL_PACKED
) {

332 
©om
 * 
a
 = &
ùx
->a[
i
];

333 
n
 = 
	`ÿÎ_¬¿y
(
pd
, 
ud
, 
f
 , 
¡¬t
 + 
a
->
v
.
s
.¡¬ˆ,‡->v.s.
’d
 -‡->v.s.start);

334 ià(
n
 < 0) {

335 
	`_pbcC_şo£
(
_ùx
);

336  -
i
-1;

339 ià(
	`ÿÎ_ty³
(
pd
,
ud
,
f
,&
ùx
->
a
[
i
],
¡¬t
) != 0) {

340 
	`_pbcC_şo£
(
_ùx
);

341  -
i
-1;

346 
	`_pbcC_şo£
(
_ùx
);

347  
ùx
->
numb”
;

348 
	}
}

	@src/descriptor.pbc.h

1 
	gpbc_desütÜ
[] = {

	@src/map.c

1 
	~"m­.h
"

2 
	~"®loc.h
"

4 
	~<¡dlib.h
>

5 
	~<¡ršg.h
>

7 
	s_pbcM__¦Ù
 {

8 
	mid
;

9 * 
	mpoš‹r
;

10 
	mÃxt
;

13 
	sm­_
 {

14 
size_t
 
	m¬¿y_size
;

15 ** 
	m¬¿y
;

16 
size_t
 
	mhash_size
;

17 
_pbcM__¦Ù
 * 
	m¦Ù
;

20 
	s_pbcM_si_¦Ù
 {

21 cÚ¡ *
	mkey
;

22 
size_t
 
	mhash
;

23 
	mid
;

24 
	mÃxt
;

27 
	sm­_si
 {

28 
size_t
 
	msize
;

29 
_pbcM_si_¦Ù
 
	m¦Ù
[1];

32 
size_t


33 
	$ÿlc_hash
(cÚ¡ *
Çme
)

35 
size_t
 
Ën
 = 
	`¡¾’
(
Çme
);

36 
size_t
 
h
 = 
Ën
;

37 
size_t
 
¡•
 = (
Ën
>>5)+1;

38 
size_t
 
i
;

39 
i
=
Ën
; i>=
¡•
; i-=step)

40 
h
 = h ^ ((h<<5)+(h>>2)+(
size_t
)
Çme
[
i
-1]);

41  
h
;

42 
	}
}

44 
m­_si
 *

45 
	$_pbcM_si_Ãw
(
m­_kv
 * 
bË
, 
size
)

47 
size_t
 
sz
 = (
m­_si
è+ (
size
-1è* (
_pbcM_si_¦Ù
);

48 
m­_si
 * 
»t
 = (m­_s˜*)
	`m®loc
(
sz
);

49 
	`mem£t
(
»t
,0,
sz
);

51 
»t
->
size
 = (
size_t
)size;

53 
em±y
 = 0;

54 
i
;

56 
i
=0;i<
size
;i++) {

57 
size_t
 
hash_fuÎ
 = 
	`ÿlc_hash
((cÚ¡ *)
bË
[
i
].
poš‹r
);

58 
size_t
 
hash
 = 
hash_fuÎ
 % 
size
;

59 
_pbcM_si_¦Ù
 * 
¦Ù
 = &
»t
->¦Ù[
hash
];

60 ià(
¦Ù
->
key
 =ğ
NULL
) {

61 
¦Ù
->
key
 = (cÚ¡ *)
bË
[
i
].
poš‹r
;

62 
¦Ù
->
id
 = 
bË
[
i
].id;

63 
¦Ù
->
hash
 = 
hash_fuÎ
;

65 
»t
->
¦Ù
[
em±y
].
key
 !ğ
NULL
) {

66 ++
em±y
;

68 
_pbcM_si_¦Ù
 * 
em±y_¦Ù
 = &
»t
->
¦Ù
[
em±y
];

69 
em±y_¦Ù
->
Ãxt
 = 
¦Ù
->next;

70 
¦Ù
->
Ãxt
 = 
em±y
 + 1;

71 
em±y_¦Ù
->
id
 = 
bË
[
i
].id;

72 
em±y_¦Ù
->
key
 = (cÚ¡ *)
bË
[
i
].
poš‹r
;

73 
em±y_¦Ù
->
hash
 = 
hash_fuÎ
;

77  
»t
;

78 
	}
}

81 
	$_pbcM_si_d–‘e
(
m­_si
 *
m­
)

83 
	`ä“
(
m­
);

84 
	}
}

87 
	$_pbcM_si_qu”y
(
m­_si
 *
m­
, cÚ¡ *
key
, *
»suÉ
)

89 
size_t
 
hash_fuÎ
 = 
	`ÿlc_hash
(
key
);

90 
size_t
 
hash
 = 
hash_fuÎ
 % 
m­
->
size
;

92 
_pbcM_si_¦Ù
 * 
¦Ù
 = &
m­
->¦Ù[
hash
];

93 ià(
¦Ù
->
key
 =ğ
NULL
) {

97 ià(
¦Ù
->
hash
 =ğ
hash_fuÎ
 && 
	`¡rcmp
(¦Ù->
key
, key) == 0) {

98 *
»suÉ
 = 
¦Ù
->
id
;

101 ià(
¦Ù
->
Ãxt
 == 0) {

104 
¦Ù
 = &
m­
->¦Ù[¦Ù->
Ãxt
-1];

106 
	}
}

108 
m­_
 *

109 
	$_pbcM__Ãw_hash
(
m­_kv
 * 
bË
, 
size
)

111 
m­_
 * 
»t
 = (m­_ *)
	`m®loc
((map_ip));

112 
»t
->
¬¿y
 = 
NULL
;

113 
»t
->
¬¿y_size
 = 0;

114 
»t
->
hash_size
 = (
size_t
)
size
;

115 
»t
->
¦Ù
 = (
_pbcM__¦Ù
 *)
	`m®loc
((_pbcM__¦Ùè* 
size
);

116 
	`mem£t
(
»t
->
¦Ù
,0,(
_pbcM__¦Ù
è* 
size
);

117 
em±y
 = 0;

118 
i
;

119 
i
=0;i<
size
;i++) {

120 
hash
 = (()
bË
[
i
].
id
è% 
size
;

121 
_pbcM__¦Ù
 * 
¦Ù
 = &
»t
->¦Ù[
hash
];

122 ià(
¦Ù
->
poš‹r
 =ğ
NULL
) {

123 
¦Ù
->
poš‹r
 = 
bË
[
i
].pointer;

124 
¦Ù
->
id
 = 
bË
[
i
].id;

126 
»t
->
¦Ù
[
em±y
].
poš‹r
 !ğ
NULL
) {

127 ++
em±y
;

129 
_pbcM__¦Ù
 * 
em±y_¦Ù
 = &
»t
->
¦Ù
[
em±y
];

130 
em±y_¦Ù
->
Ãxt
 = 
¦Ù
->next;

131 
¦Ù
->
Ãxt
 = 
em±y
 + 1;

132 
em±y_¦Ù
->
id
 = 
bË
[
i
].id;

133 
em±y_¦Ù
->
poš‹r
 = 
bË
[
i
].pointer;

136  
»t
;

137 
	}
}

139 
m­_
 *

140 
	$_pbcM__Ãw
(
m­_kv
 * 
bË
, 
size
)

142 
i
;

143 
max
 = 
bË
[0].
id
;

144 ià(
max
 > 
size
 * 2 || max < 0)

145  
	`_pbcM__Ãw_hash
(
bË
,
size
);

146 
i
=1;i<
size
;i++) {

147 ià(
bË
[
i
].
id
 < 0) {

148  
	`_pbcM__Ãw_hash
(
bË
,
size
);

150 ià(
bË
[
i
].
id
 > 
max
) {

151 
max
 = 
bË
[
i
].
id
;

152 ià(
max
 > 
size
 * 2)

153  
	`_pbcM__Ãw_hash
(
bË
,
size
);

156 
m­_
 * 
»t
 = (m­_ *)
	`m®loc
((map_ip));

157 
»t
->
hash_size
 = 
size
;

158 
»t
->
¦Ù
 = 
NULL
;

159 
»t
->
¬¿y_size
 = 
max
 + 1;

160 
»t
->
¬¿y
 = (**)
	`m®loc
((
max
+1) * (*));

161 
	`mem£t
(
»t
->
¬¿y
,0,(
max
+1) * (*));

162 
i
=0;i<
size
;i++) {

163 
»t
->
¬¿y
[
bË
[
i
].
id
] =abË[i].
poš‹r
;

165  
»t
;

166 
	}
}

169 
	$_pbcM__d–‘e
(
m­_
 * 
m­
)

171 ià(
m­
) {

172 
	`ä“
(
m­
->
¬¿y
);

173 
	`ä“
(
m­
->
¦Ù
);

174 
	`ä“
(
m­
);

176 
	}
}

179 
	$_šjeù
(
m­_kv
 * 
bË
, 
m­_
 *
m­
)

181 ià(
m­
->
¬¿y
) {

182 
n
 = 0;

183 
i
;

184 
i
=0;i<()
m­
->
¬¿y_size
;i++) {

185 ià(
m­
->
¬¿y
[
i
]) {

186 
bË
[
n
].
id
 = 
i
;

187 
bË
[
n
].
poš‹r
 = 
m­
->
¬¿y
[
i
];

188 ++ 
n
;

192 
i
;

193 
i
=0;i<()
m­
->
hash_size
;i++) {

194 
bË
[
i
].
id
 = 
m­
->
¦Ù
[i].id;

195 
bË
[
i
].
poš‹r
 = 
m­
->
¦Ù
[i].pointer;

198 
	}
}

200 
m­_
 *

201 
	$_pbcM__combše
(
m­_
 *
a
, m­_ *
b
)

203 
sz
 = ()(
a
->
hash_size
 + 
b
->hash_size);

204 
m­_kv
 * 
bË
 = (m­_kv *)
	`m®loc
(
sz
 * (map_kv));

205 
	`mem£t
(
bË
 , 0 , 
sz
 * (
m­_kv
));

206 
	`_šjeù
(
bË
, 
a
);

207 
	`_šjeù
(
bË
 + 
a
->
hash_size
, 
b
);

208 
m­_
 * 
r
 = 
	`_pbcM__Ãw
(
bË
, 
sz
);

209 
	`ä“
(
bË
);

210  
r
;

211 
	}
}

214 
	$_pbcM__qu”y
(
m­_
 * 
m­
, 
id
)

216 ià(
m­
 =ğ
NULL
)

217  
NULL
;

218 ià(
m­
->
¬¿y
) {

219 ià(
id
>=0 && id<()
m­
->
¬¿y_size
)

220  
m­
->
¬¿y
[
id
];

221  
NULL
;

223 
hash
 = ()
id
 % 
m­
->
hash_size
;

224 
_pbcM__¦Ù
 * 
¦Ù
 = &
m­
->¦Ù[
hash
];

226 ià(
¦Ù
->
id
 == id) {

227  
¦Ù
->
poš‹r
;

229 ià(
¦Ù
->
Ãxt
 == 0) {

230  
NULL
;

232 
¦Ù
 = &
m­
->¦Ù[¦Ù->
Ãxt
-1];

234 
	}
}

236 
	s_pbcM_¥_¦Ù
 {

237 cÚ¡ *
	mkey
;

238 
size_t
 
	mhash
;

239 *
	mpoš‹r
;

240 
	mÃxt
;

243 
	sm­_¥
 {

244 
size_t
 
	mÿp
;

245 
size_t
 
	msize
;

246 
h—p
 *
	mh—p
;

247 
_pbcM_¥_¦Ù
 * 
	m¦Ù
;

250 
m­_¥
 *

251 
	$_pbcM_¥_Ãw
(
max
 , 
h—p
 *
h
)

253 
m­_¥
 * 
»t
 = (m­_¥ *)
	`HMALLOC
((map_sp));

254 
ÿp
 = 1;

255 
ÿp
 < 
max
) {

256 
ÿp
 *=2;

258 
»t
->
ÿp
 = cap;

259 
»t
->
size
 = 0;

260 
»t
->
¦Ù
 = (
_pbcM_¥_¦Ù
 *)
	`HMALLOC
Ô‘->
ÿp
 * (_pbcM_sp_slot));

261 
	`mem£t
(
»t
->
¦Ù
,0,(
_pbcM_¥_¦Ù
è*„‘->
ÿp
);

262 
»t
->
h—p
 = 
h
;

263  
»t
;

264 
	}
}

267 
	$_pbcM_¥_d–‘e
(
m­_¥
 *
m­
)

269 ià(
m­
 && m­->
h—p
 =ğ
NULL
) {

270 
	`_pbcM_ä“
(
m­
->
¦Ù
);

271 
	`_pbcM_ä“
(
m­
);

273 
	}
}

275 
_pbcM_¥_»hash
(
m­_¥
 *
m­
);

278 
	$_pbcM_¥_š£¹_hash
(
m­_¥
 *
m­
, cÚ¡ *
key
, 
size_t
 
hash_fuÎ
, * 
v®ue
)

280 ià(
m­
->
ÿp
 > m­->
size
) {

281 
size_t
 
hash
 = 
hash_fuÎ
 & (
m­
->
ÿp
-1);

282 
_pbcM_¥_¦Ù
 * 
¦Ù
 = &
m­
->¦Ù[
hash
];

283 ià(
¦Ù
->
key
 =ğ
NULL
) {

284 
¦Ù
->
key
 = key;

285 
¦Ù
->
poš‹r
 = 
v®ue
;

286 
¦Ù
->
hash
 = 
hash_fuÎ
;

288 
em±y
 = (
hash
 + 1è& (
m­
->
ÿp
-1);

289 
m­
->
¦Ù
[
em±y
].
key
 !ğ
NULL
) {

290 
em±y
 = (em±y + 1è& (
m­
->
ÿp
-1);

292 
_pbcM_¥_¦Ù
 * 
em±y_¦Ù
 = &
m­
->
¦Ù
[
em±y
];

293 
em±y_¦Ù
->
Ãxt
 = 
¦Ù
->next;

294 
¦Ù
->
Ãxt
 = 
em±y
 + 1;

295 
em±y_¦Ù
->
poš‹r
 = 
v®ue
;

296 
em±y_¦Ù
->
key
 = key;

297 
em±y_¦Ù
->
hash
 = 
hash_fuÎ
;

299 
m­
->
size
++;

302 
	`_pbcM_¥_»hash
(
m­
);

303 
	`_pbcM_¥_š£¹_hash
(
m­
, 
key
, 
hash_fuÎ
, 
v®ue
);

304 
	}
}

307 
	$_pbcM_¥_»hash
(
m­_¥
 *
m­
) {

308 
h—p
 * 
h
 = 
m­
->heap;

309 
_pbcM_¥_¦Ù
 * 
Şd_¦Ù
 = 
m­
->
¦Ù
;

310 
size_t
 
size
 = 
m­
->size;

311 
m­
->
size
 = 0;

312 
m­
->
ÿp
 *= 2;

313 
m­
->
¦Ù
 = (
_pbcM_¥_¦Ù
 *)
	`HMALLOC
((_pbcM_¥_¦Ù)*m­->
ÿp
);

314 
	`mem£t
(
m­
->
¦Ù
,0,(
_pbcM_¥_¦Ù
)*m­->
ÿp
);

315 
size_t
 
i
;

316 
i
=0;i<
size
;i++) {

317 
	`_pbcM_¥_š£¹_hash
(
m­
, 
Şd_¦Ù
[
i
].
key
, old_¦Ù[i].
hash
, old_¦Ù[i].
poš‹r
);

319 ià(
h
 =ğ
NULL
) {

320 
	`_pbcM_ä“
(
Şd_¦Ù
);

322 
	}
}

325 
	$_pbcM_¥_qu”y_š£¹_hash
(
m­_¥
 *
m­
, cÚ¡ *
key
, 
size_t
 
hash_fuÎ
)

327 
size_t
 
hash
 = 
hash_fuÎ
 & (
m­
->
ÿp
-1);

328 
_pbcM_¥_¦Ù
 * 
¦Ù
 = &
m­
->¦Ù[
hash
];

329 ià(
¦Ù
->
key
 =ğ
NULL
) {

330 ià(
m­
->
ÿp
 <ğm­->
size
)

331 
_»hash
;

332 
¦Ù
->
key
 = key;

333 
¦Ù
->
hash
 = 
hash_fuÎ
;

334 
m­
->
size
++;

335  &(
¦Ù
->
poš‹r
);

338 ià(
¦Ù
->
hash
 =ğ
hash_fuÎ
 && 
	`¡rcmp
(¦Ù->
key
, key) == 0)

339  &(
¦Ù
->
poš‹r
);

340 ià(
¦Ù
->
Ãxt
 == 0) {

343 
¦Ù
 = &
m­
->¦Ù[¦Ù->
Ãxt
-1];

345 ià(
m­
->
ÿp
 <ğm­->
size
)

346 
_»hash
;

348 
em±y
 = (
hash
 + 1è& (
m­
->
ÿp
-1);

349 
m­
->
¦Ù
[
em±y
].
key
 !ğ
NULL
) {

350 
em±y
 = (em±y + 1è& (
m­
->
ÿp
-1);

352 
_pbcM_¥_¦Ù
 * 
em±y_¦Ù
 = &
m­
->
¦Ù
[
em±y
];

353 
em±y_¦Ù
->
Ãxt
 = 
¦Ù
->next;

354 
¦Ù
->
Ãxt
 = 
em±y
 + 1;

355 
em±y_¦Ù
->
key
 = key;

356 
em±y_¦Ù
->
hash
 = 
hash_fuÎ
;

358 
m­
->
size
++;

360  &(
em±y_¦Ù
->
poš‹r
);

362 
_»hash
:

363 
	`_pbcM_¥_»hash
(
m­
);

364  
	`_pbcM_¥_qu”y_š£¹_hash
(
m­
, 
key
, 
hash_fuÎ
);

365 
	}
}

368 
	$_pbcM_¥_š£¹
(
m­_¥
 *
m­
, cÚ¡ *
key
, * 
v®ue
)

370 
	`_pbcM_¥_š£¹_hash
(
m­
,
key
,
	`ÿlc_hash
(key),
v®ue
);

371 
	}
}

374 
	$_pbcM_¥_qu”y_š£¹
(
m­_¥
 *
m­
, cÚ¡ *
key
)

376  
	`_pbcM_¥_qu”y_š£¹_hash
(
m­
,
key
,
	`ÿlc_hash
(key));

377 
	}
}

380 
	$_pbcM_¥_qu”y
(
m­_¥
 *
m­
, cÚ¡ *
key
)

382 ià(
m­
 =ğ
NULL
)

383  
NULL
;

384 
size_t
 
hash_fuÎ
 = 
	`ÿlc_hash
(
key
);

385 
size_t
 
hash
 = 
hash_fuÎ
 & (
m­
->
ÿp
 -1);

387 
_pbcM_¥_¦Ù
 * 
¦Ù
 = &
m­
->¦Ù[
hash
];

388 ià(
¦Ù
->
key
 =ğ
NULL
)

389  
NULL
;

391 ià(
¦Ù
->
hash
 =ğ
hash_fuÎ
 && 
	`¡rcmp
(¦Ù->
key
, key) == 0) {

392  
¦Ù
->
poš‹r
;

394 ià(
¦Ù
->
Ãxt
 == 0) {

395  
NULL
;

397 
¦Ù
 = &
m­
->¦Ù[¦Ù->
Ãxt
-1];

399 
	}
}

402 
_pbcM_¥_fÜ—ch
(
m­_¥
 *
m­
, (*
func
)(*
p
))

404 
size_t
 
i
;

405 
i
=0;i<
m­
->
ÿp
;i++) {

406 ià(
m­
->
¦Ù
[
i
].
poš‹r
) {

407 
	`func
(
m­
->
¦Ù
[
i
].
poš‹r
);

410 
	}
}

413 
_pbcM_¥_fÜ—ch_ud
(
m­_¥
 *
m­
, (*
func
)(*
p
, *
ud
), *ud)

415 
size_t
 
i
;

416 
i
=0;i<
m­
->
ÿp
;i++) {

417 ià(
m­
->
¦Ù
[
i
].
poš‹r
) {

418 
	`func
(
m­
->
¦Ù
[
i
].
poš‹r
,
ud
);

421 
	}
}

424 
	$_fšd_fœ¡
(
m­_¥
 *
m­
)

426 
size_t
 
i
;

427 
i
=0;i<
m­
->
ÿp
;i++) {

428 ià(
m­
->
¦Ù
[
i
].
poš‹r
) {

429  
i
;

433 
	}
}

436 
	$_fšd_Ãxt
(
m­_¥
 *
m­
, cÚ¡ *
key
)

438 
size_t
 
hash_fuÎ
 = 
	`ÿlc_hash
(
key
);

439 
size_t
 
hash
 = 
hash_fuÎ
 & (
m­
->
ÿp
 -1);

441 
_pbcM_¥_¦Ù
 * 
¦Ù
 = &
m­
->¦Ù[
hash
];

442 ià(
¦Ù
->
key
 =ğ
NULL
)

445 ià(
¦Ù
->
hash
 =ğ
hash_fuÎ
 && 
	`¡rcmp
(¦Ù->
key
, key) == 0) {

446 
i
 = 
¦Ù
 - 
m­
->slot + 1;

447 
i
<
m­
->
ÿp
) {

448 ià(
m­
->
¦Ù
[
i
].
poš‹r
) {

449  
i
;

451 ++
i
;

455 ià(
¦Ù
->
Ãxt
 == 0) {

458 
¦Ù
 = &
m­
->¦Ù[¦Ù->
Ãxt
-1];

460 
	}
}

463 
	$_pbcM_¥_Ãxt
(
m­_¥
 *
m­
, cÚ¡ ** 
key
)

465 ià(
m­
 =ğ
NULL
) {

466 *
key
 = 
NULL
;

467  
NULL
;

469 
idx
;

470 ià(*
key
 =ğ
NULL
) {

471 
idx
 = 
	`_fšd_fœ¡
(
m­
);

473 
idx
 = 
	`_fšd_Ãxt
(
m­
, *
key
);

475 ià(
idx
 < 0) {

476 *
key
 = 
NULL
;

477  
NULL
;

479 *
key
 = 
m­
->
¦Ù
[
idx
].key;

480  
m­
->
¦Ù
[
idx
].
poš‹r
;

481 
	}
}

	@src/map.h

1 #iâdeà
PROTOBUF_C_MAP_H


2 
	#PROTOBUF_C_MAP_H


	)

4 
	~"®loc.h
"

6 
	gm­_
;

7 
	gm­_si
;

8 
	gm­_¥
;

10 
	sm­_kv
 {

11 
	mid
;

12 *
	mpoš‹r
;

15 
m­_si
 * 
_pbcM_si_Ãw
(
m­_kv
 * 
bË
, 
size
);

16 
_pbcM_si_qu”y
(
m­_si
 *
m­
, cÚ¡ *
key
, *
»suÉ
);

17 
_pbcM_si_d–‘e
(
m­_si
 *
m­
);

19 
m­_
 * 
_pbcM__Ãw
(
m­_kv
 * 
bË
, 
size
);

20 
m­_
 * 
_pbcM__combše
(m­_ * 
a
, m­_ * 
b
);

21 * 
_pbcM__qu”y
(
m­_
 * 
m­
, 
id
);

22 
_pbcM__d–‘e
(
m­_
 *
m­
);

24 
m­_¥
 * 
_pbcM_¥_Ãw
(
max
, 
h—p
 *
h
);

25 
_pbcM_¥_š£¹
(
m­_¥
 *
m­
, cÚ¡ *
key
, * 
v®ue
);

26 * 
_pbcM_¥_qu”y
(
m­_¥
 *
m­
, cÚ¡ *
key
);

27 ** 
_pbcM_¥_qu”y_š£¹
(
m­_¥
 *
m­
, cÚ¡ *
key
);

28 
_pbcM_¥_d–‘e
(
m­_¥
 *
m­
);

29 
_pbcM_¥_fÜ—ch
(
m­_¥
 *
m­
, (*
func
)(*
p
));

30 
	`_pbcM_¥_fÜ—ch_ud
(
m­_¥
 *
m­
, (*
func
)(*
p
, *
ud
), *ud);

31 * 
	`_pbcM_¥_Ãxt
(
m­_¥
 *
m­
, cÚ¡ ** 
key
);

	@src/pattern.c

1 
	~"®loc.h
"

2 
	~"cÚ‹xt.h
"

3 
	~"v¬št.h
"

4 
	~"·‰”n.h
"

5 
	~"¬¿y.h
"

6 
	~"´Ùo.h
"

7 
	~"m­.h
"

9 
	~<¡dšt.h
>

10 #iâdeà
_MSC_VER


11 
	~<¡dboŞ.h
>

13 
	~<¡dlib.h
>

14 
	~<¡ddef.h
>

15 
	~<¡ršg.h
>

16 
	~<¡d¬g.h
>

19 
	$£t_deçuÉ_v
(* 
ouut
, 
ùy³
, 
pbc_v¬
 
defv
) {

20 
ùy³
) {

21 
CTYPE_INT32
:

22 *(
ušt32_t
 *)
ouut
 = 
defv
->
š‹g”
.
low
;

24 
CTYPE_INT64
:

25 *(
ušt64_t
 *)
ouut
 = (ušt64_t)
defv
->
š‹g”
.
low
 | (ušt64_t)defv->š‹g”.
hi
 << 32;

27 
CTYPE_DOUBLE
:

28 *(*)
ouut
 = 
defv
->
»®
;

30 
CTYPE_FLOAT
:

31 *(*)
ouut
 = ()
defv
->
»®
;

33 
CTYPE_BOOL
:

34 *(
boŞ
 *)
ouut
 = (
defv
->
š‹g”
.
low
 != 0);

36 
CTYPE_INT8
:

37 *(
ušt8_t
 *)
ouut
 = (ušt8_t)
defv
->
š‹g”
.
low
;

39 
CTYPE_INT16
:

40 *(
ušt16_t
 *)
ouut
 = (ušt16_t)
defv
->
š‹g”
.
low
;

42 
CTYPE_VAR
:

43 *(
_pbc_v¬
 *)
ouut
 = *
defv
;

46 
	}
}

49 
	$_·‰”n_£t_deçuÉ
(
_·‰”n_f›ld
 *
f›ld
, *
ouut
) {

50 ià(
f›ld
->
ùy³
 =ğ
CTYPE_ARRAY
 || f›ld->ùy³ =ğ
CTYPE_PACKED
) {

51 
_pbc_¬¿y
 *
¬¿y
 = (_pbc_¬¿y *)(
ouut
 + 
f›ld
->
off£t
);

52 
	`_pbcA_İ’
(
¬¿y
);

53 } ià(
f›ld
->
±y³
 =ğ
PTYPE_ENUM
) {

54 
pbc_v¬
 
defv
;

55 
defv
->
š‹g”
.
low
 = 
f›ld
->defv->
e
.
id
;

56 
defv
->
š‹g”
.
hi
 = 0;

57 
	`£t_deçuÉ_v
(
ouut
 + 
f›ld
->
off£t
, f›ld->
ùy³
, 
defv
);

59 
	`£t_deçuÉ_v
(
ouut
 + 
f›ld
->
off£t
, f›ld->
ùy³
, f›ld->
defv
);

60 
	}
}

63 
	$pbc_·‰”n_£t_deçuÉ
(
pbc_·‰”n
 *
·t
, *
ouut
) {

64 
i
;

65 
i
=0;i<
·t
->
couÁ
;i++) {

66 
	`_·‰”n_£t_deçuÉ
(&
·t
->
f
[
i
], (*)
ouut
);

68 
	}
}

72 
_·‰”n_f›ld
 *

73 
	$b£¬ch_·‰”n
(
pbc_·‰”n
 *
·t
, 
id
)

75 
begš
 = 0;

76 
’d
 = 
·t
->
couÁ
;

77 
begš
 < 
’d
) {

78 
mid
 = (
begš
 + 
’d
)/2;

79 
_·‰”n_f›ld
 * 
f
 = &
·t
->f[
mid
];

80 ià(
id
 =ğ
f
->id) {

81  
f
;

83 ià(
id
 < 
f
->id) {

84 
’d
 = 
mid
;

86 
begš
 = 
mid
 + 1;

89  
NULL
;

90 
	}
}

92 
šlše
 

93 
	$wr™e_»®
(
ùy³
, 
v
, *
out
) {

94 
ùy³
) {

95 
CTYPE_DOUBLE
:

96 *(*)
out
 = 
v
;

98 
CTYPE_FLOAT
:

99 *(*)
out
 = ()
v
;

101 
CTYPE_VAR
:

102 ((
_pbc_v¬
 *)
out
)->
»®
 = 
v
;

106 
	}
}

108 
šlše
 

109 
	$wr™e_lÚglÚg
(
ùy³
, 
lÚglÚg
 *
i
, *
out
) {

110 
ùy³
) {

111 
CTYPE_INT32
:

112 *(
ušt32_t
 *)
out
 = 
i
->
low
;

114 
CTYPE_INT64
:

115 *(
ušt64_t
 *)
out
 = (ušt64_t)
i
->
low
 | (ušt64_t)i->
hi
 << 32;

117 
CTYPE_BOOL
:

118 *(
boŞ
 *)
out
 = (
i
->
low
 !=0) ;

120 
CTYPE_INT8
:

121 *(
ušt8_t
 *)
out
 = (ušt8_t)
i
->
low
;

123 
CTYPE_INT16
:

124 *(
ušt8_t
 *)
out
 = (
ušt16_t
)
i
->
low
;

126 
CTYPE_VAR
:

127 ((
_pbc_v¬
 *)
out
)->
š‹g”
 = *
i
;

131 
	}
}

133 
šlše
 

134 
	$wr™e_š‹g”
(
ùy³
, 
©om
 *
a
, *
out
) {

135  
	`wr™e_lÚglÚg
(
ùy³
, &(
a
->
v
.
i
), 
out
);

136 
	}
}

138 
uÅack_¬¿y
(
±y³
, *
bufãr
, 
©om
 *, 
pbc_¬¿y
 
_¬¿y
);

141 
	$_pbcP_uÅack_·cked
(
ušt8_t
 *
bufãr
, 
size
, 
±y³
, 
pbc_¬¿y
 
¬¿y
) {

142 
pbc_v¬
 
v¬
;

143 
v¬
->
š‹g”
.
hi
 = 0;

144 
i
;

145 
±y³
) {

146 
PTYPE_DOUBLE
:

147 ià(
size
 % 8 != 0)

149 
i
=0;i<
size
;i+=8) {

151 
d
;

152 
ušt64_t
 
i64
;

153 } 
u
;

154 
u
.
i64
 = (
ušt64_t
)
bufãr
[
i
] |

155 (
ušt64_t
)
bufãr
[
i
+1] << 8 |

156 (
ušt64_t
)
bufãr
[
i
+2] << 16 |

157 (
ušt64_t
)
bufãr
[
i
+3] << 24 |

158 (
ušt64_t
)
bufãr
[
i
+4] << 32 |

159 (
ušt64_t
)
bufãr
[
i
+5] << 40 |

160 (
ušt64_t
)
bufãr
[
i
+6] << 48 |

161 (
ušt64_t
)
bufãr
[
i
+7] << 56;

162 
v¬
->
»®
 = 
u
.
d
;

163 
	`_pbcA_push
(
¬¿y
, 
v¬
);

165  
size
/8;

166 
PTYPE_FLOAT
:

167 ià(
size
 % 4 != 0)

169 
i
=0;i<
size
;i+=4) {

171 
f
;

172 
ušt32_t
 
i32
;

173 } 
u
;

174 
u
.
i32
 = (
ušt32_t
)
bufãr
[
i
] |

175 (
ušt32_t
)
bufãr
[
i
+1] << 8 |

176 (
ušt32_t
)
bufãr
[
i
+2] << 16 |

177 (
ušt32_t
)
bufãr
[
i
+3] << 24;

178 
v¬
->
»®
 = ()
u
.
f
;

179 
	`_pbcA_push
(
¬¿y
, 
v¬
);

181  
size
/4;

182 
PTYPE_FIXED32
:

183 
PTYPE_SFIXED32
:

184 ià(
size
 % 4 != 0)

186 
i
=0;i<
size
;i+=4) {

187 
v¬
->
š‹g”
.
low
 = (
ušt32_t
)
bufãr
[
i
] |

188 (
ušt32_t
)
bufãr
[
i
+1] << 8 |

189 (
ušt32_t
)
bufãr
[
i
+2] << 16 |

190 (
ušt32_t
)
bufãr
[
i
+3] << 24;

191 
	`_pbcA_push
(
¬¿y
, 
v¬
);

193  
size
/4;

194 
PTYPE_FIXED64
:

195 
PTYPE_SFIXED64
:

196 ià(
size
 % 8 != 0)

198 
i
=0;i<
size
;i+=8) {

199 
v¬
->
š‹g”
.
low
 = (
ušt32_t
)
bufãr
[
i
] |

200 (
ušt32_t
)
bufãr
[
i
+1] << 8 |

201 (
ušt32_t
)
bufãr
[
i
+2] << 16 |

202 (
ušt32_t
)
bufãr
[
i
+3] << 24;

203 
v¬
->
š‹g”
.
hi
 = (
ušt32_t
)
bufãr
[
i
+4] |

204 (
ušt32_t
)
bufãr
[
i
+5] << 8 |

205 (
ušt32_t
)
bufãr
[
i
+6] << 16 |

206 (
ušt32_t
)
bufãr
[
i
+7] << 24;

207 
	`_pbcA_push
(
¬¿y
, 
v¬
);

209  
size
/8;

210 
PTYPE_INT64
:

211 
PTYPE_UINT64
:

212 
PTYPE_INT32
:

213 
PTYPE_UINT32
:

214 
PTYPE_ENUM
:

215 
PTYPE_BOOL
: {

216 
n
 = 0;

217 
size
 > 0) {

218 
Ën
;

219 ià(
size
 >= 10) {

220 
Ën
 = 
	`_pbcV_decode
(
bufãr
, &(
v¬
->
š‹g”
));

222 
ušt8_t
 
‹mp
[10];

223 
	`memıy
(
‹mp
, 
bufãr
, 
size
);

224 
Ën
 = 
	`_pbcV_decode
(
bufãr
, &(
v¬
->
š‹g”
));

225 ià(
Ën
 > 
size
)

228 
	`_pbcA_push
(
¬¿y
, 
v¬
);

229 
bufãr
 +ğ
Ën
;

230 
size
 -ğ
Ën
;

231 ++
n
;

233  
n
;

235 
PTYPE_SINT32
: {

236 
n
 = 0;

237 
size
 > 0) {

238 
Ën
;

239 ià(
size
 >= 10) {

240 
Ën
 = 
	`_pbcV_decode
(
bufãr
, &(
v¬
->
š‹g”
));

241 
	`_pbcV_dezigzag32
(&(
v¬
->
š‹g”
));

243 
ušt8_t
 
‹mp
[10];

244 
	`memıy
(
‹mp
, 
bufãr
, 
size
);

245 
Ën
 = 
	`_pbcV_decode
(
bufãr
, &(
v¬
->
š‹g”
));

246 ià(
Ën
 > 
size
)

248 
	`_pbcV_dezigzag32
(&(
v¬
->
š‹g”
));

250 
	`_pbcA_push
(
¬¿y
, 
v¬
);

251 
bufãr
 +ğ
Ën
;

252 
size
 -ğ
Ën
;

253 ++
n
;

255  
n
;

257 
PTYPE_SINT64
: {

258 
n
 = 0;

259 
size
 > 0) {

260 
Ën
;

261 ià(
size
 >= 10) {

262 
Ën
 = 
	`_pbcV_decode
(
bufãr
, &(
v¬
->
š‹g”
));

263 
	`_pbcV_dezigzag64
(&(
v¬
->
š‹g”
));

265 
ušt8_t
 
‹mp
[10];

266 
	`memıy
(
‹mp
, 
bufãr
, 
size
);

267 
Ën
 = 
	`_pbcV_decode
(
bufãr
, &(
v¬
->
š‹g”
));

268 ià(
Ën
 > 
size
)

270 
	`_pbcV_dezigzag64
(&(
v¬
->
š‹g”
));

272 
	`_pbcA_push
(
¬¿y
, 
v¬
);

273 
bufãr
 +ğ
Ën
;

274 
size
 -ğ
Ën
;

275 ++
n
;

277  
n
;

281 
	}
}

284 
	$uÅack_f›ld
(
ùy³
, 
±y³
, * 
bufãr
, 
©om
 * 
a
, *
out
) {

285 ià(
ùy³
 =ğ
CTYPE_ARRAY
) {

286  
	`uÅack_¬¿y
(
±y³
, 
bufãr
, 
a
 , (
_pbc_¬¿y
 *)
out
);

288 ià(
ùy³
 =ğ
CTYPE_PACKED
) {

289  
	`_pbcP_uÅack_·cked
((
ušt8_t
 *)
bufãr
 + 
a
->
v
.
s
.
¡¬t
,‡->v.s.
’d
 -‡->v.s.¡¬t, 
±y³
, (
_pbc_¬¿y
 *)
out
);

291 
±y³
) {

292 
PTYPE_DOUBLE
:

293 
	`CHECK_BIT64
(
a
, -1);

294  
	`wr™e_»®
(
ùy³
, 
	`»ad_doubË
(
a
), 
out
);

295 
PTYPE_FLOAT
:

296 
	`CHECK_BIT32
(
a
, -1);

297  
	`wr™e_»®
(
ùy³
, 
	`»ad_æßt
(
a
), 
out
);

298 
PTYPE_INT64
:

299 
PTYPE_UINT64
:

300 
PTYPE_INT32
:

301 
PTYPE_UINT32
:

302 
PTYPE_ENUM
:

303 
PTYPE_BOOL
:

304 
	`CHECK_VARINT
(
a
, -1);

305  
	`wr™e_š‹g”
(
ùy³
, 
a
 , 
out
);

306 
PTYPE_FIXED32
:

307 
PTYPE_SFIXED32
:

308 
	`CHECK_BIT32
(
a
, -1);

309  
	`wr™e_š‹g”
(
ùy³
, 
a
 , 
out
);

310 
PTYPE_FIXED64
:

311 
PTYPE_SFIXED64
:

312 
	`CHECK_BIT64
(
a
, -1);

313  
	`wr™e_š‹g”
(
ùy³
, 
a
 , 
out
);

314 
PTYPE_SINT32
: {

315 
	`CHECK_VARINT
(
a
, -1);

316 
lÚglÚg
 
‹mp
 = 
a
->
v
.
i
;

317 
	`_pbcV_dezigzag32
(&
‹mp
);

318  
	`wr™e_lÚglÚg
(
ùy³
, &
‹mp
 , 
out
);

320 
PTYPE_SINT64
: {

321 
	`CHECK_LEND
(
a
, -1);

322 
lÚglÚg
 
‹mp
 = 
a
->
v
.
i
;

323 
	`_pbcV_dezigzag64
(&
‹mp
);

324  
	`wr™e_lÚglÚg
(
ùy³
, &
‹mp
 , 
out
);

326 
PTYPE_MESSAGE
:

327 
	`CHECK_LEND
(
a
, -1);

328 ((
_pbc_v¬
 *)
out
)->
m
.
bufãr
 = bufã¸+ 
a
->
v
.
s
.
¡¬t
;

329 ((
_pbc_v¬
 *)
out
)->
m
.
Ën
 = 
a
->
v
.
s
.
’d
 -‡->v.s.
¡¬t
;

331 
PTYPE_STRING
:

332 
PTYPE_BYTES
:

333 
	`CHECK_LEND
(
a
, -1);

334 ((
pbc_¦iû
 *)
out
)->
bufãr
 = bufã¸+ 
a
->
v
.
s
.
¡¬t
;

335 ((
pbc_¦iû
 *)
out
)->
Ën
 = 
a
->
v
.
s
.
’d
 -‡->v.s.
¡¬t
;

339 
	}
}

342 
	$uÅack_¬¿y
(
±y³
, *
bufãr
, 
©om
 * 
a
, 
pbc_¬¿y
 
_¬¿y
) {

343 
pbc_v¬
 
v¬
;

344 
r
 = 
	`uÅack_f›ld
(
CTYPE_VAR
, 
±y³
, 
bufãr
, 
a
 , 
v¬
);

345 ià(
r
 !=0 )

346  
r
;

347 
	`_pbcA_push
(
_¬¿y
 , 
v¬
);

350 
	}
}

353 
	$pbc_·‰”n_şo£_¬¿ys
(
pbc_·‰”n
 *
·t
, * 
d©a
) {

354 
i
;

355 
i
=0;i<
·t
->
couÁ
;i++) {

356 ià(
·t
->
f
[
i
].
ùy³
 =ğ
CTYPE_ARRAY
 ||…©->f[i].ùy³ =ğ
CTYPE_PACKED
) {

357 *
¬¿y
 = (*)
d©a
 + 
·t
->
f
[
i
].
off£t
;

358 
	`_pbcA_şo£
((
_pbc_¬¿y
 *)
¬¿y
);

361 
	}
}

363 
šlše
 

364 
	$_·ck_wœ‘y³
(
ušt32_t
 
wt
, 
pbc_¦iû
 *
s
) {

365 
Ën
;

366 ià(
s
->
Ën
 < 10) {

367 
ušt8_t
 
‹mp
[10];

368 
Ën
 = 
	`_pbcV_’code32
(
wt
, 
‹mp
);

369 ià(
Ën
 > 
s
->len)

371 
	`memıy
(
s
->
bufãr
, 
‹mp
, 
Ën
);

373 
Ën
 = 
	`_pbcV_’code32
(
wt
, (
ušt8_t
 *)
s
->
bufãr
);

375 
s
->
bufãr
 = (*)s->bufã¸+ 
Ën
;

376 
s
->
Ën
 -=†en;

377  
Ën
;

378 
	}
}

380 
šlše
 

381 
	$_·ck_v¬št64
(
ušt64_t
 
i64
, 
pbc_¦iû
 *
s
) {

382 
Ën
;

383 ià(
s
->
Ën
 < 10) {

384 
ušt8_t
 
‹mp
[10];

385 
Ën
 = 
	`_pbcV_’code
(
i64
, 
‹mp
);

386 ià(
Ën
 > 
s
->len)

388 
	`memıy
(
s
->
bufãr
, 
‹mp
, 
Ën
);

390 
Ën
 = 
	`_pbcV_’code
(
i64
, (
ušt8_t
 *)
s
->
bufãr
);

392 
s
->
bufãr
 = (*)s->bufã¸+ 
Ën
;

393 
s
->
Ën
 -=†en;

394  
Ën
;

395 
	}
}

397 
šlše
 

398 
	$_·ck_sšt32
(
ušt32_t
 
v
, 
pbc_¦iû
 *
s
) {

399 
Ën
;

400 ià(
s
->
Ën
 < 10) {

401 
ušt8_t
 
‹mp
[10];

402 
Ën
 = 
	`_pbcV_zigzag32
(
v
, 
‹mp
);

403 ià(
Ën
 > 
s
->len)

405 
	`memıy
(
s
->
bufãr
, 
‹mp
, 
Ën
);

407 
Ën
 = 
	`_pbcV_zigzag32
(
v
, (
ušt8_t
 *)
s
->
bufãr
);

409 
s
->
bufãr
 = (*)s->bufã¸+ 
Ën
;

410 
s
->
Ën
 -=†en;

411  
Ën
;

412 
	}
}

414 
šlše
 

415 
	$_·ck_sšt64
(
ušt64_t
 
v
, 
pbc_¦iû
 *
s
) {

416 
Ën
;

417 ià(
s
->
Ën
 < 10) {

418 
ušt8_t
 
‹mp
[10];

419 
Ën
 = 
	`_pbcV_zigzag
(
v
, 
‹mp
);

420 ià(
Ën
 > 
s
->len)

422 
	`memıy
(
s
->
bufãr
, 
‹mp
, 
Ën
);

424 
Ën
 = 
	`_pbcV_zigzag
(
v
, (
ušt8_t
 *)
s
->
bufãr
);

426 
s
->
bufãr
 = (*)s->bufã¸+ 
Ën
;

427 
s
->
Ën
 -=†en;

428  
Ën
;

429 
	}
}

431 
šlše
 

432 
	$_fix32_’code
(
ušt32_t
 
v
 , 
ušt8_t
 *
bufãr
) {

433 
bufãr
[0] = (
ušt8_t
è
v
;

434 
bufãr
[1] = (
ušt8_t
è(
v
 >> 8);

435 
bufãr
[2] = (
ušt8_t
è(
v
 >> 16);

436 
bufãr
[3] = (
ušt8_t
è(
v
 >> 24);

437 
	}
}

439 
šlše
 

440 
	$_fix64_’code
(
lÚglÚg
 *
v
 , 
ušt8_t
 *
bufãr
) {

441 
	`_fix32_’code
(
v
->
low
 , 
bufãr
);

442 
	`_fix32_’code
(
v
->
hi
, 
bufãr
 + 4);

443 
	}
}

446 
	$_·ck_numb”
(
±y³
 , 
ùy³
 , 
pbc_¦iû
 *
s
, *
šput
) {

447 
pbc_v¬
 
v¬
;

448 ià(
ùy³
 =ğ
CTYPE_VAR
) {

449 
	`memıy
(
v¬
, 
šput
, (var));

451 
ùy³
) {

452 
CTYPE_INT32
:

453 
v¬
->
š‹g”
.
low
 = *(
ušt32_t
 *)
šput
;

454 
v¬
->
š‹g”
.
hi
 = 0;

456 
CTYPE_INT64
: {

457 
ušt64_t
 
v
 = *(ušt64_ˆ*)
šput
;

458 
v¬
->
š‹g”
.
low
 = (
ušt32_t
è(
v
 & 0xffffffff);

459 
v¬
->
š‹g”
.
hi
 = (
ušt32_t
è(
v
 >> 32);

462 
CTYPE_INT16
:

463 
v¬
->
š‹g”
.
low
 = *(
ušt16_t
 *)
šput
;

464 
v¬
->
š‹g”
.
hi
 = 0;

466 
CTYPE_INT8
:

467 
v¬
->
š‹g”
.
low
 = *(
ušt8_t
 *)
šput
;

468 
v¬
->
š‹g”
.
hi
 = 0;

470 
CTYPE_BOOL
:

471 
v¬
->
š‹g”
.
low
 = *(
boŞ
 *)
šput
;

472 
v¬
->
š‹g”
.
hi
 = 0;

474 
CTYPE_DOUBLE
:

475 
v¬
->
»®
 = *(*)
šput
;

477 
CTYPE_FLOAT
:

478 
v¬
->
»®
 = *(*)
šput
;

483 
±y³
) {

484 
PTYPE_FIXED64
:

485 
PTYPE_SFIXED64
:

486 ià(
s
->
Ën
 < 8)

488 
	`_fix64_’code
(&(
v¬
->
š‹g”
), (
ušt8_t
 *)
s
->
bufãr
);

489 
s
->
bufãr
 = (*)s->buffer + 8;

490 
s
->
Ën
 -= 8;

492 
PTYPE_DOUBLE
:

493 ià(
s
->
Ën
 < 8)

495 
	`doubË_’code
(
v¬
->
»®
 , (
ušt8_t
 *)
s
->
bufãr
);

496 
s
->
bufãr
 = (*)s->buffer + 8;

497 
s
->
Ën
 -= 8;

499 
PTYPE_FLOAT
:

500 ià(
s
->
Ën
 < 4)

502 
	`æßt_’code
(()
v¬
->
»®
 , (
ušt8_t
 *)
s
->
bufãr
);

503 
s
->
bufãr
 = (*)s->buffer + 4;

504 
s
->
Ën
 -= 4;

506 
PTYPE_FIXED32
:

507 
PTYPE_SFIXED32
:

508 ià(
s
->
Ën
 < 4)

510 
	`_fix32_’code
(
v¬
->
š‹g”
.
low
, (
ušt8_t
 *)
s
->
bufãr
);

511 
s
->
bufãr
 = (*)s->buffer + 4;

512 
s
->
Ën
 -= 4;

514 
PTYPE_UINT64
:

515 
PTYPE_INT64
:

516 
PTYPE_INT32
:

517  
	`_·ck_v¬št64
((
ušt64_t
)
v¬
->
š‹g”
.
low
 | (ušt64_t)v¬->š‹g”.
hi
 << 32, 
s
);

518 
PTYPE_UINT32
:

519 
PTYPE_BOOL
:

520 
PTYPE_ENUM
:

521  
	`_·ck_wœ‘y³
(
v¬
->
š‹g”
.
low
 , 
s
);

522 
PTYPE_SINT32
:

523  
	`_·ck_sšt32
(
v¬
->
š‹g”
.
low
 , 
s
);

524 
PTYPE_SINT64
:

525  
	`_·ck_sšt64
((
ušt64_t
)
v¬
->
š‹g”
.
low
 | (ušt64_t)v¬->š‹g”.
hi
 << 32 , 
s
);

529 
	}
}

532 
	$_·ck_f›ld
(
_·‰”n_f›ld
 *
pf
 , 
ùy³
, 
pbc_¦iû
 *
s
, *
šput
) {

533 
wœ‘y³
;

534 
»t
 = 0;

535 
Ën
;

536 
pbc_¦iû
 * 
šput_¦iû
;

537 
pbc_¦iû
 
¡ršg_¦iû
;

539 
pf
->
±y³
) {

540 
PTYPE_FIXED64
:

541 
PTYPE_SFIXED64
:

542 
PTYPE_DOUBLE
:

543 
wœ‘y³
 = 
WT_BIT64
;

544 
_numb”
;

545 
PTYPE_FIXED32
:

546 
PTYPE_SFIXED32
:

547 
PTYPE_FLOAT
:

548 
wœ‘y³
 = 
WT_BIT32
;

549 
_numb”
;

550 
PTYPE_UINT64
:

551 
PTYPE_INT64
:

552 
PTYPE_INT32
:

553 
PTYPE_BOOL
:

554 
PTYPE_UINT32
:

555 
PTYPE_ENUM
:

556 
PTYPE_SINT32
:

557 
PTYPE_SINT64
:

558 
wœ‘y³
 = 
WT_VARINT
;

559 
_numb”
;

560 
PTYPE_STRING
:

561 
wœ‘y³
 = 
WT_LEND
;

562 
šput_¦iû
 = (
pbc_¦iû
 *)
šput
;

563 ià(
šput_¦iû
->
Ën
 >= 0)

564 
_¡ršg
;

565 
¡ršg_¦iû
.
bufãr
 = 
šput_¦iû
->buffer;

566 
¡ršg_¦iû
.
Ën
 = 
	`¡¾’
((cÚ¡ *)¡ršg_¦iû.
bufãr
è- 
šput_¦iû
->len;

567 
šput_¦iû
 = &
¡ršg_¦iû
;

569 
_¡ršg
;

570 
PTYPE_MESSAGE
:

571 
PTYPE_BYTES
:

572 
wœ‘y³
 = 
WT_LEND
;

573 
_by‹s
;

579 
_by‹s
:

580 
šput_¦iû
 = (
pbc_¦iû
 *)
šput
;

581 
_¡ršg
:

582 
Ën
 = 
	`_·ck_wœ‘y³
(
pf
->
id
 << 3 | 
WT_LEND
 , 
s
);

583 ià(
Ën
 < 0) {

584  
Ën
;

586 
»t
 +ğ
Ën
;

587 
Ën
 = 
	`_·ck_wœ‘y³
(
šput_¦iû
->ËÀ, 
s
);

588 ià(
Ën
 < 0) {

589  
Ën
;

591 
»t
 +ğ
Ën
;

592 ià(
šput_¦iû
->
Ën
 > 
s
->len)

594 
	`memıy
(
s
->
bufãr
 , 
šput_¦iû
->bufãr, iÅut_¦iû->
Ën
);

595 
»t
 +ğ
šput_¦iû
->
Ën
;

596 
s
->
bufãr
 = (*)s->bufã¸+ 
šput_¦iû
->
Ën
;

597 
s
->
Ën
 -ğ
šput_¦iû
->len;

599  
»t
;

600 
_numb”
:

601 
Ën
 = 
	`_·ck_wœ‘y³
(
pf
->
id
 << 3 | 
wœ‘y³
 , 
s
);

602 ià(
Ën
 < 0) {

603  
Ën
;

605 
»t
 +ğ
Ën
;

606 
Ën
 = 
	`_·ck_numb”
(
pf
->
±y³
, 
ùy³
 , 
s
, 
šput
);

607 ià(
Ën
 < 0) {

608  
Ën
;

610 
»t
 +ğ
Ën
;

612  
»t
;

613 
	}
}

616 
	$_·ck_»³©ed
(
_·‰”n_f›ld
 *
pf
 , 
pbc_¦iû
 *
s
, 
pbc_¬¿y
 
¬¿y
) {

617 
n
 = 
	`pbc_¬¿y_size
(
¬¿y
);

618 
»t
 = 0;

619 ià(
n
>0) {

620 
i
;

621 
i
=0;i<
n
;i++) {

622 
Ën
 = 
	`_·ck_f›ld
(
pf
 , 
CTYPE_VAR
 , 
s
 , 
	`_pbcA_šdex_p
(
¬¿y
 , 
i
));

623 ià(
Ën
 < 0)

624  
Ën
;

625 
»t
 +ğ
Ën
;

628  
»t
;

629 
	}
}

632 
	$_·ck_·cked_fixed
(
_·‰”n_f›ld
 *
pf
 , 
width
, 
pbc_¦iû
 *
s
, 
pbc_¬¿y
 
¬¿y
) {

633 
Ën
;

634 
n
 = 
	`pbc_¬¿y_size
(
¬¿y
);

635 
Ën
 = 
	`_·ck_wœ‘y³
(
n
 * 
width
 , 
s
);

636 ià(
Ën
 < 0) {

637  
Ën
;

639 ià(
s
->
Ën
 -†’ < 
n
 * 
width
)

641 
i
;

642 
i
=0;i<
n
;i++) {

643 
	`_·ck_numb”
(
pf
->
±y³
, 
CTYPE_VAR
 , 
s
, 
	`_pbcA_šdex_p
(
¬¿y
, 
i
));

646  
Ën
 + 
n
 * 
width
;

647 
	}
}

650 
	$_·ck_·cked_v¬št
(
_·‰”n_f›ld
 *
pf
 , 
pbc_¦iû
 *
¦iû
, 
pbc_¬¿y
 
¬¿y
) {

651 
pbc_¦iû
 
s
 = * 
¦iû
;

652 
n
 = 
	`pbc_¬¿y_size
(
¬¿y
);

653 
e¡im©e
 = 
n
;

654 
e¡im©e_Ën
 = 
	`_·ck_wœ‘y³
(
e¡im©e
 , &
s
);

655 ià(
e¡im©e_Ën
 < 0) {

658 
i
;

659 
·cked_Ën
 = 0;

660 
i
=0;i<
n
;i++) {

661 
Ën
 = 
	`_·ck_numb”
(
pf
->
±y³
, 
CTYPE_VAR
 , &
s
, 
	`_pbcA_šdex_p
(
¬¿y
, 
i
));

662 ià(
Ën
 < 0)

664 
·cked_Ën
 +ğ
Ën
;

666 ià(
·cked_Ën
 =ğ
e¡im©e
) {

667 *
¦iû
 = 
s
;

668  
·cked_Ën
 + 
e¡im©e_Ën
;

670 
ušt8_t
 
‹mp
[10];

671 
pbc_¦iû
 
h—d”_¦iû
 = { 
‹mp
 , 10 };

672 
h—d”_Ën
 = 
	`_·ck_wœ‘y³
(
·cked_Ën
 , &
h—d”_¦iû
);

673 ià(
h—d”_Ën
 =ğ
e¡im©e_Ën
) {

674 
	`memıy
(
¦iû
->
bufãr
 , 
‹mp
 , 
h—d”_Ën
);

675 *
¦iû
 = 
s
;

676  
·cked_Ën
 + 
e¡im©e_Ën
;

678 ià(
h—d”_Ën
 + 
·cked_Ën
 > 
¦iû
->
Ën
)

680 
	`memmove
((*)
¦iû
->
bufãr
 + 
h—d”_Ën
 , (*)¦iû->bufã¸+ 
e¡im©e_Ën
, 
·cked_Ën
);

681 
	`memıy
(
¦iû
->
bufãr
 , 
‹mp
 , 
h—d”_Ën
);

682 
¦iû
->
bufãr
 = (*)¦iû->bufã¸+ 
·cked_Ën
 + 
h—d”_Ën
;

683 
¦iû
->
Ën
 -ğ
·cked_Ën
 + 
h—d”_Ën
;

684  
·cked_Ën
 + 
h—d”_Ën
;

685 
	}
}

688 
	$_·ck_·cked
(
_·‰”n_f›ld
 *
pf
 , 
pbc_¦iû
 *
s
, 
pbc_¬¿y
 
¬¿y
) {

689 
n
 = 
	`pbc_¬¿y_size
(
¬¿y
);

690 ià(
n
 == 0)

693 
»t
 = 0;

694 
Ën
;

695 
Ën
 = 
	`_·ck_wœ‘y³
(
pf
->
id
 << 3 | 
WT_LEND
 , 
s
);

696 ià(
Ën
 < 0) {

697  
Ën
;

699 
»t
 +ğ
Ën
;

701 
pf
->
±y³
) {

702 
PTYPE_FIXED64
:

703 
PTYPE_SFIXED64
:

704 
PTYPE_DOUBLE
:

705 
Ën
 = 
	`_·ck_·cked_fixed
(
pf
, 8, 
s
 , 
¬¿y
);

706 ià(
Ën
 < 0)

707  
Ën
;

709 
PTYPE_FIXED32
:

710 
PTYPE_SFIXED32
:

711 
PTYPE_FLOAT
:

712 
Ën
 = 
	`_·ck_·cked_fixed
(
pf
, 4, 
s
 , 
¬¿y
);

713 ià(
Ën
 < 0)

714  
Ën
;

716 
PTYPE_UINT64
:

717 
PTYPE_INT64
:

718 
PTYPE_INT32
:

719 
PTYPE_BOOL
:

720 
PTYPE_UINT32
:

721 
PTYPE_ENUM
:

722 
PTYPE_SINT32
:

723 
PTYPE_SINT64
:

724 
Ën
 = 
	`_·ck_·cked_v¬št
(
pf
, 
s
, 
¬¿y
);

725 ià(
Ën
 < 0)

726  
Ën
;

729 
»t
 +ğ
Ën
;

731  
»t
;

732 
	}
}

734 
boŞ


735 
	$_is_deçuÉ
(
_·‰”n_f›ld
 * 
pf
, * 
š
) {

736 
pf
->
ùy³
) {

737 
CTYPE_INT64
: {

738 
lÚglÚg
 * 
d64
 = &
pf
->
defv
->
š‹g”
;

739  ((
ušt64_t
)
d64
->
low
 | (ušt64_t)d64->
hi
 << 32è=ğ*(ušt64_ˆ*)
š
;

741 
CTYPE_DOUBLE
:

742  
pf
->
defv
->
»®
 =ğ*(*)
š
;

743 
CTYPE_FLOAT
:

744  ()(
pf
->
defv
->
»®
è=ğ*(*)
š
;

745 
CTYPE_INT32
:

746  
pf
->
defv
->
š‹g”
.
low
 =ğ*(
ušt32_t
 *)
š
;

747 
CTYPE_INT16
:

748  (
ušt16_t
)(
pf
->
defv
->
š‹g”
.
low
è=ğ*(ušt16_ˆ*)
š
;

749 
CTYPE_INT8
:

750  (
ušt8_t
)(
pf
->
defv
->
š‹g”
.
low
è=ğ*(ušt8_ˆ*)
š
;

751 
CTYPE_BOOL
:

752 ià(
pf
->
defv
->
š‹g”
.
low
)

753  *(
boŞ
 *)
š
 =ğ
Œue
;

755  *(
boŞ
 *)
š
 =ğ
çl£
;

757 ià(
pf
->
±y³
 =ğ
PTYPE_STRING
) {

758 
pbc_¦iû
 *
¦iû
 = (pbc_¦iû *)
š
;

759 ià(
¦iû
->
bufãr
 =ğ
NULL
) {

760  
pf
->
defv
->
s
.
¡r
[0] == '\0';

762 
Ën
 = 
¦iû
->len;

763 ià(
Ën
 <= 0) {

764  
	`¡rcmp
(
pf
->
defv
->
s
.
¡r
, (cÚ¡ *)
¦iû
->
bufãr
) == 0;

766  
Ën
 =ğ
pf
->
defv
->
s
.ËÀ&& 
	`memcmp
Õf->defv->s.
¡r
, 
¦iû
->
bufãr
,†en)==0;

767 } ià(
pf
->
±y³
 =ğ
PTYPE_BYTES
) {

768 
pbc_¦iû
 *
¦iû
 = (pbc_¦iû *)
š
;

769 ià(
¦iû
->
bufãr
 =ğ
NULL
)

770  
Œue
;

773  
çl£
;

774 
	}
}

777 
	$pbc_·‰”n_·ck
(
pbc_·‰”n
 *
·t
, *
šput
, 
pbc_¦iû
 * 
s
)

779 
pbc_¦iû
 
¦iû
 = *
s
;

780 
i
;

781 
i
=0;i<
·t
->
couÁ
;i++) {

782 
_·‰”n_f›ld
 * 
pf
 = &
·t
->
f
[
i
];

783 * 
š
 = (*)
šput
 + 
pf
->
off£t
;

784 
Ën
 = 0;

785 
pf
->
Ïb–
) {

786 
LABEL_OPTIONAL
:

787 ià(
	`_is_deçuÉ
(
pf
 , 
š
)) {

790 
LABEL_REQUIRED
:

791 
Ën
 = 
	`_·ck_f›ld
(
pf
,…f->
ùy³
, &
¦iû
, 
š
);

793 
LABEL_REPEATED
:

794 
Ën
 = 
	`_·ck_»³©ed
(
pf
, &
¦iû
 , (
_pbc_¬¿y
 *)
š
);

796 
LABEL_PACKED
:

797 
Ën
 = 
	`_·ck_·cked
(
pf
, &
¦iû
 , (
_pbc_¬¿y
 *)
š
);

800 ià(
Ën
 < 0) {

801  
Ën
;

804 
Ën
 = (*)
¦iû
.
bufãr
 - (*)
s
->buffer;

805 
»t
 = 
s
->
Ën
 -†en;

806 
s
->
Ën
 =†en;

807  
»t
;

808 
	}
}

811 
	$pbc_·‰”n_uÅack
(
pbc_·‰”n
 *
·t
, 
pbc_¦iû
 *
s
, * 
ouut
) {

812 ià(
s
->
Ën
 == 0) {

813 
	`pbc_·‰”n_£t_deçuÉ
(
·t
, 
ouut
);

816 
pbc_ùx
 
_ùx
;

817 
r
 = 
	`_pbcC_İ’
(
_ùx
, 
s
->
bufãr
, s->
Ën
);

818 ià(
r
 <= 0) {

819 
·t
->
’v
->
Ï¡”rÜ
 = "Pattern unpack open contextƒrror";

820 
	`_pbcC_şo£
(
_ùx
);

821  
r
-1;

824 
cÚ‹xt
 * 
ùx
 = (cÚ‹xˆ*)
_ùx
;

825 
boŞ
 * 
f›ld
 = (boŞ *)
	`®loÿ
(
·t
->
couÁ
 * (bool));

826 
	`mem£t
(
f›ld
, 0, 
·t
->
couÁ
 * (
boŞ
));

828 
i
;

829 
fc
 = 0;

831 
i
=0;i<
ùx
->
numb”
;i++) {

832 
_·‰”n_f›ld
 * 
f
 = 
	`b£¬ch_·‰”n
(
·t
, 
ùx
->
a
[
i
].
wœe_id
 >> 3);

833 ià(
f
) {

834 
šdex
 = 
f
 - 
·t
->f;

835 ià(
f›ld
[
šdex
] =ğ
çl£
) {

836 
f›ld
[
šdex
] = 
Œue
;

837 ++
fc
;

838 ià((
f
->
ùy³
 =ğ
CTYPE_ARRAY
 || f->ùy³ =ğ
CTYPE_PACKED
)) {

839 
_pbc_¬¿y
 *
¬¿y
 = (_pbc_¬¿y *)((*)
ouut
 + 
f
->
off£t
);

840 
	`_pbcA_İ’
(
¬¿y
);

843 * 
out
 = (*)
ouut
 + 
f
->
off£t
;

844 ià(
	`uÅack_f›ld
(
f
->
ùy³
 , f->
±y³
 , 
ùx
->
bufãr
 , &ùx->
a
[
i
], 
out
) < 0) {

845 
j
;

846 
j
=0;j<
·t
->
couÁ
;j++) {

847 ià(
f›ld
[
j
] =ğ
Œue
 && (
·t
->
f
[j].
ùy³
 =ğ
CTYPE_ARRAY
 ||…©->f[j].ùy³ =ğ
CTYPE_PACKED
)) {

848 *
¬¿y
 = (*)
ouut
 + 
·t
->
f
[
j
].
off£t
;

849 
	`_pbcA_şo£
((
_pbc_¬¿y
 *)
¬¿y
);

852 
	`_pbcC_şo£
(
_ùx
);

853 
·t
->
’v
->
Ï¡”rÜ
 = "Pattern unpack fieldƒrror";

854  -
i
-1;

858 
	`_pbcC_şo£
(
_ùx
);

859 ià(
fc
 !ğ
·t
->
couÁ
) {

860 
i
=0;i<
·t
->
couÁ
;i++) {

861 ià(
f›ld
[
i
] =ğ
çl£
) {

862 
	`_·‰”n_£t_deçuÉ
(&
·t
->
f
[
i
], (*)
ouut
);

867 
	}
}

883 
	$_ùy³
(cÚ¡ * 
ùy³
) {

884 ià(
ùy³
[0]!='%')

886 
ùy³
[1]) {

888  
CTYPE_FLOAT
;

890  
CTYPE_DOUBLE
;

892  
CTYPE_INT32
;

894  
CTYPE_INT64
;

896  
CTYPE_BOOL
;

898  
CTYPE_INT16
;

900  
CTYPE_INT8
;

902  
CTYPE_VAR
;

904  
CTYPE_ARRAY
;

908 
	}
}

911 
	$_ùy³_size
(cÚ¡ *
ùy³
) {

912 
ùy³
[1]) {

918  (
št32_t
);

920  (
št64_t
);

922  (
boŞ
);

924  (
št16_t
);

926  (
št8_t
);

928  (
pbc_¦iû
);

930  (
pbc_¬¿y
);

934 
	}
}

937 
	$_cİy_¡ršg
(cÚ¡ *
fÜm©
 , ** 
‹mp
) {

938 * 
ouut
 = *
‹mp
;

939 *
fÜm©
 == ' ' || *format == '\t' || *format == '\n' || *format == '\r') {

940 ++
fÜm©
;

942 *
fÜm©
 != '\0' &&

943 *
fÜm©
 != ' ' &&

944 *
fÜm©
 != '\t' &&

945 *
fÜm©
 != '\n' &&

946 *
fÜm©
 != '\r') {

947 *
ouut
 = *
fÜm©
;

948 ++
ouut
;

949 ++
fÜm©
;

951 *
ouut
 = '\0';

952 ++
ouut
;

953 *
‹mp
 = 
ouut
;

955  
fÜm©
;

956 
	}
}

959 
	$_sÿn_·‰”n
(cÚ¡ * 
fÜm©
 , * 
‹mp
) {

960 
n
 = 0;

962 
fÜm©
 = 
	`_cİy_¡ršg
(fÜm© , &
‹mp
);

963 ià(
fÜm©
[0] == '\0')

965 ++
n
;

966 
fÜm©
 = 
	`_cİy_¡ršg
(fÜm© , &
‹mp
);

967 ià(
fÜm©
[0] == '\0')

968  
n
;

970 
	}
}

973 
	$_comp_f›ld
(cÚ¡ * 
a
, cÚ¡ * 
b
) {

974 cÚ¡ 
_·‰”n_f›ld
 * 
ç
 = (cÚ¡ _·‰”n_f›ld *)
a
;

975 cÚ¡ 
_·‰”n_f›ld
 * 
fb
 = (cÚ¡ _·‰”n_f›ld *)
b
;

977  
ç
->
id
 - 
fb
->id;

978 
	}
}

980 
pbc_·‰”n
 *

981 
	$_pbcP_Ãw
(
pbc_’v
 * 
’v
, 
n
) {

982 
size_t
 
sz
 = (
pbc_·‰”n
è+ ((
_·‰”n_f›ld
)è* (
n
-1);

983 
pbc_·‰”n
 * 
»t
 = (pbc_·‰”À*)
	`m®loc
(
sz
);

984 
	`mem£t
(
»t
, 0 , 
sz
);

985 
»t
->
couÁ
 = 
n
;

986 
»t
->
’v
 =ƒnv;

987  
»t
;

988 
	}
}

991 
	$_check_ùy³
(
_f›ld
 * 
f›ld
, 
_·‰”n_f›ld
 *
f
) {

992 ià(
f›ld
->
Ïb–
 =ğ
LABEL_REPEATED
) {

993  
f
->
ùy³
 !ğ
CTYPE_ARRAY
;

995 ià(
f›ld
->
Ïb–
 =ğ
LABEL_PACKED
) {

996  
f
->
ùy³
 !ğ
CTYPE_PACKED
;

998 ià(
f›ld
->
ty³
 =ğ
PTYPE_STRING
 || f›ld->ty³ =ğ
PTYPE_MESSAGE
 || f›ld->ty³ =ğ
PTYPE_BYTES
) {

999  
f
->
ùy³
 !ğ
CTYPE_VAR
;

1001 ià(
f›ld
->
ty³
 =ğ
PTYPE_FLOAT
 || f›ld->ty³ =ğ
PTYPE_DOUBLE
) {

1002  !(
f
->
ùy³
 =ğ
CTYPE_DOUBLE
 || f->ùy³ =ğ
CTYPE_FLOAT
);

1004 ià(
f›ld
->
ty³
 =ğ
PTYPE_ENUM
) {

1005  !(
f
->
ùy³
 =ğ
CTYPE_INT8
 ||

1006 
f
->
ùy³
 =ğ
CTYPE_INT8
 ||

1007 
f
->
ùy³
 =ğ
CTYPE_INT16
 ||

1008 
f
->
ùy³
 =ğ
CTYPE_INT32
 ||

1009 
f
->
ùy³
 =ğ
CTYPE_INT64
);

1012  
f
->
ùy³
 =ğ
CTYPE_VAR
 || f->ùy³ =ğ
CTYPE_ARRAY
 || f->ùy³ =ğ
CTYPE_PACKED
 ||

1013 
f
->
ùy³
 =ğ
CTYPE_DOUBLE
 || f->ùy³ =ğ
CTYPE_FLOAT
;

1014 
	}
}

1016 
pbc_·‰”n
 *

1017 
	$_·‰”n_Ãw
(
_mes§ge
 *
m
, cÚ¡ *
fÜm©
) {

1018 
Ën
 = 
	`¡¾’
(
fÜm©
);

1019 * 
‹mp
 = (*)
	`®loÿ
(
Ën
+1);

1020 
n
 = 
	`_sÿn_·‰”n
(
fÜm©
, 
‹mp
);

1021 
pbc_·‰”n
 * 
·t
 = 
	`_pbcP_Ãw
(
m
->
’v
, 
n
);

1022 
i
;

1024 cÚ¡ *
±r
 = 
‹mp
;

1026 
off£t
 = 0;

1028 
i
=0;i<
n
;i++) {

1029 
_·‰”n_f›ld
 * 
f
 = &(
·t
->f[
i
]);

1030 
_f›ld
 * 
f›ld
 = (_f›ld *)
	`_pbcM_¥_qu”y
(
m
->
Çme
, 
±r
);

1031 ià(
f›ld
 =ğ
NULL
) {

1032 
m
->
’v
->
Ï¡”rÜ
 = "Pattern @new query‚oneƒxist field";

1033 
_”rÜ
;

1035 
f
->
id
 = 
f›ld
->id;

1036 
f
->
±y³
 = 
f›ld
->
ty³
;

1037 *
f
->
defv
 = *
f›ld
->
deçuÉ_v
;

1038 
f
->
off£t
 = offset;

1039 
f
->
Ïb–
 = 
f›ld
->label;

1040 
±r
 +ğ
	`¡¾’
(ptr) + 1;

1041 
f
->
ùy³
 = 
	`_ùy³
(
±r
);

1042 ià(
f
->
ùy³
 < 0) {

1043 
m
->
’v
->
Ï¡”rÜ
 = "Pattern @new use‡n invalid ctype";

1044 
_”rÜ
;

1047 ià(
f
->
ùy³
 =ğ
CTYPE_ARRAY
 && 
f›ld
->
Ïb–
 =ğ
LABEL_PACKED
) {

1048 
f
->
ùy³
 = 
CTYPE_PACKED
;

1050 ià(
	`_check_ùy³
(
f›ld
, 
f
)) {

1051 
m
->
’v
->
Ï¡”rÜ
 = "Pattern @new ctype checkƒrror";

1052 
_”rÜ
;

1055 
off£t
 +ğ
	`_ùy³_size
(
±r
);

1056 
±r
 +ğ
	`¡¾’
(ptr) + 1;

1059 
·t
->
couÁ
 = 
n
;

1061 
	`qsÜt
(
·t
->
f
 , 
n
 , (
_·‰”n_f›ld
), 
_comp_f›ld
);

1062  
·t
;

1063 
_”rÜ
:

1064 
	`ä“
(
·t
);

1065  
NULL
;

1066 
	}
}

1068 
pbc_·‰”n
 *

1069 
	$pbc_·‰”n_Ãw
(
pbc_’v
 * 
’v
 , cÚ¡ * 
mes§ge
, cÚ¡ * 
fÜm©
, ... ) {

1070 
_mes§ge
 *
m
 = 
	`_pbcP_g‘_mes§ge
(
’v
, 
mes§ge
);

1071 ià(
m
==
NULL
) {

1072 
’v
->
Ï¡”rÜ
 = "Pattern‚ew can't find…roto";

1073  
NULL
;

1075 ià(
fÜm©
[0]=='@') {

1076  
	`_·‰”n_Ãw
(
m
 , 
fÜm©
+1);

1079 
Ën
 = 
	`¡¾’
(
fÜm©
);

1080 * 
‹mp
 = (*)
	`®loÿ
(
Ën
+1);

1081 
n
 = 
	`_sÿn_·‰”n
(
fÜm©
, 
‹mp
);

1082 
pbc_·‰”n
 * 
·t
 = 
	`_pbcP_Ãw
(
’v
, 
n
);

1083 
i
;

1084 
va_li¡
 
­
;

1085 
	`va_¡¬t
(
­
 , 
fÜm©
);

1087 cÚ¡ *
±r
 = 
‹mp
;

1089 
i
=0;i<
n
;i++) {

1090 
_·‰”n_f›ld
 * 
f
 = &(
·t
->f[
i
]);

1091 
_f›ld
 * 
f›ld
 = (_f›ld *)
	`_pbcM_¥_qu”y
(
m
->
Çme
, 
±r
);

1092 ià(
f›ld
 =ğ
NULL
) {

1093 
’v
->
Ï¡”rÜ
 = "Pattern‚ew query‚oneƒxist field";

1094 
_”rÜ
;

1096 
f
->
id
 = 
f›ld
->id;

1097 
f
->
±y³
 = 
f›ld
->
ty³
;

1098 *
f
->
defv
 = *
f›ld
->
deçuÉ_v
;

1099 
f
->
off£t
 = 
	`va_¬g
(
­
, );

1100 
f
->
Ïb–
 = 
f›ld
->label;

1102 
±r
 +ğ
	`¡¾’
(ptr) + 1;

1104 
f
->
ùy³
 = 
	`_ùy³
(
±r
);

1105 ià(
f
->
ùy³
 < 0) {

1106 
’v
->
Ï¡”rÜ
 = "Pattern‚ew use‡n invalid ctype";

1107 
_”rÜ
;

1109 ià(
f
->
ùy³
 =ğ
CTYPE_ARRAY
 && 
f›ld
->
Ïb–
 =ğ
LABEL_PACKED
) {

1110 
f
->
ùy³
 = 
CTYPE_PACKED
;

1112 ià(
	`_check_ùy³
(
f›ld
, 
f
)) {

1113 
’v
->
Ï¡”rÜ
 = "Pattern‚ew ctype checkƒrror";

1114 
_”rÜ
;

1117 
±r
 +ğ
	`¡¾’
(ptr) + 1;

1120 
	`va_’d
(
­
);

1122 
·t
->
couÁ
 = 
n
;

1124 
	`qsÜt
(
·t
->
f
 , 
n
 , (
_·‰”n_f›ld
), 
_comp_f›ld
);

1125  
·t
;

1126 
_”rÜ
:

1127 
	`ä“
(
·t
);

1128  
NULL
;

1129 
	}
}

1132 
	$pbc_·‰”n_d–‘e
(
pbc_·‰”n
 * 
·t
) {

1133 
	`ä“
(
·t
);

1134 
	}
}

	@src/pattern.h

1 #iâdeà
PROTOBUF_C_PATTERN_H


2 
	#PROTOBUF_C_PATTERN_H


	)

4 
	~"pbc.h
"

5 
	~"cÚ‹xt.h
"

6 
	~"¬¿y.h
"

8 
	s_·‰”n_f›ld
 {

9 
	mid
;

10 
	moff£t
;

11 
	m±y³
;

12 
	mùy³
;

13 
	mÏb–
;

14 
pbc_v¬
 
	mdefv
;

17 
	spbc_·‰”n
 {

18 
pbc_’v
 * 
	m’v
;

19 
	mcouÁ
;

20 
_·‰”n_f›ld
 
	mf
[1];

23 
pbc_·‰”n
 * 
_pbcP_Ãw
(
pbc_’v
 * 
’v
, 
n
);

24 
_pbcP_uÅack_·cked
(
ušt8_t
 *
bufãr
, 
size
, 
±y³
, 
pbc_¬¿y
 
¬¿y
);

	@src/proto.c

1 
	~"pbc.h
"

2 
	~"´Ùo.h
"

3 
	~"·‰”n.h
"

4 
	~"m­.h
"

5 
	~"®loc.h
"

6 
	~"¡ršgpoŞ.h
"

7 
	~"boÙ¡¿p.h
"

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

13 
	$pbc_”rÜ
(
pbc_’v
 * 
p
) {

14 cÚ¡ *
”r
 = 
p
->
Ï¡”rÜ
;

15 
p
->
Ï¡”rÜ
 = "";

16  
”r
;

17 
	}
}

19 
_mes§ge
 *

20 
	$_pbcP_g‘_mes§ge
(
pbc_’v
 * 
p
 , cÚ¡ *
Çme
) {

21  (
_mes§ge
 *)
	`_pbcM_¥_qu”y
(
p
->
msgs
, 
Çme
);

22 
	}
}

24 
pbc_’v
 *

25 
	$pbc_Ãw
() {

26 
pbc_’v
 * 
p
 = (pbc_’v *)
	`m®loc
((*p));

27 
p
->
fes
 = 
	`_pbcM_¥_Ãw
(0 , 
NULL
);

28 
p
->
’ums
 = 
	`_pbcM_¥_Ãw
(0 , 
NULL
);

29 
p
->
msgs
 = 
	`_pbcM_¥_Ãw
(0 , 
NULL
);

30 
p
->
Ï¡”rÜ
 = "";

32 
	`_pbcB_š™
(
p
);

34  
p
;

35 
	}
}

38 
	$ä“_’um
(*
p
) {

39 
_’um
 * 
e
 = (_’um *)
p
;

40 
	`_pbcM__d–‘e
(
e
->
id
);

41 
	`_pbcM_si_d–‘e
(
e
->
Çme
);

43 
	`ä“
(
p
);

44 
	}
}

47 
	$ä“_¡ršgpoŞ
(*
p
) {

48 
	`_pbcS_d–‘e
((
_¡ršgpoŞ
 *)
p
);

49 
	}
}

52 
	$ä“_msg
(*
p
) {

53 
_mes§ge
 * 
m
 = (_mes§g*)
p
;

54 ià(
m
->
id
)

55 
	`_pbcM__d–‘e
(
m
->
id
);

56 
	`ä“
(
m
->
def
);

57 
	`_pbcM_¥_fÜ—ch
(
m
->
Çme
, 
ä“
);

58 
	`_pbcM_¥_d–‘e
(
m
->
Çme
);

59 
	`ä“
(
p
);

60 
	}
}

63 
	$pbc_d–‘e
(
pbc_’v
 *
p
) {

64 
	`_pbcM_¥_fÜ—ch
(
p
->
’ums
, 
ä“_’um
);

65 
	`_pbcM_¥_d–‘e
(
p
->
’ums
);

67 
	`_pbcM_¥_fÜ—ch
(
p
->
msgs
, 
ä“_msg
);

68 
	`_pbcM_¥_d–‘e
(
p
->
msgs
);

70 
	`_pbcM_¥_fÜ—ch
(
p
->
fes
, 
ä“_¡ršgpoŞ
);

71 
	`_pbcM_¥_d–‘e
(
p
->
fes
);

73 
	`ä“
(
p
);

74 
	}
}

76 
_’um
 *

77 
	$_pbcP_push_’um
(
pbc_’v
 * 
p
, cÚ¡ *
Çme
, 
m­_kv
 *
bË
, 
sz
) {

78 * 
check
 = 
	`_pbcM_¥_qu”y
(
p
->
’ums
, 
Çme
);

79 ià(
check
)

80  
NULL
;

81 
_’um
 * 
v
 = (_’um *)
	`m®loc
((*v));

82 
v
->
key
 = 
Çme
;

83 
v
->
id
 = 
	`_pbcM__Ãw
(
bË
,
sz
);

84 
v
->
Çme
 = 
	`_pbcM_si_Ãw
(
bË
,
sz
);

85 
v
->
deçuÉ_v
->
e
.
id
 = 
bË
[0].id;

86 
v
->
deçuÉ_v
->
e
.
Çme
 = (cÚ¡ *)
bË
[0].
poš‹r
;

88 
	`_pbcM_¥_š£¹
(
p
->
’ums
, 
Çme
 , 
v
);

89  
v
;

90 
	}
}

93 
	$_pbcP_push_mes§ge
(
pbc_’v
 * 
p
, cÚ¡ *
Çme
, 
_f›ld
 *
f
 , 
pbc_¬¿y
 
queue
) {

94 
_mes§ge
 * 
m
 = (_mes§g*)
	`_pbcM_¥_qu”y
(
p
->
msgs
, 
Çme
);

95 ià(
m
==
NULL
) {

96 
m
 = (
_mes§ge
 *)
	`m®loc
((*m));

97 
m
->
def
 = 
NULL
;

98 
m
->
key
 = 
Çme
;

99 
m
->
id
 = 
NULL
;

100 
m
->
Çme
 = 
	`_pbcM_¥_Ãw
(0 , 
NULL
);

101 
m
->
’v
 = 
p
;

102 
	`_pbcM_¥_š£¹
(
p
->
msgs
, 
Çme
, 
m
);

104 
_f›ld
 * 
f›ld
 = (_f›ld *)
	`m®loc
((*field));

105 
	`memıy
(
f›ld
,
f
,(*f));

106 
	`_pbcM_¥_š£¹
(
m
->
Çme
, 
f›ld
->name, field);

107 
pbc_v¬
 
©om
;

108 
©om
->
m
.
bufãr
 = 
f›ld
;

109 ià(
f
->
ty³
 =ğ
PTYPE_MESSAGE
 || f->ty³ =ğ
PTYPE_ENUM
) {

110 
	`_pbcA_push
(
queue
, 
©om
);

112 
	}
}

114 
	s_™”
 {

115 
	mcouÁ
;

116 
m­_kv
 * 
	mbË
;

120 
	$_couÁ
(*
p
, *
ud
) {

121 
_™”
 *
™”
 = (_™” *)
ud
;

122 
™”
->
couÁ
 ++;

123 
	}
}

126 
	$_£t_bË
(*
p
, *
ud
) {

127 
_f›ld
 * 
f›ld
 = (_f›ld *)
p
;

128 
_™”
 *
™”
 = (_™” *)
ud
;

129 
™”
->
bË
[™”->
couÁ
].
id
 = 
f›ld
->id;

130 
™”
->
bË
[™”->
couÁ
].
poš‹r
 = 
f›ld
;

131 ++
™”
->
couÁ
;

132 
	}
}

134 
_mes§ge
 *

135 
	$_pbcP_š™_mes§ge
(
pbc_’v
 * 
p
, cÚ¡ *
Çme
) {

136 
_mes§ge
 * 
m
 = (_mes§g*)
	`_pbcM_¥_qu”y
(
p
->
msgs
, 
Çme
);

137 ià(
m
 =ğ
NULL
) {

138 
m
 = (
_mes§ge
 *)
	`m®loc
((*m));

139 
m
->
def
 = 
NULL
;

140 
m
->
key
 = 
Çme
;

141 
m
->
id
 = 
NULL
;

142 
m
->
Çme
 = 
	`_pbcM_¥_Ãw
(0 , 
NULL
);

143 
m
->
’v
 = 
p
;

144 
	`_pbcM_¥_š£¹
(
p
->
msgs
, 
Çme
, 
m
);

146  
m
;

148 ià(
m
->
id
) {

150 
	`_pbcM__d–‘e
(
m
->
id
);

152 
_™”
 
™”
 = { 0, 
NULL
 };

153 
	`_pbcM_¥_fÜ—ch_ud
(
m
->
Çme
, 
_couÁ
, &
™”
);

154 
™”
.
bË
 = (
m­_kv
 *)
	`m®loc
(™”.
couÁ
 * (map_kv));

155 
™”
.
couÁ
 = 0;

156 
	`_pbcM_¥_fÜ—ch_ud
(
m
->
Çme
, 
_£t_bË
, &
™”
);

158 
m
->
id
 = 
	`_pbcM__Ãw
(
™”
.
bË
 , i‹r.
couÁ
);

160 
	`ä“
(
™”
.
bË
);

162  
m
;

163 
	}
}

166 
	$_pbcP_mes§ge_deçuÉ
(
_mes§ge
 * 
m
, cÚ¡ * 
Çme
, 
pbc_v¬
 
defv
) {

167 
_f›ld
 * 
f
ğ(_f›ld *)
	`_pbcM_¥_qu”y
(
m
->
Çme
,‚ame);

168 ià(
f
==
NULL
) {

170 
defv
->
p
[0] = 
NULL
;

171 
defv
->
p
[1] = 
NULL
;

174 *
defv
 = *(
f
->
deçuÉ_v
);

175  
f
->
ty³
;

176 
	}
}

179 
	$_pbcP_ty³
(
_f›ld
 * 
f›ld
, cÚ¡ ** 
ty³
) {

180 ià(
f›ld
 =ğ
NULL
) {

183 
»t
 = 0;

184 
f›ld
->
ty³
) {

185 
PTYPE_DOUBLE
:

186 
PTYPE_FLOAT
:

187 
»t
 = 
PBC_REAL
;

189 
PTYPE_INT64
:

190 
PTYPE_SINT64
:

191 
»t
 = 
PBC_INT64
;

193 
PTYPE_INT32
:

194 
PTYPE_SINT32
:

195 
»t
 = 
PBC_INT
;

197 
PTYPE_UINT32
:

198 
PTYPE_UINT64
:

199 
»t
 = 
PBC_UINT
;

201 
PTYPE_FIXED32
:

202 
PTYPE_SFIXED32
:

203 
»t
 = 
PBC_FIXED32
;

205 
PTYPE_SFIXED64
:

206 
PTYPE_FIXED64
:

207 
»t
 = 
PBC_FIXED64
;

209 
PTYPE_BOOL
:

210 
»t
 = 
PBC_BOOL
;

212 
PTYPE_STRING
:

213 
»t
 = 
PBC_STRING
;

215 
PTYPE_BYTES
:

216 
»t
 = 
PBC_BYTES
;

218 
PTYPE_ENUM
:

219 
»t
 = 
PBC_ENUM
;

220 ià(
ty³
) {

221 *
ty³
 = 
f›ld
->
ty³_Çme
.
e
->
key
;

224 
PTYPE_MESSAGE
:

225 
»t
 = 
PBC_MESSAGE
;

226 ià(
ty³
) {

227 *
ty³
 = 
f›ld
->
ty³_Çme
.
m
->
key
;

233 ià(
f›ld
->
Ïb–
 =ğ
LABEL_REPEATED
 ||

234 
f›ld
->
Ïb–
 =ğ
LABEL_PACKED
) {

235 
»t
 |ğ
PBC_REPEATED
;

238  
»t
;

239 
	}
}

242 
	$pbc_ty³
(
pbc_’v
 * 
p
, cÚ¡ * 
ty³_Çme
 , cÚ¡ * 
key
 , cÚ¡ ** 
ty³
) {

243 
_mes§ge
 *
m
 = 
	`_pbcP_g‘_mes§ge
(
p
, 
ty³_Çme
);

244 ià(
m
==
NULL
) {

247 ià(
key
 =ğ
NULL
) {

248  
PBC_NOEXIST
;

250 
_f›ld
 * 
f›ld
 = (_f›ld *)
	`_pbcM_¥_qu”y
(
m
->
Çme
, 
key
);

251  
	`_pbcP_ty³
(
f›ld
, 
ty³
);

252 
	}
}

255 
	$pbc_’um_id
(
pbc_’v
 *
’v
, cÚ¡ *
’um_ty³
, cÚ¡ *
’um_Çme
) {

256 
_’um
 *
’um_m­
 = (_’um *)
	`_pbcM_¥_qu”y
(
’v
->
’ums
, 
’um_ty³
);

257 if(!
’um_m­
) {

260 
št32_t
 
’um_id
 = 0;

261 
”r
 = 
	`_pbcM_si_qu”y
(
’um_m­
->
Çme
, 
’um_Çme
, &
’um_id
);

262 if(
”r
) {

265  
’um_id
;

266 
	}
}

	@src/proto.h

1 #iâdeà
PROTOBUFC_PROTO_H


2 
	#PROTOBUFC_PROTO_H


	)

4 
	~"pbc.h
"

5 
	~"m­.h
"

6 
	~"¬¿y.h
"

7 #iâdeà
_MSC_VER


8 
	~<¡dboŞ.h
>

10 
	~<¡ddef.h
>

12 
	gm­_
;

13 
	gm­_si
;

14 
	gm­_¥
;

15 
	g_mes§ge
;

16 
	g_’um
;

18 
	#LABEL_OPTIONAL
 0

	)

19 
	#LABEL_REQUIRED
 1

	)

20 
	#LABEL_REPEATED
 2

	)

21 
	#LABEL_PACKED
 3

	)

23 
	s_f›ld
 {

24 
	mid
;

25 cÚ¡ *
	mÇme
;

26 
	mty³
;

27 
	mÏb–
;

28 
pbc_v¬
 
	mdeçuÉ_v
;

30 cÚ¡ * 
	mn
;

31 
_mes§ge
 * 
	mm
;

32 
_’um
 * 
	me
;

33 } 
	mty³_Çme
;

36 
	s_mes§ge
 {

37 cÚ¡ * 
	mkey
;

38 
m­_
 * 
	mid
;

39 
m­_¥
 * 
	mÇme
;

40 
pbc_rmes§ge
 * 
	mdef
;

41 
pbc_’v
 * 
	m’v
;

44 
	s_’um
 {

45 cÚ¡ * 
	mkey
;

46 
m­_
 * 
	mid
;

47 
m­_si
 * 
	mÇme
;

48 
pbc_v¬
 
	mdeçuÉ_v
;

51 
	spbc_’v
 {

52 
m­_¥
 * 
	mfes
;

53 
m­_¥
 * 
	m’ums
;

54 
m­_¥
 * 
	mmsgs
;

55 cÚ¡ * 
	mÏ¡”rÜ
;

58 
_mes§ge
 * 
_pbcP_š™_mes§ge
(
pbc_’v
 * 
p
, cÚ¡ *
Çme
);

59 
_pbcP_push_mes§ge
(
pbc_’v
 * 
p
, cÚ¡ *
Çme
, 
_f›ld
 *
f
 , 
pbc_¬¿y
 
queue
);

60 
_’um
 * 
_pbcP_push_’um
(
pbc_’v
 * 
p
, cÚ¡ *
Çme
, 
m­_kv
 *
bË
, 
sz
 );

61 
_pbcP_mes§ge_deçuÉ
(
_mes§ge
 * 
m
, cÚ¡ * 
Çme
, 
pbc_v¬
 
defv
);

62 
_mes§ge
 * 
_pbcP_g‘_mes§ge
(
pbc_’v
 * 
p
, cÚ¡ *
Çme
);

63 
_pbcP_ty³
(
_f›ld
 * 
f›ld
, cÚ¡ **
ty³
);

	@src/register.c

1 
	~"pbc.h
"

2 
	~"´Ùo.h
"

3 
	~"®loc.h
"

4 
	~"m­.h
"

5 
	~"boÙ¡¿p.h
"

6 
	~"cÚ‹xt.h
"

7 
	~"¡ršgpoŞ.h
"

9 
	~<¡ršg.h
>

10 
	~<¡dlib.h
>

12 #ifdeà
_MSC_VER


13 
	#¡¹Şl
 
_¡¹oi64


	)

17 
	$_cÚÿt_Çme
(
_¡ršgpoŞ
 *
p
 , cÚ¡ *
´efix
 , 
´efix_sz
 , cÚ¡ *
Çme
 , 
Çme_sz
, *
sz
) {

18 ià(
´efix_sz
 == 0) {

19 ià(
sz
) {

20 *
sz
 = 
Çme_sz
;

22  
	`_pbcS_bud
(
p
 , 
Çme
, 
Çme_sz
);

24 * 
‹mp
 = (*)
	`®loÿ
(
Çme_sz
 + 
´efix_sz
 + 2);

25 
	`memıy
(
‹mp
,
´efix
,
´efix_sz
);

26 
‹mp
[
´efix_sz
] = '.';

27 
	`memıy
(
‹mp
+
´efix_sz
+1,
Çme
,
Çme_sz
);

28 
‹mp
[
Çme_sz
 + 
´efix_sz
 + 1] = '\0';

29 ià(
sz
) {

30 *
sz
 = 
Çme_sz
 + 
´efix_sz
 + 1;

32 cÚ¡ * 
»t
 = 
	`_pbcS_bud
(
p
 , 
‹mp
, 
Çme_sz
 + 
´efix_sz
 + 1);

33  
»t
;

34 
	}
}

37 
	$_»gi¡”_’um
(
pbc_’v
 *
p
, 
_¡ršgpoŞ
 *
poŞ
, 
pbc_rmes§ge
 * 
’um_ty³
, cÚ¡ *
´efix
, 
´efix_sz
) {

38 
f›ld_couÁ
 = 
	`pbc_rmes§ge_size
(
’um_ty³
, "value");

39 
m­_kv
 *
bË
 = (m­_kv *)
	`m®loc
(
f›ld_couÁ
 * (map_kv));

40 
i
;

41 
i
=0;i<
f›ld_couÁ
;i++) {

42 
pbc_rmes§ge
 * 
v®ue
 = 
	`pbc_rmes§ge_mes§ge
(
’um_ty³
, "v®ue", 
i
);

43 
’um_Çme_sz
;

44 cÚ¡ *
’um_Çme
 = 
	`pbc_rmes§ge_¡ršg
(
v®ue
 , "Çme" , 0 , &
’um_Çme_sz
);

45 
bË
[
i
].
poš‹r
 = (*)
	`_pbcS_bud
(
poŞ
, 
’um_Çme
 , 
’um_Çme_sz
);

46 
bË
[
i
].
id
 = 
	`pbc_rmes§ge_š‹g”
(
v®ue
 , "number", 0 , 0);

48 
Çme_sz
;

49 cÚ¡ * 
Çme
 = 
	`pbc_rmes§ge_¡ršg
(
’um_ty³
, "Çme", 0 , &
Çme_sz
);

50 cÚ¡ *
‹mp
 = 
	`_cÚÿt_Çme
(
poŞ
, 
´efix
 , 
´efix_sz
 , 
Çme
 , 
Çme_sz
, 
NULL
);

52 
	`_pbcP_push_’um
(
p
,
‹mp
,
bË
,
f›ld_couÁ
);

53 
	`ä“
(
bË
);

54 
	}
}

57 
	$_£t_deçuÉ
(
_¡ršgpoŞ
 *
poŞ
, 
_f›ld
 *
f
 , 
±y³
, cÚ¡ *
v®ue
, 
sz
) {

58 ià(
v®ue
 =ğ
NULL
 || 
sz
 == 0) {

59 ià(
f
->
ty³
 =ğ
PTYPE_STRING
 || f->ty³ =ğ
PTYPE_BYTES
) {

60 
f
->
deçuÉ_v
->
s
.
¡r
 = "";

61 
f
->
deçuÉ_v
->
s
.
Ën
 = 0;

63 
f
->
deçuÉ_v
->
š‹g”
.
low
 = 0;

64 
f
->
deçuÉ_v
->
š‹g”
.
hi
 = 0;

69 
f
->
ty³
) {

70 
PTYPE_DOUBLE
:

71 
PTYPE_FLOAT
:

72 
f
->
deçuÉ_v
->
»®
 = 
	`¡¹od
(
v®ue
,
NULL
);

74 
PTYPE_STRING
:

75 
f
->
deçuÉ_v
->
s
.
¡r
 = 
	`_pbcS_bud
(
poŞ
, 
v®ue
 , 
sz
);

76 
f
->
deçuÉ_v
->
s
.
Ën
 = 
sz
;

78 
PTYPE_ENUM
:

80 
f
->
deçuÉ_v
->
s
.
¡r
 = 
v®ue
;

81 
f
->
deçuÉ_v
->
s
.
Ën
 = 
sz
;

83 
PTYPE_BOOL
:

84 ià(
	`¡rcmp
(
v®ue
,"true") == 0) {

85 
f
->
deçuÉ_v
->
š‹g”
.
low
 = 1;

87 
f
->
deçuÉ_v
->
š‹g”
.
low
 = 0;

89 
f
->
deçuÉ_v
->
š‹g”
.
hi
 = 0;

91 
PTYPE_UINT64
:

92 
PTYPE_INT64
:

93 
PTYPE_SFIXED64
:

94 
PTYPE_SINT64
: {

95 
v
 = 
	`¡¹Şl
(
v®ue
, 
NULL
, 10);

96 
f
->
deçuÉ_v
->
š‹g”
.
low
 = (è
v
;

97 
f
->
deçuÉ_v
->
š‹g”
.
hi
 = ()(
v
 >> 32);

100 
PTYPE_INT32
:

101 
PTYPE_FIXED32
:

102 
PTYPE_SFIXED32
:

103 
PTYPE_SINT32
: {

104 
low
 = 
	`¡¹Ş
(
v®ue
, 
NULL
, 10);

105 
f
->
deçuÉ_v
->
š‹g”
.
low
 =†ow;

106 ià(
low
 < 0) {

107 
f
->
deçuÉ_v
->
š‹g”
.
hi
 = -1;

109 
f
->
deçuÉ_v
->
š‹g”
.
hi
 = 0;

113 
PTYPE_UINT32
:

114 
f
->
deçuÉ_v
->
š‹g”
.
low
 = 
	`¡¹oul
(
v®ue
, 
NULL
, 10);

115 
f
->
deçuÉ_v
->
š‹g”
.
hi
 = 0;

117 
PTYPE_BYTES
:

118 
PTYPE_MESSAGE
:

120 
f
->
deçuÉ_v
->
m
.
bufãr
 = 0;

121 
f
->
deçuÉ_v
->
m
.
Ën
 = 0;

124 
f
->
deçuÉ_v
->
š‹g”
.
low
 = 0;

125 
f
->
deçuÉ_v
->
š‹g”
.
hi
 = 0;

128 
	}
}

131 
	$_»gi¡”_f›ld
(
pbc_rmes§ge
 * 
f›ld
, 
_f›ld
 * 
f
, 
_¡ršgpoŞ
 *
poŞ
) {

132 
f
->
id
 = 
	`pbc_rmes§ge_š‹g”
(
f›ld
, "number", 0 , 0);

133 
f
->
ty³
 = 
	`pbc_rmes§ge_š‹g”
(
f›ld
, "type", 0 , 0);

134 
f
->
Ïb–
 = 
	`pbc_rmes§ge_š‹g”
(
f›ld
, "label", 0, 0) - 1;

135 ià(
	`pbc_rmes§ge_size
(
f›ld
 , "options") > 0) {

136 
pbc_rmes§ge
 * 
İtiÚs
 = 
	`pbc_rmes§ge_mes§ge
(
f›ld
, "options" , 0);

137 
·cked
 = 
	`pbc_rmes§ge_š‹g”
(
İtiÚs
 , "·cked" , 0 , 
NULL
);

138 ià(
·cked
) {

139 
f
->
Ïb–
 = 
LABEL_PACKED
;

142 
f
->
ty³_Çme
.
n
 = 
	`pbc_rmes§ge_¡ršg
(
f›ld
, "ty³_Çme", 0 , 
NULL
) +1;

143 
vsz
;

144 cÚ¡ * 
deçuÉ_v®ue
 = 
	`pbc_rmes§ge_¡ršg
(
f›ld
, "deçuÉ_v®ue", 0 , &
vsz
);

145 
	`_£t_deçuÉ
(
poŞ
 , 
f
 , f->
ty³
, 
deçuÉ_v®ue
 , 
vsz
);

146 
	}
}

149 
	$_»gi¡”_ex‹nsiÚ
(
pbc_’v
 *
p
, 
_¡ršgpoŞ
 *
poŞ
 , cÚ¡ * 
´efix
, 
´efix_sz
, 
pbc_rmes§ge
 * 
msg
, 
pbc_¬¿y
 
queue
) {

150 
ex‹nsiÚ_couÁ
 = 
	`pbc_rmes§ge_size
(
msg
 , "extension");

151 ià(
ex‹nsiÚ_couÁ
 <= 0)

153 
i
;

155 cÚ¡ * 
Ï¡
 = 
NULL
;

157 
i
=0;i<
ex‹nsiÚ_couÁ
;i++) {

158 
pbc_rmes§ge
 * 
ex‹nsiÚ
 = 
	`pbc_rmes§ge_mes§ge
(
msg
, "ex‹nsiÚ", 
i
);

159 
f›ld_Çme_sz
 = 0;

160 
_f›ld
 
f
;

161 cÚ¡ * 
f›ld_Çme
 = 
	`pbc_rmes§ge_¡ršg
(
ex‹nsiÚ
 , "Çme" , 0, &
f›ld_Çme_sz
);

162 
f
.
Çme
 = 
	`_cÚÿt_Çme
(
poŞ
, 
´efix
, 
´efix_sz
, 
f›ld_Çme
, 
f›ld_Çme_sz
, 
NULL
);

164 
	`_»gi¡”_f›ld
(
ex‹nsiÚ
, &
f
 , 
poŞ
);

166 cÚ¡ * 
ex‹nd“
 = 
	`pbc_rmes§ge_¡ršg
(
ex‹nsiÚ
 , "ex‹nd“" , 0, 
NULL
);

168 
	`_pbcP_push_mes§ge
(
p
, 
ex‹nd“
 + 1 , &
f
 , 
queue
);

170 ià(
Ï¡
 =ğ
NULL
) {

171 
Ï¡
 = 
ex‹nd“
;

172 } ià(
	`¡rcmp
(
ex‹nd“
,
Ï¡
) != 0) {

173 
	`_pbcP_š™_mes§ge
(
p
, 
Ï¡
+1);

174 
Ï¡
 = 
ex‹nd“
;

177 
	`_pbcP_š™_mes§ge
(
p
, 
Ï¡
+1);

178 
	}
}

181 
	$_»gi¡”_mes§ge
(
pbc_’v
 *
p
, 
_¡ršgpoŞ
 *
poŞ
, 
pbc_rmes§ge
 * 
mes§ge_ty³
, cÚ¡ *
´efix
, 
´efix_sz
, 
pbc_¬¿y
 
queue
) {

182 
Çme_sz
;

183 cÚ¡ * 
Çme
 = 
	`pbc_rmes§ge_¡ršg
(
mes§ge_ty³
, "Çme", 0 , &
Çme_sz
);

184 
sz
 = 0;

185 cÚ¡ *
‹mp
 = 
	`_cÚÿt_Çme
(
poŞ
, 
´efix
 , 
´efix_sz
 , 
Çme
 , 
Çme_sz
, &
sz
);

187 
f›ld_couÁ
 = 
	`pbc_rmes§ge_size
(
mes§ge_ty³
, "field");

188 
i
;

189 
i
=0;i<
f›ld_couÁ
;i++) {

190 
pbc_rmes§ge
 * 
f›ld
 = 
	`pbc_rmes§ge_mes§ge
(
mes§ge_ty³
, "f›ld" , 
i
);

191 
_f›ld
 
f
;

192 
f›ld_Çme_sz
;

193 cÚ¡ * 
f›ld_Çme
 = 
	`pbc_rmes§ge_¡ršg
(
f›ld
, "Çme", 0 , &
f›ld_Çme_sz
);

194 
f
.
Çme
 = 
	`_pbcS_bud
(
poŞ
,
f›ld_Çme
,
f›ld_Çme_sz
);

196 
	`_»gi¡”_f›ld
(
f›ld
, &
f
 , 
poŞ
);

198 
	`_pbcP_push_mes§ge
(
p
, 
‹mp
 , &
f
 , 
queue
);

201 
	`_pbcP_š™_mes§ge
(
p
, 
‹mp
);

203 
	`_»gi¡”_ex‹nsiÚ
(
p
, 
poŞ
, 
‹mp
, 
sz
,
mes§ge_ty³
, 
queue
);

207 
’um_couÁ
 = 
	`pbc_rmes§ge_size
(
mes§ge_ty³
, "enum_type");

209 
i
=0;i<
’um_couÁ
;i++) {

210 
pbc_rmes§ge
 * 
’um_ty³
 = 
	`pbc_rmes§ge_mes§ge
(
mes§ge_ty³
, "’um_ty³", 
i
);

211 
	`_»gi¡”_’um
(
p
, 
poŞ
, 
’um_ty³
, 
‹mp
, 
sz
);

215 
mes§ge_couÁ
 = 
	`pbc_rmes§ge_size
(
mes§ge_ty³
, "nested_type");

216 
i
=0;i<
mes§ge_couÁ
;i++) {

217 
pbc_rmes§ge
 * 
Ã¡ed_ty³
 = 
	`pbc_rmes§ge_mes§ge
(
mes§ge_ty³
, "Ã¡ed_ty³", 
i
);

218 
	`_»gi¡”_mes§ge
(
p
, 
poŞ
, 
Ã¡ed_ty³
, 
‹mp
, 
sz
, 
queue
);

220 
	}
}

223 
	$_»gi¡”
(
pbc_’v
 *
p
, 
pbc_rmes§ge
 * 
fe
, 
_¡ršgpoŞ
 *
poŞ
) {

224 
·ckage_sz
;

225 cÚ¡ *
·ckage
 = 
	`pbc_rmes§ge_¡ršg
(
fe
, "·ckage", 0, &
·ckage_sz
);

227 
pbc_¬¿y
 
queue
;

228 
	`_pbcA_İ’
(
queue
);

230 
’um_couÁ
 = 
	`pbc_rmes§ge_size
(
fe
, "enum_type");

231 
i
;

233 
i
=0;i<
’um_couÁ
;i++) {

234 
pbc_rmes§ge
 * 
’um_ty³
 = 
	`pbc_rmes§ge_mes§ge
(
fe
, "’um_ty³", 
i
);

235 
	`_»gi¡”_’um
(
p
, 
poŞ
 , 
’um_ty³
, 
·ckage
, 
·ckage_sz
);

238 
mes§ge_couÁ
 = 
	`pbc_rmes§ge_size
(
fe
, "message_type");

239 
i
=0;i<
mes§ge_couÁ
;i++) {

240 
pbc_rmes§ge
 * 
mes§ge_ty³
 = 
	`pbc_rmes§ge_mes§ge
(
fe
, "mes§ge_ty³", 
i
);

241 
	`_»gi¡”_mes§ge
(
p
, 
poŞ
, 
mes§ge_ty³
, 
·ckage
, 
·ckage_sz
, 
queue
);

244 
	`_»gi¡”_ex‹nsiÚ
(
p
, 
poŞ
, 
·ckage
, 
·ckage_sz
, 
fe
 , 
queue
);

246 
	`_pbcB_»gi¡”_f›lds
(
p
, 
queue
);

248 
	`_pbcA_şo£
(
queue
);

249 
	}
}

251 
	#CHECK_FILE_OK
 0

	)

252 
	#CHECK_FILE_EXIST
 1

	)

253 
	#CHECK_FILE_DEPENDENCY
 2

	)

256 
	$_check_fe_Çme
(
pbc_’v
 * 
p
 , 
pbc_rmes§ge
 * 
fe
, cÚ¡ ** 
âame
) {

257 cÚ¡ * 
f’ame
 = 
	`pbc_rmes§ge_¡ršg
(
fe
, "Çme", 0, 
NULL
);

259 ià(
	`_pbcM_¥_qu”y
(
p
->
fes
, 
f’ame
)) {

260  
CHECK_FILE_EXIST
;

262 
sz
 = 
	`pbc_rmes§ge_size
(
fe
, "dependency");

263 
i
;

264 
i
=0;i<
sz
;i++) {

265 cÚ¡ *
dÇme
 = 
	`pbc_rmes§ge_¡ršg
(
fe
,"d•’d’cy",
i
,
NULL
);

267 ià(
	`_pbcM_¥_qu”y
(
p
->
fes
, 
dÇme
è=ğ
NULL
) {

268  
CHECK_FILE_DEPENDENCY
;

272 *
âame
 = 
f’ame
;

274  
CHECK_FILE_OK
;

275 
	}
}

278 
	$_»gi¡”_no_d•’d’cy
(
pbc_’v
 * 
p
,
pbc_rmes§ge
 ** 
fes
 , 
n
 ) {

279 
r
 = 0;

280 
i
;

281 
i
=0;i<
n
;i++) {

282 ià(
fes
[
i
] =ğ
NULL
)

284 cÚ¡ *
f’ame
 = 
NULL
;

285 
”r
 = 
	`_check_fe_Çme
(
p
, 
fes
[
i
], &
f’ame
);

286 
”r
) {

287 
CHECK_FILE_EXIST
:

289 
CHECK_FILE_DEPENDENCY
:

290 ++
r
;

292 
CHECK_FILE_OK
: {

293 
_¡ršgpoŞ
 *
poŞ
 = 
	`_pbcS_Ãw
();

294 
f’ame
 = 
	`_pbcS_bud
(
poŞ
, f’am, 
	`¡¾’
(filename));

295 
	`_pbcM_¥_š£¹
(
p
->
fes
 , 
f’ame
, 
poŞ
);

296 
	`_»gi¡”
(
p
,
fes
[
i
],
poŞ
);

297 
fes
[
i
] = 
NULL
;

302  
r
;

303 
	}
}

306 
	$pbc_»gi¡”
(
pbc_’v
 * 
p
, 
pbc_¦iû
 *
¦iû
) {

307 
pbc_rmes§ge
 * 
mes§ge
 = 
	`pbc_rmes§ge_Ãw
(
p
, "googË.´Ùobuf.FeDesütÜS‘", 
¦iû
);

308 ià(
mes§ge
 =ğ
NULL
) {

309 
p
->
Ï¡”rÜ
 = "register open google.protobuf.FileDescriptorSet fail";

312 
n
 = 
	`pbc_rmes§ge_size
(
mes§ge
, "file");

313 
pbc_rmes§ge
 ** 
fes
 = (pbc_rmes§g**)
	`®loÿ
(
n
 * (pbc_rmessage *));

314 
i
;

315 ià(
n
 == 0) {

316 
p
->
Ï¡”rÜ
 = "registerƒmpty";

317 
_”rÜ
;

319 
i
=0;i<
n
;i++) {

320 
fes
[
i
] = 
	`pbc_rmes§ge_mes§ge
(
mes§ge
, "file", i);

321 ià(
fes
[
i
] =ğ
NULL
) {

322 
p
->
Ï¡”rÜ
 = "register open fail";

323 
_”rÜ
;

327 
r
 = 
n
;

329 
¼
 = 
	`_»gi¡”_no_d•’d’cy
(
p
,
fes
 , 
n
);

330 ià(
¼
 =ğ
r
) {

331 
p
->
Ï¡”rÜ
 = "register dependencyƒrror";

332 
_”rÜ
;

334 
r
 = 
¼
;

335 } 
r
>0);

337 
	`pbc_rmes§ge_d–‘e
(
mes§ge
);

339 
_”rÜ
:

340 
	`pbc_rmes§ge_d–‘e
(
mes§ge
);

342 
	}
}

	@src/rmessage.c

1 
	~"pbc.h
"

2 
	~"®loc.h
"

3 
	~"m­.h
"

4 
	~"cÚ‹xt.h
"

5 
	~"´Ùo.h
"

6 
	~"·‰”n.h
"

7 
	~"v¬št.h
"

9 
	~<¡ddef.h
>

10 
	~<¡ršg.h
>

12 
	spbc_rmes§ge
 {

13 
_mes§ge
 * 
	mmsg
;

14 
m­_¥
 * 
	mšdex
;

15 
h—p
 * 
	mh—p
;

18 
	u_v¬
 {

19 
pbc_v¬
 
	mv¬
;

20 
pbc_¬¿y
 
	m¬¿y
;

21 
pbc_rmes§ge
 
	mmes§ge
;

24 
	sv®ue
 {

25 
_f›ld
 * 
	mty³
;

26 
_v¬
 
	mv
;

30 
	$pbc_rmes§ge_Ãxt
(
pbc_rmes§ge
 *
m
, cÚ¡ **
key
) {

31 
v®ue
 * 
v
 = (v®u*)
	`_pbcM_¥_Ãxt
(
m
->
šdex
, 
key
);

32 ià(*
key
 =ğ
NULL
) {

35  
	`_pbcP_ty³
(
v
->
ty³
, 
NULL
);

36 
	}
}

38 
	#SIZE_VAR
 (
	`off£tof
(
v®ue
, 
v
è+ (
pbc_v¬
))

	)

39 
	#SIZE_ARRAY
 (
	`off£tof
(
v®ue
, 
v
è+ (
pbc_¬¿y
))

	)

40 
	#SIZE_MESSAGE
 (
	`off£tof
(
v®ue
, 
v
è+ (
pbc_rmes§ge
))

	)

42 
v®ue
 *

43 
	$»ad_¡ršg
(
h—p
 *
h
, 
©om
 *
a
,
_f›ld
 *
f
, 
ušt8_t
 *
bufãr
) {

44 cÚ¡ * 
‹mp
 = (cÚ¡ *è(
bufãr
 + 
a
->
v
.
s
.
¡¬t
);

45 
Ën
 = 
a
->
v
.
s
.
’d
 -‡->v.s.
¡¬t
;

47 ià(
Ën
 > 0 && 
‹mp
[len-1] == '\0') {

48 
v®ue
 * 
v
 = (v®u*)
	`_pbcH_®loc
(
h
, 
SIZE_VAR
);

49 
v
->v.
v¬
->
s
.
¡r
 = 
‹mp
;

50 
v
->v.
v¬
->
s
.
Ën
 =†en;

51  
v
;

53 
v®ue
 * 
v
 = (v®u*)
	`_pbcH_®loc
(
h
, 
SIZE_VAR
 + 
Ën
 + 1);

54 
	`memıy
(((*)
v
è+ 
SIZE_VAR
 , 
‹mp
, 
Ën
);

55 *(((*)
v
è+ 
SIZE_VAR
 + 
Ën
) = '\0';

56 
v
->v.
v¬
->
s
.
¡r
 = ((*)vè+ 
SIZE_VAR
;

57 
v
->v.
v¬
->
s
.
Ën
 =†en;

58  
v
;

60 
	}
}

63 
	$»ad_¡ršg_v¬
(
h—p
 *
h
, 
pbc_v¬
 
v¬
,
©om
 *
a
,
_f›ld
 *
f
,
ušt8_t
 *
bufãr
) {

64 cÚ¡ * 
‹mp
 = (cÚ¡ *è(
bufãr
 + 
a
->
v
.
s
.
¡¬t
);

65 
Ën
 = 
a
->
v
.
s
.
’d
 -‡->v.s.
¡¬t
;

66 ià(
Ën
 == 0) {

67 
v¬
->
s
.
¡r
 = "";

68 
v¬
->
s
.
Ën
 = 0;

70 ià(
‹mp
[
Ën
-1] == '\0') {

71 
v¬
->
s
.
¡r
 = 
‹mp
;

72 
v¬
->
s
.
Ën
 =†en;

74 * 
‹mp2
 = (*)
	`_pbcH_®loc
(
h
, 
Ën
 + 1);

75 
	`memıy
(
‹mp2
, 
‹mp
, 
Ën
);

76 
‹mp2
[
Ën
]='\0';

77 
v¬
->
s
.
¡r
 = 
‹mp2
;

78 
v¬
->
s
.
Ën
 = -len;

80 
	}
}

82 
_pbc_rmes§ge_Ãw
(
pbc_rmes§ge
 * 
»t
 , 
_mes§ge
 * 
ty³
 , *
bufãr
, 
size
, 
h—p
 *
h
);

84 
v®ue
 *

85 
	$»ad_v®ue
(
h—p
 *
h
, 
_f›ld
 *
f
, 
©om
 * 
a
, 
ušt8_t
 *
bufãr
) {

86 
v®ue
 * 
v
;

88 
f
->
ty³
) {

89 
PTYPE_DOUBLE
:

90 
	`CHECK_BIT64
(
a
,
NULL
);

91 
v
 = (
v®ue
 *)
	`_pbcH_®loc
(
h
, 
SIZE_VAR
);

92 
v
->v.
v¬
->
»®
 = 
	`»ad_doubË
(
a
);

94 
PTYPE_FLOAT
:

95 
	`CHECK_BIT32
(
a
,
NULL
);

96 
v
 = (
v®ue
 *)
	`_pbcH_®loc
(
h
, 
SIZE_VAR
);

97 
v
->v.
v¬
->
»®
 = (è
	`»ad_æßt
(
a
);

99 
PTYPE_ENUM
:

100 
	`CHECK_VARINT
(
a
,
NULL
);

101 
v
 = (
v®ue
 *)
	`_pbcH_®loc
(
h
, 
SIZE_VAR
);

102 
v
->v.
v¬
->
e
.
id
 = 
a
->v.
i
.
low
;

103 
v
->v.
v¬
->
e
.
Çme
 = (cÚ¡ *)
	`_pbcM__qu”y
(
f
->
ty³_Çme
.e->
id
 , 
a
->v.
i
.
low
);

105 
PTYPE_INT64
:

106 
PTYPE_UINT64
:

107 
PTYPE_INT32
:

108 
PTYPE_UINT32
:

109 
PTYPE_BOOL
:

110 
	`CHECK_VARINT
(
a
,
NULL
);

111 
v
 = (
v®ue
 *)
	`_pbcH_®loc
(
h
, 
SIZE_VAR
);

112 
v
->v.
v¬
->
š‹g”
 = 
a
->v.
i
;

114 
PTYPE_FIXED32
:

115 
PTYPE_SFIXED32
:

116 
	`CHECK_BIT32
(
a
,
NULL
);

117 
v
 = (
v®ue
 *)
	`_pbcH_®loc
(
h
, 
SIZE_VAR
);

118 
v
->v.
v¬
->
š‹g”
 = 
a
->v.
i
;

120 
PTYPE_FIXED64
:

121 
PTYPE_SFIXED64
:

122 
	`CHECK_BIT64
(
a
,
NULL
);

123 
v
 = (
v®ue
 *)
	`_pbcH_®loc
(
h
, 
SIZE_VAR
);

124 
v
->v.
v¬
->
š‹g”
 = 
a
->v.
i
;

126 
PTYPE_SINT32
:

127 
	`CHECK_VARINT
(
a
,
NULL
);

128 
v
 = (
v®ue
 *)
	`_pbcH_®loc
(
h
, 
SIZE_VAR
);

129 
v
->v.
v¬
->
š‹g”
 = 
a
->v.
i
;

130 
	`_pbcV_dezigzag32
(&(
v
->v.
v¬
->
š‹g”
));

132 
PTYPE_SINT64
:

133 
	`CHECK_VARINT
(
a
,
NULL
);

134 
v
 = (
v®ue
 *)
	`_pbcH_®loc
(
h
, 
SIZE_VAR
);

135 
v
->v.
v¬
->
š‹g”
 = 
a
->v.
i
;

136 
	`_pbcV_dezigzag64
(&(
v
->v.
v¬
->
š‹g”
));

138 
PTYPE_STRING
:

139 
	`CHECK_LEND
(
a
,
NULL
);

140 
v
 = 
	`»ad_¡ršg
(
h
,
a
,
f
,
bufãr
);

142 
PTYPE_BYTES
:

143 
	`CHECK_LEND
(
a
,
NULL
);

144 
v
 = (
v®ue
 *)
	`_pbcH_®loc
(
h
, 
SIZE_VAR
);

145 
v
->v.
v¬
->
s
.
¡r
 = (cÚ¡ *)(
bufãr
 + 
a
->v.s.
¡¬t
);

146 
v
->v.
v¬
->
s
.
Ën
 = 
a
->v.s.
’d
 -‡->v.s.
¡¬t
;

148 
PTYPE_MESSAGE
:

149 
	`CHECK_LEND
(
a
,
NULL
);

150 
v
 = (
v®ue
 *)
	`_pbcH_®loc
(
h
, 
SIZE_MESSAGE
);

151 
	`_pbc_rmes§ge_Ãw
(&(
v
->v.
mes§ge
), 
f
->
ty³_Çme
.
m
 ,

152 
bufãr
 + 
a
->
v
.
s
.
¡¬t
 ,

153 
a
->
v
.
s
.
’d
 -‡->v.s.
¡¬t
,
h
);

156  
NULL
;

158 
v
->
ty³
 = 
f
;

159  
v
;

160 
	}
}

163 
	$push_v®ue_·cked
(
_mes§ge
 * 
ty³
, 
pbc_¬¿y
 
¬¿y
, 
_f›ld
 *
f
, 
©om
 * 
¯
, 
ušt8_t
 *
bufãr
) {

164 
n
 = 
	`_pbcP_uÅack_·cked
((
ušt8_t
 *)
bufãr
 + 
¯
->
v
.
s
.
¡¬t
,‡a->v.s.
’d
 -‡a->v.s.start,

165 
f
->
ty³
 , 
¬¿y
);

166 ià(
n
<=0) {

168 
ty³
->
’v
->
Ï¡”rÜ
 = "Unpack…acked fieldƒrror";

171 ià(
f
->
ty³
 =ğ
PTYPE_ENUM
) {

172 
i
;

173 
i
=0;i<
n
;i++) {

174 
_pbc_v¬
 * 
v
 = (_pbc_v¬ *)
	`_pbcA_šdex_p
(
¬¿y
, 
i
);

175 
id
 = 
v
->
š‹g”
.
low
;

176 
v
->
e
.
id
 = id;

177 
v
->
e
.
Çme
 = (cÚ¡ *)
	`_pbcM__qu”y
(
f
->
ty³_Çme
.e->
id
 , id);

180 
	}
}

183 
	$push_v®ue_¬¿y
(
h—p
 *
h
, 
pbc_¬¿y
 
¬¿y
, 
_f›ld
 *
f
, 
©om
 * 
a
, 
ušt8_t
 *
bufãr
) {

184 
pbc_v¬
 
v
;

186 
f
->
ty³
) {

187 
PTYPE_DOUBLE
:

188 
v
->
»®
 = 
	`»ad_doubË
(
a
);

190 
PTYPE_FLOAT
:

191 
v
->
»®
 = (è
	`»ad_æßt
(
a
);

193 
PTYPE_ENUM
:

194 
v
->
e
.
id
 = 
a
->v.
i
.
low
;

195 
v
->
e
.
Çme
 = (cÚ¡ *)
	`_pbcM__qu”y
(
f
->
ty³_Çme
.e->
id
 , 
a
->v.
i
.
low
);

197 
PTYPE_INT64
:

198 
PTYPE_UINT64
:

199 
PTYPE_INT32
:

200 
PTYPE_UINT32
:

201 
PTYPE_FIXED32
:

202 
PTYPE_FIXED64
:

203 
PTYPE_SFIXED32
:

204 
PTYPE_SFIXED64
:

205 
PTYPE_BOOL
:

206 
v
->
š‹g”
 = 
a
->v.
i
;

208 
PTYPE_SINT32
:

209 
v
->
š‹g”
 = 
a
->v.
i
;

210 
	`_pbcV_dezigzag32
(&(
v
->
š‹g”
));

212 
PTYPE_SINT64
:

213 
v
->
š‹g”
 = 
a
->v.
i
;

214 
	`_pbcV_dezigzag64
(&(
v
->
š‹g”
));

216 
PTYPE_STRING
:

217 
	`CHECK_LEND
(
a
, );

218 
	`»ad_¡ršg_v¬
(
h
,
v
,
a
,
f
,
bufãr
);

220 
PTYPE_BYTES
:

221 
	`CHECK_LEND
(
a
, );

222 
v
->
s
.
¡r
 = (cÚ¡ *)(
bufãr
 + 
a
->v.s.
¡¬t
);

223 
v
->
s
.
Ën
 = 
a
->v.s.
’d
 -‡->v.s.
¡¬t
;

225 
PTYPE_MESSAGE
: {

226 
	`CHECK_LEND
(
a
, );

227 
pbc_rmes§ge
 
mes§ge
;

228 
	`_pbc_rmes§ge_Ãw
(&
mes§ge
, 
f
->
ty³_Çme
.
m
 ,

229 
bufãr
 + 
a
->
v
.
s
.
¡¬t
 ,

230 
a
->
v
.
s
.
’d
 -‡->v.s.
¡¬t
,
h
);

231 ià(
mes§ge
.
msg
 =ğ
NULL
) {

234 
v
->
p
[0] = 
mes§ge
.
msg
;

235 
v
->
p
[1] = 
mes§ge
.
šdex
;

242 
	`_pbcA_push
(
¬¿y
,
v
);

243 
	}
}

246 
	$_pbc_rmes§ge_Ãw
(
pbc_rmes§ge
 * 
»t
 , 
_mes§ge
 * 
ty³
 , *
bufãr
, 
size
 , 
h—p
 *
h
) {

247 ià(
size
 == 0) {

248 
»t
->
msg
 = 
ty³
;

249 
»t
->
šdex
 = 
	`_pbcM_¥_Ãw
(0 , 
h
);

250 
»t
->
h—p
 = 
h
;

253 
pbc_ùx
 
_ùx
;

254 
couÁ
 = 
	`_pbcC_İ’
(
_ùx
,
bufãr
,
size
);

255 ià(
couÁ
 <= 0) {

256 
ty³
->
’v
->
Ï¡”rÜ
 = "rmessage decode contextƒrror";

257 
	`mem£t
(
»t
 , 0, (*ret));

260 
cÚ‹xt
 * 
ùx
 = (cÚ‹xˆ*)
_ùx
;

262 
»t
->
msg
 = 
ty³
;

263 
»t
->
šdex
 = 
	`_pbcM_¥_Ãw
(
couÁ
, 
h
);

264 
»t
->
h—p
 = 
h
;

266 
i
;

268 
i
=0;i<
ùx
->
numb”
;i++) {

269 
id
 = 
ùx
->
a
[
i
].
wœe_id
 >> 3;

270 
_f›ld
 * 
f
 = (_f›ld *)
	`_pbcM__qu”y
(
ty³
->
id
 , id);

271 ià(
f
) {

272 ià(
f
->
Ïb–
 =ğ
LABEL_REPEATED
 || f->Ïb– =ğ
LABEL_PACKED
) {

273 
v®ue
 * 
v
;

274 ** 
vv
 = 
	`_pbcM_¥_qu”y_š£¹
(
»t
->
šdex
, 
f
->
Çme
);

275 ià(*
vv
 =ğ
NULL
) {

276 
v
 = (
v®ue
 *)
	`_pbcH_®loc
(
h
, 
SIZE_ARRAY
);

277 
v
->
ty³
 = 
f
;

278 
	`_pbcA_İ’_h—p
(
v
->v.
¬¿y
,
»t
->
h—p
);

279 *
vv
 = 
v
;

281 
v
ğ(
v®ue
 *)*
vv
;

283 ià(
f
->
Ïb–
 =ğ
LABEL_PACKED
) {

284 
	`push_v®ue_·cked
(
ty³
, 
v
->v.
¬¿y
 , 
f
 , &(
ùx
->
a
[
i
]), (
ušt8_t
 *)
bufãr
);

285 ià(
	`pbc_¬¿y_size
(
v
->v.
¬¿y
) == 0) {

286 
ty³
->
’v
->
Ï¡”rÜ
 = "rmessage decode…acked dataƒrror";

287 *
vv
 = 
NULL
;

290 
	`push_v®ue_¬¿y
(
h
,
v
->v.
¬¿y
 , 
f
, &(
ùx
->
a
[
i
]), (
ušt8_t
 *)
bufãr
);

291 ià(
	`pbc_¬¿y_size
(
v
->v.
¬¿y
) == 0) {

292 
ty³
->
’v
->
Ï¡”rÜ
 = "rmessage decode„epeated dataƒrror";

293 *
vv
 = 
NULL
;

297 
v®ue
 * 
v
 = 
	`»ad_v®ue
(
h
, 
f
, &(
ùx
->
a
[
i
]), (
ušt8_t
 *)
bufãr
);

298 ià(
v
) {

299 
	`_pbcM_¥_š£¹
(
»t
->
šdex
, 
f
->
Çme
, 
v
);

301 
ty³
->
’v
->
Ï¡”rÜ
 = "rmessage decode dataƒrror";

307 
	`_pbcC_şo£
(
_ùx
);

308 
	}
}

310 
pbc_rmes§ge
 *

311 
	$pbc_rmes§ge_Ãw
(
pbc_’v
 * 
’v
, cÚ¡ * 
ty³_Çme
 , 
pbc_¦iû
 * 
¦iû
) {

312 
_mes§ge
 * 
msg
 = 
	`_pbcP_g‘_mes§ge
(
’v
, 
ty³_Çme
);

313 ià(
msg
 =ğ
NULL
) {

314 
’v
->
Ï¡”rÜ
 = "Proto‚ot found";

315  
NULL
;

317 
pbc_rmes§ge
 
‹mp
;

318 
h—p
 * 
h
 = 
	`_pbcH_Ãw
(
¦iû
->
Ën
);

319 
	`_pbc_rmes§ge_Ãw
(&
‹mp
, 
msg
 , 
¦iû
->
bufãr
, sliû->
Ën
 , 
h
);

320 ià(
‹mp
.
msg
 =ğ
NULL
) {

321 
	`_pbcH_d–‘e
(
h
);

322  
NULL
;

325 
pbc_rmes§ge
 *
m
 = (pbc_rmes§g*)
	`_pbcH_®loc
(
‹mp
.
h—p
, (*m));

326 *
m
 = 
‹mp
;

327  
m
;

328 
	}
}

331 
	$pbc_rmes§ge_d–‘e
(
pbc_rmes§ge
 * 
m
) {

332 ià(
m
) {

333 
	`_pbcH_d–‘e
(
m
->
h—p
);

335 
	}
}

338 
	$pbc_rmes§ge_¡ršg
(
pbc_rmes§ge
 * 
m
 , cÚ¡ *
key
 , 
šdex
, *
sz
) {

339 
v®ue
 * 
v
 = (v®u*)
	`_pbcM_¥_qu”y
(
m
->
šdex
,
key
);

340 
ty³
 = 0;

341 
pbc_v¬
 
v¬
;

342 ià(
v
 =ğ
NULL
) {

343 
ty³
 = 
	`_pbcP_mes§ge_deçuÉ
(
m
->
msg
, 
key
, 
v¬
);

345 ià(
v
->
ty³
->
Ïb–
 =ğ
LABEL_REPEATED
 || v->ty³->Ïb– =ğ
LABEL_PACKED
) {

346 
	`_pbcA_šdex
(
v
->v.
¬¿y
, 
šdex
, 
v¬
);

348 
v¬
[0] = 
v
->v.var[0];

350 
ty³
 = 
v
->type->type;

353 ià(
ty³
 =ğ
PTYPE_ENUM
) {

354 ià(
sz
) {

355 *
sz
 = 
	`¡¾’
(
v¬
->
e
.
Çme
);

357  
v¬
->
e
.
Çme
;

360 ià(
sz
) {

361 
Ën
 = 
v¬
->
s
.len;

362 ià(
Ën
<0) {

363 
Ën
 = -†en;

365 *
sz
 = 
Ën
;

367  
v¬
->
s
.
¡r
;

368 
	}
}

370 
ušt32_t


371 
	$pbc_rmes§ge_š‹g”
(
pbc_rmes§ge
 *
m
 , cÚ¡ *
key
 , 
šdex
, 
ušt32_t
 *
hi
) {

372 
v®ue
 * 
v
 = (v®u*)
	`_pbcM_¥_qu”y
(
m
->
šdex
,
key
);

373 
pbc_v¬
 
v¬
;

374 
ty³
 = 0;

375 ià(
v
 =ğ
NULL
) {

376 
ty³
 = 
	`_pbcP_mes§ge_deçuÉ
(
m
->
msg
, 
key
, 
v¬
);

378 ià(
v
->
ty³
->
Ïb–
 =ğ
LABEL_REPEATED
 || v->ty³->Ïb– =ğ
LABEL_PACKED
) {

379 
	`_pbcA_šdex
(
v
->v.
¬¿y
, 
šdex
, 
v¬
);

381 
v¬
[0] = 
v
->v.var[0];

383 
ty³
 = 
v
->type->type;

386 ià(
ty³
 =ğ
PTYPE_ENUM
) {

387 ià(
hi
) {

388 *
hi
 = 0;

390  
v¬
->
e
.
id
;

393 ià(
hi
) {

394 *
hi
 = 
v¬
->
š‹g”
.hi;

396  
v¬
->
š‹g”
.
low
;

397 
	}
}

400 
	$pbc_rmes§ge_»®
(
pbc_rmes§ge
 * 
m
, cÚ¡ *
key
 , 
šdex
) {

401 
v®ue
 * 
v
 = (v®u*)
	`_pbcM_¥_qu”y
(
m
->
šdex
,
key
);

402 
pbc_v¬
 
v¬
;

403 ià(
v
 =ğ
NULL
) {

404 
	`_pbcP_mes§ge_deçuÉ
(
m
->
msg
, 
key
, 
v¬
);

406 ià(
v
->
ty³
->
Ïb–
 =ğ
LABEL_REPEATED
 || v->ty³->Ïb– =ğ
LABEL_PACKED
) {

407 
	`_pbcA_šdex
(
v
->v.
¬¿y
, 
šdex
, 
v¬
);

409  
v
->v.
v¬
->
»®
;

412  
v¬
->
»®
;

413 
	}
}

416 
pbc_rmes§ge
 *

417 
	$pbc_rmes§ge_mes§ge
(
pbc_rmes§ge
 * 
rm
, cÚ¡ *
key
, 
šdex
) {

418 
v®ue
 * 
v
 = (v®u*)
	`_pbcM_¥_qu”y
(
rm
->
šdex
,
key
);

419 ià(
v
 =ğ
NULL
) {

420 
_f›ld
 * 
f
 = (_f›ld *)
	`_pbcM_¥_qu”y
(
rm
->
msg
->
Çme
, 
key
);

421 ià(
f
 =ğ
NULL
) {

422 
rm
->
msg
->
’v
->
Ï¡”rÜ
 = "Invalid key for sub-message";

424  
NULL
;

426 
_mes§ge
 * 
m
 = 
f
->
ty³_Çme
.m;

428 ià(
m
->
def
 =ğ
NULL
) {

430 
m
->
def
 = (
pbc_rmes§ge
 *)
	`m®loc
((pbc_rmessage));

431 
m
->
def
->
msg
 = m;

432 
m
->
def
->
šdex
 = 
NULL
;

434  
m
->
def
;

436 ià(
v
->
ty³
->
Ïb–
 =ğ
LABEL_REPEATED
) {

437  (
pbc_rmes§ge
 *)
	`_pbcA_šdex_p
(
v
->v.
¬¿y
,
šdex
);

439  &(
v
->v.
mes§ge
);

442 
	}
}

445 
	$pbc_rmes§ge_size
(
pbc_rmes§ge
 *
m
, cÚ¡ *
key
) {

446 
v®ue
 * 
v
 = (v®u*)
	`_pbcM_¥_qu”y
(
m
->
šdex
,
key
);

447 ià(
v
 =ğ
NULL
) {

450 ià(
v
->
ty³
->
Ïb–
 =ğ
LABEL_REPEATED
 || v->ty³->Ïb– =ğ
LABEL_PACKED
) {

451  
	`pbc_¬¿y_size
(
v
->v.
¬¿y
);

455 
	}
}

	@src/stringpool.c

1 
	~"®loc.h
"

3 
	~<¡dlib.h
>

4 
	~<¡ršg.h
>

6 
	#PAGE_SIZE
 256

	)

8 
	s_¡ršgpoŞ
 {

9 * 
	mbufãr
;

10 
size_t
 
	mËn
;

11 
_¡ršgpoŞ
 *
	mÃxt
;

14 
_¡ršgpoŞ
 *

15 
	$_pbcS_Ãw
() {

16 
_¡ršgpoŞ
 * 
»t
 = (_¡ršgpoŞ *)
	`m®loc
((_¡ršgpoŞè+ 
PAGE_SIZE
);

17 
»t
->
bufãr
 = (*)(ret + 1);

18 
»t
->
Ën
 = 0;

19 
»t
->
Ãxt
 = 
NULL
;

20  
»t
;

21 
	}
}

24 
	$_pbcS_d–‘e
(
_¡ršgpoŞ
 *
poŞ
) {

25 
poŞ
) {

26 
_¡ršgpoŞ
 *
Ãxt
 = 
poŞ
->next;

27 
	`ä“
(
poŞ
);

28 
poŞ
 = 
Ãxt
;

30 
	}
}

33 
	$_pbcS_bud
(
_¡ršgpoŞ
 *
poŞ
, cÚ¡ * 
¡r
 , 
sz
) {

34 
size_t
 
s
 = 
sz
 + 1;

35 ià(
s
 < 
PAGE_SIZE
 - 
poŞ
->
Ën
) {

36 * 
»t
 = 
poŞ
->
bufãr
 +…oŞ->
Ën
;

37 
	`memıy
(
poŞ
->
bufãr
 +…oŞ->
Ën
, 
¡r
, 
s
);

38 
poŞ
->
Ën
 +ğ
s
;

39  
»t
;

41 ià(
s
 > 
PAGE_SIZE
) {

42 
_¡ršgpoŞ
 * 
Ãxt
 = (_¡ršgpoŞ *)
	`m®loc
((_¡ršgpoŞè+ 
s
);

43 
Ãxt
->
bufãr
 = (*)(next + 1);

44 
	`memıy
(
Ãxt
->
bufãr
, 
¡r
, 
s
);

45 
Ãxt
->
Ën
 = 
s
;

46 
Ãxt
->Ãxˆğ
poŞ
->next;

47 
poŞ
->
Ãxt
 =‚ext;

48  
Ãxt
->
bufãr
;

50 
_¡ršgpoŞ
 *
Ãxt
 = (_¡ršgpoŞ *)
	`m®loc
((_¡ršgpoŞè+ 
PAGE_SIZE
);

51 
Ãxt
->
bufãr
 = 
poŞ
->buffer;

52 
Ãxt
->Ãxˆğ
poŞ
->next;

53 
Ãxt
->
Ën
 = 
poŞ
->len;

55 
poŞ
->
Ãxt
 =‚ext;

56 
poŞ
->
bufãr
 = (*)(
Ãxt
 + 1);

57 
	`memıy
(
poŞ
->
bufãr
, 
¡r
, 
s
);

58 
poŞ
->
Ën
 = 
s
;

59  
poŞ
->
bufãr
;

60 
	}
}

	@src/stringpool.h

1 #iâdeà
PROTOBUF_C_STRINGPOOL_H


2 
	#PROTOBUF_C_STRINGPOOL_H


	)

4 
	g_¡ršgpoŞ
;

6 
_¡ršgpoŞ
 * 
_pbcS_Ãw
();

7 
_pbcS_d–‘e
(
_¡ršgpoŞ
 *
poŞ
);

8 cÚ¡ * 
_pbcS_bud
(
_¡ršgpoŞ
 *
poŞ
, cÚ¡ * 
¡r
 , 
sz
);

	@src/varint.c

1 
	~"v¬št.h
"

3 
	~"pbc.h
"

5 
	~<¡dšt.h
>

7 
šlše
 

8 
	$_pbcV_’code32
(
ušt32_t
 
numb”
, 
ušt8_t
 
bufãr
[10])

10 ià(
numb”
 < 0x80) {

11 
bufãr
[0] = (
ušt8_t
è
numb”
 ;

14 
bufãr
[0] = (
ušt8_t
è(
numb”
 | 0x80 );

15 ià(
numb”
 < 0x4000) {

16 
bufãr
[1] = (
ušt8_t
è(
numb”
 >> 7 );

19 
bufãr
[1] = (
ušt8_t
è((
numb”
 >> 7) | 0x80 );

20 ià(
numb”
 < 0x200000) {

21 
bufãr
[2] = (
ušt8_t
è(
numb”
 >> 14);

24 
bufãr
[2] = (
ušt8_t
è((
numb”
 >> 14) | 0x80 );

25 ià(
numb”
 < 0x10000000) {

26 
bufãr
[3] = (
ušt8_t
è(
numb”
 >> 21);

29 
bufãr
[3] = (
ušt8_t
è((
numb”
 >> 21) | 0x80 );

30 
bufãr
[4] = (
ušt8_t
è(
numb”
 >> 28);

32 
	}
}

35 
	$_pbcV_’code
(
ušt64_t
 
numb”
, 
ušt8_t
 
bufãr
[10])

37 ià((
numb”
 & 0xffffffff) ==‚umber) {

38  
	`_pbcV_’code32
((
ušt32_t
)
numb”
 , 
bufãr
);

40 
i
 = 0;

42 
bufãr
[
i
] = (
ušt8_t
)(
numb”
 | 0x80);

43 
numb”
 >>= 7;

44 ++
i
;

45 } 
numb”
 >= 0x80);

46 
bufãr
[
i
] = (
ušt8_t
)
numb”
;

47  
i
+1;

48 
	}
}

51 
	$_pbcV_decode
(
ušt8_t
 
bufãr
[10], 
lÚglÚg
 *
»suÉ
) {

52 ià(!(
bufãr
[0] & 0x80)) {

53 
»suÉ
->
low
 = 
bufãr
[0];

54 
»suÉ
->
hi
 = 0;

57 
ušt32_t
 
r
 = 
bufãr
[0] & 0x7f;

58 
i
;

59 
i
=1;i<4;i++) {

60 
r
 |ğ((
bufãr
[
i
]&0x7f) << (7*i));

61 ià(!(
bufãr
[
i
] & 0x80)) {

62 
»suÉ
->
low
 = 
r
;

63 
»suÉ
->
hi
 = 0;

64  
i
+1;

67 
ušt64_t
 
Ì
 = 0;

68 
i
=4;i<10;i++) {

69 
Ì
 |ğ((
ušt64_t
)(
bufãr
[
i
] & 0x7f) << (7*(i-4)));

70 ià(!(
bufãr
[
i
] & 0x80)) {

71 
»suÉ
->
hi
 = (
ušt32_t
)(
Ì
 >> 4);

72 
»suÉ
->
low
 = 
r
 | (((
ušt32_t
)
Ì
 & 0xf) << 28);

73  
i
+1;

77 
»suÉ
->
low
 = 0;

78 
»suÉ
->
hi
 = 0;

80 
	}
}

83 
	$_pbcV_zigzag32
(
št32_t
 
n
, 
ušt8_t
 
bufãr
[10])

85 
n
 = (n << 1) ^ (n >> 31);

86  
	`_pbcV_’code32
(
n
,
bufãr
);

87 
	}
}

90 
	$_pbcV_zigzag
(
št64_t
 
n
, 
ušt8_t
 
bufãr
[10])

92 
n
 = (n << 1) ^ (n >> 63);

93  
	`_pbcV_’code
(
n
,
bufãr
);

94 
	}
}

97 
	$_pbcV_dezigzag64
(
lÚglÚg
 *
r
)

99 
ušt32_t
 
low
 = 
r
->low;

100 
r
->
low
 = (Öow >> 1è| (Ô->
hi
 & 1) << 31)) ^ - (low & 1);

101 
r
->
hi
 = (r->h˜>> 1è^ - (
low
 & 1);

102 
	}
}

105 
	$_pbcV_dezigzag32
(
lÚglÚg
 *
r
)

107 
ušt32_t
 
low
 = 
r
->low;

108 
r
->
low
 = (low >> 1) ^ - (low & 1);

109 
r
->
hi
 = -(
low
 >> 31);

110 
	}
}

	@src/varint.h

1 #iâdeà
PROTOBUF_C_VARINT_H


2 
	#PROTOBUF_C_VARINT_H


	)

4 
	~<¡dšt.h
>

6 
	slÚglÚg
 {

7 
ušt32_t
 
	mlow
;

8 
ušt32_t
 
	mhi
;

11 
_pbcV_’code32
(
ušt32_t
 
numb”
, 
ušt8_t
 
bufãr
[10]);

12 
_pbcV_’code
(
ušt64_t
 
numb”
, 
ušt8_t
 
bufãr
[10]);

13 
_pbcV_zigzag32
(
št32_t
 
numb”
, 
ušt8_t
 
bufãr
[10]);

14 
_pbcV_zigzag
(
št64_t
 
numb”
, 
ušt8_t
 
bufãr
[10]);

16 
_pbcV_decode
(
ušt8_t
 
bufãr
[10], 
lÚglÚg
 *
»suÉ
);

17 
_pbcV_dezigzag64
(
lÚglÚg
 *
r
);

18 
_pbcV_dezigzag32
(
lÚglÚg
 *
r
);

	@src/wmessage.c

1 
	~"pbc.h
"

2 
	~"cÚ‹xt.h
"

3 
	~"®loc.h
"

4 
	~"v¬št.h
"

5 
	~"m­.h
"

6 
	~"´Ùo.h
"

8 
	~<¡dšt.h
>

9 
	~<¡ršg.h
>

10 
	~<as£¹.h
>

12 #iâdeà
_MSC_VER


13 
	~<¡dboŞ.h
>

16 
	#WMESSAGE_SIZE
 64

	)

18 
	spbc_wmes§ge
 {

19 
_mes§ge
 *
	mty³
;

20 
ušt8_t
 * 
	mbufãr
;

21 
ušt8_t
 * 
	m±r
;

22 
ušt8_t
 * 
	m’d±r
;

23 
pbc_¬¿y
 
	msub
;

24 
m­_¥
 *
	m·cked
;

25 
h—p
 * 
	mh—p
;

28 
	s_·cked
 {

29 
	mid
;

30 
	m±y³
;

31 
pbc_¬¿y
 
	md©a
;

34 
pbc_wmes§ge
 *

35 
	$_wmes§ge_Ãw
(
h—p
 *
h
, 
_mes§ge
 *
msg
) {

36 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
	`_pbcH_®loc
(
h
, (*m));

37 
m
->
ty³
 = 
msg
;

38 
m
->
bufãr
 = (
ušt8_t
 *)
	`_pbcH_®loc
(
h
, 
WMESSAGE_SIZE
);

39 
m
->
±r
 = m->
bufãr
;

40 
m
->
’d±r
 = m->
bufãr
 + 
WMESSAGE_SIZE
;

41 
	`_pbcA_İ’_h—p
(
m
->
sub
, 
h
);

42 
m
->
·cked
 = 
NULL
;

43 
m
->
h—p
 = 
h
;

45  
m
;

46 
	}
}

48 
pbc_wmes§ge
 *

49 
	$pbc_wmes§ge_Ãw
(
pbc_’v
 * 
’v
, cÚ¡ *
ty³_Çme
) {

50 
_mes§ge
 * 
msg
 = 
	`_pbcP_g‘_mes§ge
(
’v
, 
ty³_Çme
);

51 ià(
msg
 =ğ
NULL
)

52  
NULL
;

53 
h—p
 *
h
 = 
	`_pbcH_Ãw
(0);

54  
	`_wmes§ge_Ãw
(
h
, 
msg
);

55 
	}
}

58 
	$pbc_wmes§ge_d–‘e
(
pbc_wmes§ge
 *
m
) {

59 ià(
m
) {

60 
	`_pbcH_d–‘e
(
m
->
h—p
);

62 
	}
}

65 
	$_ex·nd_mes§ge
(
pbc_wmes§ge
 *
m
, 
sz
) {

66 ià(
m
->
±r
 + 
sz
 > m->
’d±r
) {

67 
ÿp
 = 
m
->
’d±r
 - m->
bufãr
;

68 
sz
 = 
m
->
±r
 + sz - m->
bufãr
;

70 
ÿp
 = cap * 2;

71 }  
sz
 > 
ÿp
 ) ;

72 
Şd_size
 = 
m
->
±r
 - m->
bufãr
;

73 
ušt8_t
 * 
bufãr
 = (ušt8_ˆ*)
	`_pbcH_®loc
(
m
->
h—p
, 
ÿp
);

74 
	`memıy
(
bufãr
, 
m
->bufãr, 
Şd_size
);

75 
m
->
±r
 = 
bufãr
 + (m->ptr - m->buffer);

76 
m
->
’d±r
 = 
bufãr
 + 
ÿp
;

77 
m
->
bufãr
 = buffer;

79 
	}
}

81 
_·cked
 *

82 
	$_g‘_·cked
(
pbc_wmes§ge
 *
m
 , 
_f›ld
 *
f
 , cÚ¡ *
key
) {

83 ià(
m
->
·cked
 =ğ
NULL
) {

84 
m
->
·cked
 = 
	`_pbcM_¥_Ãw
(4, m->
h—p
);

86 ** 
v
 = 
	`_pbcM_¥_qu”y_š£¹
(
m
->
·cked
 , 
key
);

87 ià(*
v
 =ğ
NULL
) {

88 *
v
 = 
	`_pbcH_®loc
(
m
->
h—p
, (
_·cked
));

89 
_·cked
 *
p
 = (_·cked *)*
v
;

90 
p
->
id
 = 
f
->id;

91 
p
->
±y³
 = 
f
->
ty³
;

92 
	`_pbcA_İ’_h—p
(
p
->
d©a
, 
m
->
h—p
);

93  
p
;

95  (
_·cked
 *)*
v
;

96 
	}
}

99 
	$_·cked_š‹g”
(
pbc_wmes§ge
 *
m
, 
_f›ld
 *
f
, cÚ¡ *
key
 , 
ušt32_t
 
low
, ušt32_ˆ
hi
) {

100 
_·cked
 * 
·cked
 = 
	`_g‘_·cked
(
m
,
f
,
key
);

101 
pbc_v¬
 
v¬
;

102 
v¬
->
š‹g”
.
low
 =†ow;

103 
v¬
->
š‹g”
.
hi
 = hi;

104 
	`_pbcA_push
(
·cked
->
d©a
 , 
v¬
);

105 
	}
}

108 
	$_·cked_»®
(
pbc_wmes§ge
 *
m
, 
_f›ld
 *
f
, cÚ¡ *
key
 , 
v
) {

109 
_·cked
 * 
·cked
 = 
	`_g‘_·cked
(
m
,
f
,
key
);

110 
pbc_v¬
 
v¬
;

111 
v¬
->
»®
 = 
v
;

112 
	`_pbcA_push
(
·cked
->
d©a
 , 
v¬
);

113 
	}
}

115 
šlše
 

116 
	$št64_’code
(
ušt32_t
 
low
, ušt32_ˆ
hi
 , 
ušt8_t
 * 
bufãr
) {

117 
bufãr
[0] = (
ušt8_t
)(
low
 & 0xff);

118 
bufãr
[1] = (
ušt8_t
)(
low
 >> 8 & 0xff);

119 
bufãr
[2] = (
ušt8_t
)(
low
 >> 16 & 0xff);

120 
bufãr
[3] = (
ušt8_t
)(
low
 >> 24 & 0xff);

121 
bufãr
[4] = (
ušt8_t
)(
hi
 & 0xff);

122 
bufãr
[5] = (
ušt8_t
)(
hi
 >> 8 & 0xff);

123 
bufãr
[6] = (
ušt8_t
)(
hi
 >> 16 & 0xff);

124 
bufãr
[7] = (
ušt8_t
)(
hi
 >> 24 & 0xff);

125 
	}
}

127 
šlše
 

128 
	$št32_’code
(
ušt32_t
 
low
, 
ušt8_t
 * 
bufãr
) {

129 
bufãr
[0] = (
ušt8_t
)(
low
 & 0xff);

130 
bufãr
[1] = (
ušt8_t
)(
low
 >> 8 & 0xff);

131 
bufãr
[2] = (
ušt8_t
)(
low
 >> 16 & 0xff);

132 
bufãr
[3] = (
ušt8_t
)(
low
 >> 24 & 0xff);

133 
	}
}

136 
	$pbc_wmes§ge_š‹g”
(
pbc_wmes§ge
 *
m
, cÚ¡ *
key
, 
ušt32_t
 
low
, ušt32_ˆ
hi
) {

137 
_f›ld
 * 
f
 = (_f›ld *)
	`_pbcM_¥_qu”y
(
m
->
ty³
->
Çme
,
key
);

138 ià(
f
==
NULL
) {

140 
m
->
ty³
->
’v
->
Ï¡”rÜ
 = "wmessage_interger query keyƒrror";

143 ià(
f
->
Ïb–
 =ğ
LABEL_PACKED
) {

144 
	`_·cked_š‹g”
(
m
 , 
f
, 
key
 , 
low
, 
hi
);

147 ià(
f
->
Ïb–
 =ğ
LABEL_OPTIONAL
) {

148 ià(
f
->
ty³
 =ğ
PTYPE_ENUM
) {

149 ià(
low
 =ğ
f
->
deçuÉ_v
->
e
.
id
)

152 ià(
low
 =ğ
f
->
deçuÉ_v
->
š‹g”
.low &&

153 
hi
 =ğ
f
->
deçuÉ_v
->
š‹g”
.hi) {

158 
id
 = 
f
->id << 3;

160 
	`_ex·nd_mes§ge
(
m
,20);

161 
f
->
ty³
) {

162 
PTYPE_INT64
:

163 
PTYPE_UINT64
:

164 
PTYPE_INT32
:

165 
id
 |ğ
WT_VARINT
;

166 
m
->
±r
 +ğ
	`_pbcV_’code32
(
id
, m->ptr);

167 
m
->
±r
 +ğ
	`_pbcV_’code
((
ušt64_t
)
low
 | (ušt64_t)
hi
 << 32 , m->ptr);

169 
PTYPE_UINT32
:

170 
PTYPE_ENUM
:

171 
PTYPE_BOOL
:

172 
id
 |ğ
WT_VARINT
;

173 
m
->
±r
 +ğ
	`_pbcV_’code32
(
id
, m->ptr);

174 
m
->
±r
 +ğ
	`_pbcV_’code32
(
low
, m->ptr);

176 
PTYPE_FIXED64
:

177 
PTYPE_SFIXED64
:

178 
id
 |ğ
WT_BIT64
;

179 
m
->
±r
 +ğ
	`_pbcV_’code32
(
id
, m->ptr);

180 
	`št64_’code
(
low
,
hi
,
m
->
±r
);

181 
m
->
±r
 += 8;

183 
PTYPE_FIXED32
:

184 
PTYPE_SFIXED32
:

185 
id
 |ğ
WT_BIT32
;

186 
m
->
±r
 +ğ
	`_pbcV_’code32
(
id
, m->ptr);

187 
	`št32_’code
(
low
,
m
->
±r
);

188 
m
->
±r
 += 4;

190 
PTYPE_SINT32
:

191 
id
 |ğ
WT_VARINT
;

192 
m
->
±r
 +ğ
	`_pbcV_’code32
(
id
, m->ptr);

193 
m
->
±r
 +ğ
	`_pbcV_zigzag32
(
low
, m->ptr);

195 
PTYPE_SINT64
:

196 
id
 |ğ
WT_VARINT
;

197 
m
->
±r
 +ğ
	`_pbcV_’code32
(
id
, m->ptr);

198 
m
->
±r
 +ğ
	`_pbcV_zigzag
((
ušt64_t
)
low
 | (ušt64_t)
hi
 << 32 , m->ptr);

203 
	}
}

206 
	$pbc_wmes§ge_»®
(
pbc_wmes§ge
 *
m
, cÚ¡ *
key
, 
v
) {

207 
_f›ld
 * 
f
 = (_f›ld *)
	`_pbcM_¥_qu”y
(
m
->
ty³
->
Çme
,
key
);

208 ià(
f
 =ğ
NULL
) {

210 
m
->
ty³
->
’v
->
Ï¡”rÜ
 = "wmessage_real query keyƒrror";

213 ià(
f
->
Ïb–
 =ğ
LABEL_PACKED
) {

214 
	`_·cked_»®
(
m
 , 
f
, 
key
 , 
v
);

218 ià(
f
->
Ïb–
 =ğ
LABEL_OPTIONAL
) {

219 ià(
v
 =ğ
f
->
deçuÉ_v
->
»®
)

222 
id
 = 
f
->id << 3;

223 
	`_ex·nd_mes§ge
(
m
,18);

224 
f
->
ty³
) {

225 
PTYPE_FLOAT
: {

226 
id
 |ğ
WT_BIT32
;

227 
m
->
±r
 +ğ
	`_pbcV_’code32
(
id
, m->ptr);

228 
	`æßt_’code
(
v
 , 
m
->
±r
);

229 
m
->
±r
 += 4;

232 
PTYPE_DOUBLE
:

233 
id
 |ğ
WT_BIT64
;

234 
m
->
±r
 +ğ
	`_pbcV_’code32
(
id
, m->ptr);

235 
	`doubË_’code
(
v
 , 
m
->
±r
);

236 
m
->
±r
 += 8;

241 
	}
}

244 
	$pbc_wmes§ge_¡ršg
(
pbc_wmes§ge
 *
m
, cÚ¡ *
key
, cÚ¡ * 
v
, 
Ën
) {

245 
_f›ld
 * 
f
 = (_f›ld *)
	`_pbcM_¥_qu”y
(
m
->
ty³
->
Çme
,
key
);

246 ià(
f
 =ğ
NULL
) {

248 
m
->
ty³
->
’v
->
Ï¡”rÜ
 = "wmessage_string query keyƒrror";

252 
boŞ
 
v¬Ën
 = 
çl£
;

254 ià(
Ën
 <=0) {

255 
v¬Ën
 = 
Œue
;

257 
Ën
 = 
	`¡¾’
(
v
) -†en;

259 ià(
f
->
Ïb–
 =ğ
LABEL_PACKED
) {

260 ià(
f
->
ty³
 =ğ
PTYPE_ENUM
) {

261 * 
‹mp
 = (*)
	`®loÿ
(
Ën
 + 1);

262 ià(!
v¬Ën
 || 
v
[
Ën
] != '\0') {

263 
	`memıy
(
‹mp
,
v
,
Ën
);

264 
‹mp
[
Ën
]='\0';

265 
v
 = 
‹mp
;

267 
’um_id
 = 0;

268 
”r
 = 
	`_pbcM_si_qu”y
(
f
->
ty³_Çme
.
e
->
Çme
, 
v
 , &
’um_id
);

269 ià(
”r
) {

271 
m
->
ty³
->
’v
->
Ï¡”rÜ
 = "wmessage_string…acked invalidƒnum";

274 
	`_·cked_š‹g”
(
m
 , 
f
, 
key
 , 
’um_id
 , 0);

279 ià(
f
->
Ïb–
 =ğ
LABEL_OPTIONAL
) {

280 ià(
f
->
ty³
 =ğ
PTYPE_ENUM
) {

281 ià(
	`¡ºcmp
(
v
 , 
f
->
deçuÉ_v
->
e
.
Çme
, 
Ën
) == 0 && f->default_v->e.name[len] =='\0') {

284 } ià(
f
->
ty³
 =ğ
PTYPE_STRING
) {

285 ià(
Ën
 =ğ
f
->
deçuÉ_v
->
s
.len &&

286 
	`¡rcmp
(
v
, 
f
->
deçuÉ_v
->
s
.
¡r
) == 0) {

289 } ià(
f
->
ty³
 =ğ
PTYPE_BYTES
) {

290 ià(
Ën
 == 0) {

295 
id
 = 
f
->id << 3;

296 
	`_ex·nd_mes§ge
(
m
,20);

297 
f
->
ty³
) {

298 
PTYPE_ENUM
 : {

299 * 
‹mp
 = (*)
	`®loÿ
(
Ën
+1);

300 ià(!
v¬Ën
 || 
v
[
Ën
] != '\0') {

301 
	`memıy
(
‹mp
,
v
,
Ën
);

302 
‹mp
[
Ën
]='\0';

303 
v
 = 
‹mp
;

305 
’um_id
 = 0;

306 
”r
 = 
	`_pbcM_si_qu”y
(
f
->
ty³_Çme
.
e
->
Çme
, 
v
, &
’um_id
);

307 ià(
”r
) {

309 
m
->
ty³
->
’v
->
Ï¡”rÜ
 = "wmessage_string invalidƒnum";

312 
id
 |ğ
WT_VARINT
;

313 
m
->
±r
 +ğ
	`_pbcV_’code32
(
id
, m->ptr);

314 
m
->
±r
 +ğ
	`_pbcV_’code32
(
’um_id
, m->ptr);

317 
PTYPE_STRING
:

318 
PTYPE_BYTES
:

319 
id
 |ğ
WT_LEND
;

320 
m
->
±r
 +ğ
	`_pbcV_’code32
(
id
, m->ptr);

321 
m
->
±r
 +ğ
	`_pbcV_’code32
(
Ën
, m->ptr);

322 
	`_ex·nd_mes§ge
(
m
,
Ën
);

323 
	`memıy
(
m
->
±r
 , 
v
 , 
Ën
);

324 
m
->
±r
 +ğ
Ën
;

329 
	}
}

331 
pbc_wmes§ge
 *

332 
	$pbc_wmes§ge_mes§ge
(
pbc_wmes§ge
 *
m
, cÚ¡ *
key
) {

333 
_f›ld
 * 
f
 = (_f›ld *)
	`_pbcM_¥_qu”y
(
m
->
ty³
->
Çme
,
key
);

334 ià(
f
 =ğ
NULL
) {

336 
m
->
ty³
->
’v
->
Ï¡”rÜ
 = "wmessage_message query keyƒrror";

337  
NULL
;

339 
pbc_v¬
 
v¬
;

340 
v¬
->
p
[0] = 
	`_wmes§ge_Ãw
(
m
->
h—p
, 
f
->
ty³_Çme
.m);

341 
v¬
->
p
[1] = 
f
;

342 
	`_pbcA_push
(
m
->
sub
 , 
v¬
);

343  (
pbc_wmes§ge
 *)
v¬
->
p
[0];

344 
	}
}

347 
	$_·ck_·cked_64
(
_·cked
 *
p
,
pbc_wmes§ge
 *
m
) {

348 
n
 = 
	`pbc_¬¿y_size
(
p
->
d©a
);

349 
Ën
 = 
n
 * 8;

350 
i
;

351 
pbc_v¬
 
v¬
;

352 
	`_ex·nd_mes§ge
(
m
,10 + 
Ën
);

353 
m
->
±r
 +ğ
	`_pbcV_’code32
(
Ën
, m->ptr);

354 
p
->
±y³
) {

355 
PTYPE_DOUBLE
:

356 
i
=0;i<
n
;i++) {

357 
	`_pbcA_šdex
(
p
->
d©a
, 
i
, 
v¬
);

358 
	`doubË_’code
(
v¬
->
»®
 , 
m
->
±r
 + 
i
 * 8);

362 
i
=0;i<
n
;i++) {

363 
	`_pbcA_šdex
(
p
->
d©a
, 
i
, 
v¬
);

364 
	`št64_’code
(
v¬
->
š‹g”
.
low
 , v¬->š‹g”.
hi
, 
m
->
±r
 + 
i
 * 8);

368 
m
->
±r
 +ğ
Ën
;

369 
	}
}

372 
	$_·ck_·cked_32
(
_·cked
 *
p
,
pbc_wmes§ge
 *
m
) {

373 
n
 = 
	`pbc_¬¿y_size
(
p
->
d©a
);

374 
Ën
 = 
n
 * 4;

375 
i
;

376 
pbc_v¬
 
v¬
;

377 
	`_ex·nd_mes§ge
(
m
,10 + 
Ën
);

378 
m
->
±r
 +ğ
	`_pbcV_’code32
(
Ën
, m->ptr);

379 
p
->
±y³
) {

380 
PTYPE_FLOAT
:

381 
i
=0;i<
n
;i++) {

382 
	`_pbcA_šdex
(
p
->
d©a
, 
i
, 
v¬
);

383 
	`æßt_’code
(
v¬
->
»®
 , 
m
->
±r
 + 
i
 * 8);

387 
i
=0;i<
n
;i++) {

388 
	`_pbcA_šdex
(
p
->
d©a
, 
i
, 
v¬
);

389 
	`št32_’code
(
v¬
->
š‹g”
.
low
 , 
m
->
±r
 + 
i
 * 8);

393 
m
->
±r
 +ğ
Ën
;

394 
	}
}

397 
	$_·ck_·cked_v¬št
(
_·cked
 *
p
,
pbc_wmes§ge
 *
m
) {

398 
n
 = 
	`pbc_¬¿y_size
(
p
->
d©a
);

400 
off£t
 = 
m
->
±r
 - m->
bufãr
;

401 
Ën
 = 
n
 * 2;

402 ià(
p
->
±y³
 =ğ
PTYPE_BOOL
) {

403 
Ën
 = 
n
;

405 
i
;

406 
pbc_v¬
 
v¬
;

407 
	`_ex·nd_mes§ge
(
m
,10 + 
Ën
);

408 
Ën_Ën
 = 
	`_pbcV_’code32
(
Ën
, 
m
->
±r
);

409 
m
->
±r
 +ğ
Ën_Ën
;

411 
p
->
±y³
) {

412 
PTYPE_INT64
:

413 
PTYPE_UINT64
:

414 
i
=0;i<
n
;i++) {

415 
	`_pbcA_šdex
(
p
->
d©a
, 
i
, 
v¬
);

416 
	`_ex·nd_mes§ge
(
m
,10);

417 
m
->
±r
 +ğ
	`_pbcV_’code
((
ušt64_t
)
v¬
->
š‹g”
.
low
 | (ušt64_t)v¬->š‹g”.
hi
 << 32 , m->ptr);

420 
PTYPE_INT32
:

421 
PTYPE_BOOL
:

422 
PTYPE_UINT32
:

423 
PTYPE_ENUM
:

424 
i
=0;i<
n
;i++) {

425 
	`_pbcA_šdex
(
p
->
d©a
, 
i
, 
v¬
);

426 
	`_ex·nd_mes§ge
(
m
,10);

427 
m
->
±r
 +ğ
	`_pbcV_’code32
(
v¬
->
š‹g”
.
low
 , m->ptr);

430 
PTYPE_SINT32
:

431 
i
=0;i<
n
;i++) {

432 
	`_pbcA_šdex
(
p
->
d©a
, 
i
, 
v¬
);

433 
	`_ex·nd_mes§ge
(
m
,10);

434 
m
->
±r
 +ğ
	`_pbcV_zigzag32
(
v¬
->
š‹g”
.
low
, m->ptr);

437 
PTYPE_SINT64
:

438 
i
=0;i<
n
;i++) {

439 
	`_pbcA_šdex
(
p
->
d©a
, 
i
, 
v¬
);

440 
	`_ex·nd_mes§ge
(
m
,10);

441 
m
->
±r
 +ğ
	`_pbcV_zigzag
((
ušt64_t
)
v¬
->
š‹g”
.
low
 | (ušt64_t)v¬->š‹g”.
hi
 << 32 , m->ptr);

446 
	`mem£t
(
m
->
±r
 , 0 , 
n
);

447 
m
->
±r
 +ğ
n
;

448 
m
->
ty³
->
’v
->
Ï¡”rÜ
 = "wmessageypeƒrror when…ack…acked";

451 
’d_off£t
 = 
m
->
±r
 - m->
bufãr
;

452 
’d_Ën
 = 
’d_off£t
 - (
off£t
 + 
Ën_Ën
);

453 ià(
’d_Ën
 !ğ
Ën
) {

454 
ušt8_t
 
‹mp
[10];

455 
’d_Ën_Ën
 = 
	`_pbcV_’code32
(
’d_Ën
, 
‹mp
);

456 ià(
’d_Ën_Ën
 !ğ
Ën_Ën
) {

457 
	`_ex·nd_mes§ge
(
m
, 
’d_Ën_Ën
);

458 
	`memmove
(
m
->
bufãr
 + 
off£t
 + 
’d_Ën_Ën
 ,

459 
m
->
bufãr
 + 
off£t
 + 
Ën_Ën
 ,

460 
’d_Ën
);

461 
m
->
±r
 +ğ
’d_Ën_Ën
 - 
Ën_Ën
;

463 
	`memıy
(
m
->
bufãr
 + 
off£t
 , 
‹mp
, 
’d_Ën_Ën
);

465 
	}
}

468 
	$_·ck_·cked
(*
p
, *
ud
) {

469 
_·cked
 *
·cked
 = (_·cked *)
p
;

470 
pbc_wmes§ge
 * 
m
 = (pbc_wmes§g*)
ud
;

471 
id
 = 
·cked
->id << 3 | 
WT_LEND
;

472 
	`_ex·nd_mes§ge
(
m
,10);

473 
m
->
±r
 +ğ
	`_pbcV_’code32
(
id
, m->ptr);

474 
·cked
->
±y³
) {

475 
PTYPE_DOUBLE
:

476 
PTYPE_FIXED64
:

477 
PTYPE_SFIXED64
:

478 
	`_·ck_·cked_64
(
·cked
,
m
);

480 
PTYPE_FLOAT
:

481 
PTYPE_FIXED32
:

482 
PTYPE_SFIXED32
:

483 
	`_·ck_·cked_32
(
·cked
,
m
);

486 
	`_·ck_·cked_v¬št
(
·cked
,
m
);

489 
	}
}

492 
	$pbc_wmes§ge_bufãr
(
pbc_wmes§ge
 *
m
, 
pbc_¦iû
 *
¦iû
) {

493 ià(
m
->
·cked
) {

494 
	`_pbcM_¥_fÜ—ch_ud
(
m
->
·cked
 , 
_·ck_·cked
, m);

496 
i
;

497 
n
 = 
	`pbc_¬¿y_size
(
m
->
sub
);

498 
i
=0;i<
n
;i++) {

499 
pbc_v¬
 
v¬
;

500 
	`_pbcA_šdex
(
m
->
sub
, 
i
 , 
v¬
);

501 
pbc_¦iû
 
s
;

502 
	`pbc_wmes§ge_bufãr
((
pbc_wmes§ge
 *)
v¬
->
p
[0] , &
s
);

503 ià(
s
.
bufãr
) {

504 
_f›ld
 * 
f
 = (_f›ld *)
v¬
->
p
[1];

505 
id
 = 
f
->id << 3 | 
WT_LEND
;

506 
	`_ex·nd_mes§ge
(
m
,20+
s
.
Ën
);

507 
m
->
±r
 +ğ
	`_pbcV_’code32
(
id
, m->ptr);

508 
m
->
±r
 +ğ
	`_pbcV_’code32
(
s
.
Ën
, m->ptr);

509 
	`memıy
(
m
->
±r
, 
s
.
bufãr
, s.
Ën
);

510 
m
->
±r
 +ğ
s
.
Ën
;

513 
¦iû
->
bufãr
 = 
m
->buffer;

514 
¦iû
->
Ën
 = 
m
->
±r
 - m->
bufãr
;

516  
m
->
bufãr
;

517 
	}
}

	@test/addressbook.c

1 
	~"pbc.h
"

3 
	~<¡dlib.h
>

4 
	~<¡dio.h
>

5 
	~<¡dšt.h
>

6 
	~<¡ddef.h
>

8 
	~"»adfe.h
"

11 
	$dump
(
ušt8_t
 *
bufãr
, 
sz
) {

12 
i
 , 
j
;

13 
i
=0;i<
sz
;i++) {

14 
	`´štf
("%02X ",
bufãr
[
i
]);

15 ià(
i
 % 16 == 15) {

16 
j
 = 0 ;j <16 ;j++) {

17 
c
 = 
bufãr
[
i
/16 * 16+
j
];

18 ià(
c
>=32 && c<127) {

19 
	`´štf
("%c",
c
);

21 
	`´štf
(".");

24 
	`´štf
("\n");

28 
	`´štf
("\n");

29 
	}
}

32 
	$‹¡_rmes§ge
(
pbc_’v
 *
’v
, 
pbc_¦iû
 *
¦iû
) {

33 
pbc_rmes§ge
 * 
m
 = 
	`pbc_rmes§ge_Ãw
(
’v
, "tutÜŸl.P”sÚ", 
¦iû
);

34 ià(
m
==
NULL
) {

35 
	`´štf
("E¼Ü : %s",
	`pbc_”rÜ
(
’v
));

38 
	`´štf
("Çmğ%s\n", 
	`pbc_rmes§ge_¡ršg
(
m
 , "Çme" , 0 , 
NULL
));

39 
	`´štf
("id = %d\n", 
	`pbc_rmes§ge_š‹g”
(
m
 , "id" , 0 , 
NULL
));

40 
	`´štf
("ema = %s\n", 
	`pbc_rmes§ge_¡ršg
(
m
 , "ema" , 0 , 
NULL
));

42 
phÚe_n
 = 
	`pbc_rmes§ge_size
(
m
, "phone");

43 
i
;

44 cÚ¡ * 
f›ld_Çme
;

45 
	`pbc_ty³
(
’v
, "tutÜŸl.P”sÚ", "phÚe", &
f›ld_Çme
);

46 
	`´štf
("phÚty³ [%s]\n",
f›ld_Çme
);

48 
i
=0;i<
phÚe_n
;i++) {

49 
pbc_rmes§ge
 * 
p
 = 
	`pbc_rmes§ge_mes§ge
(
m
 , "phÚe", 
i
);

50 
	`´štf
("\Šumb”[%d] = %s\n",
i
,
	`pbc_rmes§ge_¡ršg
(
p
 , "numb”", i ,
NULL
));

51 
	`´štf
("\‰y³[%d] = %s\n",
i
,
	`pbc_rmes§ge_¡ršg
(
p
, "ty³", i, 
NULL
));

54 
n
 = 
	`pbc_rmes§ge_size
(
m
 , "test");

56 
i
=0;i<
n
;i++) {

57 
	`´štf
("‹¡[%d] = %d\n",
i
, 
	`pbc_rmes§ge_š‹g”
(
m
 , "‹¡" , i , 
NULL
));

60 
	`´štf
("tutÜŸl.Ext.‹¡ = %d\n", 
	`pbc_rmes§ge_š‹g”
(
m
,"tutÜŸl.Ext.‹¡",0,
NULL
));

61 
	`pbc_rmes§ge_d–‘e
(
m
);

62 
	}
}

64 
pbc_wmes§ge
 *

65 
	$‹¡_wmes§ge
(
pbc_’v
 * 
’v
)

67 
pbc_wmes§ge
 * 
msg
 = 
	`pbc_wmes§ge_Ãw
(
’v
, "tutorial.Person");

69 
	`pbc_wmes§ge_¡ršg
(
msg
, "name", "Alice", -1);

70 
	`pbc_wmes§ge_š‹g”
(
msg
, "id" , 12345, 0);

71 
	`pbc_wmes§ge_¡ršg
(
msg
, "email", "alice@unkown", -1);

73 
pbc_wmes§ge
 * 
phÚe
 = 
	`pbc_wmes§ge_mes§ge
(
msg
 , "phone");

74 
	`pbc_wmes§ge_¡ršg
(
phÚe
 , "number", "87654321" , -1);

76 
phÚe
 = 
	`pbc_wmes§ge_mes§ge
(
msg
 , "phone");

77 
	`pbc_wmes§ge_¡ršg
(
phÚe
 , "number", "13901234567" , -1);

78 
	`pbc_wmes§ge_¡ršg
(
phÚe
 , "type" , "MOBILE" , -1);

80 
	`pbc_wmes§ge_š‹g”
(
msg
, "test", -123,0);

81 
	`pbc_wmes§ge_š‹g”
(
msg
, "test", 12345,0);

82 
	`pbc_wmes§ge_š‹g”
(
msg
, "test", 1234567,0);

84 
	`pbc_wmes§ge_š‹g”
(
msg
, "tutorial.Ext.test", 54321 , 0);

86  
msg
;

87 
	}
}

90 
	$maš
()

92 
pbc_¦iû
 
¦iû
;

93 
	`»ad_fe
("add»ssbook.pb", &
¦iû
);

94 ià(
¦iû
.
bufãr
 =ğ
NULL
)

96 
pbc_’v
 * 
’v
 = 
	`pbc_Ãw
();

97 
r
 = 
	`pbc_»gi¡”
(
’v
, &
¦iû
);

98 ià(
r
) {

99 
	`´štf
("E¼Ü : %s", 
	`pbc_”rÜ
(
’v
));

103 
	`ä“
(
¦iû
.
bufãr
);

105 
pbc_wmes§ge
 *
msg
 = 
	`‹¡_wmes§ge
(
’v
);

107 
	`pbc_wmes§ge_bufãr
(
msg
, &
¦iû
);

109 
	`dump
(
¦iû
.
bufãr
, sliû.
Ën
);

111 
	`‹¡_rmes§ge
(
’v
, &
¦iû
);

113 
	`pbc_wmes§ge_d–‘e
(
msg
);

114 
	`pbc_d–‘e
(
’v
);

117 
	}
}

	@test/array.c

1 
	~"pbc.h
"

2 
	~"®loc.h
"

3 
	~"¬¿y.h
"

5 
	~<¡dio.h
>

8 
	$maš
()

10 
pbc_¬¿y
 
¬¿y
;

11 
pbc_v¬
 
v
;

13 
	`_pbcA_İ’
(
¬¿y
);

15 
i
 ;

17 
i
=0;i<100;i++) {

18 
v
->
»®
 = ()
i
;

19 
	`´štf
("push %d\n",
i
);

20 
	`_pbcA_push
(
¬¿y
, 
v
);

23 
s
 = 
	`pbc_¬¿y_size
(
¬¿y
);

25 
i
=0;i<
s
;i++) {

26 
	`_pbcA_šdex
(
¬¿y
, 
i
 , 
v
);

27 
	`´štf
("%lf\n",
v
->
»®
);

30 
	`_pbcA_şo£
(
¬¿y
);

33 
	}
}

	@test/decode.c

1 
	~"pbc.h
"

3 
	~<¡dlib.h
>

4 
	~<¡dio.h
>

5 
	~<¡ršg.h
>

7 
	~"»adfe.h
"

10 
	$decode_®l
(*
ud
 , 
ty³
, cÚ¡ * 
ty³Çme
 , 
pbc_v®ue
 *
v
, 
id
, cÚ¡ *
key
) {

11 
	`´štf
("% : ", 
key
 ) ;

12 
ty³
 & ~
PBC_REPEATED
) {

13 
PBC_MESSAGE
:

14 
	`´štf
("[%s] -> \n" , 
ty³Çme
);

15 
	`pbc_decode
(
ud
, 
ty³Çme
, &(
v
->
s
), 
decode_®l
, ud);

16 
	`´štf
("---------\n");

18 
PBC_INT
:

19 
	`´štf
("%d\n", ()
v
->
i
.
low
);

21 
PBC_REAL
:

22 
	`´štf
("%lf\n", 
v
->
f
);

24 
PBC_BOOL
:

25 
	`´štf
("<%s>\n", 
v
->
i
.
low
 ? "true" : "false");

27 
PBC_ENUM
:

28 
	`´štf
("[%s:%d]\n", 
v
->
e
.
Çme
 , v->e.
id
);

30 
PBC_STRING
: {

31 
bufãr
[
v
->
s
.
Ën
+1];

32 
	`memıy
(
bufãr
, 
v
->
s
.bufãr, v->s.
Ën
);

33 
bufãr
[
v
->
s
.
Ën
] = '\0';

34 
	`´štf
("\"%s\"\n", 
bufãr
);

37 
PBC_BYTES
: {

38 
i
;

39 
ušt8_t
 *
bufãr
 = 
v
->
s
.buffer;

40 
i
=0;i<
v
->
s
.
Ën
;i++) {

41 
	`´štf
("%02X ",
bufãr
[
i
]);

43 
	`´štf
("\n");

46 
PBC_INT64
: {

47 
	`´štf
("0x%x%08x\n",
v
->
i
.
hi
, v->i.
low
);

50 
PBC_UINT
:

51 
	`´štf
("%u\n",
v
->
i
.
low
);

54 
	`´štf
("!!! %d\n", 
ty³
);

57 
	}
}

60 
	$‹¡_decode
(
pbc_’v
 * 
’v
 , cÚ¡ * 
pb
)

62 
pbc_¦iû
 
¦iû
;

63 
	`»ad_fe
(
pb
, &
¦iû
);

65 
	`pbc_decode
(
’v
, "googË.´Ùobuf.FeDesütÜS‘", &
¦iû
, 
decode_®l
 ,ƒnv);

67 
»t
 = 
	`pbc_»gi¡”
(
’v
, &
¦iû
);

69 
	`´štf
("Regi¡” %d\n",
»t
);

71 
	`ä“
(
¦iû
.
bufãr
);

72 
	}
}

75 
	$maš
(
¬gc
, *
¬gv
[])

77 
pbc_’v
 * 
’v
 = 
	`pbc_Ãw
();

79 
	`‹¡_decode
(
’v
,
¬gv
[1]);

81 
	`pbc_d–‘e
(
’v
);

85 
	}
}

	@test/float.c

1 
	~"pbc.h
"

3 
	~<¡dlib.h
>

4 
	~<¡dio.h
>

5 
	~<¡dšt.h
>

6 
	~<¡ddef.h
>

8 
	~"»adfe.h
"

11 
	$dump
(
ušt8_t
 *
bufãr
, 
sz
) {

12 
i
 , 
j
;

13 
i
=0;i<
sz
;i++) {

14 
	`´štf
("%02X ",
bufãr
[
i
]);

15 ià(
i
 % 16 == 15) {

16 
j
 = 0 ;j <16 ;j++) {

17 
c
 = 
bufãr
[
i
/16 * 16+
j
];

18 ià(
c
>=32 && c<127) {

19 
	`´štf
("%c",
c
);

21 
	`´štf
(".");

24 
	`´štf
("\n");

28 
	`´štf
("\n");

29 
	}
}

32 
	$‹¡_rmes§ge
(
pbc_’v
 *
’v
, 
pbc_¦iû
 *
¦iû
) {

33 
pbc_rmes§ge
 * 
m
 = 
	`pbc_rmes§ge_Ãw
(
’v
, "»®", 
¦iû
);

34 
	`´štf
("àğ%f\n", 
	`pbc_rmes§ge_»®
(
m
 , "f" , 0 ));

35 
	`´štf
("d = %f\n", 
	`pbc_rmes§ge_»®
(
m
 , "d" , 0 ));

36 
	`pbc_rmes§ge_d–‘e
(
m
);

37 
	}
}

39 
pbc_wmes§ge
 *

40 
	$‹¡_wmes§ge
(
pbc_’v
 * 
’v
)

42 
pbc_wmes§ge
 * 
msg
 = 
	`pbc_wmes§ge_Ãw
(
’v
, "real");

44 
	`pbc_wmes§ge_»®
(
msg
, "f", 1.0);

45 
	`pbc_wmes§ge_»®
(
msg
, "d" , 4.0);

47  
msg
;

48 
	}
}

51 
	$maš
()

53 
pbc_¦iû
 
¦iû
;

54 
	`»ad_fe
("æßt.pb", &
¦iû
);

55 ià(
¦iû
.
bufãr
 =ğ
NULL
)

57 
pbc_’v
 * 
’v
 = 
	`pbc_Ãw
();

58 
	`pbc_»gi¡”
(
’v
, &
¦iû
);

60 
	`ä“
(
¦iû
.
bufãr
);

62 
pbc_wmes§ge
 *
msg
 = 
	`‹¡_wmes§ge
(
’v
);

64 
	`pbc_wmes§ge_bufãr
(
msg
, &
¦iû
);

66 
	`dump
(
¦iû
.
bufãr
, sliû.
Ën
);

68 
	`‹¡_rmes§ge
(
’v
, &
¦iû
);

70 
	`pbc_wmes§ge_d–‘e
(
msg
);

71 
	`pbc_d–‘e
(
’v
);

74 
	}
}

	@test/map.c

1 
	~"¤c/m­.h
"

3 
	~<¡dio.h
>

4 
	~<¡ddef.h
>

7 
	$maš
()

9 
m­_kv
 
kv
[] = {

15 
m­_
 * 
m­
 = 
	`_pbcM__Ãw
(
kv
, (kv)/(kv[0]));

16 
m­_si
 * 
m­2
 = 
	`_pbcM_si_Ãw
(
kv
, (kv)/(kv[0]));

17 
i
;

19 
i
=0;i<100;i++) {

20 *
p
ğ
	`_pbcM__qu”y
(
m­
,
i
);

21 ià(
p
) {

22 
id
 = 0;

23 
	`_pbcM_si_qu”y
(
m­2
,
p
,&
id
);

24 
	`´štf
("%d %s\n",
id
,(cÚ¡ *)
p
);

28 
m­_¥
 * 
m­3
 = 
	`_pbcM_¥_Ãw
(0, 
NULL
);

29 
	`_pbcM_¥_š£¹
(
m­3
,"Alice","alice");

30 
	`_pbcM_¥_š£¹
(
m­3
,"Bob","bob");

32 ** 
r
 = 
	`_pbcM_¥_qu”y_š£¹
(
m­3
, "Carol");

33 *
r
 = "carol";

35 
r
 = 
	`_pbcM_¥_qu”y_š£¹
(
m­3
, "Alice");

36 *
r
 = "not‡lice";

38 
	`´štf
("%s\n",(cÚ¡ *)
	`_pbcM_¥_qu”y
(
m­3
,"Alice"));

39 
	`´štf
("%s\n",(cÚ¡ *)
	`_pbcM_¥_qu”y
(
m­3
,"Bob"));

40 
	`´štf
("%s\n",(cÚ¡ *)
	`_pbcM_¥_qu”y
(
m­3
,"Carol"));

42 cÚ¡ * 
key
 = 
NULL
;

44 * 
v
 = 
	`_pbcM_¥_Ãxt
(
m­3
, &
key
);

45 ià(
key
 =ğ
NULL
)

47 
	`´štf
("% : %s\n", 
key
, (cÚ¡ *)
v
);

51 
	}
}

	@test/pattern.c

1 
	~"pbc.h
"

3 
	~<¡dlib.h
>

4 
	~<¡dio.h
>

5 
	~<¡dšt.h
>

6 
	~<¡ddef.h
>

8 
	~"»adfe.h
"

11 
	$dump
(
ušt8_t
 *
bufãr
, 
sz
) {

12 
i
 , 
j
;

13 
i
=0;i<
sz
;i++) {

14 
	`´štf
("%02X ",
bufãr
[
i
]);

15 ià(
i
 % 16 == 15) {

16 
j
 = 0 ;j <16 ;j++) {

17 
c
 = 
bufãr
[
i
/16 * 16+
j
];

18 ià(
c
>=32 && c<127) {

19 
	`´štf
("%c",
c
);

21 
	`´štf
(".");

24 
	`´štf
("\n");

28 
	`´štf
("\n");

29 
	}
}

31 
pbc_·‰”n
 *
	g·t
;

32 
pbc_·‰”n
 *
	g·t_phÚe
;

34 
	s³rsÚ_phÚe
 {

35 
pbc_¦iû
 
	mnumb”
;

36 
št32_t
 
	mty³
;

39 
	s³rsÚ
 {

40 
pbc_¦iû
 
	mÇme
;

41 
št32_t
 
	mid
;

42 
pbc_¦iû
 
	mema
;

43 
pbc_¬¿y
 
	mphÚe
;

44 
pbc_¬¿y
 
	m‹¡
;

49 
	$‹¡_·‰”n_uÅack
(
pbc_’v
 *
’v
, 
pbc_¦iû
 * 
¦iû
) {

50 
³rsÚ
 
p
;

51 
r
 = 
	`pbc_·‰”n_uÅack
(
·t
, 
¦iû
, &
p
);

52 ià(
r
>=0) {

53 
	`´štf
("Çmğ%s\n",(cÚ¡ *)
p
.
Çme
.
bufãr
);

54 
	`´štf
("id = %d\n",
p
.
id
);

55 
	`´štf
("ema = %s\n",(cÚ¡ *)
p
.
ema
.
bufãr
);

56 
n
 = 
	`pbc_¬¿y_size
(
p
.
phÚe
);

57 
i
;

58 
i
=0;i<
n
;i++) {

59 
pbc_¦iû
 * 
by‹s
 = 
	`pbc_¬¿y_¦iû
(
p
.
phÚe
, 
i
);

60 
³rsÚ_phÚe
 
µ
;

61 
	`pbc_·‰”n_uÅack
(
·t_phÚe
 , 
by‹s
 , &
µ
);

62 
	`´štf
("\Šumb” = %s\n" , (cÚ¡ *)
µ
.
numb”
.
bufãr
);

63 
	`´štf
("\‰y³ = %d\n" , 
µ
.
ty³
);

66 
n
 = 
	`pbc_¬¿y_size
(
p
.
‹¡
);

67 
i
=0;i<
n
;i++) {

68 
	`´štf
("‹¡[%d] = %d\n",
i
, 
	`pbc_¬¿y_š‹g”
(
p
.
‹¡
, i , 
NULL
));

71 
	`pbc_·‰”n_şo£_¬¿ys
(
·t
,&
p
);

73 
	}
}

76 
	$‹¡_·‰”n_·ck
(
pbc_’v
 *
’v
 , 
pbc_¦iû
 *
¦iû
) {

77 
³rsÚ
 
p
;

82 
	`pbc_·‰”n_£t_deçuÉ
(
·t
, &
p
);

84 
p
.
Çme
.
bufãr
 = (*)"Alice";

85 
p
.
Çme
.
Ën
 = -1;

86 
p
.
id
 = 1234;

87 
p
.
ema
.
bufãr
 = (*)"alice@unknown";

88 
p
.
ema
.
Ën
 = -1;

90 
³rsÚ_phÚe
 
phÚe
;

91 
phÚe
.
numb”
.
bufãr
 = (*)"1234567";

92 
phÚe
.
numb”
.
Ën
 = -1;

93 
phÚe
.
ty³
 = 1;

95 
‹mp
[128];

96 
pbc_¦iû
 
phÚe_¦iû
 = { 
‹mp
, (temp) };

98 
unu£d
 = 
	`pbc_·‰”n_·ck
(
·t_phÚe
, &
phÚe
 , &
phÚe_¦iû
);

100 ià(
unu£d
 < 0) {

101 
¦iû
->
Ën
 = 0;

102  
¦iû
->
Ën
;

105 
	`pbc_¬¿y_push_¦iû
(
p
.
phÚe
, &
phÚe_¦iû
);

107 
	`pbc_·‰”n_£t_deçuÉ
(
·t_phÚe
, &
phÚe
);

109 
phÚe
.
numb”
.
bufãr
 = (*)"87654321";

110 
phÚe
.
numb”
.
Ën
 = -1;

112 
‹mp2
[128];

113 
pbc_¦iû
 
phÚe_¦iû2
 = { 
‹mp2
, (temp2) };

115 
unu£d
 = 
	`pbc_·‰”n_·ck
(
·t_phÚe
, &
phÚe
 , &
phÚe_¦iû2
);

117 ià(
unu£d
 < 0) {

118 
¦iû
->
Ën
 = 0;

119  
¦iû
->
Ën
;

122 
	`pbc_¬¿y_push_¦iû
(
p
.
phÚe
, &
phÚe_¦iû2
);

124 
i
;

125 
i
=0;i<3;i++) {

126 
	`pbc_¬¿y_push_š‹g”
(
p
.
‹¡
, -
i
*4,0);

129 
r
 = 
	`pbc_·‰”n_·ck
(
·t
, &
p
, 
¦iû
);

131 
	`pbc_·‰”n_şo£_¬¿ys
(
·t
,&
p
);

132 
	`´štf
("·ck iÁØ%d by‹s\n", 
¦iû
->
Ën
);

134  
r
;

135 
	}
}

138 
	$maš
()

140 
pbc_¦iû
 
¦iû
;

141 
	`»ad_fe
("add»ssbook.pb", &
¦iû
);

142 ià(
¦iû
.
bufãr
 =ğ
NULL
)

144 
pbc_’v
 * 
’v
 = 
	`pbc_Ãw
();

145 
	`pbc_»gi¡”
(
’v
, &
¦iû
);

147 
	`ä“
(
¦iû
.
bufãr
);

149 
·t
 = 
	`pbc_·‰”n_Ãw
(
’v
, "tutorial.Person" ,

151 
	`off£tof
(
³rsÚ
, 
Çme
) ,

152 
	`off£tof
(
³rsÚ
, 
id
) ,

153 
	`off£tof
(
³rsÚ
, 
ema
) ,

154 
	`off£tof
(
³rsÚ
, 
phÚe
) ,

155 
	`off£tof
(
³rsÚ
, 
‹¡
));

157 
·t_phÚe
 = 
	`pbc_·‰”n_Ãw
(
’v
, "tutorial.Person.PhoneNumber",

159 
	`off£tof
(
³rsÚ_phÚe
, 
numb”
),

160 
	`off£tof
(
³rsÚ_phÚe
, 
ty³
));

163 
bufãr
[4096];

164 
pbc_¦iû
 
mes§ge
 = { 
bufãr
, (buffer) };

166 
	`‹¡_·‰”n_·ck
(
’v
, &
mes§ge
);

168 
	`dump
(
mes§ge
.
bufãr
, mes§ge.
Ën
);

170 
	`‹¡_·‰”n_uÅack
(
’v
, &
mes§ge
);

172 
	`pbc_·‰”n_d–‘e
(
·t
);

173 
	`pbc_·‰”n_d–‘e
(
·t_phÚe
);

175 
	`pbc_d–‘e
(
’v
);

178 
	}
}

	@test/pbc.c

1 
	~"pbc.h
"

3 
	~<¡dlib.h
>

4 
	~<¡dio.h
>

6 
	~"»adfe.h
"

9 
	$‹¡_des
(
pbc_’v
 * 
’v
 , cÚ¡ * 
pb
)

11 
pbc_¦iû
 
¦iû
;

12 
	`»ad_fe
(
pb
, &
¦iû
);

14 
pbc_rmes§ge
 * 
msg
 = 
	`pbc_rmes§ge_Ãw
(
’v
, "googË.´Ùobuf.FeDesütÜS‘", &
¦iû
);

16 
pbc_rmes§ge
 * 
fe
 = 
	`pbc_rmes§ge_mes§ge
(
msg
,"file",0);

18 
	`´štf
("Çmğ%s\n",
	`pbc_rmes§ge_¡ršg
(
fe
, "Çme", 0 , 
NULL
));

19 
	`´štf
("·ckagğ%s\n",
	`pbc_rmes§ge_¡ršg
(
fe
, "·ckage", 0 , 
NULL
));

21 
sz
 = 
	`pbc_rmes§ge_size
(
fe
, "dependency");

22 
	`´štf
("d•’d’cy[%d] =\n" , 
sz
);

23 
i
;

24 
i
=0;i<
sz
;i++) {

25 
	`´štf
("\t%s\n",
	`pbc_rmes§ge_¡ršg
(
fe
, "d•’d’cy", 
i
 , 
NULL
));

27 
sz
 = 
	`pbc_rmes§ge_size
(
fe
, "message_type");

28 
	`´štf
("mes§ge_ty³[%d] = \n",
sz
);

29 
i
=0;i<
sz
;i++) {

30 
pbc_rmes§ge
 * 
mes§ge_ty³
 = 
	`pbc_rmes§ge_mes§ge
(
fe
,"mes§ge_ty³",
i
);

31 
	`´štf
("\Šamğ%s\n",
	`pbc_rmes§ge_¡ršg
(
mes§ge_ty³
,"Çme",0,
NULL
));

35 
	`pbc_rmes§ge_d–‘e
(
msg
);

37 
»t
 = 
	`pbc_»gi¡”
(
’v
, &
¦iû
);

39 
	`´štf
("Regi¡” %d\n",
»t
);

41 
	`ä“
(
¦iû
.
bufãr
);

42 
	}
}

45 
	$maš
(
¬gc
, *
¬gv
[])

47 
pbc_’v
 * 
’v
 = 
	`pbc_Ãw
();

49 
	`‹¡_des
(
’v
,
¬gv
[1]);

51 
	`pbc_d–‘e
(
’v
);

55 
	}
}

	@test/readfile.h

1 #iâdeà
»adfe_h


2 
	#»adfe_h


	)

4 
	~<¡dio.h
>

5 
	~<¡dlib.h
>

8 
	$»ad_fe
 (cÚ¡ *
f’ame
 , 
pbc_¦iû
 *
¦iû
) {

9 
FILE
 *
f
 = 
	`fİ’
(
f’ame
, "rb");

10 ià(
f
 =ğ
NULL
) {

11 
¦iû
->
bufãr
 = 
NULL
;

12 
¦iû
->
Ën
 = 0;

15 
	`f£ek
(
f
,0,
SEEK_END
);

16 
¦iû
->
Ën
 = 
	`á–l
(
f
);

17 
	`f£ek
(
f
,0,
SEEK_SET
);

18 
¦iû
->
bufãr
 = 
	`m®loc
(¦iû->
Ën
);

19 ià(
	`ä—d
(
¦iû
->
bufãr
, 1 , sliû->
Ën
 , 
f
) == 0)

20 
	`ex™
(1);

21 
	`fşo£
(
f
);

22 
	}
}

	@test/test.c

1 
	~"pbc.h
"

3 
	~<¡dlib.h
>

4 
	~<¡dio.h
>

5 
	~<as£¹.h
>

7 
	#COUNT
 1000000

	)

9 
	~"»adfe.h
"

12 
	$‹¡
(
pbc_’v
 *
’v
) {

13 
i
;

14 
i
=0; i<
COUNT
; i++)

16 
pbc_wmes§ge
* 
w_msg
 = 
	`pbc_wmes§ge_Ãw
(
’v
, "at");

17 
pbc_rmes§ge
* 
r_msg
 = 
NULL
;

18 
pbc_¦iû
 
¦
;

19 
bufãr
[1024];

20 
¦
.
bufãr
 = bufãr, sl.
Ën
 = 1024;

21 
	`pbc_wmes§ge_š‹g”
(
w_msg
, "aa", 123, 0);

22 
	`pbc_wmes§ge_š‹g”
(
w_msg
, "bb", 456, 0);

23 
	`pbc_wmes§ge_¡ršg
(
w_msg
, "cc", "test string!", -1);

24 
	`pbc_wmes§ge_bufãr
(
w_msg
, &
¦
);

26 
r_msg
 = 
	`pbc_rmes§ge_Ãw
(
’v
, "©", &
¦
);

27 
	`pbc_rmes§ge_d–‘e
(
r_msg
);

28 
	`pbc_wmes§ge_d–‘e
(
w_msg
);

30 
	}
}

33 
	$maš
() {

34 
pbc_’v
 * 
’v
 = 
	`pbc_Ãw
();

35 
pbc_¦iû
 
¦iû
;

36 
	`»ad_fe
("‹¡.pb", &
¦iû
);

37 
»t
 = 
	`pbc_»gi¡”
(
’v
, &
¦iû
);

38 
	`as£¹
(
»t
 == 0);

39 
	`‹¡
(
’v
);

40 
	`pbc_d–‘e
(
’v
);

43 
	}
}

	@test/varint.c

1 
	~<¡dio.h
>

3 
	~"v¬št.h
"

4 
	~"pbc.h
"

7 
	$dump
(
ušt8_t
 
bufãr
[10], 
s
)

9 
i
;

10 
i
=0;i<
s
;i++) {

11 
	`´štf
("%02X ",
bufãr
[
i
]);

13 
	`´štf
("\n");

14 
	}
}

17 
	$’code
(
ušt64_t
 
n
)

19 
ušt8_t
 
bufãr
[10];

20 
	`dump
(
bufãr
,
	`v¬št_’code
(
n
,buffer));

21 
	}
}

24 
	$decode
(
ušt8_t
 
bufãr
[10])

26 
lÚglÚg
 
r
;

27 
s
 = 
	`v¬št_decode
(
bufãr
,&
r
);

28 
	`´štf
("[%d] %x %x\n",
s
, 
r
.
low
,„.
hi
);

29 
	}
}

32 
	$zigzag
(
št64_t
 
n
)

34 
	`´štf
("%Îx\n",
n
);

35 
ušt8_t
 
zigzag
[10];

36 
	`dump
(
zigzag
, 
	`v¬št_zigzag
(
n
,zigzag));

38 
lÚglÚg
 
r
;

39 
	`v¬št_decode
(
zigzag
,&
r
);

40 
	`v¬št_dezigzag64
(&
r
);

42 
	`´štf
("%x%08x\n",
r
.
hi
,„.
low
);

43 
	}
}

46 
	$maš
()

48 
	`’code
(300);

49 
ušt8_t
 
bufãr
[10] = { 0xac, 0x2 };

50 
	`decode
(
bufãr
);

51 
	`’code
(0xfffffffffLL);

52 
ušt8_t
 
bufãr2
[10] = { 0xff, 0xff, 0xff, 0xff, 0xff, 0x1 };

53 
	`decode
(
bufãr2
);

55 
	`zigzag
(-0x1234567890LL);

58 
	}
}

	@tool/dump.c

1 
	~<¡dio.h
>

2 
	~<uni¡d.h
>

3 
	~<¡dlib.h
>

4 
	~<¡dšt.h
>

6 
	~"pbc.h
"

9 
	$»ad_fe
(cÚ¡ *
f’ame
 , 
pbc_¦iû
 *
¦iû
) {

10 
FILE
 *
f
 = 
	`fİ’
(
f’ame
, "rb");

11 ià(
f
 =ğ
NULL
) {

12 
	`årštf
(
¡d”r
, "Cª'ˆİ’ f%s\n", 
f’ame
);

13 
	`ex™
(1);

15 
	`f£ek
(
f
,0,
SEEK_END
);

16 
¦iû
->
Ën
 = 
	`á–l
(
f
);

17 
	`f£ek
(
f
,0,
SEEK_SET
);

18 
¦iû
->
bufãr
 = 
	`m®loc
(¦iû->
Ën
);

19 
	`ä—d
(
¦iû
->
bufãr
, 1 , sliû->
Ën
 , 
f
);

20 
	`fşo£
(
f
);

21 
	}
}

24 
	$dump_by‹s
(cÚ¡ *
d©a
, 
size_t
 
Ën
) {

25 
size_t
 
i
;

26 
i
 = 0; i < 
Ën
; i++)

27 ià(
i
 == 0)

28 
	`årštf
(
¡dout
, "%02x", 0xfà& 
d©a
[
i
]);

30 
	`årštf
(
¡dout
, " %02x", 0xfà& 
d©a
[
i
]);

31 
	}
}

33 
dump_mes§ge
(
pbc_rmes§ge
 *
m
, 
Ëv–
);

36 
	$dump_v®ue
(
pbc_rmes§ge
 *
m
, cÚ¡ *
key
, 
ty³
, 
idx
, 
Ëv–
) {

37 
i
;

38 
i
=0;i<
Ëv–
;i++) {

39 
	`´štf
(" ");

41 
	`´štf
("%s",
key
);

42 ià(
ty³
 & 
PBC_REPEATED
) {

43 
	`´štf
("[%d]",
idx
);

44 
ty³
 -ğ
PBC_REPEATED
;

46 
	`´štf
(": ");

48 
ušt32_t
 
low
;

49 
ušt32_t
 
hi
;

50 
»®
;

51 cÚ¡ *
¡r
;

52 
¡r_Ën
;

54 
ty³
) {

55 
PBC_INT
:

56 
low
 = 
	`pbc_rmes§ge_š‹g”
(
m
, 
key
, 
idx
, 
NULL
);

57 
	`´štf
("%d", (è
low
);

59 
PBC_REAL
:

60 
»®
 = 
	`pbc_rmes§ge_»®
(
m
, 
key
 , 
idx
);

61 
	`´štf
("%lf", 
»®
);

63 
PBC_BOOL
:

64 
low
 = 
	`pbc_rmes§ge_š‹g”
(
m
, 
key
, 
idx
, 
NULL
);

65 
	`´štf
("%s", 
low
 ? "true" : "false");

67 
PBC_ENUM
:

68 
¡r
 = 
	`pbc_rmes§ge_¡ršg
(
m
, 
key
 , 
idx
 , 
NULL
);

69 
	`´štf
("[%s]", 
¡r
);

71 
PBC_STRING
:

72 
¡r
 = 
	`pbc_rmes§ge_¡ršg
(
m
, 
key
 , 
idx
 , 
NULL
);

73 
	`´štf
("'%s'", 
¡r
);

75 
PBC_MESSAGE
:

76 
	`´štf
("\n");

77 
	`dump_mes§ge
(
	`pbc_rmes§ge_mes§ge
(
m
, 
key
, 
idx
),
Ëv–
+1);

79 
PBC_FIXED64
:

80 
low
 = 
	`pbc_rmes§ge_š‹g”
(
m
, 
key
, 
idx
, &
hi
);

81 
	`´štf
("0x%8x%8x",
hi
,
low
);

83 
PBC_FIXED32
:

84 
low
 = 
	`pbc_rmes§ge_š‹g”
(
m
, 
key
, 
idx
, 
NULL
);

85 
	`´štf
("0x%x",
low
);

87 
PBC_BYTES
:

88 
¡r
 = 
	`pbc_rmes§ge_¡ršg
(
m
, 
key
, 
idx
, &
¡r_Ën
);

89 
	`dump_by‹s
(
¡r
, 
¡r_Ën
);

92 
	`´štf
("unknown");

96 
	`´štf
("\n");

97 
	}
}

100 
	$dump_mes§ge
(
pbc_rmes§ge
 *
m
, 
Ëv–
) {

101 
t
 = 0;

102 cÚ¡ *
key
 = 
NULL
;

104 
t
 = 
	`pbc_rmes§ge_Ãxt
(
m
, &
key
);

105 ià(
key
 =ğ
NULL
)

107 ià(
t
 & 
PBC_REPEATED
) {

108 
n
 = 
	`pbc_rmes§ge_size
(
m
, 
key
);

109 
i
;

110 
i
=0;i<
n
;i++) {

111 
	`dump_v®ue
(
m
, 
key
 , 
t
 , 
i
 , 
Ëv–
);

114 
	`dump_v®ue
(
m
, 
key
 , 
t
 , 0 , 
Ëv–
);

117 
	}
}

120 
	$dump
(cÚ¡ *
´Ùo
, cÚ¡ * 
mes§ge
, 
pbc_¦iû
 *
d©a
) {

121 
pbc_’v
 * 
’v
 = 
	`pbc_Ãw
();

122 
pbc_¦iû
 
pb
;

123 
	`»ad_fe
(
´Ùo
, &
pb
);

124 
r
 = 
	`pbc_»gi¡”
(
’v
, &
pb
);

125 ià(
r
!=0) {

126 
	`årštf
(
¡d”r
, "Cª'ˆ»gi¡” %s\n", 
´Ùo
);

127 
	`ex™
(1);

129 
pbc_rmes§ge
 * 
m
 = 
	`pbc_rmes§ge_Ãw
(
’v
 , 
mes§ge
 , 
d©a
);

130 ià(
m
 =ğ
NULL
) {

131 
	`årštf
(
¡d”r
, "Decodšg mes§g'%s' faed\n",
mes§ge
);

132 
	`ex™
(1);

134 
	`dump_mes§ge
(
m
,0);

135 
	}
}

138 
	$push_by‹
(
by‹
, 
pbc_¦iû
 *
d©a
 , 
idx
) {

139 ià(
idx
 >ğ
d©a
->
Ën
) {

140 
d©a
->
Ën
 *= 2;

141 
d©a
->
bufãr
 = 
	`»®loc
(d©a->bufãr, d©a->
Ën
);

143 ((
ušt8_t
 *)
d©a
->
bufãr
)[
idx
] = (ušt8_t)
by‹
;

144 
	}
}

147 
	$»ad_¡dš
(
mode
, 
pbc_¦iû
 *
d©a
) {

148 
d©a
->
Ën
 = 128;

149 
d©a
->
bufãr
 = 
	`m®loc
(d©a->
Ën
);

150 
idx
 = 0;

151 !
	`ãof
(
¡dš
)) {

152 
by‹
;

153 
r
 = 
	`sÿnf
("%d" , &
by‹
);

154 ià(
r
 == 0) {

157 
	`push_by‹
(
by‹
, 
d©a
, 
idx
);

158 ++
idx
;

160 
d©a
->
Ën
 = 
idx
;

161 
	}
}

164 
	$u§ge
(cÚ¡ *
¬gv0
) {

165 
	`´štf
(" -h help.\n"

171 
	}
}

174 
	$maš
(
¬gc
 , * 
¬gv
[])

176 
ch
;

177 cÚ¡ * 
´Ùo
 = 
NULL
;

178 cÚ¡ * 
mes§ge
 = 
NULL
;

179 cÚ¡ * 
d©afe
 = 
NULL
;

180 
mode
 = 0;

181 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "hDp:m:d:")) != -1) {

182 
ch
) {

184 
	`u§ge
(
¬gv
[0]);

187 
´Ùo
 = 
İrg
;

190 
mes§ge
 = 
İrg
;

193 
d©afe
 = 
İrg
;

196 
mode
 = 10;

199 
	`u§ge
(
¬gv
[0]);

204 ià(
´Ùo
 =ğ
NULL
 || 
mes§ge
 == NULL) {

205 
	`u§ge
(
¬gv
[0]);

209 
pbc_¦iû
 
d©a
;

211 ià(
d©afe
 =ğ
NULL
) {

212 
	`»ad_¡dš
(
mode
, &
d©a
);

214 
	`»ad_fe
(
d©afe
 , &
d©a
);

217 
	`dump
(
´Ùo
 , 
mes§ge
 , &
d©a
);

220 
	}
}

	@
1
.
0
44
691
binding/lua/parser.lua
binding/lua/pbc-lua.c
binding/lua/protobuf.lua
binding/lua/test.lua
binding/lua/test2.lua
binding/lua/testparser.lua
binding/lua53/pbc-lua53.c
binding/lua53/protobuf.lua
binding/lua53/test.lua
pbc.h
src/alloc.c
src/alloc.h
src/array.c
src/array.h
src/bootstrap.c
src/bootstrap.h
src/context.c
src/context.h
src/decode.c
src/descriptor.pbc.h
src/map.c
src/map.h
src/pattern.c
src/pattern.h
src/proto.c
src/proto.h
src/register.c
src/rmessage.c
src/stringpool.c
src/stringpool.h
src/varint.c
src/varint.h
src/wmessage.c
test/addressbook.c
test/array.c
test/decode.c
test/float.c
test/map.c
test/pattern.c
test/pbc.c
test/readfile.h
test/test.c
test/varint.c
tool/dump.c
